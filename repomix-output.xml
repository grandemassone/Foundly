This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.mvn/
  wrapper/
    maven-wrapper.jar
    maven-wrapper.properties
db/
  insert.sql
  schemaDB.sql
doc/
  RAD_Foundly.pdf
  SDD_Foundly.pdf
  SOW_Foundly_2025-2026.pdf
src/
  main/
    java/
      controller/
        AreaAdminServlet.java
        AreaDropPointServlet.java
        AvatarServlet.java
        ClassificaServlet.java
        CreaSegnalazioneServlet.java
        DettaglioSegnalazioneServlet.java
        DropPointAvatarServlet.java
        DropPointServlet.java
        GestioneReclamoServlet.java
        IndexServlet.java
        LoginServlet.java
        LogoutServlet.java
        ProfiloDropPointServlet.java
        ProfiloServlet.java
        RecuperoPasswordServlet.java
        RegistrazioneDropPointServlet.java
        RegistrazioneUtenteServlet.java
        SearchServlet.java
        SegnalazioneImgServlet.java
        SegnalazioniReclamiServlet.java
      model/
        bean/
          enums/
            Badge.java
            CategoriaOggetto.java
            ModalitaConsegna.java
            Ruolo.java
            StatoDropPoint.java
            StatoReclamo.java
            StatoSegnalazione.java
            TipoSegnalazione.java
          DropPoint.java
          Reclamo.java
          Segnalazione.java
          SegnalazioneAnimale.java
          SegnalazioneOggetto.java
          Utente.java
        dao/
          DropPointDAO.java
          ReclamoDAO.java
          SegnalazioneDAO.java
          UtenteDAO.java
        service/
          DropPointService.java
          EmailService.java
          RecuperoPasswordService.java
          SegnalazioneService.java
          UtenteService.java
        utils/
          GeocodingUtils.java
          PasswordUtils.java
        ConPool.java
    webapp/
      assets/
        images/
          badges/
            badge_detective.png
            badge_occhio_di_falco.png
            badge_sherlock_holmes.png
          logo.png
      css/
        area_admin.css
        area_drop_point.css
        classifica.css
        crea_segnalazione.css
        dettaglio_segnalazione.css
        drop_point.css
        index.css
        login.css
        profilo.css
        segnalazioni_e_reclami.css
      javascript/
        index.js
      WEB-INF/
        jsp/
          area_admin.jsp
          area_drop_point.jsp
          classifica.jsp
          crea_segnalazione.jsp
          dettaglio_segnalazione.jsp
          drop_point.jsp
          home.jsp
          login.jsp
          navbar.jsp
          profilo_drop_point.jsp
          profilo.jsp
          recupero_password_codice.jsp
          recupero_password_email.jsp
          registrazione_droppoint.jsp
          registrazione_utente.jsp
          segnalazioni_e_reclami.jsp
        web.xml
.gitignore
mvnw
mvnw.cmd
pom.xml
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".mvn/wrapper/maven-wrapper.properties">
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.6/apache-maven-3.9.6-bin.zip
wrapperUrl=https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.3.0/maven-wrapper-3.3.0.jar
</file>

<file path="src/main/webapp/WEB-INF/web.xml">
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="https://jakarta.ee/xml/ns/jakartaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="https://jakarta.ee/xml/ns/jakartaee https://jakarta.ee/xml/ns/jakartaee/web-app_6_0.xsd"
         version="6.0">
</web-app>
</file>

<file path="mvnw">
#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Maven Start Up Batch script
#
# Required ENV vars:
# ------------------
#   JAVA_HOME - location of a JDK home dir
#
# Optional ENV vars
# -----------------
#   M2_HOME - location of maven2's installed home dir
#   MAVEN_OPTS - parameters passed to the Java VM when running Maven
#     e.g. to debug Maven itself, use
#       set MAVEN_OPTS=-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8000
#   MAVEN_SKIP_RC - flag to disable loading of mavenrc files
# ----------------------------------------------------------------------------

if [ -z "$MAVEN_SKIP_RC" ] ; then

  if [ -f /usr/local/etc/mavenrc ] ; then
    . /usr/local/etc/mavenrc
  fi

  if [ -f /etc/mavenrc ] ; then
    . /etc/mavenrc
  fi

  if [ -f "$HOME/.mavenrc" ] ; then
    . "$HOME/.mavenrc"
  fi

fi

# OS specific support.  $var _must_ be set to either true or false.
cygwin=false;
darwin=false;
mingw=false
case "`uname`" in
  CYGWIN*) cygwin=true ;;
  MINGW*) mingw=true;;
  Darwin*) darwin=true
    # Use /usr/libexec/java_home if available, otherwise fall back to /Library/Java/Home
    # See https://developer.apple.com/library/mac/qa/qa1170/_index.html
    if [ -z "$JAVA_HOME" ]; then
      if [ -x "/usr/libexec/java_home" ]; then
        export JAVA_HOME="`/usr/libexec/java_home`"
      else
        export JAVA_HOME="/Library/Java/Home"
      fi
    fi
    ;;
esac

if [ -z "$JAVA_HOME" ] ; then
  if [ -r /etc/gentoo-release ] ; then
    JAVA_HOME=`java-config --jre-home`
  fi
fi

if [ -z "$M2_HOME" ] ; then
  ## resolve links - $0 may be a link to maven's home
  PRG="$0"

  # need this for relative symlinks
  while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
      PRG="$link"
    else
      PRG="`dirname "$PRG"`/$link"
    fi
  done

  saveddir=`pwd`

  M2_HOME=`dirname "$PRG"`/..

  # make it fully qualified
  M2_HOME=`cd "$M2_HOME" && pwd`

  cd "$saveddir"
  # echo Using m2 at $M2_HOME
fi

# For Cygwin, ensure paths are in UNIX format before anything is touched
if $cygwin ; then
  [ -n "$M2_HOME" ] &&
    M2_HOME=`cygpath --unix "$M2_HOME"`
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME=`cygpath --unix "$JAVA_HOME"`
  [ -n "$CLASSPATH" ] &&
    CLASSPATH=`cygpath --path --unix "$CLASSPATH"`
fi

# For Mingw, ensure paths are in UNIX format before anything is touched
if $mingw ; then
  [ -n "$M2_HOME" ] &&
    M2_HOME="`(cd "$M2_HOME"; pwd)`"
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME="`(cd "$JAVA_HOME"; pwd)`"
fi

if [ -z "$JAVA_HOME" ]; then
  javaExecutable="`which javac`"
  if [ -n "$javaExecutable" ] && ! [ "`expr \"$javaExecutable\" : '\([^ ]*\)'`" = "no" ]; then
    # readlink(1) is not available as standard on Solaris 10.
    readLink=`which readlink`
    if [ ! `expr "$readLink" : '\([^ ]*\)'` = "no" ]; then
      if $darwin ; then
        javaHome="`dirname \"$javaExecutable\"`"
        javaExecutable="`cd \"$javaHome\" && pwd -P`/javac"
      else
        javaExecutable="`readlink -f \"$javaExecutable\"`"
      fi
      javaHome="`dirname \"$javaExecutable\"`"
      javaHome=`expr "$javaHome" : '\(.*\)/bin'`
      JAVA_HOME="$javaHome"
      export JAVA_HOME
    fi
  fi
fi

if [ -z "$JAVACMD" ] ; then
  if [ -n "$JAVA_HOME"  ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
    else
      JAVACMD="$JAVA_HOME/bin/java"
    fi
  else
    JAVACMD="`\\unset -f command; \\command -v java`"
  fi
fi

if [ ! -x "$JAVACMD" ] ; then
  echo "Error: JAVA_HOME is not defined correctly." >&2
  echo "  We cannot execute $JAVACMD" >&2
  exit 1
fi

if [ -z "$JAVA_HOME" ] ; then
  echo "Warning: JAVA_HOME environment variable is not set."
fi

CLASSWORLDS_LAUNCHER=org.codehaus.plexus.classworlds.launcher.Launcher

# traverses directory structure from process work directory to filesystem root
# first directory with .mvn subdirectory is considered project base directory
find_maven_basedir() {

  if [ -z "$1" ]
  then
    echo "Path not specified to find_maven_basedir"
    return 1
  fi

  basedir="$1"
  wdir="$1"
  while [ "$wdir" != '/' ] ; do
    if [ -d "$wdir"/.mvn ] ; then
      basedir=$wdir
      break
    fi
    # workaround for JBEAP-8937 (on Solaris 10/Sparc)
    if [ -d "${wdir}" ]; then
      wdir=`cd "$wdir/.."; pwd`
    fi
    # end of workaround
  done
  echo "${basedir}"
}

# concatenates all lines of a file
concat_lines() {
  if [ -f "$1" ]; then
    echo "$(tr -s '\n' ' ' < "$1")"
  fi
}

BASE_DIR=`find_maven_basedir "$(pwd)"`
if [ -z "$BASE_DIR" ]; then
  exit 1;
fi

##########################################################################################
# Extension to allow automatically downloading the maven-wrapper.jar from Maven-central
# This allows using the maven wrapper in projects that prohibit checking in binary data.
##########################################################################################
if [ -r "$BASE_DIR/.mvn/wrapper/maven-wrapper.jar" ]; then
    if [ "$MVNW_VERBOSE" = true ]; then
      echo "Found .mvn/wrapper/maven-wrapper.jar"
    fi
else
    if [ "$MVNW_VERBOSE" = true ]; then
      echo "Couldn't find .mvn/wrapper/maven-wrapper.jar, downloading it ..."
    fi
    if [ -n "$MVNW_REPOURL" ]; then
      jarUrl="$MVNW_REPOURL/org/apache/maven/wrapper/maven-wrapper/3.1.0/maven-wrapper-3.1.0.jar"
    else
      jarUrl="https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.1.0/maven-wrapper-3.1.0.jar"
    fi
    while IFS="=" read key value; do
      case "$key" in (wrapperUrl) jarUrl="$value"; break ;;
      esac
    done < "$BASE_DIR/.mvn/wrapper/maven-wrapper.properties"
    if [ "$MVNW_VERBOSE" = true ]; then
      echo "Downloading from: $jarUrl"
    fi
    wrapperJarPath="$BASE_DIR/.mvn/wrapper/maven-wrapper.jar"
    if $cygwin; then
      wrapperJarPath=`cygpath --path --windows "$wrapperJarPath"`
    fi

    if command -v wget > /dev/null; then
        if [ "$MVNW_VERBOSE" = true ]; then
          echo "Found wget ... using wget"
        fi
        if [ -z "$MVNW_USERNAME" ] || [ -z "$MVNW_PASSWORD" ]; then
            wget "$jarUrl" -O "$wrapperJarPath" || rm -f "$wrapperJarPath"
        else
            wget --http-user=$MVNW_USERNAME --http-password=$MVNW_PASSWORD "$jarUrl" -O "$wrapperJarPath" || rm -f "$wrapperJarPath"
        fi
    elif command -v curl > /dev/null; then
        if [ "$MVNW_VERBOSE" = true ]; then
          echo "Found curl ... using curl"
        fi
        if [ -z "$MVNW_USERNAME" ] || [ -z "$MVNW_PASSWORD" ]; then
            curl -o "$wrapperJarPath" "$jarUrl" -f
        else
            curl --user $MVNW_USERNAME:$MVNW_PASSWORD -o "$wrapperJarPath" "$jarUrl" -f
        fi

    else
        if [ "$MVNW_VERBOSE" = true ]; then
          echo "Falling back to using Java to download"
        fi
        javaClass="$BASE_DIR/.mvn/wrapper/MavenWrapperDownloader.java"
        # For Cygwin, switch paths to Windows format before running javac
        if $cygwin; then
          javaClass=`cygpath --path --windows "$javaClass"`
        fi
        if [ -e "$javaClass" ]; then
            if [ ! -e "$BASE_DIR/.mvn/wrapper/MavenWrapperDownloader.class" ]; then
                if [ "$MVNW_VERBOSE" = true ]; then
                  echo " - Compiling MavenWrapperDownloader.java ..."
                fi
                # Compiling the Java class
                ("$JAVA_HOME/bin/javac" "$javaClass")
            fi
            if [ -e "$BASE_DIR/.mvn/wrapper/MavenWrapperDownloader.class" ]; then
                # Running the downloader
                if [ "$MVNW_VERBOSE" = true ]; then
                  echo " - Running MavenWrapperDownloader.java ..."
                fi
                ("$JAVA_HOME/bin/java" -cp .mvn/wrapper MavenWrapperDownloader "$MAVEN_PROJECTBASEDIR")
            fi
        fi
    fi
fi
##########################################################################################
# End of extension
##########################################################################################

export MAVEN_PROJECTBASEDIR=${MAVEN_BASEDIR:-"$BASE_DIR"}
if [ "$MVNW_VERBOSE" = true ]; then
  echo $MAVEN_PROJECTBASEDIR
fi
MAVEN_OPTS="$(concat_lines "$MAVEN_PROJECTBASEDIR/.mvn/jvm.config") $MAVEN_OPTS"

# For Cygwin, switch paths to Windows format before running java
if $cygwin; then
  [ -n "$M2_HOME" ] &&
    M2_HOME=`cygpath --path --windows "$M2_HOME"`
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME=`cygpath --path --windows "$JAVA_HOME"`
  [ -n "$CLASSPATH" ] &&
    CLASSPATH=`cygpath --path --windows "$CLASSPATH"`
  [ -n "$MAVEN_PROJECTBASEDIR" ] &&
    MAVEN_PROJECTBASEDIR=`cygpath --path --windows "$MAVEN_PROJECTBASEDIR"`
fi

# Provide a "standardized" way to retrieve the CLI args that will
# work with both Windows and non-Windows executions.
MAVEN_CMD_LINE_ARGS="$MAVEN_CONFIG $@"
export MAVEN_CMD_LINE_ARGS

WRAPPER_LAUNCHER=org.apache.maven.wrapper.MavenWrapperMain

exec "$JAVACMD" \
  $MAVEN_OPTS \
  $MAVEN_DEBUG_OPTS \
  -classpath "$MAVEN_PROJECTBASEDIR/.mvn/wrapper/maven-wrapper.jar" \
  "-Dmaven.home=${M2_HOME}" \
  "-Dmaven.multiModuleProjectDirectory=${MAVEN_PROJECTBASEDIR}" \
  ${WRAPPER_LAUNCHER} $MAVEN_CONFIG "$@"
</file>

<file path="mvnw.cmd">
@REM ----------------------------------------------------------------------------
@REM Licensed to the Apache Software Foundation (ASF) under one
@REM or more contributor license agreements.  See the NOTICE file
@REM distributed with this work for additional information
@REM regarding copyright ownership.  The ASF licenses this file
@REM to you under the Apache License, Version 2.0 (the
@REM "License"); you may not use this file except in compliance
@REM with the License.  You may obtain a copy of the License at
@REM
@REM    https://www.apache.org/licenses/LICENSE-2.0
@REM
@REM Unless required by applicable law or agreed to in writing,
@REM software distributed under the License is distributed on an
@REM "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
@REM KIND, either express or implied.  See the License for the
@REM specific language governing permissions and limitations
@REM under the License.
@REM ----------------------------------------------------------------------------

@REM ----------------------------------------------------------------------------
@REM Maven Start Up Batch script
@REM
@REM Required ENV vars:
@REM JAVA_HOME - location of a JDK home dir
@REM
@REM Optional ENV vars
@REM M2_HOME - location of maven2's installed home dir
@REM MAVEN_BATCH_ECHO - set to 'on' to enable the echoing of the batch commands
@REM MAVEN_BATCH_PAUSE - set to 'on' to wait for a keystroke before ending
@REM MAVEN_OPTS - parameters passed to the Java VM when running Maven
@REM     e.g. to debug Maven itself, use
@REM set MAVEN_OPTS=-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8000
@REM MAVEN_SKIP_RC - flag to disable loading of mavenrc files
@REM ----------------------------------------------------------------------------

@REM Begin all REM lines with '@' in case MAVEN_BATCH_ECHO is 'on'
@echo off
@REM set title of command window
title %0
@REM enable echoing by setting MAVEN_BATCH_ECHO to 'on'
@if "%MAVEN_BATCH_ECHO%" == "on"  echo %MAVEN_BATCH_ECHO%

@REM set %HOME% to equivalent of $HOME
if "%HOME%" == "" (set "HOME=%HOMEDRIVE%%HOMEPATH%")

@REM Execute a user defined script before this one
if not "%MAVEN_SKIP_RC%" == "" goto skipRcPre
@REM check for pre script, once with legacy .bat ending and once with .cmd ending
if exist "%USERPROFILE%\mavenrc_pre.bat" call "%USERPROFILE%\mavenrc_pre.bat" %*
if exist "%USERPROFILE%\mavenrc_pre.cmd" call "%USERPROFILE%\mavenrc_pre.cmd" %*
:skipRcPre

@setlocal

set ERROR_CODE=0

@REM To isolate internal variables from possible post scripts, we use another setlocal
@setlocal

@REM ==== START VALIDATION ====
if not "%JAVA_HOME%" == "" goto OkJHome

echo.
echo Error: JAVA_HOME not found in your environment. >&2
echo Please set the JAVA_HOME variable in your environment to match the >&2
echo location of your Java installation. >&2
echo.
goto error

:OkJHome
if exist "%JAVA_HOME%\bin\java.exe" goto init

echo.
echo Error: JAVA_HOME is set to an invalid directory. >&2
echo JAVA_HOME = "%JAVA_HOME%" >&2
echo Please set the JAVA_HOME variable in your environment to match the >&2
echo location of your Java installation. >&2
echo.
goto error

@REM ==== END VALIDATION ====

:init

@REM Find the project base dir, i.e. the directory that contains the folder ".mvn".
@REM Fallback to current working directory if not found.

set MAVEN_PROJECTBASEDIR=%MAVEN_BASEDIR%
IF NOT "%MAVEN_PROJECTBASEDIR%"=="" goto endDetectBaseDir

set EXEC_DIR=%CD%
set WDIR=%EXEC_DIR%
:findBaseDir
IF EXIST "%WDIR%"\.mvn goto baseDirFound
cd ..
IF "%WDIR%"=="%CD%" goto baseDirNotFound
set WDIR=%CD%
goto findBaseDir

:baseDirFound
set MAVEN_PROJECTBASEDIR=%WDIR%
cd "%EXEC_DIR%"
goto endDetectBaseDir

:baseDirNotFound
set MAVEN_PROJECTBASEDIR=%EXEC_DIR%
cd "%EXEC_DIR%"

:endDetectBaseDir

IF NOT EXIST "%MAVEN_PROJECTBASEDIR%\.mvn\jvm.config" goto endReadAdditionalConfig

@setlocal EnableExtensions EnableDelayedExpansion
for /F "usebackq delims=" %%a in ("%MAVEN_PROJECTBASEDIR%\.mvn\jvm.config") do set JVM_CONFIG_MAVEN_PROPS=!JVM_CONFIG_MAVEN_PROPS! %%a
@endlocal & set JVM_CONFIG_MAVEN_PROPS=%JVM_CONFIG_MAVEN_PROPS%

:endReadAdditionalConfig

SET MAVEN_JAVA_EXE="%JAVA_HOME%\bin\java.exe"
set WRAPPER_JAR="%MAVEN_PROJECTBASEDIR%\.mvn\wrapper\maven-wrapper.jar"
set WRAPPER_LAUNCHER=org.apache.maven.wrapper.MavenWrapperMain

set DOWNLOAD_URL="https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.1.0/maven-wrapper-3.1.0.jar"

FOR /F "usebackq tokens=1,2 delims==" %%A IN ("%MAVEN_PROJECTBASEDIR%\.mvn\wrapper\maven-wrapper.properties") DO (
    IF "%%A"=="wrapperUrl" SET DOWNLOAD_URL=%%B
)

@REM Extension to allow automatically downloading the maven-wrapper.jar from Maven-central
@REM This allows using the maven wrapper in projects that prohibit checking in binary data.
if exist %WRAPPER_JAR% (
    if "%MVNW_VERBOSE%" == "true" (
        echo Found %WRAPPER_JAR%
    )
) else (
    if not "%MVNW_REPOURL%" == "" (
        SET DOWNLOAD_URL="%MVNW_REPOURL%/org/apache/maven/wrapper/maven-wrapper/3.1.0/maven-wrapper-3.1.0.jar"
    )
    if "%MVNW_VERBOSE%" == "true" (
        echo Couldn't find %WRAPPER_JAR%, downloading it ...
        echo Downloading from: %DOWNLOAD_URL%
    )

    powershell -Command "&{"^
		"$webclient = new-object System.Net.WebClient;"^
		"if (-not ([string]::IsNullOrEmpty('%MVNW_USERNAME%') -and [string]::IsNullOrEmpty('%MVNW_PASSWORD%'))) {"^
		"$webclient.Credentials = new-object System.Net.NetworkCredential('%MVNW_USERNAME%', '%MVNW_PASSWORD%');"^
		"}"^
		"[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; $webclient.DownloadFile('%DOWNLOAD_URL%', '%WRAPPER_JAR%')"^
		"}"
    if "%MVNW_VERBOSE%" == "true" (
        echo Finished downloading %WRAPPER_JAR%
    )
)
@REM End of extension

@REM Provide a "standardized" way to retrieve the CLI args that will
@REM work with both Windows and non-Windows executions.
set MAVEN_CMD_LINE_ARGS=%*

%MAVEN_JAVA_EXE% ^
  %JVM_CONFIG_MAVEN_PROPS% ^
  %MAVEN_OPTS% ^
  %MAVEN_DEBUG_OPTS% ^
  -classpath %WRAPPER_JAR% ^
  "-Dmaven.multiModuleProjectDirectory=%MAVEN_PROJECTBASEDIR%" ^
  %WRAPPER_LAUNCHER% %MAVEN_CONFIG% %*
if ERRORLEVEL 1 goto error
goto end

:error
set ERROR_CODE=1

:end
@endlocal & set ERROR_CODE=%ERROR_CODE%

if not "%MAVEN_SKIP_RC%"=="" goto skipRcPost
@REM check for post script, once with legacy .bat ending and once with .cmd ending
if exist "%USERPROFILE%\mavenrc_post.bat" call "%USERPROFILE%\mavenrc_post.bat"
if exist "%USERPROFILE%\mavenrc_post.cmd" call "%USERPROFILE%\mavenrc_post.cmd"
:skipRcPost

@REM pause the script if MAVEN_BATCH_PAUSE is set to 'on'
if "%MAVEN_BATCH_PAUSE%"=="on" pause

if "%MAVEN_TERMINATE_CMD%"=="on" exit %ERROR_CODE%

cmd /C exit /B %ERROR_CODE%
</file>

<file path="src/main/java/controller/AreaAdminServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import model.bean.DropPoint;
import model.bean.Utente;
import model.bean.enums.Ruolo;
import model.service.DropPointService;
import model.service.UtenteService;

import java.io.IOException;
import java.util.List;

@WebServlet(name = "AreaAdminServlet", value = "/admin")
public class AreaAdminServlet extends HttpServlet {

    private final DropPointService dropPointService = new DropPointService();
    private final UtenteService utenteService = new UtenteService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        Utente admin = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (admin == null || admin.getRuolo() != Ruolo.ADMIN) {
            response.sendError(HttpServletResponse.SC_FORBIDDEN);
            return;
        }

        List<DropPoint> pendenti = dropPointService.findAllInAttesa();
        List<Utente> utenti = utenteService.trovaTutti();

        request.setAttribute("dropPointsPendenti", pendenti);
        request.setAttribute("listaUtenti", utenti);

        request.getRequestDispatcher("/WEB-INF/jsp/area_admin.jsp")
                .forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        Utente admin = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (admin == null || admin.getRuolo() != Ruolo.ADMIN) {
            response.sendError(HttpServletResponse.SC_FORBIDDEN);
            return;
        }

        String action = request.getParameter("action");

        try {
            if ("approveDropPoint".equals(action)) {
                long id = Long.parseLong(request.getParameter("dropPointId"));
                dropPointService.approvaDropPoint(id);

            } else if ("rejectDropPoint".equals(action)) {
                long id = Long.parseLong(request.getParameter("dropPointId"));
                dropPointService.rifiutaDropPoint(id);

            } else if ("deleteUser".equals(action)) {
                long userId = Long.parseLong(request.getParameter("userId"));
                // Non permetto all'admin di cancellare se stesso
                if (userId != admin.getId()) {
                    utenteService.cancellaUtente(userId);
                }
            }
        } catch (NumberFormatException ignore) {
            // input non valido, ignoro
        }

        response.sendRedirect(request.getContextPath() + "/admin");
    }
}
</file>

<file path="src/main/java/controller/AvatarServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.bean.Utente;
import model.service.UtenteService;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;

@WebServlet(name = "AvatarServlet", value = "/avatar")
public class AvatarServlet extends HttpServlet {

    private final UtenteService utenteService = new UtenteService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws IOException {

        String idParam = request.getParameter("userId");
        long userId;

        try {
            userId = Long.parseLong(idParam);
        } catch (Exception e) {
            sendDefaultAvatar(response);
            return;
        }

        Utente u = utenteService.trovaPerId(userId);
        if (u == null || u.getImmagineProfilo() == null || u.getImmagineProfilo().length == 0) {
            sendDefaultAvatar(response);
            return;
        }

        String contentType = u.getImmagineProfiloContentType();
        if (contentType == null || contentType.isBlank()) {
            contentType = "image/jpeg";
        }

        byte[] data = u.getImmagineProfilo();

        // (opzionale) disabilita la cache se vuoi sempre l'ultima versione
        // response.setHeader("Cache-Control", "no-store, no-cache, must-revalidate, max-age=0");

        response.setContentType(contentType);
        response.setContentLength(data.length);

        try (OutputStream os = response.getOutputStream()) {
            os.write(data);
        }
    }

    private void sendDefaultAvatar(HttpServletResponse response) throws IOException {
        // avatar di default: metti un file in src/main/webapp/assets/images/default-avatar.png
        try (InputStream is = getServletContext()
                .getResourceAsStream("/assets/images/default-avatar.png")) {

            if (is == null) {
                // nessun default: non mando contenuto
                response.setStatus(HttpServletResponse.SC_NO_CONTENT);
                return;
            }

            byte[] buffer = is.readAllBytes();

            response.setContentType("image/png");
            response.setContentLength(buffer.length);

            try (OutputStream os = response.getOutputStream()) {
                os.write(buffer);
            }
        }
    }
}
</file>

<file path="src/main/java/controller/ClassificaServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.bean.Utente;
import model.service.UtenteService;

import java.io.IOException;
import java.util.List;

@WebServlet(name = "ClassificaServlet", value = "/classifica")
public class ClassificaServlet extends HttpServlet {

    private final UtenteService utenteService = new UtenteService();

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {

        // 1. Recupera la lista completa degli utenti ordinata per punteggio decrescente
        // Assicurati che nel tuo Service/DAO esista questo metodo
        List<Utente> classificaCompleta = utenteService.getClassificaUtenti();

        // 2. Opzionale: Se volessi passare solo i top 3 separatamente (ma la JSP attuale usa la lista completa)
        // List<Utente> top3 = classificaCompleta.stream().limit(3).toList();
        // request.setAttribute("top3", top3);

        // 3. Passa la lista completa alla JSP
        request.setAttribute("classifica", classificaCompleta);

        // 4. Mostra la pagina
        request.getRequestDispatcher("/WEB-INF/jsp/classifica.jsp").forward(request, response);
    }
}
</file>

<file path="src/main/java/controller/DropPointAvatarServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.bean.DropPoint;
import model.service.DropPointService;

import java.io.IOException;

@WebServlet(name = "DropPointAvatarServlet", value = "/drop-point-avatar")
public class DropPointAvatarServlet extends HttpServlet {

    private final DropPointService dropPointService = new DropPointService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        String idParam = request.getParameter("dpId");
        if (idParam == null) {
            response.setStatus(HttpServletResponse.SC_NOT_FOUND);
            return;
        }

        long id;
        try {
            id = Long.parseLong(idParam);
        } catch (NumberFormatException ex) {
            response.setStatus(HttpServletResponse.SC_NOT_FOUND);
            return;
        }

        DropPoint dp = dropPointService.trovaPerId(id);
        if (dp == null || dp.getImmagine() == null || dp.getImmagine().length == 0) {
            // nessun logo salvato -> 404 (oppure qui puoi servire un png di default)
            response.setStatus(HttpServletResponse.SC_NOT_FOUND);
            return;
        }

        String contentType = dp.getImmagineContentType();
        if (contentType == null || contentType.isBlank()) {
            contentType = "image/png";
        }

        byte[] img = dp.getImmagine();
        response.setContentType(contentType);
        response.setContentLength(img.length);
        response.getOutputStream().write(img);
    }
}
</file>

<file path="src/main/java/controller/ProfiloDropPointServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.MultipartConfig;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import jakarta.servlet.http.Part;
import model.bean.DropPoint;
import model.service.DropPointService;

import java.io.IOException;
import java.io.InputStream;

@WebServlet(name = "ProfiloDropPointServlet", value = "/profilo-drop-point")
@MultipartConfig(
        fileSizeThreshold = 1024 * 1024 * 2, // 2MB
        maxFileSize = 1024 * 1024 * 10,      // 10MB
        maxRequestSize = 1024 * 1024 * 50    // 50MB
)
public class ProfiloDropPointServlet extends HttpServlet {

    private final DropPointService dropPointService = new DropPointService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        DropPoint dp = (session != null) ? (DropPoint) session.getAttribute("dropPoint") : null;

        if (dp == null) {
            response.sendRedirect(request.getContextPath() + "/login");
            return;
        }

        // ricarico dal DB per avere i dati aggiornati
        DropPoint fresh = dropPointService.trovaPerId(dp.getId());
        if (fresh != null) {
            session.setAttribute("dropPoint", fresh);
            dp = fresh;
        }

        request.setAttribute("dropPoint", dp);
        request.getRequestDispatcher("/WEB-INF/jsp/profilo_drop_point.jsp")
                .forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        DropPoint dp = (session != null) ? (DropPoint) session.getAttribute("dropPoint") : null;

        if (dp == null) {
            response.sendRedirect(request.getContextPath() + "/login");
            return;
        }

        // Parametri testo (NON tocco l'email qui, altrimenti la azzeri)
        String nomeAttivita   = request.getParameter("nomeAttivita");
        String indirizzo      = request.getParameter("indirizzo");
        String citta          = request.getParameter("citta");
        String provincia      = request.getParameter("provincia");
        String telefono       = request.getParameter("telefono");
        String orariApertura  = request.getParameter("orariApertura");
        String removeLogo     = request.getParameter("removeLogo");

        dp.setNomeAttivita(nomeAttivita);
        dp.setIndirizzo(indirizzo);
        dp.setCitta(citta);
        dp.setProvincia(provincia);
        dp.setTelefono(telefono);
        dp.setOrariApertura(orariApertura);

        // Gestione logo (BLOB)
        Part logoPart = null;
        try {
            logoPart = request.getPart("logo");
        } catch (Exception ignored) { }

        if ("true".equalsIgnoreCase(removeLogo)) {
            dp.setImmagine(null);
            dp.setImmagineContentType(null);
        } else if (logoPart != null && logoPart.getSize() > 0) {
            try (InputStream is = logoPart.getInputStream()) {
                byte[] bytes = is.readAllBytes();
                dp.setImmagine(bytes);
                dp.setImmagineContentType(logoPart.getContentType());
            }
        }
        // Se non carico nulla e non chiedo rimozione, l'immagine rimane quella attuale.

        boolean ok = dropPointService.aggiornaProfilo(dp);

        if (ok) {
            // ricarico dal DB e aggiorno sessione
            DropPoint updated = dropPointService.trovaPerId(dp.getId());
            if (updated != null) {
                session.setAttribute("dropPoint", updated);
            } else {
                session.setAttribute("dropPoint", dp);
            }
            response.sendRedirect(request.getContextPath() + "/profilo-drop-point?success=1");
        } else {
            request.setAttribute("dropPoint", dp);
            request.setAttribute("errore", "Errore nel salvataggio del profilo Drop-Point.");
            request.getRequestDispatcher("/WEB-INF/jsp/profilo_drop_point.jsp")
                    .forward(request, response);
        }
    }
}
</file>

<file path="src/main/java/controller/SearchServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.bean.Segnalazione;
import model.service.SegnalazioneService;

import java.io.IOException;
import java.util.List;

@WebServlet(name = "SearchServlet", value = "/search")
public class SearchServlet extends HttpServlet {
    private final SegnalazioneService service = new SegnalazioneService();

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String q = request.getParameter("q");
        String tipo = request.getParameter("tipo");
        String categoria = request.getParameter("categoria");

        List<Segnalazione> risultati = service.cercaSegnalazioni(q, tipo, categoria);

        // Salvo i risultati nella request
        request.setAttribute("segnalazioni", risultati);

        // Manteniamo i filtri selezionati (per UX)
        request.setAttribute("paramQ", q);
        request.setAttribute("paramTipo", tipo);
        request.setAttribute("paramCat", categoria);

        // MODIFICA QUI: Inoltro alla Servlet "Index" invece che alla JSP diretta
        request.getRequestDispatcher("/index").forward(request, response);
    }
}
</file>

<file path="src/main/java/controller/SegnalazioneImgServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.bean.Segnalazione;
import model.service.SegnalazioneService;

import java.io.IOException;
import java.io.OutputStream;

@WebServlet(name = "SegnalazioneImgServlet", value = "/segnalazione-img")
public class SegnalazioneImgServlet extends HttpServlet {

    private final SegnalazioneService segnalazioneService = new SegnalazioneService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        String idParam = request.getParameter("id");
        if (idParam == null) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST, "Missing id");
            return;
        }

        long id;
        try {
            id = Long.parseLong(idParam);
        } catch (NumberFormatException e) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST, "Invalid id");
            return;
        }

        Segnalazione s = segnalazioneService.trovaPerId(id);
        if (s == null || s.getImmagine() == null || s.getImmagine().length == 0) {
            // nessuna immagine: puoi mandare 404 o un placeholder
            response.sendError(HttpServletResponse.SC_NOT_FOUND);
            return;
        }

        String contentType = s.getImmagineContentType();
        if (contentType == null || contentType.isBlank()) {
            contentType = "image/jpeg";
        }

        response.setContentType(contentType);
        response.setContentLength(s.getImmagine().length);

        try (OutputStream out = response.getOutputStream()) {
            out.write(s.getImmagine());
        }
    }
}
</file>

<file path="src/main/java/controller/SegnalazioniReclamiServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import model.bean.Reclamo;
import model.bean.Segnalazione;
import model.bean.Utente;
import model.service.SegnalazioneService;

import java.io.IOException;
import java.util.List;

@WebServlet(name = "SegnalazioniReclamiServlet", value = "/le-mie-segnalazioni")
public class SegnalazioniReclamiServlet extends HttpServlet {

    private final SegnalazioneService service = new SegnalazioneService();

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        HttpSession session = request.getSession(false);
        Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (utente == null) {
            response.sendRedirect("login");
            return;
        }

        // 1. Le Mie Segnalazioni (Oggetti che HO trovato)
        List<Segnalazione> mieSegnalazioni = service.trovaPerUtente(utente.getId());
        request.setAttribute("mieSegnalazioni", mieSegnalazioni);

        // 2. I Miei Reclami (Oggetti che HO perso e sto richiedendo)
        List<Reclamo> mieiReclami = service.trovaReclamiFattiDaUtente(utente.getId());
        request.setAttribute("mieiReclami", mieiReclami);

        request.getRequestDispatcher("/WEB-INF/jsp/segnalazioni_e_reclami.jsp").forward(request, response);
    }
}
</file>

<file path="src/main/java/model/bean/enums/Badge.java">
package model.bean.enums;

public enum Badge {
    OCCHIO_DI_FALCO, DETECTIVE, SHERLOCK_HOLMES
}
</file>

<file path="src/main/java/model/bean/enums/CategoriaOggetto.java">
package model.bean.enums;

public enum CategoriaOggetto {
    DOCUMENTI, ELETTRONICA, PORTAFOGLI, CHIAVI, GIOIELLI, ABBIGLIAMENTO, ALTRO
}
</file>

<file path="src/main/java/model/bean/enums/ModalitaConsegna.java">
package model.bean.enums;

public enum ModalitaConsegna { DIRETTA, DROP_POINT }
</file>

<file path="src/main/java/model/bean/enums/Ruolo.java">
package model.bean.enums;

public enum Ruolo { UTENTE_BASE, ADMIN }
</file>

<file path="src/main/java/model/bean/enums/StatoDropPoint.java">
package model.bean.enums;


public enum StatoDropPoint {
    IN_ATTESA,
    APPROVATO,
    RIFIUTATO
}
</file>

<file path="src/main/java/model/bean/enums/StatoReclamo.java">
package model.bean.enums;

public enum StatoReclamo { IN_ATTESA, ACCETTATO, RIFIUTATO }
</file>

<file path="src/main/java/model/bean/enums/StatoSegnalazione.java">
package model.bean.enums;

public enum StatoSegnalazione { APERTA, IN_CONSEGNA, CHIUSA }
</file>

<file path="src/main/java/model/bean/enums/TipoSegnalazione.java">
package model.bean.enums;

public enum TipoSegnalazione { OGGETTO, ANIMALE }
</file>

<file path="src/main/java/model/bean/SegnalazioneAnimale.java">
package model.bean;

import model.bean.enums.TipoSegnalazione;

public class SegnalazioneAnimale extends Segnalazione {
    private String specie;
    private String razza;

    public SegnalazioneAnimale() {
        super();
        this.setTipoSegnalazione(TipoSegnalazione.ANIMALE);
    }

    public String getSpecie() { return specie; }
    public void setSpecie(String specie) { this.specie = specie; }

    public String getRazza() { return razza; }
    public void setRazza(String razza) { this.razza = razza; }
}
</file>

<file path="src/main/java/model/bean/SegnalazioneOggetto.java">
package model.bean;

import model.bean.enums.CategoriaOggetto;
import model.bean.enums.ModalitaConsegna;
import model.bean.enums.TipoSegnalazione;

public class SegnalazioneOggetto extends Segnalazione {
    private CategoriaOggetto categoria;
    private ModalitaConsegna modalitaConsegna;
    private Long idDropPoint;

    public SegnalazioneOggetto() {
        super();
        this.setTipoSegnalazione(TipoSegnalazione.OGGETTO);
    }

    public CategoriaOggetto getCategoria() { return categoria; }
    public void setCategoria(CategoriaOggetto categoria) { this.categoria = categoria; }

    public ModalitaConsegna getModalitaConsegna() { return modalitaConsegna; }
    public void setModalitaConsegna(ModalitaConsegna modalitaConsegna) { this.modalitaConsegna = modalitaConsegna; }

    public Long getIdDropPoint() { return idDropPoint; }
    public void setIdDropPoint(Long idDropPoint) { this.idDropPoint = idDropPoint; }
}
</file>

<file path="src/main/java/model/service/RecuperoPasswordService.java">
package model.service;

public class RecuperoPasswordService {
}
</file>

<file path="src/main/java/model/utils/GeocodingUtils.java">
package model.utils;

import org.json.JSONArray;
import org.json.JSONObject;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

public class GeocodingUtils {

    // Coordinate di default (es. Roma) se l'indirizzo non viene trovato
    private static final double DEFAULT_LAT = 41.9028;
    private static final double DEFAULT_LON = 12.4964;

    /**
     * Restituisce un array di double {latitudine, longitudine} dato un indirizzo.
     */
    public static double[] getCoordinates(String indirizzo, String citta, String provincia) {
        try {
            // 1. Costruiamo la query per OpenStreetMap
            String fullAddress = indirizzo + ", " + citta + ", " + provincia;
            String encodedAddress = URLEncoder.encode(fullAddress, StandardCharsets.UTF_8);

            // URL API Nominatim (OpenStreetMap)
            String urlString = "https://nominatim.openstreetmap.org/search?q=" + encodedAddress + "&format=json&limit=1";

            URL url = new URL(urlString);
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("GET");

            // IMPORTANTE: Nominatim richiede uno User-Agent identificativo
            conn.setRequestProperty("User-Agent", "FoundlyApp/1.0 (student.project@unisa.it)");

            int responseCode = conn.getResponseCode();
            if (responseCode == 200) {
                BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                String inputLine;
                StringBuilder content = new StringBuilder();
                while ((inputLine = in.readLine()) != null) {
                    content.append(inputLine);
                }
                in.close();

                // 2. Parsiamo il JSON ricevuto
                JSONArray jsonArray = new JSONArray(content.toString());

                if (jsonArray.length() > 0) {
                    JSONObject location = jsonArray.getJSONObject(0);
                    double lat = location.getDouble("lat");
                    double lon = location.getDouble("lon");

                    System.out.println("Geocoding Successo: " + fullAddress + " -> " + lat + ", " + lon);
                    return new double[]{lat, lon};
                }
            } else {
                System.err.println("Errore API Geocoding: HTTP " + responseCode);
            }

        } catch (Exception e) {
            e.printStackTrace();
            System.err.println("Eccezione durante il geocoding per: " + indirizzo);
        }

        System.out.println("Indirizzo non trovato, uso coordinate default.");
        return new double[]{DEFAULT_LAT, DEFAULT_LON};
    }
}
</file>

<file path="src/main/java/model/utils/PasswordUtils.java">
package model.utils;

import org.mindrot.jbcrypt.BCrypt;

public class PasswordUtils {
    public static String hashPassword(String password) {
        return BCrypt.hashpw(password, BCrypt.gensalt(12));
    }
    public static boolean checkPassword(String plainPassword, String hashedPassword) {
        if (hashedPassword == null || !hashedPassword.startsWith("$2a$")) {
            throw new IllegalArgumentException("Hash non valido");
        }
        return BCrypt.checkpw(plainPassword, hashedPassword);
    }
}
</file>

<file path="src/main/webapp/css/area_admin.css">
.admin-main {
    max-width: 1100px;
    margin: 24px auto 40px;
    padding: 0 24px 40px;
}

.admin-section {
    margin-bottom: 32px;
}

.admin-title {
    font-size: 1.6rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: #202124;
}

.admin-card {
    background-color: #FFFFFF;
    border-radius: 18px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    padding: 16px 20px 18px;
}

.admin-subtitle {
    font-size: 1.1rem;
    font-weight: 500;
    margin-bottom: 12px;
    color: #E65100;
}

.admin-empty {
    font-size: 0.95rem;
    color: #757575;
    padding: 4px 0 8px;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.admin-table th,
.admin-table td {
    padding: 10px 14px;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
}

.admin-table th {
    font-weight: 600;
    color: #5F6368;
    background-color: #FAFAFA;
}

.admin-actions {
    display: flex;
    gap: 6px;
    align-items: center;
}

.inline-form {
    display: inline-block;
}

.btn-admin-approve,
.btn-admin-reject,
.btn-admin-delete {
    padding: 4px 10px;
    border-radius: 999px;
    border: none;
    font-size: 0.8rem;
    cursor: pointer;
    font-weight: 500;
}

.btn-admin-approve {
    background-color: #E8F5E9;
    color: #2E7D32;
}

.btn-admin-reject {
    background-color: #FFEBEE;
    color: #C62828;
}

.btn-admin-delete {
    background-color: #FFF3E0;
    color: #E65100;
}

.btn-admin-approve:hover {
    background-color: #C8E6C9;
}

.btn-admin-reject:hover {
    background-color: #FFCDD2;
}

.btn-admin-delete:hover {
    background-color: #FFE0B2;
}

.admin-note {
    font-size: 0.8rem;
    color: #9E9E9E;
}
/* Rimuove la riga di bordo sotto l'ultima riga della tabella utenti
   cos√¨ non si vede la linea "spezzata" sotto Elimina / N/D */
.admin-table tbody tr:last-child td {
    border-bottom: none;
}
</file>

<file path="src/main/webapp/css/area_drop_point.css">
/* area_drop_point.css */

.dp-area-main {
    max-width: 1100px;
    margin: 30px auto 50px auto;
    padding: 0 20px 40px 20px;
    font-family: 'Roboto', sans-serif;
}

/* HEADER */

.dp-area-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.dp-area-title-block {
    display: flex;
    align-items: center;
    gap: 14px;
}

.dp-area-icon {
    width: 48px;
    height: 48px;
    border-radius: 18px;
    background: #FFF3E0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.dp-area-icon .material-icons {
    font-size: 28px;
    color: #E65100;
}

.dp-area-title {
    font-size: 1.4rem;
    margin: 0;
    color: #202124;
}

.dp-area-subtitle {
    font-size: 0.85rem;
    margin: 2px 0 0 0;
    color: #5f6368;
}

.dp-area-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 0.8rem;
    border: 1px solid transparent;
}

.dp-area-status-badge .material-icons {
    font-size: 16px;
}

.status-none {
    background: #f5f5f5;
    border-color: #e0e0e0;
    color: #5f6368;
}

.status-ok {
    background: #E8F5E9;
    border-color: #81C784;
    color: #2E7D32;
}

.status-pending {
    background: #FFF3E0;
    border-color: #FFB74D;
    color: #E65100;
}

/* STATS */

.dp-stats-row {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.dp-stat-card {
    background: #FFFFFF;
    border-radius: 18px;
    padding: 16px 18px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    position: relative;
}

.dp-stat-label {
    font-size: 0.85rem;
    color: #5f6368;
    margin-bottom: 4px;
}

.dp-stat-value {
    font-size: 1.6rem;
    font-weight: 700;
}

.dp-stat-value.warning { color: #FB8C00; }
.dp-stat-value.success { color: #2E7D32; }
.dp-stat-value.info    { color: #1E88E5; }

.dp-stat-icon {
    position: absolute;
    right: 14px;
    top: 14px;
    font-size: 22px;
    opacity: 0.35;
}

/* ALERT */

.dp-alert {
    margin-bottom: 16px;
    border-radius: 12px;
    padding: 10px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
}

.dp-alert .material-icons {
    font-size: 18px;
}

.dp-alert-warning {
    background: #FFF8E1;
    color: #E65100;
}

.dp-alert-error {
    background: #FFEBEE;
    color: #C62828;
}

.dp-alert-info {
    background: #E3F2FD;
    color: #1565C0;
}

/* BOTTONI GRANDI AZIONE */

.dp-actions-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 18px;
    margin-bottom: 24px;
}

.dp-big-action {
    border: none;
    border-radius: 20px;
    padding: 18px 20px;
    text-align: left;
    background: #FFFFFF;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 10px;
    transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
}

.dp-big-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    background: #FFFDF8;
}

.dp-big-action.active {
    border: 1px solid #FB8C00;
    box-shadow: 0 4px 12px rgba(251,140,0,0.25);
    background: #FFF3E0;
}

.dp-big-icon-wrapper {
    width: 40px;
    height: 40px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.dp-action-deposito .dp-big-icon-wrapper {
    background: #E3F2FD;
}

.dp-action-ritiro .dp-big-icon-wrapper {
    background: #E8F5E9;
}

.dp-big-icon-wrapper .material-icons {
    font-size: 22px;
    color: #424242;
}

.dp-big-action h2 {
    font-size: 1rem;
    margin: 0;
    color: #202124;
}

.dp-big-action p {
    font-size: 0.85rem;
    margin: 0;
    color: #5f6368;
}

/* PANNELLI FORM */

.dp-panel-card {
    display: none;
    background: #FFFFFF;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    padding: 18px 20px 20px 20px;
    margin-bottom: 16px;
}

.dp-panel-card.active {
    display: block;
}

.dp-panel-title {
    font-size: 1.05rem;
    margin-bottom: 4px;
    color: #202124;
}

.dp-panel-subtitle {
    font-size: 0.85rem;
    color: #5f6368;
    margin-bottom: 16px;
}

/* FORM */

.dp-form {
    margin-top: 8px;
}

.dp-label {
    display: block;
    font-size: 0.8rem;
    margin-bottom: 4px;
    color: #5f6368;
}

.dp-input {
    width: 100%;
    border-radius: 10px;
    border: 1px solid #E0E0E0;
    padding: 10px 12px;
    font-size: 0.9rem;
    margin-bottom: 12px;
}

.dp-input:focus {
    outline: none;
    border-color: #FB8C00;
    box-shadow: 0 0 0 2px rgba(251,140,0,0.15);
}

.dp-btn-primary {
    width: 100%;
    border: none;
    border-radius: 999px;
    padding: 10px 18px;
    font-size: 0.9rem;
    font-weight: 600;
    background: #FB8C00;
    color: #FFFFFF;
    cursor: pointer;
    transition: background 0.15s ease, box-shadow 0.15s ease;
}

.dp-btn-primary:hover {
    background: #F57C00;
    box-shadow: 0 2px 6px rgba(0,0,0,0.18);
}

.dp-btn-primary.disabled,
.dp-btn-primary[disabled] {
    background: #FFCC80;
    cursor: not-allowed;
    box-shadow: none;
}

/* RESPONSIVE */

@media (max-width: 900px) {
    .dp-area-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }

    .dp-stats-row {
        grid-template-columns: 1fr;
    }

    .dp-actions-grid {
        grid-template-columns: 1fr;
    }
}
</file>

<file path="src/main/webapp/css/crea_segnalazione.css">
/* --- OVERRIDE/ADATTAMENTO LAYOUT --- */

/* Allarghiamo la card di destra rispetto al login standard */
.auth-card.wide {
    max-width: 850px; /* Pi√π largo per contenere le due colonne del form */
    width: 100%;
}

/* Titolo della pagina nel form */
.form-page-title {
    font-size: 2rem;
    color: #202124;
    margin-bottom: 10px;
    font-weight: 800;
}

.form-page-subtitle {
    color: #5F6368;
    margin-bottom: 30px;
    font-size: 1rem;
}

/* --- GRIGLIA DEL FORM --- */
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

/* Su mobile diventa una colonna sola */
@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
}

/* --- STILI INPUT MODERNI (Mantenuti) --- */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #5F6368;
    font-size: 0.9rem;
}

/* Input, Select, Textarea */
.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #EEEEEE;
    border-radius: 12px;
    font-size: 0.95rem;
    color: #333;
    background-color: #FAFAFA;
    transition: all 0.2s ease;
    font-family: inherit;
    box-sizing: border-box;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    border-color: #FB8C00;
    background-color: #FFFFFF;
    box-shadow: 0 0 0 4px rgba(251, 140, 0, 0.1);
    outline: none;
}

/* Textarea specifica */
.form-textarea {
    resize: vertical;
    min-height: 100px;
    line-height: 1.5;
}

/* Select custom arrow */
.form-select {
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%235F6368' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
    padding-right: 2.5rem;
    cursor: pointer;
}

/* --- FILE UPLOAD MODERNO --- */
.file-input-hidden {
    display: none;
}

.file-upload-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 20px;
    border: 2px dashed #E0E0E0;
    border-radius: 12px;
    background-color: #FAFAFA;
    color: #757575;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.file-upload-label:hover {
    border-color: #FB8C00;
    background-color: #FFF8E1;
    color: #E65100;
}

.file-upload-icon {
    font-size: 32px;
    color: #FB8C00;
}

#file-name-display {
    margin-top: 8px;
    font-size: 0.85rem;
    color: #2E7D32;
    font-weight: 600;
    text-align: center;
    min-height: 20px;
}

/* --- BOTTONE SUBMIT --- */
.btn-submit-modern {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #FB8C00, #EF6C00);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(239, 108, 0, 0.25);
    margin-top: 20px;
}

.btn-submit-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(239, 108, 0, 0.35);
    background: linear-gradient(135deg, #FFA726, #FB8C00);
}

/* Utilities */
.hidden { display: none; }
hr { border-color: #EEE; }

/* --- BOX DETTAGLI DROP-POINT --- */
.dp-details-box {
    margin-top: 15px;
    padding: 16px;
    background-color: #FFF8E1; /* Giallo chiaro */
    border: 1px solid #FFE0B2;
    border-radius: 12px;
    color: #333;
    font-size: 0.9rem;
    animation: fadeIn 0.3s ease-in-out;
}

.dp-details-title {
    font-weight: 700;
    color: #E65100; /* Arancione scuro */
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.dp-info-row {
    margin-bottom: 4px;
    display: flex;
    gap: 8px;
}

.dp-icon-small {
    font-size: 18px;
    color: #FB8C00;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
</file>

<file path="src/main/webapp/WEB-INF/jsp/profilo_drop_point.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="model.bean.DropPoint" %>
<%@ page import="model.bean.enums.StatoDropPoint" %>

<%
    DropPoint dropPoint = (DropPoint) session.getAttribute("dropPoint");
    if (dropPoint == null) {
        response.sendRedirect(request.getContextPath() + "/login");
        return;
    }

    // Stato DP
    StatoDropPoint stato = dropPoint.getStato();
    boolean isApproved = (stato == StatoDropPoint.APPROVATO);
    boolean isPending  = (stato == StatoDropPoint.IN_ATTESA);
    boolean isRejected = (stato == StatoDropPoint.RIFIUTATO);

    String statoLabel = "In attesa di approvazione";
    String statoClass = "status-pending";
    if (isApproved) {
        statoLabel = "Drop-Point approvato";
        statoClass = "status-ok";
    } else if (isRejected) {
        statoLabel = "Drop-Point rifiutato";
        statoClass = "status-rejected";
    }

    // Logo / immagine attivit√† (BLOB nel DB)
    boolean hasLogo = (dropPoint.getImmagine() != null &&
            dropPoint.getImmagine().length > 0);

    // URL della servlet che dovr√† streammare il logo del Drop-Point (da implementare lato server)
    String logoUrl = request.getContextPath() + "/drop-point-avatar?dpId=" + dropPoint.getId();
%>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilo Drop-Point - Foundly</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/index.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/profilo.css">
</head>
<body class="page-enter">

<jsp:include page="navbar.jsp" />

<main class="profile-main">
    <section class="profile-card">
        <!-- HEADER: logo + nome attivit√† + email + badge stato -->
        <div class="profile-header">
            <div class="profile-avatar-wrapper <%= hasLogo ? "has-avatar" : "" %>" id="avatarWrapper">
                <div class="profile-avatar-large">
                    <% if (hasLogo) { %>
                    <!-- Logo attivit√† servito da servlet che legge il BLOB dal DB -->
                    <img
                            src="<%= logoUrl %>"
                            alt="Logo Drop-Point"
                            id="profileAvatarImg">
                    <% } else { %>
                    <!-- Nessun logo: img nascosta, cerchio arancione gestito via CSS -->
                    <img
                            src="<%= logoUrl %>"
                            alt="Logo Drop-Point"
                            id="profileAvatarImg"
                            style="display:none;">
                    <% } %>
                </div>

                <!-- overlay rosso con cestino -->
                <div class="avatar-remove-overlay" id="avatarRemoveOverlay">
                    <span class="material-icons">delete</span>
                </div>

                <button type="button" class="avatar-edit-btn" id="avatarEditBtn" title="Cambia logo attivit√†">
                    <span class="material-icons">edit</span>
                </button>
            </div>

            <div>
                <h1 class="profile-title">
                    <%= dropPoint.getNomeAttivita() %>
                </h1>
                <p class="profile-subtitle">
                    <%= dropPoint.getEmail() %>
                </p>

                <div class="dp-area-status-badge <%= statoClass %>">
                    <span class="material-icons">
                        <%= isApproved ? "check_circle" : (isRejected ? "highlight_off" : "hourglass_top") %>
                    </span>
                    <span><%= statoLabel %></span>
                </div>
            </div>
        </div>

        <!-- BOX INFO VELOCI SU POSIZIONE E CONTATTI -->
        <div class="profile-badge-card">
            <div class="badge-medal">
                <span class="material-icons">location_on</span>
            </div>
            <div class="badge-texts">
                <span class="badge-label">Indirizzo</span>
                <span class="badge-name">
                    <%= dropPoint.getIndirizzo() %>,
                    <%= dropPoint.getCitta() %> (<%= dropPoint.getProvincia() %>)
                </span>
            </div>
        </div>

        <div class="profile-badge-card">
            <div class="badge-medal">
                <span class="material-icons">call</span>
            </div>
            <div class="badge-texts">
                <span class="badge-label">Telefono</span>
                <span class="badge-name">
                    <%= (dropPoint.getTelefono() != null && !dropPoint.getTelefono().isEmpty())
                            ? dropPoint.getTelefono()
                            : "Non specificato" %>
                </span>
            </div>
        </div>

        <div class="profile-badge-card">
            <div class="badge-medal">
                <span class="material-icons">schedule</span>
            </div>
            <div class="badge-texts">
                <span class="badge-label">Orari di apertura</span>
                <span class="badge-name">
                    <%= (dropPoint.getOrariApertura() != null && !dropPoint.getOrariApertura().isEmpty())
                            ? dropPoint.getOrariApertura()
                            : "Non specificati" %>
                </span>
            </div>
        </div>

        <!-- FORM PROFILO DROPPPOINT (dati anagrafici + logo) -->
        <form method="post"
              action="${pageContext.request.contextPath}/profilo-drop-point"
              id="profileEditForm"
              class="profile-edit-form"
              enctype="multipart/form-data">

            <!-- input file nascosto per il logo -->
            <input type="file"
                   name="logo"
                   id="avatarInput"
                   accept="image/*"
                   class="avatar-file-input">

            <!-- flag rimozione logo -->
            <input type="hidden"
                   name="removeLogo"
                   id="removeAvatarField"
                   value="false">

            <section class="profile-edit-card" id="profileEditCard">
                <div class="profile-edit-header">
                    <div class="profile-edit-header-left">
                        <span class="material-icons">storefront</span>
                        <span>Dati attivit√†</span>
                    </div>
                    <button type="button" class="edit-main-button" id="editToggleBtn">
                        <span class="material-icons">edit</span>
                        <span>Modifica</span>
                    </button>
                </div>

                <!-- NOME ATTIVIT√Ä -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Nome Attivit√†</span>
                        <span class="field-value view-mode" id="nomeAttivitaView">
                            <%= dropPoint.getNomeAttivita() %>
                        </span>
                        <input type="text"
                               class="field-input edit-mode"
                               name="nomeAttivita"
                               id="nomeAttivitaInput"
                               value="<%= dropPoint.getNomeAttivita() %>">
                    </div>
                </div>

                <!-- INDIRIZZO -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Indirizzo</span>
                        <span class="field-value view-mode" id="indirizzoView">
                            <%= dropPoint.getIndirizzo() %>
                        </span>
                        <input type="text"
                               class="field-input edit-mode"
                               name="indirizzo"
                               id="indirizzoInput"
                               value="<%= dropPoint.getIndirizzo() %>">
                    </div>
                </div>

                <!-- CITT√Ä -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Citt√†</span>
                        <span class="field-value view-mode" id="cittaView">
                            <%= dropPoint.getCitta() %>
                        </span>
                        <input type="text"
                               class="field-input edit-mode"
                               name="citta"
                               id="cittaInput"
                               value="<%= dropPoint.getCitta() %>">
                    </div>
                </div>

                <!-- PROVINCIA -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Provincia</span>
                        <span class="field-value view-mode" id="provinciaView">
                            <%= dropPoint.getProvincia() %>
                        </span>
                        <input type="text"
                               class="field-input edit-mode"
                               name="provincia"
                               id="provinciaInput"
                               value="<%= dropPoint.getProvincia() %>">
                    </div>
                </div>

                <!-- TELEFONO -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Telefono</span>
                        <span class="field-value view-mode" id="telefonoView">
                            <%= dropPoint.getTelefono() != null ? dropPoint.getTelefono() : "" %>
                        </span>
                        <input type="text"
                               class="field-input edit-mode"
                               name="telefono"
                               id="telefonoInput"
                               value="<%= dropPoint.getTelefono() != null ? dropPoint.getTelefono() : "" %>">
                    </div>
                </div>

                <!-- ORARI APERTURA -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Orari di apertura</span>
                        <span class="field-value view-mode" id="orariView">
                            <%= dropPoint.getOrariApertura() != null ? dropPoint.getOrariApertura() : "" %>
                        </span>
                        <textarea
                                class="field-input edit-mode"
                                name="orariApertura"
                                id="orariInput"><%= dropPoint.getOrariApertura() != null ? dropPoint.getOrariApertura() : "" %></textarea>
                    </div>
                </div>
            </section>

            <!-- PULSANTI SOTTO IL BOX, CENTRATI -->
            <div class="edit-actions">
                <button type="submit" class="btn-confirm">
                    Conferma Modifiche
                </button>
                <button type="button" class="btn-cancel" id="cancelEditBtn">
                    Annulla Modifiche
                </button>
            </div>
        </form>

        <div class="profile-grid">
            <!-- eventuali altri blocchi in futuro -->
        </div>
    </section>
</main>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        const editForm          = document.getElementById("profileEditForm");
        const editToggleBtn     = document.getElementById("editToggleBtn");
        const cancelEditBtn     = document.getElementById("cancelEditBtn");

        const avatarWrapper     = document.getElementById("avatarWrapper");
        const avatarEditBtn     = document.getElementById("avatarEditBtn");
        const avatarRemoveOv    = document.getElementById("avatarRemoveOverlay");
        const avatarInput       = document.getElementById("avatarInput");
        const avatarImg         = document.getElementById("profileAvatarImg");
        const removeAvatarField = document.getElementById("removeAvatarField");

        // attiva/disattiva modalit√† editing per i campi testo
        if (editForm && editToggleBtn && cancelEditBtn) {
            editToggleBtn.addEventListener("click", function () {
                editForm.classList.add("editing");
            });

            cancelEditBtn.addEventListener("click", function () {
                window.location.reload();
            });
        }

        // click sulla matita -> selezione file logo
        if (avatarEditBtn && avatarInput && avatarImg) {
            avatarEditBtn.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (!editForm.classList.contains("editing")) {
                    editForm.classList.add("editing");
                }
                avatarInput.click();
            });

            avatarInput.addEventListener("change", function () {
                const file = avatarInput.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (ev) {
                    avatarImg.src = ev.target.result;
                    avatarImg.style.display = "block";
                    if (avatarWrapper) {
                        avatarWrapper.classList.add("has-avatar");
                    }
                    if (removeAvatarField) {
                        removeAvatarField.value = "false"; // stiamo caricando una nuova immagine
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // click sul cestino -> rimozione logo (UI + flag per il server)
        if (avatarRemoveOv && avatarWrapper && avatarImg && avatarInput && removeAvatarField) {
            avatarRemoveOv.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (!editForm.classList.contains("editing")) {
                    editForm.classList.add("editing");
                }

                removeAvatarField.value = "true";
                avatarInput.value = "";
                avatarImg.src = "";
                avatarImg.style.display = "none";
                avatarWrapper.classList.remove("has-avatar");
            });
        }
    });
</script>


</body>
</html>
</file>

<file path=".gitignore">
target/
!.mvn/wrapper/maven-wrapper.jar
!**/src/main/**/target/
!**/src/test/**/target/

### IntelliJ IDEA ###
.idea/modules.xml
.idea/jarRepositories.xml
.idea/compiler.xml
.idea/libraries/
*.iws
*.iml
*.ipr
repomix-output.xml

### Eclipse ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/
build/
!**/src/main/**/build/
!**/src/test/**/build/

### VS Code ###
.vscode/

### Mac OS ###
.DS_Store
</file>

<file path="db/schemaDB.sql">
DROP DATABASE IF EXISTS defaultdb;
CREATE DATABASE defaultdb;
USE defaultdb;

-- 1. UTENTE
CREATE TABLE utente
(
    id                           BIGINT AUTO_INCREMENT PRIMARY KEY,
    username                     VARCHAR(50)  NOT NULL UNIQUE,
    email                        VARCHAR(100) NOT NULL UNIQUE,
    password_hash                VARCHAR(255) NOT NULL,
    nome                         VARCHAR(50)  NOT NULL,
    cognome                      VARCHAR(50)  NOT NULL,
    telefono                     VARCHAR(20),
    immagine_profilo             LONGBLOB,
    immagine_profilo_content_type VARCHAR(50),
    punteggio                    INT                                                      DEFAULT 0,
    ruolo                        ENUM ('UTENTE_BASE', 'ADMIN')                            DEFAULT 'UTENTE_BASE',
    badge                        ENUM ('OCCHIO_DI_FALCO', 'DETECTIVE', 'SHERLOCK_HOLMES') DEFAULT 'OCCHIO_DI_FALCO'
);

-- 2. DROP-POINT
CREATE TABLE drop_point
(
    id                       BIGINT AUTO_INCREMENT PRIMARY KEY,
    nome_attivita            VARCHAR(100) NOT NULL,
    email                    VARCHAR(100) NOT NULL UNIQUE,
    password_hash            VARCHAR(255) NOT NULL,
    indirizzo                VARCHAR(100) NOT NULL,
    citta                    VARCHAR(50)  NOT NULL,
    provincia                VARCHAR(50)  NOT NULL,
    telefono                 VARCHAR(20),
    orari_apertura           VARCHAR(255),
    descrizione              TEXT,
    immagine                 LONGBLOB,
    immagine_content_type    VARCHAR(50),
    latitudine               DOUBLE,
    longitudine              DOUBLE,
    ritiri_effettuati        INT                                          DEFAULT 0,
    stato                    ENUM ('IN_ATTESA', 'APPROVATO', 'RIFIUTATO') DEFAULT 'IN_ATTESA'
);

-- 3. SEGNALAZIONE (Tabella Padre - Abstract)
CREATE TABLE segnalazione
(
    id                 BIGINT AUTO_INCREMENT PRIMARY KEY,
    id_utente          BIGINT                      NOT NULL,
    titolo             VARCHAR(100)                NOT NULL,
    descrizione        TEXT                        NOT NULL,
    data_ritrovamento  DATETIME                    NOT NULL,
    luogo_ritrovamento VARCHAR(100)                NOT NULL,
    citta              VARCHAR(50)                 NOT NULL,
    provincia          VARCHAR(50)                 NOT NULL,
    latitudine         DOUBLE,
    longitudine        DOUBLE,
    immagine           LONGBLOB,
    immagine_content_type VARCHAR(50),
    domanda_verifica1  VARCHAR(255)                NOT NULL,
    domanda_verifica2  VARCHAR(255)                NOT NULL,
    data_pubblicazione DATETIME                                 DEFAULT CURRENT_TIMESTAMP,
    stato              ENUM ('APERTA', 'IN_CONSEGNA', 'CHIUSA') DEFAULT 'APERTA',
    tipo_segnalazione  ENUM ('OGGETTO', 'ANIMALE') NOT NULL,
    FOREIGN KEY (id_utente) REFERENCES utente (id) ON DELETE CASCADE
);

-- 4. SEGNALAZIONE OGGETTO (Estensione)
CREATE TABLE segnalazione_oggetto
(
    id_segnalazione   BIGINT PRIMARY KEY,
    categoria         ENUM ('DOCUMENTI', 'ELETTRONICA', 'PORTAFOGLI', 'CHIAVI', 'GIOIELLI', 'ABBIGLIAMENTO', 'ALTRO') NOT NULL,
    modalita_consegna ENUM ('DIRETTA', 'DROP_POINT')                                                                  NOT NULL,
    id_drop_point     BIGINT,
    FOREIGN KEY (id_segnalazione) REFERENCES segnalazione (id) ON DELETE CASCADE,
    FOREIGN KEY (id_drop_point) REFERENCES drop_point (id) ON DELETE SET NULL
);

-- 5. SEGNALAZIONE ANIMALE (Estensione)
CREATE TABLE segnalazione_animale
(
    id_segnalazione BIGINT PRIMARY KEY,
    specie          VARCHAR(50) NOT NULL,
    razza           VARCHAR(50),
    FOREIGN KEY (id_segnalazione) REFERENCES segnalazione (id) ON DELETE CASCADE
);

-- 6. RECLAMO (Secure Claim)
CREATE TABLE reclamo
(
    id                    BIGINT AUTO_INCREMENT PRIMARY KEY,
    id_segnalazione       BIGINT       NOT NULL,
    id_utente_richiedente BIGINT       NOT NULL,
    risposta_verifica1    VARCHAR(255) NOT NULL,
    risposta_verifica2    VARCHAR(255) NOT NULL,
    data_richiesta        DATETIME                                     DEFAULT CURRENT_TIMESTAMP,
    stato                 ENUM ('IN_ATTESA', 'ACCETTATO', 'RIFIUTATO') DEFAULT 'IN_ATTESA',

    codice_consegna       VARCHAR(6) UNIQUE,
    data_deposito         DATETIME,
    data_ritiro           DATETIME,
    conferma_finder       BOOLEAN                                      DEFAULT FALSE,
    conferma_owner        BOOLEAN                                      DEFAULT FALSE,

    FOREIGN KEY (id_segnalazione) REFERENCES segnalazione (id) ON DELETE CASCADE,
    FOREIGN KEY (id_utente_richiedente) REFERENCES utente (id) ON DELETE CASCADE
);
</file>

<file path="src/main/java/controller/AreaDropPointServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import model.bean.DropPoint;
import model.bean.enums.StatoDropPoint;
import model.service.DropPointService;

import java.io.IOException;

@WebServlet(name = "AreaDropPointServlet", value = "/area-drop-point")
public class AreaDropPointServlet extends HttpServlet {

    private final DropPointService dropPointService = new DropPointService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        DropPoint dp = (session != null) ? (DropPoint) session.getAttribute("dropPoint") : null;

        if (dp != null) {
            // ricarico dal DB per avere lo stato aggiornato
            DropPoint fromDb = dropPointService.trovaPerId(dp.getId());
            if (fromDb != null) {
                dp = fromDb;
                session.setAttribute("dropPoint", dp);
            }
        }

        request.setAttribute("dropPoint", dp);

        if (dp != null && dp.getStato() == StatoDropPoint.APPROVATO) {
            long id = dp.getId();
            request.setAttribute("depositiAttivi",      dropPointService.countDepositiAttivi(id));
            request.setAttribute("consegneCompletate", dropPointService.countConsegneCompletate(id));
            request.setAttribute("totaleOperazioni",   dropPointService.countTotaleOperazioni(id));
        } else {
            request.setAttribute("depositiAttivi", 0);
            request.setAttribute("consegneCompletate", 0);
            request.setAttribute("totaleOperazioni", 0);
        }

        request.getRequestDispatcher("/WEB-INF/jsp/area_drop_point.jsp")
                .forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        DropPoint dp = (session != null) ? (DropPoint) session.getAttribute("dropPoint") : null;

        if (dp == null) {
            response.sendRedirect(request.getContextPath() + "/login");
            return;
        }

        // ricarico stato
        dp = dropPointService.trovaPerId(dp.getId());
        session.setAttribute("dropPoint", dp);
        request.setAttribute("dropPoint", dp);

        String action = request.getParameter("action");
        String codice = request.getParameter("codice");

        if (dp.getStato() != StatoDropPoint.APPROVATO) {
            request.setAttribute("erroreGenerale", "Devi avere un Drop-Point approvato per effettuare operazioni.");
        } else if (action != null && codice != null && !codice.isBlank()) {

            if ("deposito".equals(action)) {
                boolean ok = dropPointService.registraDeposito(dp.getId(), codice.trim());
                if (ok) {
                    request.setAttribute("msgDeposito", "Deposito verificato.");
                } else {
                    request.setAttribute("msgDeposito", "Codice non valido o non associato a questo punto.");
                }
            } else if ("ritiro".equals(action)) {
                // QUI AVVIENE LA MAGIA: Chiama il service aggiornato che chiude la segnalazione nel DB
                boolean ok = dropPointService.registraRitiro(dp.getId(), codice.trim());
                if (ok) {
                    request.setAttribute("msgRitiro", "Ritiro confermato! Segnalazione chiusa e punti assegnati.");
                } else {
                    request.setAttribute("msgRitiro", "Errore: Codice non valido o segnalazione gi√† chiusa.");
                }
            }
        }

        long id = dp.getId();
        request.setAttribute("depositiAttivi",      dropPointService.countDepositiAttivi(id));
        request.setAttribute("consegneCompletate", dropPointService.countConsegneCompletate(id));
        request.setAttribute("totaleOperazioni",   dropPointService.countTotaleOperazioni(id));

        request.getRequestDispatcher("/WEB-INF/jsp/area_drop_point.jsp")
                .forward(request, response);
    }
}
</file>

<file path="src/main/java/controller/DettaglioSegnalazioneServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import model.bean.DropPoint;
import model.bean.Reclamo;
import model.bean.Segnalazione;
import model.bean.SegnalazioneOggetto;
import model.bean.Utente;
import model.bean.enums.ModalitaConsegna;
import model.dao.ReclamoDAO;
import model.dao.UtenteDAO;
import model.service.DropPointService;
import model.service.SegnalazioneService;

import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@WebServlet(name = "DettaglioSegnalazioneServlet", value = "/dettaglio-segnalazione")
public class DettaglioSegnalazioneServlet extends HttpServlet {

    private final SegnalazioneService segnalazioneService = new SegnalazioneService();
    private final ReclamoDAO reclamoDAO = new ReclamoDAO();
    private final UtenteDAO utenteDAO = new UtenteDAO();
    private final DropPointService dropPointService = new DropPointService();

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String idStr = request.getParameter("id");
        if (idStr == null) {
            response.sendRedirect("index");
            return;
        }

        long id = Long.parseLong(idStr);
        Segnalazione s = segnalazioneService.trovaPerId(id);

        if (s == null) {
            response.sendRedirect("index");
            return;
        }

        // --- Recupero Drop-Point per la consegna (se applicabile) ---
        if (s instanceof SegnalazioneOggetto) {
            SegnalazioneOggetto so = (SegnalazioneOggetto) s;
            if (so.getModalitaConsegna() == ModalitaConsegna.DROP_POINT && so.getIdDropPoint() != null) {
                DropPoint dp = dropPointService.trovaPerId(so.getIdDropPoint());
                request.setAttribute("dropPointRitiro", dp);
            }
        }

        HttpSession session = request.getSession(false);
        Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (utente != null) {
            if (utente.getId() == s.getIdUtente()) {
                // CASO PROPRIETARIO (Finder)
                List<Reclamo> reclami = reclamoDAO.doRetrieveBySegnalazione(s.getId());
                request.setAttribute("reclamiRicevuti", reclami);

                // --- NUOVO: Mappa per associare ID Utente -> Oggetto Utente (Richiedente) ---
                // Serve per mostrare i dati di chi ha fatto reclamo al Finder
                Map<Long, Utente> mappaRichiedenti = new HashMap<>();
                for (Reclamo r : reclami) {
                    if (!mappaRichiedenti.containsKey(r.getIdUtenteRichiedente())) {
                        Utente richiedente = utenteDAO.doRetrieveById(r.getIdUtenteRichiedente());
                        mappaRichiedenti.put(r.getIdUtenteRichiedente(), richiedente);
                    }
                }
                request.setAttribute("mappaRichiedenti", mappaRichiedenti);
                // ----------------------------------------------------------------------------

            } else {
                // CASO UTENTE CHE CERCA (Owner)
                Reclamo mioReclamo = reclamoDAO.doRetrieveBySegnalazioneAndUtente(s.getId(), utente.getId());
                request.setAttribute("mioReclamo", mioReclamo);
            }
        }

        // Recupero info del proprietario (Finder) per mostrarle all'Owner in caso di vittoria
        Utente proprietario = utenteDAO.doRetrieveById(s.getIdUtente());
        request.setAttribute("proprietarioSegnalazione", proprietario);

        request.setAttribute("segnalazione", s);
        request.getRequestDispatcher("/WEB-INF/jsp/dettaglio_segnalazione.jsp").forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String action = request.getParameter("action");
        String idStr = request.getParameter("idSegnalazione");

        if ("delete".equals(action) && idStr != null) {
            long id = Long.parseLong(idStr);
            HttpSession session = request.getSession(false);
            Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;
            Segnalazione s = segnalazioneService.trovaPerId(id);

            if (utente != null && s != null && s.getIdUtente() == utente.getId()) {
                segnalazioneService.eliminaSegnalazione(id);
            }
            response.sendRedirect("le-mie-segnalazioni");
        }
    }
}
</file>

<file path="src/main/java/controller/DropPointServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.bean.DropPoint;
import model.service.DropPointService;

import java.io.IOException;
import java.util.List;

@WebServlet(name = "DropPointServlet", value = "/drop-point")
public class DropPointServlet extends HttpServlet {

    private final DropPointService dropPointService = new DropPointService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        // Solo Drop-Point APPROVATI
        List<DropPoint> approvati = dropPointService.findAllApprovati();
        request.setAttribute("dropPoints", approvati);

        request.getRequestDispatcher("/WEB-INF/jsp/drop_point.jsp")
                .forward(request, response);
    }
}
</file>

<file path="src/main/java/controller/LogoutServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;

import java.io.IOException;

@WebServlet(name = "LogoutServlet", value = "/logout")
public class LogoutServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        if (session != null) {
            // escono sia utente che drop-point
            session.invalidate();
        }

        // dopo il logout torno alla home pubblica
        response.sendRedirect(request.getContextPath() + "/index");
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {
        doGet(request, response);
    }
}
</file>

<file path="src/main/java/controller/RegistrazioneDropPointServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.service.DropPointService;
import java.io.IOException;

@WebServlet(name = "RegistrazioneDropPointServlet", value = "/registrazione-droppoint")
public class RegistrazioneDropPointServlet extends HttpServlet {

    private final DropPointService dpService = new DropPointService();

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        request.getRequestDispatcher("/WEB-INF/jsp/registrazione_droppoint.jsp").forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String nomeAttivita = request.getParameter("nomeAttivita");
        String email = request.getParameter("email");
        String password = request.getParameter("password");
        String indirizzo = request.getParameter("indirizzo");
        String citta = request.getParameter("citta");
        String provincia = request.getParameter("provincia");
        String telefono = request.getParameter("telefono");
        String orari = request.getParameter("orari");

        String latStr = request.getParameter("latitudine");
        String lonStr = request.getParameter("longitudine");

        Double latitudine = null;
        Double longitudine = null;

        try {
            if (latStr != null && !latStr.isEmpty()) latitudine = Double.parseDouble(latStr);
            if (lonStr != null && !lonStr.isEmpty()) longitudine = Double.parseDouble(lonStr);
        } catch (NumberFormatException e) {
            // Ignora
        }

        if (email == null || password == null || nomeAttivita == null || latitudine == null || longitudine == null) {
            request.setAttribute("errore", "Campi obbligatori mancanti o posizione mappa non selezionata.");
            request.getRequestDispatcher("/WEB-INF/jsp/registrazione_droppoint.jsp").forward(request, response);
            return;
        }

        // CORRETTO: Ordine parametri allineato col Service aggiornato (Lat, Lon)
        boolean successo = dpService.registraDropPoint(nomeAttivita, email, password, indirizzo, citta, provincia, telefono, orari, latitudine, longitudine);

        if (successo) {
            response.sendRedirect("login?registrazione=attesa_approvazione");
        } else {
            request.setAttribute("errore", "Email gi√† registrata per un altro Drop-Point.");
            request.getRequestDispatcher("/WEB-INF/jsp/registrazione_droppoint.jsp").forward(request, response);
        }
    }
}
</file>

<file path="src/main/java/model/bean/Segnalazione.java">
package model.bean;

import model.bean.enums.StatoSegnalazione;
import model.bean.enums.TipoSegnalazione;

import java.sql.Timestamp;

public abstract class Segnalazione {
    private long id;
    private long idUtente;
    private String titolo;
    private String descrizione;
    private Timestamp dataRitrovamento;
    private String luogoRitrovamento;
    private String citta;
    private String provincia;
    private Double latitudine;
    private Double longitudine;

    // Ora BLOB nel DB ‚Üí byte[] nel model
    private byte[] immagine;
    private String immagineContentType;

    private String domandaVerifica1;
    private String domandaVerifica2;
    private Timestamp dataPubblicazione;
    private StatoSegnalazione stato;
    private TipoSegnalazione tipoSegnalazione;

    public Segnalazione() {}

    // Getters e Setters
    public long getId() { return id; }
    public void setId(long id) { this.id = id; }

    public long getIdUtente() { return idUtente; }
    public void setIdUtente(long idUtente) { this.idUtente = idUtente; }

    public String getTitolo() { return titolo; }
    public void setTitolo(String titolo) { this.titolo = titolo; }

    public String getDescrizione() { return descrizione; }
    public void setDescrizione(String descrizione) { this.descrizione = descrizione; }

    public Timestamp getDataRitrovamento() { return dataRitrovamento; }
    public void setDataRitrovamento(Timestamp dataRitrovamento) {
        this.dataRitrovamento = dataRitrovamento;
    }

    public String getLuogoRitrovamento() { return luogoRitrovamento; }
    public void setLuogoRitrovamento(String luogoRitrovamento) {
        this.luogoRitrovamento = luogoRitrovamento;
    }

    public String getCitta() { return citta; }
    public void setCitta(String citta) { this.citta = citta; }

    public String getProvincia() { return provincia; }
    public void setProvincia(String provincia) { this.provincia = provincia; }

    public Double getLatitudine() { return latitudine; }
    public void setLatitudine(Double latitudine) { this.latitudine = latitudine; }

    public Double getLongitudine() { return longitudine; }
    public void setLongitudine(Double longitudine) { this.longitudine = longitudine; }

    public byte[] getImmagine() { return immagine; }
    public void setImmagine(byte[] immagine) { this.immagine = immagine; }

    public String getImmagineContentType() { return immagineContentType; }
    public void setImmagineContentType(String immagineContentType) {
        this.immagineContentType = immagineContentType;
    }

    public String getDomandaVerifica1() { return domandaVerifica1; }
    public void setDomandaVerifica1(String domandaVerifica1) {
        this.domandaVerifica1 = domandaVerifica1;
    }

    public String getDomandaVerifica2() { return domandaVerifica2; }
    public void setDomandaVerifica2(String domandaVerifica2) {
        this.domandaVerifica2 = domandaVerifica2;
    }

    public Timestamp getDataPubblicazione() { return dataPubblicazione; }
    public void setDataPubblicazione(Timestamp dataPubblicazione) {
        this.dataPubblicazione = dataPubblicazione;
    }

    public StatoSegnalazione getStato() { return stato; }
    public void setStato(StatoSegnalazione stato) { this.stato = stato; }

    public TipoSegnalazione getTipoSegnalazione() { return tipoSegnalazione; }
    public void setTipoSegnalazione(TipoSegnalazione tipoSegnalazione) {
        this.tipoSegnalazione = tipoSegnalazione;
    }
}
</file>

<file path="src/main/java/model/bean/Utente.java">
package model.bean;

import model.bean.enums.Ruolo;

public class Utente {
    private long id;
    private String username;
    private String email;
    private String passwordHash;
    private String nome;
    private String cognome;
    private String telefono;

    // Ora BLOB nel DB ‚Üí byte[] nel model
    private byte[] immagineProfilo;
    private String immagineProfiloContentType;

    private int punteggio;
    private Ruolo ruolo;
    private String badge;

    public Utente() {}

    // Getters e Setters
    public long getId() { return id; }
    public void setId(long id) { this.id = id; }

    public String getUsername() { return username; }
    public void setUsername(String username) { this.username = username; }

    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }

    public String getPasswordHash() { return passwordHash; }
    public void setPasswordHash(String passwordHash) { this.passwordHash = passwordHash; }

    public String getNome() { return nome; }
    public void setNome(String nome) { this.nome = nome; }

    public String getCognome() { return cognome; }
    public void setCognome(String cognome) { this.cognome = cognome; }

    public String getTelefono() { return telefono; }
    public void setTelefono(String telefono) { this.telefono = telefono; }

    public byte[] getImmagineProfilo() { return immagineProfilo; }
    public void setImmagineProfilo(byte[] immagineProfilo) { this.immagineProfilo = immagineProfilo; }

    public String getImmagineProfiloContentType() { return immagineProfiloContentType; }
    public void setImmagineProfiloContentType(String immagineProfiloContentType) {
        this.immagineProfiloContentType = immagineProfiloContentType;
    }

    public int getPunteggio() { return punteggio; }
    public void setPunteggio(int punteggio) { this.punteggio = punteggio; }

    public Ruolo getRuolo() { return ruolo; }
    public void setRuolo(Ruolo ruolo) { this.ruolo = ruolo; }

    public String getBadge() { return badge; }
    public void setBadge(String badge) { this.badge = badge; }
}
</file>

<file path="src/main/webapp/css/classifica.css">
/* Layout Generale */
.classifica-main {
    max-width: 1100px;
    margin: 40px auto 80px;
    padding: 0 24px;
    font-family: 'Roboto', sans-serif;
}

/* Header */
.classifica-header {
    text-align: center;
    margin-bottom: 50px;
}

.classifica-header h1 {
    font-size: 2.5rem;
    font-weight: 900;
    color: #202124;
    margin-bottom: 8px;
    /* Gradiente sul testo del titolo */
    background: linear-gradient(45deg, #FF6F00, #FFAB00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.classifica-header p {
    color: #5F6368;
    font-size: 1.15rem;
}

/* --- PODIO (TOP 3) --- */
.podium-container {
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 15px; /* Spazio tra i gradini */
    margin-bottom: 60px;
    min-height: 350px;
}

.podium-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    width: 220px;
    transition: transform 0.3s ease;
}

.podium-step:hover {
    transform: translateY(-10px); /* Effetto hover */
}

/* Base del podio */
.podium-base {
    width: 100%;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 10px;
    font-size: 4rem;
    font-weight: 900;
    color: rgba(255,255,255,0.4);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

/* Stili specifici per posizione */
/* ORO (1¬∞) */
.step-gold { z-index: 2; margin-bottom: 20px; } /* Pi√π in alto */
.step-gold .podium-base {
    height: 220px;
    background: linear-gradient(135deg, #FFB300 0%, #FF6F00 100%);
    box-shadow: 0 10px 30px rgba(255, 111, 0, 0.4);
}
.step-gold .podium-avatar { border: 4px solid #FFD54F; }
.crown-icon { font-size: 3rem; margin-bottom: -10px; z-index: 3; animation: float 3s infinite ease-in-out; }

/* ARGENTO (2¬∞) */
.step-silver { order: -1; } /* Mette il 2¬∞ a sinistra */
.step-silver .podium-base {
    height: 160px;
    background: linear-gradient(135deg, #E0E0E0 0%, #BDBDBD 100%);
}
.step-silver .podium-avatar { border: 4px solid #F5F5F5; }
.medal-icon { font-size: 2.5rem; margin-bottom: 5px; }

/* BRONZO (3¬∞) */
.step-bronze .podium-base {
    height: 130px;
    background: linear-gradient(135deg, #D7CCC8 0%, #8D6E63 100%);
}
.step-bronze .podium-avatar { border: 4px solid #EFEBE9; }

/* Info Utente sul Podio */
.podium-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: #FFF;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    background: #FFF;
}

.initials {
    font-size: 1.8rem;
    font-weight: 700;
    color: #FF6F00;
}

.podium-info {
    text-align: center;
    margin-bottom: 10px;
    background-color: rgba(255,255,255,0.9);
    padding: 10px 15px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    width: 100%;
}

.podium-name {
    display: block;
    font-weight: 700;
    font-size: 1rem;
    color: #202124;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.podium-points {
    display: block;
    font-weight: 900;
    color: #E65100;
    font-size: 1.1rem;
}

.podium-badge {
    display: inline-block;
    font-size: 0.75rem;
    background: #FFF8E1;
    color: #FF8F00;
    padding: 2px 8px;
    border-radius: 10px;
    margin: 4px 0;
    font-weight: 600;
}

/* --- LISTA CLASSIFICA (Table) --- */
.ranking-list-section h3 {
    font-size: 1.5rem;
    color: #424242;
    margin-bottom: 20px;
    padding-left: 10px;
    border-left: 5px solid #FF6F00;
}

.table-card {
    background: #FFF;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    overflow: hidden;
    border: 1px solid #F0F0F0;
}

.ranking-table {
    width: 100%;
    border-collapse: collapse;
}

.ranking-table th {
    background-color: #FAFAFA;
    color: #9E9E9E;
    font-size: 0.8rem;
    text-transform: uppercase;
    font-weight: 700;
    padding: 15px 20px;
    text-align: left;
}

.ranking-table td {
    padding: 15px 20px;
    border-bottom: 1px solid #F5F5F5;
    vertical-align: middle;
}

.ranking-table tr:last-child td { border-bottom: none; }
.ranking-table tr:hover { background-color: #FFFDE7; }

/* Colonne Tabella */
.col-rank { width: 60px; text-align: center; font-weight: 700; color: #BDBDBD; }
.rank-circle {
    display: inline-block;
    width: 28px;
    height: 28px;
    line-height: 28px;
    background: #F5F5F5;
    border-radius: 50%;
    font-size: 0.9rem;
    color: #616161;
}

.col-user { width: 40%; }
.user-row-info { display: flex; align-items: center; gap: 12px; }
.mini-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #FFCC80, #FFAB00);
    color: #FFF;
    font-weight: 700;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1rem;
}
.u-name { display: block; font-weight: 600; color: #202124; }
.u-username { font-size: 0.85rem; color: #9E9E9E; }

.col-points { text-align: right; font-weight: 700; color: #E65100; font-size: 1.1rem; }

/* Badges Tabella */
.badge-tag {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}
.bg-gold { background: #FFF8E1; color: #FF8F00; }
.bg-silver { background: #ECEFF1; color: #546E7A; }
.bg-bronze { background: #EFEBE9; color: #6D4C41; }
.bg-gray { background: #F5F5F5; color: #9E9E9E; }

/* Evidenzia Utente Loggato */
.highlight-me {
    background-color: #FFF3E0 !important;
    border-left: 4px solid #FF6F00;
}
/* Stile Immagini nel Podio */
.podium-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover; /* Mantiene le proporzioni riempiendo il cerchio */
}

.podium-placeholder {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-color: #FFF;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #FF6F00;
    font-size: 1.8rem;
}

/* Stile Immagini nella Lista */
.mini-avatar-img {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.mini-avatar-placeholder {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #FFCC80, #FFAB00);
    color: #FFF;
    font-weight: 700;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1rem;
}

/* Animazione Corona */
@keyframes float {
    0% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-8px) rotate(5deg); }
    100% { transform: translateY(0px) rotate(0deg); }
}

/* Responsive */
@media (max-width: 768px) {
    .podium-container {
        flex-direction: column;
        align-items: center;
        gap: 30px;
    }
    .podium-step { width: 100%; max-width: 300px; }
    .step-silver { order: 0; } /* Reset ordine su mobile */
    .podium-base { height: 60px !important; border-radius: 12px; }

    .col-badge { display: none; }
}
</file>

<file path="src/main/webapp/css/dettaglio_segnalazione.css">
/* --- LAYOUT GENERALE --- */
:root {
    --primary-orange: #FB8C00;
    --primary-dark: #E65100;
    --bg-light: #F5F7FA;
    --text-dark: #202124;
    --text-grey: #5F6368;
    --success-green: #2E7D32;
    --bg-green-light: #E8F5E9;
    --error-red: #C62828;
    --bg-red-light: #FFEBEE;
    --purple-main: #7B1FA2;
    --bg-purple-light: #F3E5F5;
    --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

body {
    background-color: var(--bg-light);
}

.local-wrapper {
    max-width: 1150px;
    margin: 30px auto 60px auto;
    padding: 0 20px;
}

.local-back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--text-grey);
    text-decoration: none;
    font-weight: 500;
    margin-bottom: 24px;
    transition: color 0.2s;
}
.local-back-link:hover { color: var(--primary-orange); }

/* --- GRIGLIA PRINCIPALE --- */
.local-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 32px;
    align-items: start;
}

@media (max-width: 900px) {
    .local-grid { grid-template-columns: 1fr; }
}

/* --- CARD GENERICHE --- */
.local-card, .sidebar-card {
    background: white;
    border-radius: 16px;
    border: 1px solid #E0E0E0;
    overflow: hidden;
    box-shadow: var(--card-shadow);
}

/* --- COLONNA SINISTRA (HERO) --- */
.hero-card { border: none; }

.image-container {
    position: relative;
    width: 100%;
    height: 400px;
    background-color: #eee;
}

.local-hero-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.local-hero-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #bdbdbd;
}
.local-hero-placeholder span { font-size: 80px; }

/* Status Badge sovrapposto all'immagine */
.status-overlay {
    position: absolute;
    top: 20px;
    left: 20px;
}

.status-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.status-open { background: white; color: var(--success-green); }
.status-closed { background: #424242; color: white; }

/* Content Area */
.local-content { padding: 32px; }

.header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.category-tags { display: flex; gap: 8px; }

.tag-pill {
    background: var(--bg-light);
    color: var(--text-dark);
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: capitalize;
}
.tag-pill.outline { border: 1px solid #ddd; background: transparent; }

.date-text { font-size: 0.85rem; color: var(--text-grey); }

.local-title {
    font-size: 2rem;
    color: var(--text-dark);
    margin: 0 0 20px 0;
    line-height: 1.2;
}

.local-text {
    font-size: 1.05rem;
    color: #4a4a4a;
    line-height: 1.7;
}

/* Info Grid (Data e Luogo) */
.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 30px 0;
    padding: 20px 0;
    border-top: 1px solid #eee;
    border-bottom: 1px solid #eee;
}

.info-item {
    display: flex;
    gap: 12px;
}

.info-item .material-icons {
    color: var(--primary-orange);
    background: #FFF3E0;
    padding: 8px;
    border-radius: 10px;
    height: 40px;
    width: 40px;
    display: flex; align-items: center; justify-content: center;
}

.info-item .label {
    font-size: 0.8rem;
    color: var(--text-grey);
    text-transform: uppercase;
    font-weight: 600;
    display: block;
    margin-bottom: 2px;
}

.info-item .value { font-weight: 600; color: var(--text-dark); font-size: 1rem; }
.info-item .sub-value { display: block; font-size: 0.85rem; color: var(--text-grey); }

/* Mini Map */
.mini-map {
    width: 100%;
    height: 200px;
    border-radius: 12px;
    margin-bottom: 24px;
    border: 1px solid #ddd;
    z-index: 1; /* Fix per leaflet */
}

/* Box Modalit√† Consegna */
.delivery-box {
    display: flex;
    gap: 16px;
    padding: 20px;
    border-radius: 12px;
    align-items: center;
}

.delivery-box.purple { background: var(--bg-purple-light); border: 1px solid #E1BEE7; }
.delivery-box.purple .icon-box { background: white; color: var(--purple-main); }
.delivery-box.purple h4 { color: var(--purple-main); }

.delivery-box.green { background: var(--bg-green-light); border: 1px solid #C8E6C9; }
.delivery-box.green .icon-box { background: white; color: var(--success-green); }
.delivery-box.green h4 { color: var(--success-green); }

.delivery-box .icon-box {
    width: 48px; height: 48px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
.delivery-box h4 { margin: 0 0 4px 0; font-size: 1rem; }
.delivery-box p { margin: 0; font-size: 0.9rem; opacity: 0.9; }

/* --- SIDEBAR (COLONNA DESTRA) --- */
.sidebar { position: sticky; top: 100px; }

.sidebar-card { padding: 24px; }
.sidebar-title { font-size: 1.1rem; margin-bottom: 16px; color: var(--text-dark); }

/* Bottoni */
.btn-primary {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-dark));
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    text-decoration: none;
    transition: transform 0.2s;
    display: inline-block;
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(251, 140, 0, 0.3); }
.full-width { width: 100%; display: block; }

/* Form Reclamo */
.claim-intro { font-size: 0.9rem; color: var(--text-grey); margin-bottom: 20px; }
.q-label { font-weight: 600; font-size: 0.9rem; margin-bottom: 6px; display: block; color: var(--text-dark); }
.form-input {
    width: 100%; padding: 10px; border: 2px solid #eee;
    border-radius: 8px; margin-bottom: 16px; transition: border 0.2s;
}
.form-input:focus { border-color: var(--primary-orange); outline: none; }

/* Stati Reclamo (Non-Owner) */
.status-box {
    text-align: center; padding: 20px; border-radius: 12px;
}
.status-box .material-icons { font-size: 32px; margin-bottom: 8px; }
.status-box h4 { margin: 0 0 6px 0; }
.status-box p { font-size: 0.9rem; margin: 0; }

.status-box.pending { background: #FFF3E0; color: #E65100; border: 1px solid #FFE0B2; }
.status-box.rejected { background: #FFEBEE; color: #C62828; border: 1px solid #FFCDD2; }

/* Winner Box */
.status-box.winner {
    background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
    border: 2px dashed var(--success-green);
    color: var(--success-green);
}
.confetti-icon { font-size: 40px; margin-bottom: 10px; }
.code-display {
    background: white; padding: 10px; border-radius: 8px;
    margin: 15px 0; border: 1px solid #A5D6A7;
}
.the-code {
    font-family: 'Courier New', monospace; font-size: 1.8rem;
    font-weight: 800; letter-spacing: 3px; color: #1B5E20;
}

/* --- OWNER VIEW (Gestione) --- */
.owner-header {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 20px; color: var(--primary-dark);
}

.claims-section h4 { font-size: 0.9rem; color: var(--text-grey); margin-bottom: 12px; }

.empty-claims {
    text-align: center; padding: 20px; color: #ccc;
    border: 1px dashed #ddd; border-radius: 8px;
}
.empty-claims .material-icons { font-size: 32px; margin-bottom: 4px; }

.claim-card {
    background: #FAFAFA; border: 1px solid #eee;
    padding: 12px; border-radius: 8px; margin-bottom: 12px;
}
.claim-header {
    display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px;
}
.date { color: var(--text-grey); font-weight: 400; }

.qa-pair { margin-bottom: 4px; font-size: 0.9rem; }
.qa-pair small { font-weight: 700; color: var(--text-grey); margin-right: 4px; }

/* ================================================= */
/* === BOTTONI ACCETTA/RIFIUTA (Allineamento Flex) === */
/* ================================================= */

.action-buttons-row {
    display: flex;       /* Forza i bottoni sulla stessa riga */
    gap: 10px;           /* Spazio tra i bottoni */
    margin-top: 12px;
    width: 100%;
}

.action-form {
    flex: 1;             /* Ogni form occupa il 50% dello spazio */
    margin: 0;           /* Rimuove margini default */
}

/* Bottone ACCETTA (Verde) */
.btn-accept {
    width: 100%;
    background-color: var(--success-green);
    color: white;
    border: none;
    padding: 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}

.btn-accept:hover {
    background-color: #1B5E20;
}

/* Bottone RIFIUTA (Rosso) */
.btn-reject {
    width: 100%;
    background-color: #FFEBEE;
    color: #C62828;
    border: 1px solid #FFCDD2;
    padding: 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}

.btn-reject:hover {
    background-color: #FFCDD2;
    border-color: #E57373;
}

/* ================================================= */

.accepted-badge {
    margin-top: 8px; color: var(--success-green); font-weight: 700;
    font-size: 0.9rem; display: flex; flex-direction: column; align-items: center;
}

.rejected-badge {
    margin-top: 8px; color: var(--error-red); font-weight: 700;
    font-size: 0.9rem; text-align: center;
}
.rejected-badge span { margin-right: 4px; }

.danger-zone {
    margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;
}
.btn-danger {
    background: white; border: 1px solid #e57373; color: #d32f2f;
    padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    transition: all 0.2s;
}
.btn-danger:hover { background: #FFEBEE; }

/* --- STILE BOX RITIRO DROP-POINT --- */
.dp-pickup-info {
    margin-top: 20px;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 12px;
    padding: 15px;
    text-align: left;
    border: 1px solid rgba(46, 125, 50, 0.3);
}

.pickup-header {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--success-green);
    margin-bottom: 8px;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.dp-name {
    font-size: 1.1rem;
    font-weight: 800;
    color: #1B5E20; /* Verde scuro */
    margin-bottom: 2px;
}

.dp-address {
    font-size: 0.95rem;
    color: #388E3C;
    margin-bottom: 8px;
}

.dp-hours {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 0.85rem;
    color: #558B2F;
    background: rgba(232, 245, 233, 0.7);
    padding: 4px 8px;
    border-radius: 6px;
    margin-bottom: 12px;
}

.dp-hours .material-icons { font-size: 14px; }

.btn-map-nav {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background-color: var(--success-green);
    color: white;
    text-decoration: none;
    padding: 10px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: background-color 0.2s, transform 0.1s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.btn-map-nav:hover {
    background-color: #1B5E20;
    transform: translateY(-1px);
}

/* Box per segnalazione chiusa vista dagli altri utenti */
.status-box.closed-public {
    background-color: #F5F5F5;
    border: 1px solid #BDBDBD;
    color: #616161;
}

.status-box.closed-public .material-icons {
    color: #757575;
    font-size: 36px;
}

.status-box.closed-public h4 {
    color: #424242;
    margin-top: 8px;
}

/* --- BOX CONTATTI (Scambio diretto) --- */
.contact-card {
    background-color: #FFFFFF;
    border: 1px solid #E0E0E0;
    border-radius: 8px;
    padding: 12px;
    margin-top: 15px;
    text-align: left;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.contact-card.owner-view {
    margin-top: 10px;
    background-color: #F1F8E9; /* Verde chiaro per distinguere */
    border-color: #C5E1A5;
}

.contact-header {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--primary-dark);
    display: flex;
    align-items: center;
    gap: 5px;
    margin-bottom: 8px;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
}

.contact-row {
    font-size: 0.9rem;
    margin-bottom: 4px;
    color: var(--text-dark);
    word-break: break-all;
}

.contact-row a {
    color: var(--primary-orange);
    text-decoration: none;
    font-weight: 500;
}

.contact-row a:hover {
    text-decoration: underline;
}

.contact-note {
    font-size: 0.8rem;
    color: var(--text-grey);
    font-style: italic;
    margin-top: 8px;
}
</file>

<file path="src/main/webapp/css/drop_point.css">
.dp-main {
    max-width: 1200px;
    margin: 24px auto 40px;
    padding: 0 24px;
    font-family: 'Roboto', sans-serif;
}

/* Header card */
.dp-header-card {
    background: #ffffff;
    border-radius: 18px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    padding: 20px 24px 18px;
    margin-bottom: 16px;
}

.dp-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.dp-title {
    font-size: 1.6rem;
    margin-bottom: 4px;
    color: #202124;
}

.dp-subtitle {
    font-size: 0.9rem;
    color: #5f6368;
}

.dp-register-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;

    padding: 10px 22px;
    border-radius: 999px;
    border: none;

    background: #FF7043;          /* arancione */
    color: #FFFFFF;
    font-weight: 500;
    font-size: 0.9rem;

    text-decoration: none;        /* <--- niente sottolineatura */
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
}

.dp-register-btn:hover {
    background: #F4511E;
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    transform: translateY(-1px);
    text-decoration: none;        /* <--- evita underline anche in hover */
}

.dp-register-btn .material-icons {
    font-size: 18px;
}

/* search bar */
.dp-search-wrapper {
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    border-radius: 999px;
    background: #f5f5f5;
    padding: 8px 14px;
}

.dp-search-icon {
    font-size: 20px;
    color: #9e9e9e;
}

.dp-search-input {
    border: none;
    background: transparent;
    outline: none;
    font-size: 0.9rem;
    width: 100%;
}

/* info card */
.dp-info-card {
    margin-top: 16px;
    background: #ffffff;
    border-radius: 18px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    padding: 14px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.dp-info-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.dp-info-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: #fff3e0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.dp-info-icon .material-icons {
    color: #fb8c00;
    font-size: 22px;
}

.dp-info-text {
    display: flex;
    flex-direction: column;
}

.dp-info-label {
    font-size: 0.85rem;
    color: #757575;
}

.dp-info-value {
    font-size: 1.2rem;
    font-weight: 700;
    color: #fb8c00;
}

/* toggle mappa/elenco */
.dp-view-toggle {
    display: inline-flex;
    background: #f5f5f5;
    border-radius: 999px;
    padding: 2px;
}

.dp-toggle-btn {
    border: none;
    background: transparent;
    padding: 6px 14px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    color: #5f6368;
    cursor: pointer;
}

.dp-toggle-btn .material-icons {
    font-size: 18px;
}

.dp-toggle-btn-active {
    background: #ffffff;
    color: #fb8c00;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

/* map + list card */
.dp-map-card {
    margin-top: 16px;
    background: #ffffff;
    border-radius: 18px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    padding: 10px;
}

.dp-map-container {
    width: 100%;
    height: 520px;
    border-radius: 12px;
    overflow: hidden;
}

.dp-list-container {
    display: none; /* default: nascosta, attiva solo in modalit√† Elenco */
    max-height: 520px;
    overflow-y: auto;
    padding: 6px 4px 2px;
}

/* lista Drop-Point */
.dp-list-item {
    border-radius: 12px;
    border: 1px solid #f1f1f1;
    padding: 10px 12px;
    margin-bottom: 8px;
    background: #fffdf9;
}

.dp-list-title {
    font-size: 1rem;
    font-weight: 600;
    color: #202124;
    margin-bottom: 4px;
}

.dp-list-address {
    font-size: 0.85rem;
    color: #5f6368;
    margin-bottom: 4px;
}

.dp-list-phone,
.dp-list-hours {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: #5f6368;
}

.dp-list-phone .material-icons,
.dp-list-hours .material-icons {
    font-size: 16px;
    color: #fb8c00;
}

.dp-empty {
    font-size: 0.9rem;
    color: #757575;
    padding: 12px;
}

/* responsive */
@media (max-width: 768px) {
    .dp-header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }

    .dp-info-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }

    .dp-view-toggle {
        align-self: stretch;
        justify-content: flex-end;
    }

    .dp-map-container,
    .dp-list-container {
        height: 420px;
    }
}
.dp-list-item {
    display: flex;
    gap: 16px;
    align-items: flex-start;
}

.dp-list-thumb {
    flex-shrink: 0;
    width: 64px;
    height: 64px;
    border-radius: 16px;
    overflow: hidden;
    background: #FFF5E6;
    display: flex;
    align-items: center;
    justify-content: center;
}

.dp-list-thumb-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.dp-list-thumb-placeholder .material-icons {
    font-size: 32px;
    color: #FB8C00;
}

.dp-list-content {
    flex: 1;
}
</file>

<file path="src/main/webapp/css/profilo.css">
/* Layout generale della pagina profilo */

.profile-main {
    max-width: 900px;
    margin: 32px auto 40px;
    padding: 0 24px;
}

/* CARD PROFILO */

.profile-card {
    background: linear-gradient(135deg, #FFF8E1 0%, #FFFFFF 45%, #FFF3E0 100%);
    border-radius: 24px;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.14);
    padding: 24px 24px 28px;
    border: 1px solid rgba(255, 183, 77, 0.45);
}

/* Header con avatar grande + nome & email */

.profile-header {
    display: flex;
    align-items: center;
    gap: 18px;
    margin-bottom: 20px;
}

/* wrapper avatar + bottone matita */

.profile-avatar-wrapper {
    position: relative;
    display: inline-block;
}

.profile-avatar-large {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: linear-gradient(135deg, #FFE0B2, #FB8C00);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    overflow: hidden;
}

.profile-avatar-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* matita in alto a destra */

.avatar-edit-btn {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: none;
    background: #FFFFFF;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
}

.avatar-edit-btn .material-icons {
    font-size: 16px;
    color: #FB8C00;
}

.avatar-edit-btn:hover {
    background-color: #FFF3E0;
}

.avatar-file-input {
    display: none;
}

.profile-title {
    font-size: 1.4rem;
    font-weight: 600;
    color: #202124;
    margin-bottom: 4px;
}

.profile-subtitle {
    font-size: 0.9rem;
    color: #5F6368;
}

/* BOX PUNTI: pi√π evidente */

.profile-points-box {
    margin: 12px 0 18px;
    padding: 14px 20px;
    border-radius: 18px;
    background: linear-gradient(135deg, #FF9800 0%, #FB8C00 40%, #EF6C00 90%);
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 10px 26px rgba(244, 143, 0, 0.5);
}

.points-left {
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.points-icon {
    font-size: 24px;
    color: #FFFDE7;
    text-shadow: 0 2px 5px rgba(0,0,0,0.35);
}

.points-label-big {
    font-size: 1.05rem;
    font-weight: 700;
    color: #FFFFFF;
    text-transform: uppercase;
    letter-spacing: 0.12em;
}

.points-right {
    display: flex;
    align-items: center;
}

.points-value-big {
    font-size: 3rem;
    font-weight: 800;
    color: #FFFFFF;
    text-shadow: 0 3px 8px rgba(0,0,0,0.4);
}

/* BADGE: medaglia grafica */

.profile-badge-card {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding: 10px 14px;
    border-radius: 16px;
    background-color: rgba(255, 243, 224, 0.9);
    border: 1px dashed rgba(251, 140, 0, 0.6);
}

.badge-medal {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 20%, #FFF3E0 0%, #FFB74D 40%, #F57C00 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    overflow: hidden;
}

.badge-medal-img {
    max-width: 48px;
    max-height: 48px;
    display: block;
}

.badge-texts {
    display: flex;
    flex-direction: column;
}

.badge-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #E65100;
    margin-bottom: 2px;
}

.badge-name {
    font-size: 1rem;
    font-weight: 600;
    color: #BF360C;
}

/* BOX MODIFICA DATI: un solo bottone Modifica */

.profile-edit-card {
    margin-bottom: 12px;
    padding: 14px 16px 10px;
    border-radius: 18px;
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid #FFE0B2;
}

.profile-edit-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
}

.profile-edit-header-left {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    color: #E65100;
}

.profile-edit-header-left .material-icons {
    font-size: 20px;
}

/* bottone principale Modifica */

.edit-main-button {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 14px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(135deg, #FFB74D 0%, #FB8C00 60%);
    color: #FFFFFF;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(251, 140, 0, 0.5);
    transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
}

.edit-main-button .material-icons {
    font-size: 18px;
}

.edit-main-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 5px 14px rgba(251, 140, 0, 0.7);
    filter: brightness(1.05);
}

.profile-edit-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 8px 0;
    border-top: 1px solid #FFE0B2;
}

.profile-edit-row:first-of-type {
    border-top: none;
}

.edit-field-text {
    display: flex;
    flex-direction: column;
}

.field-label {
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: #9E9E9E;
    margin-bottom: 2px;
}

.field-value {
    font-size: 0.95rem;
    color: #212121;
}

/* input in modalit√† edit */

.field-input {
    display: none;
    border: none;
    border-bottom: 1px solid #FFE0B2;
    padding: 4px 0;
    font-size: 0.95rem;
    background-color: transparent;
    color: #212121;
    outline: none;
}

.field-input:focus {
    border-color: #FB8C00;
}

/* default: solo view, niente bottoni azione */

.profile-edit-card .edit-mode {
    display: none;
}

.profile-edit-form .edit-actions {
    display: none;
    margin-top: 16px;
    justify-content: center;
    gap: 10px;
}

/* quando il form √® in editing */

.profile-edit-form.editing .view-mode {
    display: none;
}

.profile-edit-form.editing .edit-mode {
    display: block;
}

.profile-edit-form.editing .edit-actions {
    display: flex;
}

/* bottoni Conferma/Annulla */

.btn-confirm,
.btn-cancel {
    padding: 8px 16px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
}

.btn-confirm {
    background: linear-gradient(135deg, #FFB74D 0%, #FB8C00 60%);
    color: #FFFFFF;
    box-shadow: 0 3px 10px rgba(251, 140, 0, 0.5);
}

.btn-confirm:hover {
    filter: brightness(1.05);
}

.btn-cancel {
    background-color: #FFFFFF;
    color: #E65100;
    border: 1px solid #FFB74D;
}

.btn-cancel:hover {
    background-color: #FFF3E0;
}

/* Griglia campi profilo (altri dati) */

.profile-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 14px 18px;
    margin-top: 8px;
}

.profile-field {
    padding: 8px 10px;
    border-radius: 12px;
    background-color: #FAFAFA;
    border: 1px solid #EEEEEE;
}

/* Responsive */

@media (max-width: 768px) {
    .profile-card {
        padding: 20px 16px 22px;
    }

    .profile-main {
        padding: 0 16px;
    }

    .profile-header {
        flex-direction: row;
        align-items: center;
    }

    .profile-title {
        font-size: 1.2rem;
    }

    .points-value-big {
        font-size: 2.4rem;
    }

    .profile-edit-row {
        align-items: flex-start;
    }
}
/* overlay rosso per rimozione avatar */

.avatar-remove-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 72px;          /* stessa size di .profile-avatar-large */
    height: 72px;
    border-radius: 50%;
    background: rgba(244, 67, 54, 0.8); /* rosso semi-trasparente */
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 2;
}

.avatar-remove-overlay .material-icons {
    font-size: 26px;
    color: #FFFFFF;
}

/* mostra overlay solo quando c‚Äô√® un avatar e sei in hover */

.profile-avatar-wrapper.has-avatar:hover .avatar-remove-overlay {
    opacity: 1;
    pointer-events: auto;
}

/* scurisce un po' l'immagine sotto in hover */

.profile-avatar-wrapper.has-avatar:hover .profile-avatar-large img {
    filter: brightness(0.7);
}

/* matita sopra l'overlay */
.avatar-edit-btn {
    z-index: 3;
}
</file>

<file path="src/main/webapp/css/segnalazioni_e_reclami.css">
.page-wrapper {
    max-width: 1100px;
    margin: 100px auto 60px;
    padding: 0 20px 40px;
    font-family: 'Roboto', sans-serif;
}

/* Header */

.page-header {
    margin-bottom: 24px;
}

.page-title {
    font-size: 2.1rem;
    font-weight: 700;
    color: #202124;
    margin-bottom: 4px;
}

.page-subtitle {
    font-size: 0.95rem;
    color: #5f6368;
}

/* Tabs */

.tabs {
    display: inline-flex;
    padding: 4px;
    border-radius: 999px;
    background-color: #fff7ec;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.tab-button {
    border: none;
    background: transparent;
    padding: 8px 18px;
    border-radius: 999px;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    color: #5f6368;
    transition: all 0.2s ease;
}

.tab-button .tab-icon {
    font-size: 18px;
}

.tab-button.active {
    background: #ff9800;
    color: #ffffff;
    box-shadow: 0 3px 8px rgba(0,0,0,0.12);
}

/* Sezioni */

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.section-header {
    margin: 10px 0 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-header h2 {
    font-size: 1.2rem;
    font-weight: 600;
    color: #202124;
}

/* Buttons generici */

.btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 20px;
    border-radius: 999px;
    border: none;
    background: #ff9800;
    color: #fff;
    font-size: 0.9rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(255,152,0,0.4);
    transition: transform 0.1s ease, box-shadow 0.1s ease;
}

.btn-primary .material-icons {
    font-size: 18px;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 5px 14px rgba(255,152,0,0.6);
}

.btn-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    min-width: 120px;
    border-radius: 999px;
    border: 1px solid #ff9800;
    background: #fff7ec;
    color: #e65100;
    font-size: 0.85rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.15s ease;
}

.btn-secondary:hover {
    background: #ffe3c2;
}

/* Empty state */

.empty-state {
    margin-top: 24px;
    padding: 30px 24px;
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 3px 14px rgba(0,0,0,0.06);
    text-align: center;
}

.empty-icon {
    font-size: 42px;
    margin-bottom: 8px;
    color: #ff9800;
}

/* Layout a colonna */

.cards-column {
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin-top: 10px;
}

/* Card a riga intera */

.card-row {
    display: flex;
    align-items: stretch;
    gap: 16px;
    padding: 14px 18px;
    background: #ffffff;
    border-radius: 18px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.06);
    border: 1px solid #f1f3f4;
}

/* Thumb immagine */

.card-thumb {
    width: 80px;
    min-width: 80px;
    height: 80px;
    border-radius: 18px;
    background: radial-gradient(circle at top left, #ffe0b2, #ffb74d);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.card-thumb-img-wrapper {
    width: 100%;
    height: 100%;
}

.card-thumb-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

.card-thumb-placeholder {
    position: absolute;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    color: #ffffff;
    font-size: 30px;
}

.card-thumb.no-img .card-thumb-img-wrapper img {
    display: none;
}

.card-thumb.no-img .card-thumb-placeholder {
    display: flex;
}

/* Contenuto centrale */

.card-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 4px;
}

.card-badges {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 2px;
}

.badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 3px 10px;
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
}

.badge-active {
    background: #e8f5e9;
    color: #2e7d32;
}

.badge-closed {
    background: #ffebee;
    color: #c62828;
}

.badge-type {
    background: #e3f2fd;
    color: #1565c0;
}

.badge-reclamo {
    background: #e3f2fd;
    color: #1565c0;
}

.card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #202124;
}

.card-info {
    font-size: 0.85rem;
    color: #5f6368;
    display: flex;
    align-items: center;
    gap: 4px;
}

.card-info-icon {
    font-size: 16px;
    color: #ff9800;
}

/* Azioni a destra */

.card-actions {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-end;
    gap: 8px;
    min-width: 140px;
}

.delete-form {
    margin: 0;
}

.icon-button {
    border: none;
    background: transparent;
    cursor: pointer;
    padding: 4px;
    border-radius: 999px;
    transition: background 0.15s ease;
}

.icon-button .material-icons {
    color: #e53935;
    font-size: 20px;
}

.icon-button:hover {
    background: #ffebee;
}

/* Responsivo */

@media (max-width: 700px) {
    .card-row {
        flex-direction: column;
        align-items: flex-start;
    }

    .card-actions {
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
    }

    .card-actions .btn-secondary {
        flex: 1;
    }
}
</file>

<file path="src/main/webapp/WEB-INF/jsp/area_admin.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="java.util.List" %>
<%@ page import="model.bean.Utente" %>
<%@ page import="model.bean.DropPoint" %>
<%@ page import="model.bean.enums.Ruolo" %>
<%@ page import="java.util.Arrays" %>

<%
  Utente utente = (Utente) session.getAttribute("utente");
  if (utente == null || utente.getRuolo() != Ruolo.ADMIN) {
    response.sendRedirect(request.getContextPath() + "/login");
    return;
  }

  List<DropPoint> pendenti = (List<DropPoint>) request.getAttribute("dropPointsPendenti");
  List<Utente> utenti = (List<Utente>) request.getAttribute("listaUtenti");

  String navAvatarPath = Arrays.toString(utente.getImmagineProfilo());
  boolean navHasAvatar = navAvatarPath != null && !navAvatarPath.trim().isEmpty();
%>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Area Admin - Foundly</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="${pageContext.request.contextPath}/css/index.css">
  <link rel="stylesheet" href="${pageContext.request.contextPath}/css/area_admin.css">
</head>
<body class="page-enter">

<jsp:include page="/WEB-INF/jsp/navbar.jsp"/>

<main class="admin-main">

  <!-- Gestione Drop-Point -->
  <section class="admin-section">
    <h1 class="admin-title">Gestione Drop-Point</h1>

    <div class="admin-card">
      <h2 class="admin-subtitle">Richieste in attesa</h2>

      <%
        if (pendenti == null || pendenti.isEmpty()) {
      %>
      <p class="admin-empty">Nessun Drop-Point in attesa di approvazione.</p>
      <%
      } else {
      %>
      <table class="admin-table">
        <thead>
        <tr>
          <th>Nome attivit√†</th>
          <th>Indirizzo</th>
          <th>Citt√†</th>
          <th>Provincia</th>
          <th>Telefono</th>
          <th>Azioni</th>
        </tr>
        </thead>
        <tbody>
        <%
          for (DropPoint dp : pendenti) {
        %>
        <tr>
          <td><%= dp.getNomeAttivita() %></td>
          <td><%= dp.getIndirizzo() %></td>
          <td><%= dp.getCitta() %></td>
          <td><%= dp.getProvincia() %></td>
          <td><%= dp.getTelefono() != null ? dp.getTelefono() : "-" %></td>
          <td class="admin-actions">
            <form method="post"
                  action="${pageContext.request.contextPath}/admin"
                  class="inline-form">
              <input type="hidden" name="action" value="approveDropPoint">
              <input type="hidden" name="dropPointId" value="<%= dp.getId() %>">
              <button type="submit" class="btn-admin-approve">Approva</button>
            </form>

            <form method="post"
                  action="${pageContext.request.contextPath}/admin"
                  class="inline-form">
              <input type="hidden" name="action" value="rejectDropPoint">
              <input type="hidden" name="dropPointId" value="<%= dp.getId() %>">
              <button type="submit" class="btn-admin-reject">Rifiuta</button>
            </form>
          </td>
        </tr>
        <%
          }
        %>
        </tbody>
      </table>
      <%
        }
      %>
    </div>
  </section>

  <!-- Gestione Utenti -->
  <section class="admin-section">
    <h1 class="admin-title">Gestione Utenti</h1>

    <div class="admin-card">
      <h2 class="admin-subtitle">Lista utenti</h2>

      <table class="admin-table">
        <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Nome</th>
          <th>Cognome</th>
          <th>Email</th>
          <th>Ruolo</th>
          <th>Azioni</th>
        </tr>
        </thead>
        <tbody>
        <%
          if (utenti != null) {
            for (Utente u : utenti) {
        %>
        <tr>
          <td><%= u.getId() %></td>
          <td><%= u.getUsername() %></td>
          <td><%= u.getNome() %></td>
          <td><%= u.getCognome() %></td>
          <td><%= u.getEmail() %></td>
          <td><%= u.getRuolo() %></td>
          <td class="admin-actions">
            <%
              // Non permetto di cancellare se stesso e, volendo, altri ADMIN
              if (u.getId() != utente.getId() && u.getRuolo() == Ruolo.UTENTE_BASE) {
            %>
            <form method="post"
                  action="${pageContext.request.contextPath}/admin"
                  class="inline-form"
                  onsubmit="return confirm('Confermi la rimozione di questo utente?');">
              <input type="hidden" name="action" value="deleteUser">
              <input type="hidden" name="userId" value="<%= u.getId() %>">
              <button type="submit" class="btn-admin-delete">Elimina</button>
            </form>
            <%
            } else {
            %>
            <span class="admin-note">N/D</span>
            <%
              }
            %>
          </td>
        </tr>
        <%
            }
          }
        %>
        </tbody>
      </table>
    </div>
  </section>

</main>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const userMenu = document.querySelector(".user-menu");
    if (userMenu) {
      const btn = userMenu.querySelector(".user-avatar-btn");
      btn.addEventListener("click", function (e) {
        e.stopPropagation();
        userMenu.classList.toggle("open");
      });
      document.addEventListener("click", function () {
        userMenu.classList.remove("open");
      });
    }
  });
</script>

</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/jsp/area_drop_point.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="model.bean.DropPoint" %>
<%@ page import="model.bean.enums.StatoDropPoint" %>

<%
    DropPoint dropPoint = (DropPoint) request.getAttribute("dropPoint");

    boolean hasDp      = (dropPoint != null);
    boolean isApproved = hasDp && dropPoint.getStato() == StatoDropPoint.APPROVATO;
    boolean isPending  = hasDp && dropPoint.getStato() == StatoDropPoint.IN_ATTESA;

    int depositiAttivi      = (request.getAttribute("depositiAttivi")      != null) ? (Integer) request.getAttribute("depositiAttivi")      : 0;
    int consegneCompletate  = (request.getAttribute("consegneCompletate")  != null) ? (Integer) request.getAttribute("consegneCompletate")  : 0;
    int totaleOperazioni    = (request.getAttribute("totaleOperazioni")    != null) ? (Integer) request.getAttribute("totaleOperazioni")    : 0;

    String msgDeposito    = (String) request.getAttribute("msgDeposito");
    String msgRitiro      = (String) request.getAttribute("msgRitiro");
    String erroreGenerale = (String) request.getAttribute("erroreGenerale");
%>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Area Drop-Point - Foundly</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/index.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/area_drop_point.css?v=3">
</head>
<body class="page-enter">

<jsp:include page="navbar.jsp" />

<main class="dp-area-main">

    <!-- HEADER -->
    <section class="dp-area-header">
        <div class="dp-area-title-block">
            <div class="dp-area-icon">
                <span class="material-icons">storefront</span>
            </div>
            <div>
                <h1 class="dp-area-title">Area Drop-Point</h1>
                <p class="dp-area-subtitle">Gestisci i codici di deposito e ritiro dei clienti.</p>
            </div>
        </div>

        <div class="dp-area-status-badge
             <%= !hasDp ? "status-none" : (isApproved ? "status-ok" : "status-pending") %>">
            <span class="material-icons">
                <%= !hasDp ? "info" : (isApproved ? "check_circle" : "hourglass_top") %>
            </span>
            <span>
                <% if (!hasDp) { %>
                    Nessun Drop-Point associato
                <% } else if (isApproved) { %>
                    Drop-Point approvato:
                    <strong><%= dropPoint.getNomeAttivita() %></strong>
                <% } else { %>
                    In attesa di approvazione
                <% } %>
            </span>
        </div>
    </section>

    <!-- CARDS CONTATORI -->
    <section class="dp-stats-row">
        <article class="dp-stat-card">
            <div class="dp-stat-label">Depositi Attivi</div>
            <div class="dp-stat-value warning"><%= depositiAttivi %></div>
            <span class="material-icons dp-stat-icon">inventory_2</span>
        </article>

        <article class="dp-stat-card">
            <div class="dp-stat-label">Consegne Completate</div>
            <div class="dp-stat-value success"><%= consegneCompletate %></div>
            <span class="material-icons dp-stat-icon">check_circle</span>
        </article>

        <article class="dp-stat-card">
            <div class="dp-stat-label">Totale Operazioni</div>
            <div class="dp-stat-value info"><%= totaleOperazioni %></div>
            <span class="material-icons dp-stat-icon">store</span>
        </article>
    </section>

    <% if (erroreGenerale != null) { %>
    <div class="dp-alert dp-alert-error">
        <span class="material-icons">error_outline</span>
        <span><%= erroreGenerale %></span>
    </div>
    <% } %>

    <!-- BOTTONI GRANDI AZIONE -->
    <section class="dp-actions-grid">
        <button type="button"
                class="dp-big-action dp-action-deposito active"
                data-panel="panel-deposito">
            <div class="dp-big-icon-wrapper">
                <span class="material-icons">north_east</span>
            </div>
            <h2>Registra Deposito</h2>
            <p>Quando il Finder lascia l‚Äôoggetto nel tuo negozio, usa il codice di consegna per registrare il deposito.</p>
        </button>

        <button type="button"
                class="dp-big-action dp-action-ritiro"
                data-panel="panel-ritiro">
            <div class="dp-big-icon-wrapper">
                <span class="material-icons">south_west</span>
            </div>
            <h2>Registra Ritiro</h2>
            <p>Quando il proprietario arriva con il codice, conferma il ritiro per chiudere l‚Äôoperazione.</p>
        </button>
    </section>

    <!-- PANNELLI SOTTO I BOTTONI -->

    <!-- PANEL DEPOSITO -->
    <section class="dp-panel-card active" id="panel-deposito">
        <h2 class="dp-panel-title">Registra Deposito</h2>
        <p class="dp-panel-subtitle">
            Inserisci il codice di consegna a 6 cifre che il Finder ti mostra dall‚Äôapp.
        </p>

        <% if (!hasDp) { %>
        <div class="dp-alert dp-alert-warning">
            <span class="material-icons">info</span>
            <span>Devi registrare un Drop-Point per utilizzare questa funzione.</span>
        </div>
        <% } else if (!isApproved) { %>
        <div class="dp-alert dp-alert-warning">
            <span class="material-icons">hourglass_empty</span>
            <span>Il tuo Drop-Point √® ancora in attesa di approvazione.</span>
        </div>
        <% } %>

        <% if (msgDeposito != null) { %>
        <div class="dp-alert dp-alert-info">
            <span class="material-icons">info</span>
            <span><%= msgDeposito %></span>
        </div>
        <% } %>

        <form method="post"
              action="${pageContext.request.contextPath}/area-drop-point"
              class="dp-form">
            <input type="hidden" name="action" value="deposito">

            <label class="dp-label">Codice di Consegna (6 cifre)</label>
            <input type="text"
                   name="codice"
                   maxlength="6"
                   class="dp-input"
                   placeholder="123456"
                    <%= (!isApproved ? "disabled" : "") %> />

            <button type="submit"
                    class="dp-btn-primary <%= (!isApproved ? "disabled" : "") %>"
                    <%= (!isApproved ? "disabled" : "") %>>
                Conferma Deposito
            </button>
        </form>
    </section>

    <!-- PANEL RITIRO -->
    <section class="dp-panel-card" id="panel-ritiro">
        <h2 class="dp-panel-title">Registra Ritiro</h2>
        <p class="dp-panel-subtitle">
            Usa lo stesso codice di consegna per confermare che l‚Äôoggetto √® stato ritirato dal proprietario.
        </p>

        <% if (!hasDp) { %>
        <div class="dp-alert dp-alert-warning">
            <span class="material-icons">info</span>
            <span>Devi registrare un Drop-Point per utilizzare questa funzione.</span>
        </div>
        <% } else if (!isApproved) { %>
        <div class="dp-alert dp-alert-warning">
            <span class="material-icons">hourglass_empty</span>
            <span>Il tuo Drop-Point √® ancora in attesa di approvazione.</span>
        </div>
        <% } %>

        <% if (msgRitiro != null) { %>
        <div class="dp-alert dp-alert-info">
            <span class="material-icons">info</span>
            <span><%= msgRitiro %></span>
        </div>
        <% } %>

        <form method="post"
              action="${pageContext.request.contextPath}/area-drop-point"
              class="dp-form">
            <input type="hidden" name="action" value="ritiro">

            <label class="dp-label">Codice di Consegna (6 cifre)</label>
            <input type="text"
                   name="codice"
                   maxlength="6"
                   class="dp-input"
                   placeholder="123456"
                    <%= (!isApproved ? "disabled" : "") %> />

            <button type="submit"
                    class="dp-btn-primary <%= (!isApproved ? "disabled" : "") %>"
                    <%= (!isApproved ? "disabled" : "") %>>
                Conferma Ritiro
            </button>
        </form>
    </section>

</main>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Toggle pannelli tramite bottoni grandi
        const actionButtons = document.querySelectorAll(".dp-big-action");
        const panels = document.querySelectorAll(".dp-panel-card");

        actionButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const targetId = btn.getAttribute("data-panel");

                // reset bottoni
                actionButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");

                // reset pannelli
                panels.forEach(p => p.classList.remove("active"));
                const targetPanel = document.getElementById(targetId);
                if (targetPanel) {
                    targetPanel.classList.add("active");
                    targetPanel.scrollIntoView({ behavior: "smooth", block: "start" });
                }
            });
        });
    });
</script>


</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/jsp/home.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>

<%
        model.bean.DropPoint dp = (model.bean.DropPoint) session.getAttribute("dropPoint");
        model.bean.Utente u = (model.bean.Utente) session.getAttribute("utente");

        if (dp != null) {
            response.sendRedirect(request.getContextPath() + "/area-drop-point");
            return;
        }
%>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundly - Home</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/index.css">
</head>
<body class="page-enter">

<jsp:include page="navbar.jsp" />

<header class="hero">
    <h1>Hai perso qualcosa?</h1>
    <p>
        Foundly ti aiuta a ritrovare oggetti e animali smarriti grazie alla nostra
        community. Segnala, cerca e restituisci!
    </p>
    <a href="${pageContext.request.contextPath}/crea-segnalazione" class="btn-cta-hero">
        <span class="material-icons">inventory_2</span>
        Crea Segnalazione
    </a>
</header>

<div class="search-wrapper">
    <div class="search-card">
        <!-- FORM DI RICERCA -->
        <form action="${pageContext.request.contextPath}/search" method="GET">

            <div class="search-main-row">
                <div class="input-group">
                    <span class="material-icons search-icon">search</span>
                    <input type="text" name="q"
                           placeholder="Cerca per titolo..."
                           value="${param.q}">
                </div>
                <button type="submit" class="btn-search-submit">
                    Cerca
                </button>
            </div>

            <div class="search-divider"></div>

            <div class="filters-row">
                <div class="filter-item">
                    <span class="material-icons">category</span>
                    <select name="tipo">
                        <option value="">Tutti i tipi</option>
                        <option value="oggetto" ${param.tipo == 'oggetto' ? 'selected' : ''}>Oggetto</option>
                        <option value="animale" ${param.tipo == 'animale' ? 'selected' : ''}>Animale</option>
                    </select>
                </div>

                <div class="filter-item">
                    <span class="material-icons">sell</span>
                    <select name="categoria">
                        <option value="">Tutte le categorie</option>
                        <option value="ELETTRONICA" ${param.categoria == 'ELETTRONICA' ? 'selected' : ''}>Elettronica</option>
                        <option value="DOCUMENTI" ${param.categoria == 'DOCUMENTI' ? 'selected' : ''}>Documenti</option>
                        <option value="ABBIGLIAMENTO" ${param.categoria == 'ABBIGLIAMENTO' ? 'selected' : ''}>Abbigliamento</option>
                        <option value="GIOIELLI" ${param.categoria == 'GIOIELLI' ? 'selected' : ''}>Gioielli</option>
                        <option value="CHIAVI" ${param.categoria == 'CHIAVI' ? 'selected' : ''}>Chiavi</option>
                        <option value="PORTAFOGLI" ${param.categoria == 'PORTAFOGLI' ? 'selected' : ''}>Portafogli</option>
                        <option value="BORSE" ${param.categoria == 'BORSE' ? 'selected' : ''}>Borse</option>
                        <option value="ALTRO" ${param.categoria == 'ALTRO' ? 'selected' : ''}>Altro</option>
                    </select>
                </div>
            </div>
        </form>
    </div>
</div>

<section class="recent-section">
    <div class="section-header">
        <h2>
            <c:choose>
                <c:when test="${not empty param.q or not empty param.tipo or not empty param.categoria}">
                    Risultati Ricerca
                </c:when>
                <c:otherwise>Segnalazioni Recenti</c:otherwise>
            </c:choose>
        </h2>

        <c:choose>
            <c:when test="${empty segnalazioni}">
                <span class="result-count">0 risultati</span>
            </c:when>
            <c:otherwise>
                <span class="result-count">${segnalazioni.size()} risultati</span>
            </c:otherwise>
        </c:choose>
    </div>

    <div class="cards-grid">
        <c:if test="${empty segnalazioni}">
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <span class="material-icons" style="font-size: 48px; color: #e0e0e0;">search_off</span>
                <p style="color: #666; font-style: italic; margin-top: 10px;">
                    Nessuna segnalazione trovata con questi criteri.
                </p>
                <a href="${pageContext.request.contextPath}/index"
                   style="color: var(--primary-orange); text-decoration: none; font-weight: 500;">
                    Mostra tutto
                </a>
            </div>
        </c:if>

        <c:forEach var="s" items="${segnalazioni}">
            <a href="${pageContext.request.contextPath}/dettaglio-segnalazione?id=${s.id}" class="card-link">
                <article class="card">
                    <div class="card-badges">
                        <span class="badge ${s.stato == 'CHIUSA' ? 'badge-closed' : 'badge-active'}">
                                ${s.stato}
                        </span>
                        <span class="badge badge-type">${s.tipoSegnalazione}</span>
                    </div>

                    <div class="card-image-placeholder">
                        <c:choose>
                            <c:when test="${not empty s.immagine}">
                                <!-- Immagine da BLOB -->
                                <img src="${pageContext.request.contextPath}/segnalazione-img?id=${s.id}"
                                     alt="${s.titolo}"
                                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
                            </c:when>
                            <c:otherwise>
                                <span class="material-icons" style="font-size: 42px; color: #9E9E9E;">
                                    inventory_2
                                </span>
                            </c:otherwise>
                        </c:choose>
                    </div>

                    <div class="card-footer">
                        <div class="card-title">${s.titolo}</div>
                        <div class="card-info">
                                ${s.citta} ‚Ä¢
                            <fmt:formatDate value="${s.dataRitrovamento}" pattern="dd MMM" />
                        </div>
                    </div>
                </article>
            </a>
        </c:forEach>
    </div>
</section>

</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/jsp/recupero_password_codice.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Foundly - Conferma Recupero</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">

  <style>
    .info-section {
      background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
    }

    /* Stile footer form come nello screenshot */
    .form-footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;   /* linea orizzontale */
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      color: #666;
      font-size: 0.95rem;
    }

    .link-login {
      color: #FB8C00;
      font-weight: 600;
      text-decoration: none;
      padding: 0 4px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .link-login:hover {
      background-color: #FFF3E0;
      color: #E65100;
    }
  </style>
</head>
<body>

<div class="main-container">

  <div class="info-section">
    <div class="brand-header">
      <div class="brand-icon">
        <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
      </div>
    </div>

    <div class="hero-text">
      <h1>Inserisci il codice</h1>
      <p>
        Abbiamo inviato un codice di verifica all'indirizzo email specificato.
        Inserisci il codice ricevuto e scegli una nuova password.
      </p>
      <% String msg = (String) request.getAttribute("messaggio"); %>
      <% if (msg != null) { %>
      <p style="margin-top:10px;color:#2e7d32;font-size:0.9rem;"><%= msg %></p>
      <% } %>
    </div>
  </div>

  <div class="auth-section">
    <div class="auth-card">
      <h2>Verifica Codice</h2>
      <p class="subtitle">Inserisci il codice e la nuova password</p>

      <% String errore = (String) request.getAttribute("errore"); %>
      <% if (errore != null) { %>
      <div style="background-color:#ffebee;color:#c62828;padding:10px;border-radius:8px;margin-bottom:20px;font-size:0.9rem;text-align:center;">
        <span class="material-icons" style="font-size:16px;vertical-align:middle;">error</span>
        <%= errore %>
      </div>
      <% } %>

      <form action="${pageContext.request.contextPath}/recupero-password" method="post">
        <input type="hidden" name="step" value="codice">

        <div class="input-group">
          <label for="codice">Codice di verifica</label>
          <input type="text"
                 id="codice"
                 name="codice"
                 placeholder="es. 123456"
                 required
                 minlength="6"
                 maxlength="6">
        </div>

        <div class="input-group">
          <label for="nuovaPassword">Nuova password</label>
          <input type="password"
                 id="nuovaPassword"
                 name="nuovaPassword"
                 placeholder="Minimo 8 caratteri, con maiuscole, minuscole, numeri e simboli"
                 required>
        </div>

        <div class="input-group">
          <label for="confermaPassword">Conferma password</label>
          <input type="password"
                 id="confermaPassword"
                 name="confermaPassword"
                 placeholder="Ripeti la nuova password"
                 required>
        </div>

        <button type="submit" class="btn-primary mt-2">Conferma</button>
      </form>

      <div class="form-footer">
        <span>Hai ricordato la password?</span>
        <a href="${pageContext.request.contextPath}/login" class="link-login">Accedi qui</a>
      </div>
    </div>
  </div>

</div>

</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/jsp/recupero_password_email.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundly - Recupero Password</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">

    <style>
        .info-section {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
        }

        .pill.active {
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #FF9800;
        }

        /* Stile footer form come nello screenshot */
        .form-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;   /* linea orizzontale */
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 0.95rem;
        }

        .link-login {
            color: #FB8C00;
            font-weight: 600;
            text-decoration: none;
            padding: 0 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .link-login:hover {
            background-color: #FFF3E0;
            color: #E65100;
        }
    </style>
</head>
<body>

<div class="main-container">

    <div class="info-section">
        <div class="brand-header">
            <div class="brand-icon">
                <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
            </div>
        </div>

        <div class="hero-text">
            <h1>Problemi di accesso?</h1>
            <p>
                Non preoccuparti, succede a tutti.
                Inserisci l'email associata al tuo account e ti invieremo le istruzioni
                per reimpostare la password in sicurezza.
            </p>
            <div class="feature-pills">
                <span class="pill"><span class="material-icons">lock</span> Sicurezza garantita</span>
                <span class="pill"><span class="material-icons">mail</span> Codice via Email</span>
            </div>
        </div>
    </div>

    <div class="auth-section">
        <div class="auth-card">
            <h2>Recupero Password</h2>
            <p class="subtitle">Inserisci la tua email per continuare</p>

            <%-- Messaggi --%>
            <% String errore = (String) request.getAttribute("errore"); %>
            <% String messaggio = (String) request.getAttribute("messaggio"); %>

            <% if (errore != null) { %>
            <div style="background-color:#ffebee;color:#c62828;padding:10px;border-radius:8px;margin-bottom:20px;font-size:0.9rem;text-align:center;">
                <span class="material-icons" style="font-size:16px;vertical-align:middle;">error</span>
                <%= errore %>
            </div>
            <% } %>

            <% if (messaggio != null) { %>
            <div style="background-color:#e8f5e9;color:#2e7d32;padding:10px;border-radius:8px;margin-bottom:20px;font-size:0.9rem;text-align:center;">
                <span class="material-icons" style="font-size:16px;vertical-align:middle;">check_circle</span>
                <%= messaggio %>
            </div>
            <% } %>

            <form action="${pageContext.request.contextPath}/recupero-password" method="post">
                <!-- IMPORTANTE per il servlet a due step -->
                <input type="hidden" name="step" value="email">

                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email"
                           id="email"
                           name="email"
                           placeholder="nome@esempio.com"
                           required>
                </div>

                <button type="submit" class="btn-primary mt-2">Invia codice</button>

                <div class="form-footer">
                    <span>Hai ricordato la password?</span>
                    <a href="${pageContext.request.contextPath}/login" class="link-login">Accedi qui</a>
                </div>
            </form>

        </div>
    </div>
</div>

</body>
</html>
</file>

<file path="db/insert.sql">
-- Cancellare dati da tabella utente
SET FOREIGN_KEY_CHECKS = 0;
TRUNCATE TABLE utente;
SET FOREIGN_KEY_CHECKS = 1;

-- Cancellare dati da tabella drop-point
SET FOREIGN_KEY_CHECKS = 0;
TRUNCATE TABLE drop_point;
SET FOREIGN_KEY_CHECKS = 1;
</file>

<file path="src/main/java/controller/CreaSegnalazioneServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.MultipartConfig;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import jakarta.servlet.http.Part;
import model.bean.Segnalazione;
import model.bean.SegnalazioneAnimale;
import model.bean.SegnalazioneOggetto;
import model.bean.Utente;
import model.bean.enums.CategoriaOggetto;
import model.bean.enums.ModalitaConsegna;
import model.bean.enums.StatoSegnalazione;
import model.bean.enums.TipoSegnalazione;
import model.service.DropPointService;
import model.service.SegnalazioneService;

import java.io.IOException;
import java.io.InputStream;
import java.sql.Timestamp;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;

@WebServlet(name = "CreaSegnalazioneServlet", value = "/crea-segnalazione")
@MultipartConfig(
        fileSizeThreshold = 1024 * 1024 * 2, // 2MB
        maxFileSize = 1024 * 1024 * 10,      // 10MB
        maxRequestSize = 1024 * 1024 * 50    // 50MB
)
public class CreaSegnalazioneServlet extends HttpServlet {

    private final DropPointService dropPointService = new DropPointService();
    private final SegnalazioneService segnalazioneService = new SegnalazioneService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (utente == null) {
            response.sendRedirect(request.getContextPath() + "/login");
            return;
        }

        request.setAttribute("listaDropPoint", dropPointService.findAllApprovati());
        request.getRequestDispatcher("/WEB-INF/jsp/crea_segnalazione.jsp")
                .forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (utente == null) {
            response.sendRedirect(request.getContextPath() + "/login");
            return;
        }

        try {
            // 1) parametri base
            String tipo = request.getParameter("tipo_segnalazione");
            String titolo = request.getParameter("titolo");
            String descrizione = request.getParameter("descrizione");
            String dataStr = request.getParameter("dataRitrovamento");
            String luogo = request.getParameter("luogo_ritrovamento");
            String citta = request.getParameter("citta");
            String provincia = request.getParameter("provincia");
            String domanda1 = request.getParameter("domanda1");
            String domanda2 = request.getParameter("domanda2");

            Segnalazione segnalazione;

            // 2) oggetto polimorfico
            if ("OGGETTO".equalsIgnoreCase(tipo)) {
                SegnalazioneOggetto so = new SegnalazioneOggetto();

                String categoriaStr = request.getParameter("categoria");
                if (categoriaStr != null && !categoriaStr.isEmpty()) {
                    try {
                        so.setCategoria(CategoriaOggetto.valueOf(categoriaStr));
                    } catch (IllegalArgumentException e) {
                        so.setCategoria(CategoriaOggetto.ALTRO);
                    }
                } else {
                    so.setCategoria(CategoriaOggetto.ALTRO);
                }

                String modalitaStr = request.getParameter("modalita_consegna");
                if ("DROP_POINT".equals(modalitaStr)) {
                    so.setModalitaConsegna(ModalitaConsegna.DROP_POINT);
                    String idDpStr = request.getParameter("idDropPoint");
                    if (idDpStr != null && !idDpStr.isEmpty()) {
                        so.setIdDropPoint(Long.parseLong(idDpStr));
                    }
                } else {
                    so.setModalitaConsegna(ModalitaConsegna.DIRETTA);
                    so.setIdDropPoint(null);
                }

                so.setTipoSegnalazione(TipoSegnalazione.OGGETTO);
                segnalazione = so;

            } else {
                SegnalazioneAnimale sa = new SegnalazioneAnimale();
                sa.setSpecie(request.getParameter("specie"));
                sa.setRazza(request.getParameter("razza"));
                sa.setTipoSegnalazione(TipoSegnalazione.ANIMALE);
                segnalazione = sa;
            }

            // 3) dati comuni
            segnalazione.setIdUtente(utente.getId());
            segnalazione.setTitolo(titolo);
            segnalazione.setDescrizione(descrizione);
            segnalazione.setLuogoRitrovamento(luogo);
            segnalazione.setCitta(citta);
            segnalazione.setProvincia(provincia);
            segnalazione.setDomandaVerifica1(domanda1);
            segnalazione.setDomandaVerifica2(domanda2);
            segnalazione.setStato(StatoSegnalazione.APERTA);
            segnalazione.setDataPubblicazione(new Timestamp(System.currentTimeMillis()));

            if (dataStr != null && !dataStr.isEmpty()) {
                if (dataStr.contains("T")) {
                    LocalDateTime dt = LocalDateTime.parse(dataStr);
                    segnalazione.setDataRitrovamento(Timestamp.valueOf(dt));
                } else {
                    LocalDate date = LocalDate.parse(dataStr);
                    segnalazione.setDataRitrovamento(
                            Timestamp.valueOf(LocalDateTime.of(date, LocalTime.NOON)));
                }
            }

            // 4) immagine BLOB
            Part filePart = null;
            try {
                filePart = request.getPart("immagine");
            } catch (IllegalStateException | ServletException e) {
                // niente upload ‚Üí lascio immagine null
            }

            if (filePart != null && filePart.getSize() > 0) {
                try (InputStream is = filePart.getInputStream()) {
                    byte[] bytes = is.readAllBytes();
                    segnalazione.setImmagine(bytes);
                    segnalazione.setImmagineContentType(filePart.getContentType());
                }
            } else {
                segnalazione.setImmagine(null);
                segnalazione.setImmagineContentType(null);
            }

            // 5) salvataggio
            boolean successo = segnalazioneService.creaSegnalazione(segnalazione);

            if (successo) {
                response.sendRedirect(request.getContextPath() + "/index?msg=success_segnalazione");
            } else {
                request.setAttribute("listaDropPoint", dropPointService.findAllApprovati());
                request.setAttribute("errore", "Errore nel salvataggio. Controlla i dati inseriti.");
                request.getRequestDispatcher("/WEB-INF/jsp/crea_segnalazione.jsp")
                        .forward(request, response);
            }

        } catch (Exception e) {
            e.printStackTrace();
            request.setAttribute("listaDropPoint", dropPointService.findAllApprovati());
            request.setAttribute("errore", "Errore tecnico: " + e.getMessage());
            request.getRequestDispatcher("/WEB-INF/jsp/crea_segnalazione.jsp")
                    .forward(request, response);
        }
    }
}
</file>

<file path="src/main/java/controller/GestioneReclamoServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import model.bean.DropPoint;
import model.bean.Reclamo;
import model.bean.Segnalazione;
import model.bean.SegnalazioneOggetto;
import model.bean.Utente;
import model.bean.enums.ModalitaConsegna;
import model.bean.enums.StatoSegnalazione;
import model.dao.ReclamoDAO;
import model.service.SegnalazioneService;

import java.io.IOException;
import java.util.UUID;

@WebServlet(name = "GestioneReclamoServlet", value = "/gestione-reclamo")
public class GestioneReclamoServlet extends HttpServlet {

    private final ReclamoDAO reclamoDAO = new ReclamoDAO();
    private final SegnalazioneService segnalazioneService = new SegnalazioneService();

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String action = request.getParameter("action");
        HttpSession session = request.getSession(false);

        Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;
        DropPoint dropPoint = (session != null) ? (DropPoint) session.getAttribute("dropPoint") : null;

        if (utente == null && dropPoint == null) {
            response.sendRedirect("login");
            return;
        }

        // --- 1. DROP-POINT: Conferma Ritiro con Codice ---
        if ("conferma_ritiro".equals(action)) {
            if (dropPoint == null) { response.sendRedirect("login"); return; }
            try {
                long idReclamo = Long.parseLong(request.getParameter("idReclamo"));
                long idSegnalazione = Long.parseLong(request.getParameter("idSegnalazione"));
                String codice = request.getParameter("codiceConsegna");

                boolean successo = segnalazioneService.accettaReclamoEChiudiSegnalazione(idReclamo, idSegnalazione, codice);
                response.sendRedirect("area-drop-point?msg=" + (successo ? "successo_consegna" : "codice_errato"));
            } catch (Exception e) {
                response.sendRedirect("area-drop-point?err=errore");
            }
            return;
        }

        // --- 2. AZIONI UTENTE (Finder / Owner) ---
        if (utente == null) { response.sendRedirect("login"); return; }

        if ("invia".equals(action)) {
            long idSegnalazione = Long.parseLong(request.getParameter("idSegnalazione"));
            Segnalazione s = segnalazioneService.trovaPerId(idSegnalazione);

            if (s == null || s.getStato() != StatoSegnalazione.APERTA) {
                response.sendRedirect("dettaglio-segnalazione?id=" + idSegnalazione + "&msg=segnalazione_chiusa");
                return;
            }
            if (reclamoDAO.doRetrieveBySegnalazioneAndUtente(idSegnalazione, utente.getId()) != null) {
                response.sendRedirect("dettaglio-segnalazione?id=" + idSegnalazione + "&msg=reclamo_esistente");
                return;
            }

            Reclamo r = new Reclamo();
            r.setIdSegnalazione(idSegnalazione);
            r.setIdUtenteRichiedente(utente.getId());
            r.setRispostaVerifica1(request.getParameter("risposta1"));
            r.setRispostaVerifica2(request.getParameter("risposta2"));
            reclamoDAO.doSave(r);
            response.sendRedirect("dettaglio-segnalazione?id=" + idSegnalazione + "&msg=reclamo_inviato");

        } else if ("accetta".equals(action)) {
            long idReclamo = Long.parseLong(request.getParameter("idReclamo"));
            long idSegnalazione = Long.parseLong(request.getParameter("idSegnalazione"));
            Segnalazione s = segnalazioneService.trovaPerId(idSegnalazione);

            String codice = null;
            boolean isDropPoint = false;

            // VERIFICA SE √à DROP-POINT PER GENERARE IL CODICE
            if (s instanceof SegnalazioneOggetto) {
                SegnalazioneOggetto so = (SegnalazioneOggetto) s;
                if (so.getModalitaConsegna() == ModalitaConsegna.DROP_POINT) {
                    isDropPoint = true;
                    // Genera codice univoco (6 caratteri)
                    codice = UUID.randomUUID().toString().substring(0, 6).toUpperCase();
                }
            }

            // Salva nel DB (se DropPoint salva codice, se Diretta salva null)
            reclamoDAO.accettaReclamo(idReclamo, codice);

            if (isDropPoint) {
                // Reindirizza con un messaggio che la JSP user√† per mostrare il codice
                response.sendRedirect("dettaglio-segnalazione?id=" + idSegnalazione + "&msg=attesa_ritiro");
            } else {
                // Scambio diretto: avvia il flusso dei pulsanti
                response.sendRedirect("dettaglio-segnalazione?id=" + idSegnalazione + "&msg=scambio_avviato");
            }

        } else if ("rifiuta".equals(action)) {
            long idReclamo = Long.parseLong(request.getParameter("idReclamo"));
            long idSegnalazione = Long.parseLong(request.getParameter("idSegnalazione"));
            segnalazioneService.rifiutaReclamo(idReclamo);
            response.sendRedirect("dettaglio-segnalazione?id=" + idSegnalazione + "&msg=reclamo_rifiutato");

        } else if ("conferma_scambio".equals(action)) {
            // SCAMBIO DIRETTO
            long idReclamo = Long.parseLong(request.getParameter("idReclamo"));
            long idSegnalazione = Long.parseLong(request.getParameter("idSegnalazione"));

            Segnalazione s = segnalazioneService.trovaPerId(idSegnalazione);
            boolean isFinder = (s.getIdUtente() == utente.getId());

            boolean finito = segnalazioneService.gestisciConfermaScambio(idReclamo, isFinder);

            if (finito) {
                response.sendRedirect("dettaglio-segnalazione?id=" + idSegnalazione + "&msg=scambio_completato");
            } else {
                response.sendRedirect("dettaglio-segnalazione?id=" + idSegnalazione + "&msg=conferma_registrata");
            }
        }
    }
}
</file>

<file path="src/main/java/controller/ProfiloServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.MultipartConfig;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import jakarta.servlet.http.Part;
import model.bean.Utente;
import model.service.UtenteService;

import java.io.IOException;
import java.io.InputStream;

@WebServlet(name = "ProfiloServlet", value = "/profilo")
@MultipartConfig(
        maxFileSize = 5 * 1024 * 1024,        // 5 MB
        maxRequestSize = 10 * 1024 * 1024     // 10 MB
)
public class ProfiloServlet extends HttpServlet {

    private final UtenteService utenteService = new UtenteService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (utente == null) {
            response.sendRedirect(request.getContextPath() + "/login");
            return;
        }

        // mantiene il badge coerente con il punteggio
        utenteService.aggiornaPunteggioEBadge(utente, 0);
        session.setAttribute("utente", utente);

        request.getRequestDispatcher("/WEB-INF/jsp/profilo.jsp")
                .forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        request.setCharacterEncoding("UTF-8");

        HttpSession session = request.getSession(false);
        Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (utente == null) {
            response.sendRedirect(request.getContextPath() + "/login");
            return;
        }

        // campi testo
        String username = request.getParameter("username");
        String nome     = request.getParameter("nome");
        String cognome  = request.getParameter("cognome");

        utente.setUsername(username);
        utente.setNome(nome);
        utente.setCognome(cognome);

        // flag rimozione immagine
        String removeAvatarParam = request.getParameter("removeAvatar");
        boolean removeAvatar = "true".equalsIgnoreCase(removeAvatarParam);

        // upload immagine profilo (campo "avatar")
        Part avatarPart = null;
        try {
            avatarPart = request.getPart("avatar");
        } catch (IllegalStateException | ServletException e) {
            avatarPart = null; // tieni l'immagine precedente
        }

        boolean hasNewUpload = (avatarPart != null && avatarPart.getSize() > 0);

        if (hasNewUpload) {
            // nuova immagine: carico i byte nel BLOB e salvo il content-type
            try (InputStream is = avatarPart.getInputStream()) {
                byte[] bytes = is.readAllBytes();
                utente.setImmagineProfilo(bytes);
                utente.setImmagineProfiloContentType(avatarPart.getContentType());
            }
            // se carico una nuova immagine, ignoro il flag di rimozione
            removeAvatar = false;

        } else if (removeAvatar) {
            // rimozione esplicita senza nuovo upload
            utente.setImmagineProfilo(null);
            utente.setImmagineProfiloContentType(null);
        }

        // aggiorna profilo (username, nome, cognome, immagine_profilo + content_type)
        utenteService.aggiornaProfilo(utente);

        // aggiorna sessione
        session.setAttribute("utente", utente);

        // redirect al profilo (per evitare il resubmit del POST)
        response.sendRedirect(request.getContextPath() + "/profilo?success=1");
    }
}
</file>

<file path="src/main/java/controller/RegistrazioneUtenteServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.service.UtenteService;
import java.io.IOException;

@WebServlet(name = "RegistrazioneUtenteServlet", value = "/registrazione-utente")
public class RegistrazioneUtenteServlet extends HttpServlet {

    private final UtenteService utenteService = new UtenteService();

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        request.getRequestDispatcher("/WEB-INF/jsp/registrazione_utente.jsp").forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String nome = request.getParameter("nome");
        String cognome = request.getParameter("cognome");
        String username = request.getParameter("username");
        String email = request.getParameter("email");
        String password = request.getParameter("password");
        String telefono = request.getParameter("telefono");

        // REGEX AGGIORNATA: Aggiunto '#' tra i caratteri speciali permessi
        // Vecchia: ...[@$!%*?&._-]...
        // Nuova:   ...[@$!%*?&._#-]...
        String passwordPattern = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&._#-])[A-Za-z\\d@$!%*?&._#-]{8,}$";

        if (!password.matches(passwordPattern)) {
            request.setAttribute("errore", "La password non rispetta i requisiti (usa solo @$!%*?&._#-)");
            // CORREZIONE QUI: Percorso allineato a quello del doGet
            request.getRequestDispatcher("/WEB-INF/jsp/registrazione_utente.jsp").forward(request, response);
            return;
        }

        if (email == null || username == null) {
            request.setAttribute("errore", "Campi obbligatori mancanti.");
            request.getRequestDispatcher("/WEB-INF/jsp/registrazione_utente.jsp").forward(request, response);
            return;
        }

        boolean successo = utenteService.registraUtente(nome, cognome, username, email, password, telefono);

        if (successo) {
            response.sendRedirect("login?registrazione=ok");
        } else {
            request.setAttribute("errore", "Email o Username gi√† esistenti.");
            request.getRequestDispatcher("/WEB-INF/jsp/registrazione_utente.jsp").forward(request, response);
        }
    }
}
</file>

<file path="src/main/java/model/bean/DropPoint.java">
package model.bean;

import model.bean.enums.StatoDropPoint;

public class DropPoint {

    private Long id;
    private String nomeAttivita;
    private String email;
    private String passwordHash;
    private String indirizzo;
    private String citta;
    private String provincia;
    private String telefono;
    private String orariApertura;
    private String descrizione;

    // Ora BLOB nel DB ‚Üí byte[] nel model
    private byte[] immagine;
    private String immagineContentType;

    private Double latitudine;
    private Double longitudine;
    private int ritiriEffettuati;

    private StatoDropPoint stato;

    public DropPoint() {}

    // Getters e Setters

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getNomeAttivita() {
        return nomeAttivita;
    }

    public void setNomeAttivita(String nomeAttivita) {
        this.nomeAttivita = nomeAttivita;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getPasswordHash() {
        return passwordHash;
    }

    public void setPasswordHash(String passwordHash) {
        this.passwordHash = passwordHash;
    }

    public String getIndirizzo() {
        return indirizzo;
    }

    public void setIndirizzo(String indirizzo) {
        this.indirizzo = indirizzo;
    }

    public String getCitta() {
        return citta;
    }

    public void setCitta(String citta) {
        this.citta = citta;
    }

    public String getProvincia() {
        return provincia;
    }

    public void setProvincia(String provincia) {
        this.provincia = provincia;
    }

    public String getTelefono() {
        return telefono;
    }

    public void setTelefono(String telefono) {
        this.telefono = telefono;
    }

    public String getOrariApertura() {
        return orariApertura;
    }

    public void setOrariApertura(String orariApertura) {
        this.orariApertura = orariApertura;
    }

    public String getDescrizione() {
        return descrizione;
    }

    public void setDescrizione(String descrizione) {
        this.descrizione = descrizione;
    }

    public byte[] getImmagine() {
        return immagine;
    }

    public void setImmagine(byte[] immagine) {
        this.immagine = immagine;
    }

    public String getImmagineContentType() {
        return immagineContentType;
    }

    public void setImmagineContentType(String immagineContentType) {
        this.immagineContentType = immagineContentType;
    }

    public Double getLatitudine() {
        return latitudine;
    }

    public void setLatitudine(Double latitudine) {
        this.latitudine = latitudine;
    }

    public Double getLongitudine() {
        return longitudine;
    }

    public void setLongitudine(Double longitudine) {
        this.longitudine = longitudine;
    }

    public int getRitiriEffettuati() {
        return ritiriEffettuati;
    }

    public void setRitiriEffettuati(int ritiriEffettuati) {
        this.ritiriEffettuati = ritiriEffettuati;
    }

    public StatoDropPoint getStato() {
        return stato;
    }

    public void setStato(StatoDropPoint stato) {
        this.stato = stato;
    }
}
</file>

<file path="src/main/java/model/bean/Reclamo.java">
package model.bean;

import model.bean.enums.StatoReclamo;

import java.sql.Timestamp;

public class Reclamo {

    private long id;
    private long idSegnalazione;
    private long idUtenteRichiedente;
    private String rispostaVerifica1;
    private String rispostaVerifica2;
    private Timestamp dataRichiesta;
    private StatoReclamo stato;

    // Gestione Consegna
    private String codiceConsegna;
    private Timestamp dataDeposito;
    private Timestamp dataRitiro;
    private boolean confermaFinder;
    private boolean confermaOwner;

    // Dati derivati dalla segnalazione associata (join)
    private String titoloSegnalazione;
    private byte[] immagineSegnalazione;
    private String immagineSegnalazioneContentType;

    public Reclamo() {}

    // Getters e Setters base

    public long getId() {
        return id;
    }

    public void setId(long id) {
        this.id = id;
    }

    public long getIdSegnalazione() {
        return idSegnalazione;
    }

    public void setIdSegnalazione(long idSegnalazione) {
        this.idSegnalazione = idSegnalazione;
    }

    public long getIdUtenteRichiedente() {
        return idUtenteRichiedente;
    }

    public void setIdUtenteRichiedente(long idUtenteRichiedente) {
        this.idUtenteRichiedente = idUtenteRichiedente;
    }

    public String getRispostaVerifica1() {
        return rispostaVerifica1;
    }

    public void setRispostaVerifica1(String rispostaVerifica1) {
        this.rispostaVerifica1 = rispostaVerifica1;
    }

    public String getRispostaVerifica2() {
        return rispostaVerifica2;
    }

    public void setRispostaVerifica2(String rispostaVerifica2) {
        this.rispostaVerifica2 = rispostaVerifica2;
    }

    public Timestamp getDataRichiesta() {
        return dataRichiesta;
    }

    public void setDataRichiesta(Timestamp dataRichiesta) {
        this.dataRichiesta = dataRichiesta;
    }

    public StatoReclamo getStato() {
        return stato;
    }

    public void setStato(StatoReclamo stato) {
        this.stato = stato;
    }

    public String getCodiceConsegna() {
        return codiceConsegna;
    }

    public void setCodiceConsegna(String codiceConsegna) {
        this.codiceConsegna = codiceConsegna;
    }

    public Timestamp getDataDeposito() {
        return dataDeposito;
    }

    public void setDataDeposito(Timestamp dataDeposito) {
        this.dataDeposito = dataDeposito;
    }

    public Timestamp getDataRitiro() {
        return dataRitiro;
    }

    public void setDataRitiro(Timestamp dataRitiro) {
        this.dataRitiro = dataRitiro;
    }

    public boolean isConfermaFinder() {
        return confermaFinder;
    }

    public void setConfermaFinder(boolean confermaFinder) {
        this.confermaFinder = confermaFinder;
    }

    public boolean isConfermaOwner() {
        return confermaOwner;
    }

    public void setConfermaOwner(boolean confermaOwner) {
        this.confermaOwner = confermaOwner;
    }

    // Dati derivati dalla segnalazione

    public String getTitoloSegnalazione() {
        return titoloSegnalazione;
    }

    public void setTitoloSegnalazione(String titoloSegnalazione) {
        this.titoloSegnalazione = titoloSegnalazione;
    }

    public byte[] getImmagineSegnalazione() {
        return immagineSegnalazione;
    }

    public void setImmagineSegnalazione(byte[] immagineSegnalazione) {
        this.immagineSegnalazione = immagineSegnalazione;
    }

    public String getImmagineSegnalazioneContentType() {
        return immagineSegnalazioneContentType;
    }

    public void setImmagineSegnalazioneContentType(String immagineSegnalazioneContentType) {
        this.immagineSegnalazioneContentType = immagineSegnalazioneContentType;
    }
}
</file>

<file path="src/main/java/model/service/EmailService.java">
package model.service;

import jakarta.mail.Authenticator;
import jakarta.mail.Message;
import jakarta.mail.MessagingException;
import jakarta.mail.PasswordAuthentication;
import jakarta.mail.Session;
import jakarta.mail.Transport;
import jakarta.mail.internet.InternetAddress;
import jakarta.mail.internet.MimeBodyPart;
import jakarta.mail.internet.MimeMessage;
import jakarta.mail.internet.MimeMultipart;

import java.nio.charset.StandardCharsets;
import java.util.Properties;

public class EmailService {
    private final Session session;
    private final String mittente;
    private final String nomeMittente = "Foundly";

    public EmailService() {
        Properties props = new Properties();
        props.put("mail.smtp.auth", "true");
        props.put("mail.smtp.starttls.enable", "true");
        props.put("mail.smtp.host", "smtp.gmail.com");
        props.put("mail.smtp.port", "587");

        this.mittente = "foundly.app@gmail.com";
        final String username = "foundly.app@gmail.com";
        final String password = System.getenv("SMTP_PASSKEY"); // app password

        this.session = Session.getInstance(props, new Authenticator() {
            @Override
            protected PasswordAuthentication getPasswordAuthentication() {
                return new PasswordAuthentication(username, password);
            }
        });
    }

    public void inviaCodiceRecuperoPassword(String destinatario, String codice)
            throws MessagingException {

        MimeMessage message = new MimeMessage(session);

        try {
            message.setFrom(new InternetAddress(mittente, nomeMittente, StandardCharsets.UTF_8.name()));
        } catch (Exception e) {
            message.setFrom(new InternetAddress(mittente));
        }

        message.setRecipients(Message.RecipientType.TO, InternetAddress.parse(destinatario));
        message.setSubject("Codice per il recupero password Foundly", StandardCharsets.UTF_8.name());

        // versione testo semplice
        String testoPlain =
                "Ciao,\n\n" +
                        "hai richiesto il recupero della password per il tuo account Foundly.\n\n" +
                        "Questo √® il tuo codice di verifica:\n\n" +
                        codice + "\n\n" +
                        "Inseriscilo nella pagina di recupero password e scegli una nuova password.\n\n" +
                        "Se non hai richiesto tu questo recupero, puoi ignorare questa email.\n\n" +
                        "Il team Foundly";

        // versione HTML pi√π curata
        String testoHtml =
                "<!DOCTYPE html>" +
                        "<html lang=\"it\">" +
                        "<head>" +
                        "  <meta charset=\"UTF-8\">" +
                        "  <title>Codice recupero password Foundly</title>" +
                        "</head>" +
                        "<body style=\"margin:0;padding:0;background-color:#f5f5f5;font-family:Roboto,Arial,sans-serif;\">" +
                        "  <table align=\"center\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"padding:24px 0;\">" +
                        "    <tr>" +
                        "      <td>" +
                        "        <table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" " +
                        "               style=\"max-width:520px;width:100%;background-color:#ffffff;border-radius:12px;" +
                        "                      box-shadow:0 4px 16px rgba(0,0,0,0.06);overflow:hidden;\">" +
                        "          <tr>" +
                        "            <td style=\"padding:18px 24px;background:linear-gradient(135deg,#FB8C00,#F57C00);color:#ffffff;\">" +
                        "              <div style=\"font-size:20px;font-weight:700;\">Foundly</div>" +
                        "              <div style=\"font-size:12px;opacity:0.9;\">Recupero password</div>" +
                        "            </td>" +
                        "          </tr>" +
                        "          <tr>" +
                        "            <td style=\"padding:24px 24px 16px 24px;color:#202124;font-size:14px;line-height:1.6;\">" +
                        "              <p style=\"margin:0 0 12px 0;\">Ciao,</p>" +
                        "              <p style=\"margin:0 0 12px 0;\">" +
                        "                hai richiesto il recupero della password per il tuo account <strong>Foundly</strong>." +
                        "              </p>" +
                        "              <p style=\"margin:0 0 8px 0;\">Questo √® il tuo codice di verifica:</p>" +
                        "            </td>" +
                        "          </tr>" +
                        "          <tr>" +
                        "            <td style=\"padding:0 24px 16px 24px;\">" +
                        "              <div style=\"text-align:center;margin:8px 0 16px 0;\">" +
                        "                <span style=\"" +
                        "                       display:inline-block;" +
                        "                       padding:12px 24px;" +
                        "                       border-radius:999px;" +
                        "                       background-color:#FFF3E0;" +
                        "                       color:#E65100;" +
                        "                       font-size:22px;" +
                        "                       font-weight:700;" +
                        "                       letter-spacing:4px;" +
                        "                       font-family:monospace;\">" +
                        codice +
                        "                </span>" +
                        "              </div>" +
                        "              <p style=\"margin:0 0 8px 0;font-size:13px;color:#5f6368;text-align:center;\">" +
                        "                Inserisci questo codice nella pagina di <strong>Recupero password</strong> e scegli una nuova password." +
                        "              </p>" +
                        "            </td>" +
                        "          </tr>" +
                        "          <tr>" +
                        "            <td style=\"padding:0 24px 20px 24px;color:#5f6368;font-size:12px;line-height:1.6;\">" +
                        "              <p style=\"margin:0 0 10px 0;\">" +
                        "                Se non hai richiesto tu questo recupero, puoi ignorare questa email in totale sicurezza." +
                        "              </p>" +
                        "              <p style=\"margin:0;\">" +
                        "                A presto,<br>" +
                        "                <span style=\"color:#E65100;font-weight:600;\">Il team Foundly</span>" +
                        "              </p>" +
                        "            </td>" +
                        "          </tr>" +
                        "          <tr>" +
                        "            <td style=\"padding:12px 24px 18px 24px;border-top:1px solid #eee;color:#9e9e9e;font-size:10px;text-align:center;\">" +
                        "              Non rispondere a questa email: il messaggio √® stato generato automaticamente." +
                        "            </td>" +
                        "          </tr>" +
                        "        </table>" +
                        "      </td>" +
                        "    </tr>" +
                        "  </table>" +
                        "</body>" +
                        "</html>";

        MimeBodyPart textPart = new MimeBodyPart();
        textPart.setText(testoPlain, StandardCharsets.UTF_8.name());

        MimeBodyPart htmlPart = new MimeBodyPart();
        htmlPart.setContent(testoHtml, "text/html; charset=UTF-8");

        MimeMultipart multipart = new MimeMultipart("alternative");
        multipart.addBodyPart(textPart);
        multipart.addBodyPart(htmlPart);

        message.setContent(multipart);

        message.setHeader("X-Mailer", "Foundly Mailer");
        message.setHeader("Content-Transfer-Encoding", "8bit");

        Transport.send(message);
    }
}
</file>

<file path="src/main/java/model/ConPool.java">
package model;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

public class ConPool {
    private static final String URL = "jdbc:mysql://foundly-db-salvolepore7.j.aivencloud.com:21893/defaultdb"
            + "?useSSL=true"
            + "&requireSSL=true"
            + "&verifyServerCertificate=false"
            + "&allowPublicKeyRetrieval=true"
            + "&serverTimezone=Europe/Rome"
            + "&enabledTLSProtocols=TLSv1.2,TLSv1.3";

    private static final String USER = "avnadmin";
    private static final String PASSWORD = System.getenv("DB_PASSKEY"); //Ciao

    static {
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
        } catch (ClassNotFoundException e) {
            throw new RuntimeException("Driver MySQL non trovato!", e);
        }
    }

    /**
     * Restituisce una connessione attiva al database.
     */
    public static Connection getConnection() throws SQLException {
        return DriverManager.getConnection(URL, USER, PASSWORD);
    }
}
</file>

<file path="src/main/webapp/css/login.css">
:root {
    /* Palette Colori Arancione (Stile Google/Material) */
    --primary-color: #FB8C00;
    --primary-hover: #F57C00;
    --primary-light: #FFE0B2;
    --text-dark: #202124;
    --text-grey: #5f6368;
    --bg-color: #f0f2f5;
    --white: #ffffff;
    --border-radius: 8px;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Roboto', sans-serif;
    background-color: var(--bg-color);
    color: var(--text-dark);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

/* --- CONTENITORE PRINCIPALE --- */
.main-container {
    display: flex;
    width: 100%;
    max-width: 1200px;
    min-height: 80vh;
    height: auto;
    background-color: var(--white);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

/* --- PARTE SINISTRA (Info) --- */
.info-section {
    position: relative;
    flex: 1;
    background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
    padding: 190px 60px 60px 60px; /* spazio tra logo e testo */
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}

/* Logo in alto a sinistra su schermi grandi */
.brand-header {
    position: absolute;
    top: 32px;
    left: 40px;
}

.brand-icon img {
    height: 150px;
    width: 150px;
    display: block;
}

.hero-text h1 {
    font-size: 3rem;
    line-height: 1.2;
    margin-bottom: 20px;
    color: var(--text-dark);
}

.hero-text p {
    font-size: 1.1rem;
    color: var(--text-grey);
    line-height: 1.6;
    margin-bottom: 30px;
}

.feature-pills {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.pill {
    background-color: rgba(255, 255, 255, 0.6);
    padding: 8px 16px;
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 500;
    color: #E65100;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* pill attiva evidenziata */
.pill.active {
    background-color: #ffffff;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    border: 1px solid #FF9800;
}

/* --- PARTE DESTRA (Form) --- */
.auth-section {
    flex: 1.2;
    padding: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--white);
}

.auth-card {
    width: 100%;
    max-width: 480px;
}

.auth-card h2 {
    font-size: 2rem;
    margin-bottom: 10px;
}

.subtitle {
    color: var(--text-grey);
    margin-bottom: 30px;
}

/* --- STILE INPUT --- */
.input-group {
    margin-bottom: 20px;
}

/* per righe affiancate */
.input-row {
    display: flex;
    gap: 15px;
}

.input-group label {
    display: block;
    font-size: 0.9rem;
    color: var(--text-grey);
    margin-bottom: 5px;
    font-weight: 500;
}

.input-group input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #dadce0;
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: all 0.3s ease;
    background-color: #fafafa;
}

.input-group input:focus {
    border-color: var(--primary-color);
    background-color: var(--white);
    outline: none;
    box-shadow: 0 0 0 3px rgba(251, 140, 0, 0.2);
}

/* --- BOTTONI --- */
.btn-primary {
    width: 100%;
    padding: 14px;
    background-color: var(--primary-color);
    color: var(--white);
    border: none;
    border-radius: var(--border-radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
}

.btn-primary:hover {
    background-color: var(--primary-hover);
    box-shadow: 0 4px 12px rgba(251, 140, 0, 0.3);
}

.mt-2 {
    margin-top: 20px;
}

/* Utility Links */
.form-actions {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 20px;
}

.forgot-password {
    color: var(--primary-color);
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
}

.back-link {
    margin-top: 20px;
    text-align: center;
    font-size: 0.9rem;
    color: var(--text-grey);
}

.back-link a {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
}

/* --- FOOTER FORM (login/registrazione) --- */
.form-footer {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    color: #666;
    font-size: 0.95rem;
}

.link-login {
    color: #FB8C00;
    font-weight: 600;
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.link-login:hover {
    background-color: #FFF3E0;
    color: #E65100;
}

/* --- BOTTONI REGISTRAZIONE / OSPITE (pagina login) --- */
.registration-area {
    margin-top: 24px;
    text-align: center;
}

.registration-area p {
    margin-bottom: 12px;
    color: #5f6368;
}

.reg-buttons {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

/* base comune per registrazione e ospite */
.btn-register,
.btn-guest {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 999px;
    font-size: 0.9rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    line-height: 1.2;
    white-space: nowrap;
}

/* stile registrazione */
.btn-register {
    border: 1px solid #FFB74D;
    background: #FFF7EC;
    color: #E65100;
}

.btn-register:hover {
    background: #FFE7CF;
    border-color: #FFA726;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
}

/* versione Drop Point */
.btn-register.drop {
    border-color: #FFCC80;
}

.btn-register.drop:hover {
    background: #FFE0C0;
}

/* stile per "Continua come ospite" */
.btn-guest {
    border: 1px solid #e0e0e0;
    background: #ffffff;
    color: var(--text-grey);
}

.btn-guest:hover {
    background: #f7f7f7;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.btn-register .material-icons,
.btn-guest .material-icons {
    font-size: 18px;
}

/* Desktop: "Continua come ospite" sotto ma non a tutta larghezza */
@media (min-width: 768px) {
    .reg-buttons {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
    }

    .reg-buttons .btn-guest {
        flex-basis: 100%; /* resta su una riga tutta sua */
        max-width: 220px; /* ma visivamente √® pi√π corto */
        margin-top: 4px;
        margin-inline: auto; /* centrato */
        padding: 8px 12px; /* un filo meno largo */
    }
}

/* --- STILE MAPPA (registrazione droppoint) --- */
#map {
    height: 250px;
    width: 100%;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #dadce0;
    z-index: 1;
}

.map-label {
    display: block;
    font-size: 0.9rem;
    color: var(--text-grey);
    margin-bottom: 8px;
    font-weight: 500;
}

/* --- RESPONSIVE MOBILE / TABLET --- */
@media (max-width: 960px) {
    .main-container {
        flex-direction: column;
        height: auto;
        min-height: auto;
    }

    .info-section {
        padding: 40px 30px;
        min-height: 300px;
    }

    .auth-section {
        padding: 40px 20px;
    }

    .hero-text h1 {
        font-size: 2.2rem;
    }

    /* Logo centrato sopra al testo su schermi medi/piccoli */
    .brand-header {
        position: static;
        margin-bottom: 24px;
        text-align: center;
    }

    .brand-icon img {
        height: 120px;
        width: auto;
        margin: 0 auto;
    }
}

/* --- FIX PER I RADIO BUTTON (Scelta Consegna) --- */

/* Impedisce che il pallino diventi largo quanto tutto lo schermo */
.input-group input[type="radio"] {
    width: auto !important;       /* Torna alla dimensione naturale */
    height: auto !important;
    margin-right: 8px;            /* Spazio tra pallino e testo */
    margin-bottom: 0;
    padding: 0;
    box-shadow: none;             /* Rimuove l'ombra degli input di testo */
    border: none;
    background-color: transparent;
}

/* Contenitore per mettere le due opzioni in riga */
.radio-container {
    display: flex;
    gap: 25px;       /* Spazio tra le due opzioni */
    margin-top: 8px;
}

/* Stile per l'etichetta cliccabile (pallino + testo) */
.radio-label {
    display: flex !important;     /* Forza allineamento orizzontale */
    align-items: center;
    font-weight: 500 !important;
    color: #333 !important;
    cursor: pointer;
    margin-bottom: 0 !important;  /* Rimuove il margine sotto */
    width: auto !important;       /* Non prendere tutta la riga */
}

.radio-label span {
    font-size: 0.95rem;
}
</file>

<file path="src/main/java/controller/IndexServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.service.SegnalazioneService;

import java.io.IOException;

@WebServlet(name = "IndexServlet", value = "/index")
public class IndexServlet extends HttpServlet {

    private final SegnalazioneService service = new SegnalazioneService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        // Se non arrivo da una SearchServlet che ha gi√† settato "segnalazioni"
        if (request.getAttribute("segnalazioni") == null) {
            request.setAttribute("segnalazioni", service.getUltimeSegnalazioni());
        }

        // NOTA: ora punta a home.jsp
        request.getRequestDispatcher("/WEB-INF/jsp/home.jsp")
                .forward(request, response);
    }
}
</file>

<file path="src/main/java/controller/RecuperoPasswordServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import model.bean.Utente;
import model.service.EmailService;
import model.service.UtenteService;

import java.io.IOException;
import java.security.SecureRandom;

@WebServlet(name = "RecuperoPasswordServlet", value = "/recupero-password")
public class RecuperoPasswordServlet extends HttpServlet {

    private final UtenteService utenteService = new UtenteService();
    private final EmailService emailService = new EmailService();

    // durata codice in millisecondi (es. 15 minuti)
    private static final long DURATA_CODICE_MS = 15 * 60 * 1000L;

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {
        request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_email.jsp")
                .forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        String step = request.getParameter("step");
        if (step == null || step.isEmpty()) {
            step = "email";
        }

        if ("email".equals(step)) {
            gestisciStepEmail(request, response);
        } else if ("codice".equals(step)) {
            gestisciStepCodice(request, response);
        } else {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST, "Step non valido");
        }
    }

    private void gestisciStepEmail(HttpServletRequest request,
                                   HttpServletResponse response) throws ServletException, IOException {

        String email = request.getParameter("email");
        HttpSession session = request.getSession();

        // Non riveliamo se l'email esiste o meno:
        // ma se esiste, generiamo codice e inviamo mail.

        Utente utente = utenteService.trovaPerEmail(email);
        if (utente != null) {
            // genera codice 6 cifre
            String codice = generaCodiceSeiCifre();

            long scadenza = System.currentTimeMillis() + DURATA_CODICE_MS;

            session.setAttribute("recuperoEmail", email);
            session.setAttribute("recuperoCodice", codice);
            session.setAttribute("recuperoScadenza", scadenza);

            try {
                emailService.inviaCodiceRecuperoPassword(email, codice);
            } catch (Exception e) {
                e.printStackTrace();
                // NON diciamo all'utente che √® fallito, per sicurezza
            }
        }

        // Messaggio generico, anche se utente == null
        request.setAttribute("messaggio",
                "Se l'email esiste nel sistema, riceverai un codice di verifica a breve.");
        // Mostra pagina per inserire codice + nuova password
        request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_codice.jsp")
                .forward(request, response);
    }

    private void gestisciStepCodice(HttpServletRequest request,
                                    HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        if (session == null) {
            request.setAttribute("errore",
                    "Sessione di recupero scaduta. Ripeti la procedura.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_email.jsp")
                    .forward(request, response);
            return;
        }

        String emailSession = (String) session.getAttribute("recuperoEmail");
        String codiceSession = (String) session.getAttribute("recuperoCodice");
        Long scadenza = (Long) session.getAttribute("recuperoScadenza");

        if (emailSession == null || codiceSession == null || scadenza == null) {
            request.setAttribute("errore",
                    "Sessione di recupero non valida. Ripeti la procedura.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_email.jsp")
                    .forward(request, response);
            return;
        }

        if (System.currentTimeMillis() > scadenza) {
            // codice scaduto
            session.removeAttribute("recuperoEmail");
            session.removeAttribute("recuperoCodice");
            session.removeAttribute("recuperoScadenza");

            request.setAttribute("errore",
                    "Il codice √® scaduto. Richiedi un nuovo codice.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_email.jsp")
                    .forward(request, response);
            return;
        }

        String codiceInserito = request.getParameter("codice");
        String nuovaPassword = request.getParameter("nuovaPassword");
        String confermaPassword = request.getParameter("confermaPassword");

        // verifica codice
        if (codiceInserito == null || !codiceInserito.equals(codiceSession)) {
            request.setAttribute("errore", "Codice non valido.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_codice.jsp")
                    .forward(request, response);
            return;
        }

        // verifica password + conferma
        if (nuovaPassword == null || confermaPassword == null ||
                !nuovaPassword.equals(confermaPassword)) {

            request.setAttribute("errore", "Le password non coincidono.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_codice.jsp")
                    .forward(request, response);
            return;
        }

        // opzionale: applica gli stessi controlli di sicurezza delle altre password
        String patternPassword =
                "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&._-])[A-Za-z\\d@$!%*?&._-]{8,}$";

        if (!nuovaPassword.matches(patternPassword)) {
            request.setAttribute("errore",
                    "La password non rispetta i requisiti di sicurezza.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_codice.jsp")
                    .forward(request, response);
            return;
        }

        // aggiorna password nel DB
        boolean aggiornato = utenteService.resetPasswordByEmail(emailSession, nuovaPassword);
        // implementa resetPasswordByEmail(email, nuovaPassword) nel tuo service

        // pulizia attributi di sessione
        session.removeAttribute("recuperoEmail");
        session.removeAttribute("recuperoCodice");
        session.removeAttribute("recuperoScadenza");

        if (!aggiornato) {
            request.setAttribute("errore",
                    "Si √® verificato un errore durante l'aggiornamento della password.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_codice.jsp")
                    .forward(request, response);
            return;
        }

        // scenario: mostra messaggio e reindirizza al login
        request.setAttribute("messaggioSuccesso", "Password aggiornata con successo. Ora puoi accedere.");
        request.getRequestDispatcher("/WEB-INF/jsp/login.jsp")
                .forward(request, response);
    }

    private String generaCodiceSeiCifre() {
        SecureRandom random = new SecureRandom();
        int codice = random.nextInt(1_000_000); // 0..999999
        return String.format("%06d", codice);
    }
}
</file>

<file path="src/main/webapp/WEB-INF/jsp/classifica.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="model.bean.Utente" %>
<%@ page import="model.bean.DropPoint" %>
<%@ page import="java.util.List" %>

<%
    // Controllo sessione: se sei un Drop-Point ‚Üí Area Drop-Point
    DropPoint dpSession = (DropPoint) session.getAttribute("dropPoint");
    Utente utenteLoggato = (Utente) session.getAttribute("utente");

    if (dpSession != null) {
        response.sendRedirect(request.getContextPath() + "/area-drop-point");
        return;
    }
    if (utenteLoggato == null) {
        response.sendRedirect(request.getContextPath() + "/login");
        return;
    }

    // Recupero dati classifica dalla servlet
    @SuppressWarnings("unchecked")
    List<Utente> classifica = (List<Utente>) request.getAttribute("classifica");

    // Avatar navbar: BLOB byte[]
    boolean navHasAvatar = utenteLoggato.getImmagineProfilo() != null &&
            utenteLoggato.getImmagineProfilo().length > 0;
%>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Classifica - Foundly</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/index.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/classifica.css?v=3">
</head>
<body class="page-enter">

<nav class="navbar">
    <a href="${pageContext.request.contextPath}/index" class="brand">
        <div class="brand-icon">
            <img src="${pageContext.request.contextPath}/assets/images/logo.png" alt="Foundly">
        </div>
    </a>
    <div class="nav-links">
        <a href="${pageContext.request.contextPath}/index" class="nav-item">
            <span class="material-icons">home</span> Home
        </a>
        <a href="${pageContext.request.contextPath}/crea-segnalazione" class="nav-item">
            <span class="material-icons">add_circle_outline</span> Crea Segnalazione
        </a>
        <a href="${pageContext.request.contextPath}/le-mie-segnalazioni" class="nav-item">
            <span class="material-icons">inventory</span> Le mie Segnalazioni
        </a>
        <a href="${pageContext.request.contextPath}/drop-point" class="nav-item">
            <span class="material-icons">place</span> Drop-Point
        </a>
        <a href="${pageContext.request.contextPath}/classifica" class="nav-item active">
            <span class="material-icons">emoji_events</span> Classifica
        </a>
    </div>

    <div class="user-menu">
        <button type="button" class="user-avatar-btn">
            <% if (navHasAvatar) { %>
            <img src="<%= request.getContextPath() %>/avatar?userId=<%= utenteLoggato.getId() %>"
                 class="user-avatar-img" alt="">
            <% } else { %>
            <div class="user-avatar-placeholder"></div>
            <% } %>
        </button>
        <div class="user-dropdown">
            <div class="user-dropdown-header">
                <div class="user-email"><%= utenteLoggato.getEmail() %></div>
                <div class="user-points-row">
                    <span class="points-label">punti</span>
                    <span class="points-value"><%= utenteLoggato.getPunteggio() %></span>
                </div>
            </div>
            <a href="${pageContext.request.contextPath}/profilo" class="user-dropdown-item">
                <span class="material-icons">person</span><span>Profilo</span>
            </a>
            <a href="${pageContext.request.contextPath}/logout" class="user-dropdown-item user-dropdown-item-logout">
                <span class="material-icons">logout</span><span>Logout</span>
            </a>
        </div>
    </div>
</nav>

<main class="classifica-main">

    <header class="classifica-header">
        <h1>I Campioni di Foundly</h1>
        <p>Grazie a voi la community cresce e gli oggetti tornano a casa.</p>
    </header>

    <% if (classifica == null || classifica.isEmpty()) { %>
    <div class="empty-state">
        <span class="material-icons empty-icon">emoji_events</span>
        <h3>La classifica √® ancora vuota!</h3>
        <p>Sii il primo a completare una restituzione.</p>
    </div>
    <% } else { %>

    <section class="podium-container">
        <%
            Utente first  = classifica.size() > 0 ? classifica.get(0) : null;
            Utente second = classifica.size() > 1 ? classifica.get(1) : null;
            Utente third  = classifica.size() > 2 ? classifica.get(2) : null;
        %>

        <%-- SECONDO POSTO --%>
        <% if (second != null) {
            String[] b2 = getBadgeInfo(second.getBadge()); // Calcolo badge
        %>
        <div class="podium-step step-silver">
            <div class="medal-icon">ü•à</div>
            <div class="podium-avatar">
                <% boolean secondHasAvatar = second.getImmagineProfilo() != null && second.getImmagineProfilo().length > 0; %>
                <% if (secondHasAvatar) { %>
                <img src="<%= request.getContextPath() %>/avatar?userId=<%= second.getId() %>" class="podium-img" alt="">
                <% } else { %>
                <div class="podium-placeholder"><%= second.getNome().charAt(0) %></div>
                <% } %>
            </div>
            <div class="podium-info">
                <span class="podium-name"><%= second.getNome() %> <%= second.getCognome() %></span>
                <span class="badge-tag <%= b2[1] %>" style="margin-top: 4px;"><%= b2[0] %></span>
                <span class="podium-points"><%= second.getPunteggio() %> pt</span>
            </div>
            <div class="podium-base">2</div>
        </div>
        <% } %>

        <%-- PRIMO POSTO --%>
        <% if (first != null) {
            String[] b1 = getBadgeInfo(first.getBadge()); // Calcolo badge
        %>
        <div class="podium-step step-gold">
            <div class="crown-icon">üëë</div>
            <div class="podium-avatar">
                <% boolean firstHasAvatar = first.getImmagineProfilo() != null && first.getImmagineProfilo().length > 0; %>
                <% if (firstHasAvatar) { %>
                <img src="<%= request.getContextPath() %>/avatar?userId=<%= first.getId() %>" class="podium-img" alt="">
                <% } else { %>
                <div class="podium-placeholder"><%= first.getNome().charAt(0) %></div>
                <% } %>
            </div>
            <div class="podium-info">
                <span class="podium-name"><%= first.getNome() %> <%= first.getCognome() %></span>
                <span class="podium-badge">üèÜ Campione</span>
                <span class="badge-tag <%= b1[1] %>" style="margin-top: 4px;"><%= b1[0] %></span>
                <span class="podium-points"><%= first.getPunteggio() %> pt</span>
            </div>
            <div class="podium-base">1</div>
        </div>
        <% } %>

        <%-- TERZO POSTO --%>
        <% if (third != null) {
            String[] b3 = getBadgeInfo(third.getBadge()); // Calcolo badge
        %>
        <div class="podium-step step-bronze">
            <div class="medal-icon">ü•â</div>
            <div class="podium-avatar">
                <% boolean thirdHasAvatar = third.getImmagineProfilo() != null && third.getImmagineProfilo().length > 0; %>
                <% if (thirdHasAvatar) { %>
                <img src="<%= request.getContextPath() %>/avatar?userId=<%= third.getId() %>" class="podium-img" alt="">
                <% } else { %>
                <div class="podium-placeholder"><%= third.getNome().charAt(0) %></div>
                <% } %>
            </div>
            <div class="podium-info">
                <span class="podium-name"><%= third.getNome() %> <%= third.getCognome() %></span>
                <span class="badge-tag <%= b3[1] %>" style="margin-top: 4px;"><%= b3[0] %></span>
                <span class="podium-points"><%= third.getPunteggio() %> pt</span>
            </div>
            <div class="podium-base">3</div>
        </div>
        <% } %>
    </section>

    <% if (classifica.size() > 3) { %>
    <section class="ranking-list-section">
        <h3>Top Contributors</h3>
        <div class="table-card">
            <table class="ranking-table">
                <thead>
                <tr>
                    <th class="col-rank">#</th>
                    <th class="col-user">Utente</th>
                    <th class="col-badge">Livello</th>
                    <th class="col-points">Punti</th>
                </tr>
                </thead>
                <tbody>
                <%
                    for (int i = 3; i < Math.min(classifica.size(), 15); i++) {
                        Utente u = classifica.get(i);
                        int rank = i + 1;

                        // USIAMO LA FUNZIONE HELPER ANCHE QUI
                        String[] bInfo = getBadgeInfo(u.getBadge());
                        String badgeName = bInfo[0];
                        String badgeClass = bInfo[1];

                        boolean isMe = utenteLoggato.getId() == u.getId();
                        boolean uHasAvatar =
                                u.getImmagineProfilo() != null &&
                                        u.getImmagineProfilo().length > 0;
                %>
                <tr class="<%= isMe ? "highlight-me" : "" %>">
                    <td class="col-rank"><span class="rank-circle"><%= rank %></span></td>

                    <td class="col-user">
                        <div class="user-row-info">
                            <% if (uHasAvatar) { %>
                            <img src="<%= request.getContextPath() %>/avatar?userId=<%= u.getId() %>"
                                 class="mini-avatar-img" alt="">
                            <% } else { %>
                            <div class="mini-avatar-placeholder"><%= u.getNome().charAt(0) %></div>
                            <% } %>

                            <div class="user-data">
                                <span class="u-name"><%= u.getNome() %> <%= u.getCognome() %></span>
                                <span class="u-username">@<%= u.getUsername() %></span>
                            </div>
                        </div>
                    </td>

                    <td class="col-badge">
                        <span class="badge-tag <%= badgeClass %>"><%= badgeName %></span>
                    </td>
                    <td class="col-points">
                        <%= u.getPunteggio() %>
                    </td>
                </tr>
                <% } %>
                </tbody>
            </table>
        </div>
    </section>
    <% } %>

    <% } %>

</main>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const userMenu = document.querySelector(".user-menu");
        if (userMenu) {
            const btn = userMenu.querySelector(".user-avatar-btn");
            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                userMenu.classList.toggle("open");
            });
            document.addEventListener("click", () => userMenu.classList.remove("open"));
        }
    });
</script>

</body>
</html>

<%!
    // Metodo helper per calcolare il badge (Nome e Classe CSS)
    private String[] getBadgeInfo(String rawBadge) {
        String badgeName = "Novizio";
        String badgeClass = "bg-gray";

        if ("OCCHIO_DI_FALCO".equals(rawBadge)) {
            badgeName = "Occhio di Falco";
            badgeClass = "bg-bronze";
        } else if ("DETECTIVE".equals(rawBadge)) {
            badgeName = "Detective";
            badgeClass = "bg-silver";
        } else if ("SHERLOCK_HOLMES".equals(rawBadge)) {
            badgeName = "Sherlock";
            badgeClass = "bg-gold";
        }

        return new String[]{badgeName, badgeClass};
    }
%>
</file>

<file path="src/main/webapp/WEB-INF/jsp/drop_point.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="java.util.List" %>
<%@ page import="model.bean.Utente" %>
<%@ page import="model.bean.DropPoint" %>

<%
    Utente utente = (Utente) session.getAttribute("utente");

    List<DropPoint> dropPoints = (List<DropPoint>) request.getAttribute("dropPoints");
    int countDropPoints = (dropPoints != null) ? dropPoints.size() : 0;
%>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Drop-Point - Foundly</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Leaflet -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/index.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/drop_point.css">
</head>
<body class="page-enter">

<jsp:include page="/WEB-INF/jsp/navbar.jsp" />

<!-- CONTENUTO -->
<main class="dp-main">

    <!-- Header pagina -->
    <section class="dp-header-card">
        <div class="dp-header-top">
            <div>
                <h1 class="dp-title">Drop-Point</h1>
                <p class="dp-subtitle">
                    Trova i punti di consegna autorizzati nella tua citt√†
                </p>
            </div>

            <a href="${pageContext.request.contextPath}/registrazione-droppoint"
               class="dp-register-btn">
                <span class="material-icons">add</span>
                Registra la Tua Attivit√†
            </a>
        </div>

        <!-- barra ricerca -->
        <div class="dp-search-wrapper">
            <span class="material-icons dp-search-icon">search</span>
            <input type="text"
                   class="dp-search-input"
                   placeholder="Cerca per nome, citt√† o indirizzo...">
        </div>
    </section>

    <!-- Card info + toggle -->
    <section class="dp-info-card">
        <div class="dp-info-left">
            <div class="dp-info-icon">
                <span class="material-icons">storefront</span>
            </div>
            <div class="dp-info-text">
                <span class="dp-info-label">Drop-Point Disponibili</span>
                <span class="dp-info-value"><%= countDropPoints %></span>
            </div>
        </div>

        <div class="dp-view-toggle">
            <button class="dp-toggle-btn dp-toggle-btn-active" id="btnViewMap">
                <span class="material-icons">map</span>
                <span>Mappa</span>
            </button>
            <button class="dp-toggle-btn" id="btnViewList">
                <span class="material-icons">list</span>
                <span>Elenco</span>
            </button>
        </div>
    </section>

    <!-- Contenitore mappa / lista -->
    <section class="dp-map-card">
        <div id="dpMapContainer" class="dp-map-container"></div>

        <div id="dpListContainer" class="dp-list-container">
            <%
                if (dropPoints == null || dropPoints.isEmpty()) {
            %>
            <p class="dp-empty">Nessun Drop-Point disponibile.</p>
            <%
            } else {
                for (DropPoint dp : dropPoints) {

                    boolean hasLogo = (dp.getImmagine() != null &&
                            dp.getImmagine().length > 0);
            %>
            <article class="dp-list-item">
                <!-- COLONNA IMMAGINE A SINISTRA -->
                <div class="dp-list-thumb">
                    <% if (hasLogo) { %>
                    <img
                            src="<%= request.getContextPath() %>/drop-point-avatar?dpId=<%= dp.getId() %>"
                            alt="Logo <%= dp.getNomeAttivita() %>"
                            class="dp-list-thumb-img">
                    <% } else { %>
                    <div class="dp-list-thumb-placeholder">
                        <span class="material-icons">storefront</span>
                    </div>
                    <% } %>
                </div>

                <!-- COLONNA TESTO A DESTRA -->
                <div class="dp-list-content">
                    <h3 class="dp-list-title"><%= dp.getNomeAttivita() %></h3>
                    <p class="dp-list-address">
                        <%= dp.getIndirizzo() %>, <%= dp.getCitta() %> (<%= dp.getProvincia() %>)
                    </p>
                    <p class="dp-list-phone">
                        <span class="material-icons">phone</span>
                        <span><%= dp.getTelefono() != null ? dp.getTelefono() : "-" %></span>
                    </p>
                    <p class="dp-list-hours">
                        <span class="material-icons">schedule</span>
                        <span><%= dp.getOrariApertura() != null ? dp.getOrariApertura() : "Orari non disponibili" %></span>
                    </p>
                </div>
            </article>
            <%
                    }
                }
            %>
        </div>
    </section>

</main>

<!-- Leaflet + JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    // ====== DATI DAL SERVER ======
    const dropPointsData = [
        <% if (dropPoints != null) {
               for (int i = 0; i < dropPoints.size(); i++) {
                   DropPoint dp = dropPoints.get(i);
                   Double lat = dp.getLatitudine();
                   Double lng = dp.getLongitudine();
        %>
        {
            id: <%= dp.getId() %>,
            name: "<%= dp.getNomeAttivita().replace("\"", "\\\"") %>",
            address: "<%= dp.getIndirizzo().replace("\"", "\\\"") %>",
            city: "<%= dp.getCitta().replace("\"", "\\\"") %>",
            lat: <%= lat != null ? lat.toString() : "null" %>,
            lng: <%= lng != null ? lng.toString() : "null" %>
        }<%= (i < dropPoints.size() - 1) ? "," : "" %>
        <%     }
           } %>
    ];

    // ====== MAPPA LEAFLET ======
    const defaultCenter = [41.9028, 12.4964]; // Roma
    let mapCenter = defaultCenter;
    if (dropPointsData.length > 0 && dropPointsData[0].lat != null && dropPointsData[0].lng != null) {
        mapCenter = [dropPointsData[0].lat, dropPointsData[0].lng];
    }

    const map = L.map('dpMapContainer').setView(mapCenter, 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);

    function renderMarkers(filterText) {
        const q = (filterText || "").toLowerCase();
        markersLayer.clearLayers();

        dropPointsData.forEach(dp => {
            if (dp.lat == null || dp.lng == null) return;

            const haystack = (dp.name + " " + dp.address + " " + dp.city).toLowerCase();
            if (!q || haystack.includes(q)) {
                L.marker([dp.lat, dp.lng])
                    .addTo(markersLayer)
                    .bindPopup(
                        '<strong>' + dp.name + '</strong><br>' +
                        dp.address + '<br>' +
                        dp.city
                    );
            }
        });
    }

    // ====== TOGGLE MAPPA / ELENCO ======
    const btnViewMap = document.getElementById('btnViewMap');
    const btnViewList = document.getElementById('btnViewList');
    const mapContainer = document.getElementById('dpMapContainer');
    const listContainer = document.getElementById('dpListContainer');

    function setView(view) {
        if (view === 'map') {
            mapContainer.style.display = 'block';
            listContainer.style.display = 'none';
            btnViewMap.classList.add('dp-toggle-btn-active');
            btnViewList.classList.remove('dp-toggle-btn-active');
            map.invalidateSize();
        } else {
            mapContainer.style.display = 'none';
            listContainer.style.display = 'block';
            btnViewMap.classList.remove('dp-toggle-btn-active');
            btnViewList.classList.add('dp-toggle-btn-active');
        }
    }

    btnViewMap.addEventListener('click', () => setView('map'));
    btnViewList.addEventListener('click', () => setView('list'));

    // vista iniziale
    setView('map');
    renderMarkers("");

    // ====== RICERCA (mappa + elenco) ======
    const searchInput = document.querySelector(".dp-search-input");

    if (searchInput) {
        searchInput.addEventListener("input", function () {
            const q = this.value.trim().toLowerCase();

            // filtra elenco
            document.querySelectorAll(".dp-list-item").forEach(item => {
                const text = item.innerText.toLowerCase();
                item.style.display = (!q || text.includes(q)) ? "block" : "none";
            });

            // filtra marker
            renderMarkers(q);
        });
    }
</script>

</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/jsp/login.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundly - Login</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">
</head>
<body>

<div class="main-container">

    <div class="info-section">
        <div class="brand-header">
            <div class="brand-icon">
                <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
            </div>
        </div>

        <div class="hero-text">
            <h1>Hai perso qualcosa?</h1>
            <p>
                Foundly ti aiuta a ritrovare oggetti e animali smarriti grazie alla nostra community.
                Segnala uno smarrimento, cerca tra i ritrovamenti e restituisci in sicurezza tramite i nostri
                Drop-Point.
            </p>
            <div class="feature-pills">
                <span class="pill"><span class="material-icons">security</span> Secure Claim</span>
                <span class="pill"><span class="material-icons">store</span> Drop-Points</span>
                <span class="pill"><span class="material-icons">emoji_events</span> Scoreboard</span>
            </div>
        </div>
    </div>

    <div class="auth-section">
        <div class="auth-card">
            <h2>Accedi</h2>
            <p class="subtitle">Benvenuto su Foundly</p>

            <form action="${pageContext.request.contextPath}/login" method="post">

                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="nome@esempio.com" required>
                </div>

                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Inserisci la tua password"
                           required>
                </div>

                <div class="form-actions">
                    <a href="${pageContext.request.contextPath}/recupero-password" class="forgot-password">
                        Password dimenticata?
                    </a>
                </div>

                <button type="submit" class="btn-primary">Accedi</button>
            </form>

            <div class="registration-area">
                <p>Non hai un account?</p>
                <div class="reg-buttons">
                    <a href="${pageContext.request.contextPath}/registrazione-utente" class="btn-register">
                        <span class="material-icons">person</span>
                        <span>Registrati come Utente</span>
                    </a>
                    <a href="${pageContext.request.contextPath}/registrazione-droppoint" class="btn-register drop">
                        <span class="material-icons">storefront</span>
                        <span>Registrati come Drop Point</span>
                    </a>
                    <a href="${pageContext.request.contextPath}/index" class="btn-guest">
                        <span class="material-icons">arrow_back</span>
                        <span>Continua come ospite</span>
                    </a>
                </div>
            </div>

        </div>
    </div>
</div>

</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/jsp/segnalazioni_e_reclami.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>

<%
    model.bean.DropPoint dp = (model.bean.DropPoint) session.getAttribute("dropPoint");
    model.bean.Utente u = (model.bean.Utente) session.getAttribute("utente");

    if (dp != null) {
        response.sendRedirect(request.getContextPath() + "/area-drop-point");
        return;
    }
    if (u == null) {
        response.sendRedirect(request.getContextPath() + "/login");
        return;
    }
%>
<!DOCTYPE html>
<html lang="it">
<head>
    <title>Segnalazioni e Reclami - Foundly</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/index.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/segnalazioni_e_reclami.css?v=2">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

<jsp:include page="navbar.jsp" />

<div class="page-wrapper">

    <header class="page-header">
        <h1 class="page-title">Gestione Attivit√†</h1>
        <p class="page-subtitle">
            Qui trovi le segnalazioni che hai pubblicato e i reclami che hai inviato.
        </p>
    </header>

    <div class="tabs">
        <button class="tab-button active" data-target="tab-segnalazioni">
            <span class="material-icons tab-icon">campaign</span>
            Le Mie Segnalazioni
        </button>
        <button class="tab-button" data-target="tab-reclami">
            <span class="material-icons tab-icon">back_hand</span>
            I Miei Reclami
        </button>
    </div>

    <!-- TAB SEGNALAZIONI -->
    <section id="tab-segnalazioni" class="tab-content active">
        <div class="section-header">
            <h2>Oggetti che hai trovato</h2>
            <a href="${pageContext.request.contextPath}/crea-segnalazione" class="btn-primary">
                <span class="material-icons">add</span> Nuova segnalazione
            </a>
        </div>

        <c:if test="${empty mieSegnalazioni}">
            <div class="empty-state">
                <span class="material-icons empty-icon">search_off</span>
                <h3>Nessuna segnalazione pubblicata</h3>
                <p>Non hai ancora segnalato oggetti ritrovati.</p>
            </div>
        </c:if>

        <c:if test="${not empty mieSegnalazioni}">
            <div class="cards-column">
                <c:forEach var="s" items="${mieSegnalazioni}">
                    <article class="card-row">

                        <!-- IMMAGINE A SINISTRA (SEGNALAZIONE) -->
                        <div class="card-thumb">
                            <c:choose>
                                <c:when test="${not empty s.immagine}">
                                    <div class="card-thumb-img-wrapper">
                                        <img
                                                src="${pageContext.request.contextPath}/segnalazione-img?id=${s.id}"
                                                alt="Immagine segnalazione ${s.titolo}"
                                                class="card-thumb-img">
                                    </div>
                                </c:when>
                                <c:otherwise>
                                    <div class="card-thumb-placeholder">
                                        <span class="material-icons">inventory_2</span>
                                    </div>
                                </c:otherwise>
                            </c:choose>
                        </div>

                        <!-- CONTENUTO CENTRALE -->
                        <div class="card-main">
                            <div class="card-badges">
                                <span class="badge ${s.stato == 'CHIUSA' ? 'badge-closed' : 'badge-active'}">
                                        ${s.stato}
                                </span>
                            </div>

                            <h3 class="card-title">${s.titolo}</h3>

                            <p class="card-info">
                                <span class="material-icons card-info-icon">place</span>
                                    ${s.citta}
                                &nbsp;‚Ä¢&nbsp;
                                <fmt:formatDate value="${s.dataRitrovamento}" pattern="dd MMM" />
                            </p>
                        </div>

                        <!-- AZIONI A DESTRA -->
                        <div class="card-actions">
                            <a href="${pageContext.request.contextPath}/dettaglio-segnalazione?id=${s.id}"
                               class="btn-secondary">
                                Gestisci
                            </a>

                            <form method="post"
                                  action="${pageContext.request.contextPath}/elimina-segnalazione"
                                  class="delete-form">
                                <input type="hidden" name="id" value="${s.id}">
                                <button type="submit"
                                        class="icon-button"
                                        title="Elimina segnalazione"
                                        onclick="return confirm('Vuoi davvero eliminare questa segnalazione?');">
                                    <span class="material-icons">delete</span>
                                </button>
                            </form>
                        </div>

                    </article>
                </c:forEach>
            </div>
        </c:if>
    </section>

    <!-- TAB RECLAMI -->
    <section id="tab-reclami" class="tab-content">
        <div class="section-header">
            <h2>Oggetti che hai reclamato</h2>
        </div>

        <c:if test="${empty mieiReclami}">
            <div class="empty-state">
                <span class="material-icons empty-icon">support_agent</span>
                <h3>Nessun reclamo attivo</h3>
                <p>Non hai inviato richieste di restituzione per oggetti smarriti.</p>
            </div>
        </c:if>

        <c:if test="${not empty mieiReclami}">
            <div class="cards-column">
                <c:forEach var="r" items="${mieiReclami}">
                    <article class="card-row">

                        <!-- IMMAGINE DELLA SEGNALAZIONE COLLEGATA AL RECLAMO -->
                        <div class="card-thumb">
                            <c:choose>
                                <c:when test="${not empty r.immagineSegnalazione}">
                                    <div class="card-thumb-img-wrapper">
                                        <img
                                                src="${pageContext.request.contextPath}/segnalazione-img?id=${r.idSegnalazione}"
                                                alt="Immagine segnalazione reclamata"
                                                class="card-thumb-img">
                                    </div>
                                </c:when>
                                <c:otherwise>
                                    <div class="card-thumb-placeholder">
                                        <span class="material-icons">help_outline</span>
                                    </div>
                                </c:otherwise>
                            </c:choose>
                        </div>

                        <!-- TESTO -->
                        <div class="card-main">
                            <div class="card-badges">
                                <span class="badge badge-reclamo">RECLAMO</span>
                                <span class="badge
                                    ${r.stato == 'ACCETTATO' ? 'badge-active' :
                                      (r.stato == 'RIFIUTATO' ? 'badge-closed' : 'badge-type')}">
                                        ${r.stato}
                                </span>
                            </div>

                            <h3 class="card-title">${r.titoloSegnalazione}</h3>

                            <p class="card-info">
                                Richiesto il:
                                <fmt:formatDate value="${r.dataRichiesta}" pattern="dd MMM yyyy" />
                            </p>
                        </div>

                        <div class="card-actions">
                            <a href="${pageContext.request.contextPath}/dettaglio-segnalazione?id=${r.idSegnalazione}"
                               class="btn-secondary">
                                Vedi Stato
                            </a>
                        </div>

                    </article>
                </c:forEach>
            </div>
        </c:if>
    </section>

</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const buttons = document.querySelectorAll(".tab-button");
        const tabs = document.querySelectorAll(".tab-content");

        buttons.forEach(btn => {
            btn.addEventListener("click", () => {
                buttons.forEach(b => b.classList.remove("active"));
                tabs.forEach(t => t.classList.remove("active"));

                btn.classList.add("active");
                const targetId = btn.dataset.target;
                document.getElementById(targetId).classList.add("active");
            });
        });
    });
</script>

</body>
</html>
</file>

<file path="pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.example</groupId>
    <artifactId>Foundly</artifactId>
    <version>1.0-SNAPSHOT</version>
    <name>Foundly</name>
    <packaging>war</packaging>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.target>23</maven.compiler.target>
        <maven.compiler.source>23</maven.compiler.source>
        <junit.version>5.11.0</junit.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>jakarta.servlet</groupId>
            <artifactId>jakarta.servlet-api</artifactId>
            <version>6.1.0</version>
            <scope>provided</scope>
        </dependency>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-api</artifactId>
            <version>${junit.version}</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-engine</artifactId>
            <version>${junit.version}</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
            <version>9.2.0</version>
        </dependency>
        <dependency>
            <groupId>org.apache.tomcat</groupId>
            <artifactId>tomcat-jdbc</artifactId>
            <version>11.0.4</version>
        </dependency>

        <dependency>
            <groupId>org.mindrot</groupId>
            <artifactId>jbcrypt</artifactId>
            <version>0.4</version>
        </dependency>

        <dependency>
            <groupId>com.sun.mail</groupId>
            <artifactId>jakarta.mail</artifactId>
            <version>2.0.1</version>
        </dependency>

        <dependency>
            <groupId>org.json</groupId>
            <artifactId>json</artifactId>
            <version>20231013</version>
        </dependency>

        <dependency>
            <groupId>jakarta.servlet.jsp.jstl</groupId>
            <artifactId>jakarta.servlet.jsp.jstl-api</artifactId>
            <version>3.0.0</version>
        </dependency>
        <dependency>
            <groupId>org.glassfish.web</groupId>
            <artifactId>jakarta.servlet.jsp.jstl</artifactId>
            <version>3.0.1</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-war-plugin</artifactId>
                <version>3.4.0</version>
            </plugin>
        </plugins>
    </build>
</project>
</file>

<file path="src/main/java/model/dao/ReclamoDAO.java">
package model.dao;

import model.ConPool;
import model.bean.Reclamo;
import model.bean.enums.StatoReclamo;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class ReclamoDAO {

    public boolean doSave(Reclamo r) {
        String query = "INSERT INTO reclamo (" +
                "id_segnalazione, id_utente_richiedente, " +
                "risposta_verifica1, risposta_verifica2, " +
                "stato, data_richiesta" +
                ") VALUES (?, ?, ?, ?, ?, ?)";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setLong(1, r.getIdSegnalazione());
            ps.setLong(2, r.getIdUtenteRichiedente());
            ps.setString(3, r.getRispostaVerifica1());
            ps.setString(4, r.getRispostaVerifica2());
            ps.setString(5, StatoReclamo.IN_ATTESA.toString());
            ps.setTimestamp(6, new Timestamp(System.currentTimeMillis()));

            return ps.executeUpdate() > 0;
        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        }
    }

    // --- NUOVI METODI PER SCAMBIO DIRETTO ---
    public boolean confermaFinder(long idReclamo) {
        String sql = "UPDATE reclamo SET conferma_finder = 1 WHERE id = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setLong(1, idReclamo);
            return ps.executeUpdate() > 0;
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    public boolean confermaOwner(long idReclamo) {
        String sql = "UPDATE reclamo SET conferma_owner = 1 WHERE id = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setLong(1, idReclamo);
            return ps.executeUpdate() > 0;
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }
    // ----------------------------------------

    // --- NUOVO METODO PER DROP-POINT (CERCA PER CODICE) ---
    public Reclamo doRetrieveByCodice(String codice) {
        String query = "SELECT * FROM reclamo WHERE codice_consegna = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, codice);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return mapRow(rs);
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }
    // -----------------------------------------------------

    public List<Reclamo> doRetrieveBySegnalazione(long idSegnalazione) {
        List<Reclamo> list = new ArrayList<>();
        String query = "SELECT * FROM reclamo WHERE id_segnalazione = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setLong(1, idSegnalazione);
            try (ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    list.add(mapRow(rs));
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return list;
    }

    public Reclamo doRetrieveBySegnalazioneAndUtente(long idSegnalazione, long idUtente) {
        String query = "SELECT * FROM reclamo WHERE id_segnalazione = ? AND id_utente_richiedente = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setLong(1, idSegnalazione);
            ps.setLong(2, idUtente);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) return mapRow(rs);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    public boolean accettaReclamo(long idReclamo, String codice) {
        String query = "UPDATE reclamo SET stato = 'ACCETTATO', codice_consegna = ? WHERE id = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, codice);
            ps.setLong(2, idReclamo);
            return ps.executeUpdate() > 0;

        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        }
    }

    public Reclamo doRetrieveById(long id) {
        String query = "SELECT * FROM reclamo WHERE id = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setLong(1, id);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) return mapRow(rs);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    public boolean rifiutaReclamo(long idReclamo) {
        String query = "UPDATE reclamo SET stato = 'RIFIUTATO' WHERE id = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setLong(1, idReclamo);
            return ps.executeUpdate() > 0;

        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        }
    }

    public List<Reclamo> doRetrieveByRichiedente(long idUtenteRichiedente) {
        List<Reclamo> list = new ArrayList<>();
        String query = "SELECT r.*, s.titolo AS seg_titolo, s.immagine AS seg_immagine " +
                "FROM reclamo r " +
                "JOIN segnalazione s ON r.id_segnalazione = s.id " +
                "WHERE r.id_utente_richiedente = ? " +
                "ORDER BY r.data_richiesta DESC";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setLong(1, idUtenteRichiedente);
            try (ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    Reclamo r = mapRow(rs);
                    r.setTitoloSegnalazione(rs.getString("seg_titolo"));
                    String imgPath = rs.getString("seg_immagine");
                    if (imgPath != null) {
                        r.setImmagineSegnalazione(imgPath.getBytes());
                    }
                    list.add(r);
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return list;
    }

    private Reclamo mapRow(ResultSet rs) throws SQLException {
        Reclamo r = new Reclamo();
        r.setId(rs.getLong("id"));
        r.setIdSegnalazione(rs.getLong("id_segnalazione"));
        r.setIdUtenteRichiedente(rs.getLong("id_utente_richiedente"));
        r.setRispostaVerifica1(rs.getString("risposta_verifica1"));
        r.setRispostaVerifica2(rs.getString("risposta_verifica2"));
        r.setDataRichiesta(rs.getTimestamp("data_richiesta"));
        r.setDataDeposito(rs.getTimestamp("data_deposito"));
        r.setDataRitiro(rs.getTimestamp("data_ritiro"));
        r.setConfermaFinder(rs.getBoolean("conferma_finder"));
        r.setConfermaOwner(rs.getBoolean("conferma_owner"));
        r.setCodiceConsegna(rs.getString("codice_consegna"));
        try {
            r.setStato(StatoReclamo.valueOf(rs.getString("stato")));
        } catch (Exception e) {
            r.setStato(StatoReclamo.IN_ATTESA);
        }
        return r;
    }
}
</file>

<file path="src/main/webapp/WEB-INF/jsp/crea_segnalazione.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="model.bean.enums.CategoriaOggetto" %>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>

<%
    model.bean.DropPoint dp = (model.bean.DropPoint) session.getAttribute("dropPoint");
    model.bean.Utente u = (model.bean.Utente) session.getAttribute("utente");

    if (dp != null) {
        response.sendRedirect(request.getContextPath() + "/area-drop-point");
        return;
    }
    if (u == null) {
        response.sendRedirect(request.getContextPath() + "/login");
        return;
    }
    if (session.getAttribute("utente") == null) {
        response.sendRedirect(request.getContextPath() + "/login");
        return;
    }
%>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Crea Segnalazione - Foundly</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/crea_segnalazione.css">
</head>
<body>

<div class="main-container">

    <div class="info-section">
        <div class="brand-header">
            <div class="brand-icon">
                <a href="${pageContext.request.contextPath}/index">
                    <img src="${pageContext.request.contextPath}/assets/images/logo.png" alt="logo_foundly">
                </a>
            </div>
        </div>

        <div class="hero-text">
            <h1>Nuova Segnalazione</h1>
            <p>
                Hai trovato qualcosa? Compila il modulo dettagliato qui a fianco.
                Pi√π informazioni fornisci, pi√π facile sar√† il ritrovamento.
            </p>

            <div style="margin-top: 40px;">
                <a href="${pageContext.request.contextPath}/index"
                   style="color: #E65100; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 500;">
                    <span class="material-icons">arrow_back</span> Torna alla Home
                </a>
            </div>
        </div>
    </div>

    <div class="auth-section">
        <div class="auth-card wide">

            <h2 class="form-page-title">Dettagli Ritrovamento</h2>
            <p class="form-page-subtitle">Inserisci le informazioni principali</p>

            <% if (request.getAttribute("errore") != null) { %>
            <div style="background:#ffebee; color:#c62828; padding:12px; border-radius:12px; margin-bottom:20px; display:flex; align-items:center; gap:10px;">
                <span class="material-icons">error_outline</span>
                <%= request.getAttribute("errore") %>
            </div>
            <% } %>

            <form action="${pageContext.request.contextPath}/crea-segnalazione"
                  method="post"
                  enctype="multipart/form-data">

                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label for="titolo" class="form-label">Titolo Annuncio</label>
                            <input type="text" id="titolo" name="titolo" class="form-input"
                                   required placeholder="Es. Trovato mazzo di chiavi">
                        </div>

                        <div class="form-group">
                            <label for="tipo_segnalazione" class="form-label">Cosa hai trovato?</label>
                            <select id="tipo_segnalazione" name="tipo_segnalazione"
                                    class="form-select" required onchange="toggleCampi()">
                                <option value="OGGETTO">Un Oggetto</option>
                                <option value="ANIMALE">Un Animale</option>
                            </select>
                        </div>

                        <div id="campi-oggetto">
                            <div class="form-group">
                                <label for="categoria" class="form-label">Categoria</label>
                                <select id="categoria" name="categoria" class="form-select">
                                    <% for(CategoriaOggetto c : CategoriaOggetto.values()) { %>
                                    <option value="<%= c %>"><%= c %></option>
                                    <% } %>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="modalita_consegna" class="form-label">Modalit√† Restituzione</label>
                                <select id="modalita_consegna" name="modalita_consegna"
                                        class="form-select" onchange="toggleCampi()">
                                    <option value="DIRETTA">Consegna a mano (Diretta)</option>
                                    <option value="DROP_POINT">Lascia a un Drop-Point (Negozio)</option>
                                </select>
                            </div>

                            <div id="container-drop-point" class="hidden">
                                <div class="form-group" style="background: #FFFDE7; padding: 15px; border-radius: 12px; border: 1px dashed #FBC02D;">
                                    <label for="idDropPoint" class="form-label" style="color: #F57F17;">Seleziona il Drop-Point</label>
                                    <select id="idDropPoint" name="idDropPoint" class="form-select"
                                            onchange="showDropPointDetails()">
                                        <option value="">-- Scegli un negozio --</option>
                                        <c:forEach var="dp" items="${listaDropPoint}">
                                            <option value="${dp.id}"
                                                    data-indirizzo="${dp.indirizzo}, ${dp.citta}"
                                                    data-orari="${dp.orariApertura}"
                                                    data-tel="${dp.telefono}">
                                                    ${dp.nomeAttivita} - ${dp.citta}
                                            </option>
                                        </c:forEach>
                                    </select>

                                    <div id="dp-details-box" class="dp-details-box hidden">
                                        <div class="dp-details-title">
                                            <span class="material-icons">store</span> Dettagli Punto
                                        </div>
                                        <div class="dp-info-row">
                                            <span class="material-icons dp-icon-small">place</span>
                                            <span id="dp-addr">Indirizzo...</span>
                                        </div>
                                        <div class="dp-info-row">
                                            <span class="material-icons dp-icon-small">schedule</span>
                                            <span id="dp-time">Orari...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="campi-animale" class="hidden">
                            <div class="form-group">
                                <label for="specie" class="form-label">Specie</label>
                                <input type="text" id="specie" name="specie" class="form-input" placeholder="Es. Cane">
                            </div>
                            <div class="form-group">
                                <label for="razza" class="form-label">Razza (Opzionale)</label>
                                <input type="text" id="razza" name="razza" class="form-input" placeholder="Es. Labrador">
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="form-group">
                            <label for="descrizione" class="form-label">Descrizione Dettagliata</label>
                            <textarea id="descrizione" name="descrizione" class="form-textarea"
                                      required placeholder="Descrivi colore, marca, segni particolari..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Foto (Opzionale)</label>
                            <label for="immagine" class="file-upload-label">
                                <span class="material-icons file-upload-icon">cloud_upload</span>
                                <span>Carica un'immagine</span>
                            </label>
                            <input type="file" id="immagine" name="immagine"
                                   class="file-input-hidden" accept="image/*"
                                   onchange="showFileName(this)">
                            <div id="file-name-display"></div>
                        </div>
                    </div>
                </div>

                <hr style="margin: 25px 0;">

                <h3 style="font-size:1.1rem; color:#E65100; margin-bottom:15px;">üìç Dove e Quando</h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="luogo_ritrovamento" class="form-label">Indirizzo / Luogo</label>
                        <input type="text" id="luogo_ritrovamento" name="luogo_ritrovamento"
                               class="form-input" required placeholder="Es. Via Roma 10">
                    </div>
                    <div class="form-group">
                        <label for="citta" class="form-label">Citt√†</label>
                        <input type="text" id="citta" name="citta" class="form-input" required placeholder="Es. Milano">
                    </div>
                    <div class="form-group">
                        <label for="provincia" class="form-label">Provincia (Sigla)</label>
                        <input type="text" id="provincia" name="provincia"
                               class="form-input" maxlength="2" style="text-transform:uppercase;" required placeholder="MI">
                    </div>
                    <div class="form-group">
                        <label for="data_ritrovamento" class="form-label">Data Ritrovamento</label>
                        <input type="date" id="data_ritrovamento" name="dataRitrovamento"
                               class="form-input" required>
                    </div>
                </div>

                <hr style="margin: 25px 0;">

                <h3 style="font-size:1.1rem; color:#E65100; margin-bottom:10px;">üîí Sicurezza (Secure Claim)</h3>
                <p style="font-size:0.85rem; color:#757575; margin-bottom:20px;">
                    Importa due domande a cui solo il vero proprietario pu√≤ rispondere.
                </p>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="domanda1" class="form-label">Domanda 1</label>
                        <input type="text" id="domanda1" name="domanda1" class="form-input"
                               required placeholder="Es. Di che colore √® il portachiavi?">
                    </div>
                    <div class="form-group">
                        <label for="domanda2" class="form-label">Domanda 2</label>
                        <input type="text" id="domanda2" name="domanda2" class="form-input"
                               required placeholder="Es. C'√® un graffio sul retro?">
                    </div>
                </div>

                <button type="submit" class="btn-submit-modern">Pubblica Segnalazione</button>

            </form>
        </div>
    </div>
</div>

<script>
    function toggleCampi() {
        const tipo = document.getElementById("tipo_segnalazione").value;
        const campiOggetto = document.getElementById("campi-oggetto");
        const campiAnimale = document.getElementById("campi-animale");

        const modalita = document.getElementById("modalita_consegna").value;
        const containerDP = document.getElementById("container-drop-point");
        const selectDP = document.getElementById("idDropPoint");

        if (tipo === "OGGETTO") {
            campiOggetto.classList.remove("hidden");
            campiAnimale.classList.add("hidden");

            if (modalita === "DROP_POINT") {
                containerDP.classList.remove("hidden");
                selectDP.setAttribute("required", "required");
            } else {
                containerDP.classList.add("hidden");
                selectDP.removeAttribute("required");
            }

        } else {
            campiOggetto.classList.add("hidden");
            campiAnimale.classList.remove("hidden");
            containerDP.classList.add("hidden");
            selectDP.removeAttribute("required");
        }
    }

    function showDropPointDetails() {
        const select = document.getElementById("idDropPoint");
        const detailsBox = document.getElementById("dp-details-box");

        if (select.value === "") {
            detailsBox.classList.add("hidden");
            return;
        }

        const selectedOpt = select.options[select.selectedIndex];
        const addr = selectedOpt.getAttribute("data-indirizzo");
        const time = selectedOpt.getAttribute("data-orari");

        document.getElementById("dp-addr").textContent = addr;
        document.getElementById("dp-time").textContent = time;

        detailsBox.classList.remove("hidden");
    }

    function showFileName(input) {
        const display = document.getElementById('file-name-display');
        if (input.files && input.files.length > 0) {
            display.textContent = input.files[0].name;
            display.style.color = "#2E7D32";
        } else {
            display.textContent = "";
        }
    }

    document.addEventListener("DOMContentLoaded", toggleCampi);
</script>

</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/jsp/registrazione_utente.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundly - Registrazione Utente</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">
</head>
<body>

<div class="main-container">

    <div class="info-section">
        <div class="brand-header">
            <div class="brand-icon">
                <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
            </div>
        </div>

        <div class="hero-text">
            <h1>Entra nella Community</h1>
            <p>
                Registrati come utente per segnalare oggetti ritrovati o reclamare ci√≤ che hai perso.
                Aiutaci a costruire una rete di cittadini onesti e collaborativi.
            </p>
            <div class="feature-pills">
                <span class="pill active"><span class="material-icons">security</span> Secure Claim</span>
                <span class="pill"><span class="material-icons">store</span> Drop-Points</span>
                <span class="pill"><span class="material-icons">emoji_events</span> Scoreboard</span>
            </div>
        </div>
    </div>

    <div class="auth-section">
        <div class="auth-card">
            <h2>Crea Account</h2>
            <p class="subtitle">Inserisci i tuoi dati personali</p>

            <%-- Gestione Errori --%>
            <% String errore = (String) request.getAttribute("errore"); %>
            <% if (errore != null) { %>
            <div style="background-color: #ffebee; color: #c62828; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; text-align: center;">
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">error</span> <%= errore %>
            </div>
            <% } %>

            <form action="${pageContext.request.contextPath}/registrazione-utente" method="post">

                <div class="input-row">
                    <div class="input-group">
                        <label for="nome">Nome</label>
                        <input type="text" id="nome" name="nome" placeholder="Es. Mario" required>
                    </div>
                    <div class="input-group">
                        <label for="cognome">Cognome</label>
                        <input type="text" id="cognome" name="cognome" placeholder="Es. Rossi" required>
                    </div>
                </div>

                <div class="input-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" placeholder="Scegli un username" required>
                </div>

                <div class="input-row">
                    <div class="input-group" style="flex: 2;">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="mario.rossi@email.com" required>
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <label for="telefono">Telefono</label>
                        <input type="tel" id="telefono" name="telefono" placeholder="342..." required>
                    </div>
                </div>

                <div class="input-group">
                    <label for="password">Password</label>
                    <input
                            type="password"
                            id="password"
                            name="password"
                            placeholder="Minimo 8 caratteri"
                            required
                            minlength="8"
                            pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&._#-])[A-Za-z\d@$!%*?&._#-]{8,}$"
                            title="Almeno 8 caratteri, con una maiuscola, una minuscola, un numero e un carattere speciale (@$!%*?&._#-)"
                    >
                    <small id="passwordHelp" style="color:#777; font-size:0.8rem;">
                        Minimo 8 caratteri, almeno 1 maiuscola, 1 minuscola, 1 numero e 1 carattere speciale
                        (@$!%*?&._#-).
                    </small>
                    <div id="passwordError" style="display:none; color:#c62828; font-size:0.8rem; margin-top:4px;">
                        La password non rispetta i requisiti indicati.
                    </div>

                    <button type="submit" class="btn-primary mt-2">Registrati</button>

                    <div class="form-footer">
                        <span>Hai giaÃÄ un account?</span>
                        <a href="${pageContext.request.contextPath}/login" class="link-login">Accedi qui</a>
                    </div>

                </div>

                <script>
                    (function () {
                        const form = document.querySelector('.auth-card form');
                        const passwordInput = document.getElementById('password');
                        const passwordError = document.getElementById('passwordError');

                        if (!form || !passwordInput || !passwordError) return;

                        // REGEX AGGIORNATA ANCHE QUI
                        const passwordRegex =
                            /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&._#-])[A-Za-z\d@$!%*?&._#-]{8,}$/;

                        function validatePassword() {
                            const value = passwordInput.value || "";

                            if (passwordRegex.test(value)) {
                                passwordInput.style.borderColor = '#ccc';
                                passwordError.style.display = 'none';
                                return true;
                            } else {
                                if (value.length > 0) {
                                    passwordInput.style.borderColor = '#c62828';
                                    passwordError.style.display = 'block';
                                } else {
                                    passwordInput.style.borderColor = '#ccc';
                                    passwordError.style.display = 'none';
                                }
                                return false;
                            }
                        }

                        passwordInput.addEventListener('input', validatePassword);

                        form.addEventListener('submit', function (e) {
                            if (!validatePassword()) {
                                e.preventDefault();
                                passwordInput.focus();
                            }
                        });
                    })();
                </script>

</body>
</html>
</file>

<file path="src/main/java/model/dao/SegnalazioneDAO.java">
package model.dao;

import model.ConPool;
import model.bean.Segnalazione;
import model.bean.SegnalazioneAnimale;
import model.bean.SegnalazioneOggetto;
import model.bean.enums.CategoriaOggetto;
import model.bean.enums.ModalitaConsegna;
import model.bean.enums.StatoSegnalazione;
import model.bean.enums.TipoSegnalazione;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class SegnalazioneDAO {

    public boolean updateStato(long id, StatoSegnalazione nuovoStato) {
        String query = "UPDATE segnalazione SET stato = ? WHERE id = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {
            ps.setString(1, nuovoStato.toString());
            ps.setLong(2, id);
            return ps.executeUpdate() > 0;
        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        }
    }

    public boolean doSave(Segnalazione s) {
        String sqlPadre =
                "INSERT INTO segnalazione (" +
                        "id_utente, titolo, descrizione, data_ritrovamento, " +
                        "luogo_ritrovamento, citta, provincia, latitudine, longitudine, " +
                        "immagine, immagine_content_type, " +
                        "domanda_verifica1, domanda_verifica2, stato, tipo_segnalazione" +
                        ") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

        try (Connection con = ConPool.getConnection();
             PreparedStatement psPadre = con.prepareStatement(sqlPadre, Statement.RETURN_GENERATED_KEYS)) {

            con.setAutoCommit(false);

            psPadre.setLong(1, s.getIdUtente());
            psPadre.setString(2, s.getTitolo());
            psPadre.setString(3, s.getDescrizione());
            psPadre.setTimestamp(4, s.getDataRitrovamento());
            psPadre.setString(5, s.getLuogoRitrovamento());
            psPadre.setString(6, s.getCitta());
            psPadre.setString(7, s.getProvincia());
            psPadre.setObject(8, s.getLatitudine());
            psPadre.setObject(9, s.getLongitudine());

            if (s.getImmagine() != null && s.getImmagine().length > 0) {
                psPadre.setBytes(10, s.getImmagine());
                psPadre.setString(11, s.getImmagineContentType());
            } else {
                psPadre.setNull(10, Types.BLOB);
                psPadre.setNull(11, Types.VARCHAR);
            }

            psPadre.setString(12, s.getDomandaVerifica1());
            psPadre.setString(13, s.getDomandaVerifica2());
            psPadre.setString(14, s.getStato().toString());
            psPadre.setString(15, s.getTipoSegnalazione().toString());

            int result = psPadre.executeUpdate();

            if (result > 0) {
                try (ResultSet generatedKeys = psPadre.getGeneratedKeys()) {
                    if (generatedKeys.next()) {
                        long id = generatedKeys.getLong(1);
                        s.setId(id);

                        if (s instanceof SegnalazioneOggetto) {
                            saveOggetto(con, (SegnalazioneOggetto) s);
                        } else if (s instanceof SegnalazioneAnimale) {
                            saveAnimale(con, (SegnalazioneAnimale) s);
                        }

                        con.commit();
                        return true;
                    }
                }
            }
            con.rollback();
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    private void saveOggetto(Connection con, SegnalazioneOggetto so) throws SQLException {
        String sql = "INSERT INTO segnalazione_oggetto " +
                "(id_segnalazione, categoria, modalita_consegna, id_drop_point) " +
                "VALUES (?, ?, ?, ?)";
        try (PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setLong(1, so.getId());
            ps.setString(2, so.getCategoria().toString());
            ps.setString(3, so.getModalitaConsegna().toString());
            ps.setObject(4, so.getIdDropPoint());
            ps.executeUpdate();
        }
    }

    private void saveAnimale(Connection con, SegnalazioneAnimale sa) throws SQLException {
        String sql = "INSERT INTO segnalazione_animale " +
                "(id_segnalazione, specie, razza) VALUES (?, ?, ?)";
        try (PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setLong(1, sa.getId());
            ps.setString(2, sa.getSpecie());
            ps.setString(3, sa.getRazza());
            ps.executeUpdate();
        }
    }

    /**
     * Recupera le ultime segnalazioni per la HOME.
     * FILTRO: Solo segnalazioni 'APERTA'. Quelle CHIUSE non si vedono.
     */
    public List<Segnalazione> doRetrieveLatest(int limit) {
        List<Segnalazione> list = new ArrayList<>();
        String query = "SELECT s.*, so.categoria, so.modalita_consegna, so.id_drop_point, sa.specie, sa.razza " +
                "FROM segnalazione s " +
                "LEFT JOIN segnalazione_oggetto so ON s.id = so.id_segnalazione " +
                "LEFT JOIN segnalazione_animale sa ON s.id = sa.id_segnalazione " +
                "WHERE s.stato = 'APERTA' " + // <--- QUESTA RIGA FA LA MAGIA
                "ORDER BY s.data_pubblicazione DESC LIMIT ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {
            ps.setInt(1, limit);
            try (ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    list.add(mapRow(rs));
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return list;
    }

    public Segnalazione doRetrieveById(long id) {
        String query = "SELECT s.*, so.categoria, so.modalita_consegna, so.id_drop_point, sa.specie, sa.razza " +
                "FROM segnalazione s " +
                "LEFT JOIN segnalazione_oggetto so ON s.id = so.id_segnalazione " +
                "LEFT JOIN segnalazione_animale sa ON s.id = sa.id_segnalazione " +
                "WHERE s.id = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {
            ps.setLong(1, id);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) return mapRow(rs);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    /**
     * Recupera le segnalazioni di un utente specifico (Storico Personale).
     * QUI NON FILTRIAMO: L'utente deve poter vedere anche le sue segnalazioni CHIUSE.
     */
    public List<Segnalazione> doRetrieveByUtente(long idUtente) {
        List<Segnalazione> list = new ArrayList<>();
        String query = "SELECT s.*, so.categoria, so.modalita_consegna, so.id_drop_point, sa.specie, sa.razza " +
                "FROM segnalazione s " +
                "LEFT JOIN segnalazione_oggetto so ON s.id = so.id_segnalazione " +
                "LEFT JOIN segnalazione_animale sa ON s.id = sa.id_segnalazione " +
                "WHERE s.id_utente = ? ORDER BY s.data_pubblicazione DESC";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {
            ps.setLong(1, idUtente);
            try (ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    list.add(mapRow(rs));
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return list;
    }

    public boolean doDelete(long id) {
        String query = "DELETE FROM segnalazione WHERE id = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {
            ps.setLong(1, id);
            return ps.executeUpdate() > 0;
        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        }
    }

    /**
     * Ricerca Pubblica.
     * FILTRO: Solo segnalazioni 'APERTA'.
     */
    public List<Segnalazione> doRetrieveByFiltri(String queryTesto, String tipo, String categoria) {
        StringBuilder sql = new StringBuilder(
                "SELECT s.*, so.categoria, so.modalita_consegna, so.id_drop_point, sa.specie, sa.razza " +
                        "FROM segnalazione s " +
                        "LEFT JOIN segnalazione_oggetto so ON s.id = so.id_segnalazione " +
                        "LEFT JOIN segnalazione_animale sa ON s.id = sa.id_segnalazione " +
                        "WHERE s.stato = 'APERTA'"); // <--- ANCHE QUI LA MAGIA

        List<Object> params = new ArrayList<>();

        if (queryTesto != null && !queryTesto.trim().isEmpty()) {
            sql.append(" AND (s.titolo LIKE ? OR s.descrizione LIKE ? OR s.luogo_ritrovamento LIKE ?)");
            String likeQuery = "%" + queryTesto + "%";
            params.add(likeQuery);
            params.add(likeQuery);
            params.add(likeQuery);
        }

        if (tipo != null && !tipo.trim().isEmpty()) {
            sql.append(" AND s.tipo_segnalazione = ?");
            params.add(tipo.toUpperCase());
        }

        if (categoria != null && !categoria.trim().isEmpty()) {
            sql.append(" AND so.categoria = ?");
            params.add(categoria.toUpperCase());
        }

        sql.append(" ORDER BY s.data_pubblicazione DESC");

        List<Segnalazione> list = new ArrayList<>();
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(sql.toString())) {

            for (int i = 0; i < params.size(); i++) {
                ps.setObject(i + 1, params.get(i));
            }

            try (ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    list.add(mapRow(rs));
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return list;
    }

    private Segnalazione mapRow(ResultSet rs) throws SQLException {
        Segnalazione s;
        String tipo = rs.getString("tipo_segnalazione");

        if ("OGGETTO".equals(tipo)) {
            SegnalazioneOggetto so = new SegnalazioneOggetto();
            try {
                String cat = rs.getString("categoria");
                if (cat != null) so.setCategoria(CategoriaOggetto.valueOf(cat));

                String mod = rs.getString("modalita_consegna");
                if (mod != null) so.setModalitaConsegna(ModalitaConsegna.valueOf(mod));
            } catch (Exception ignored) {}
            so.setIdDropPoint(rs.getObject("id_drop_point", Long.class));
            s = so;
        } else {
            SegnalazioneAnimale sa = new SegnalazioneAnimale();
            sa.setSpecie(rs.getString("specie"));
            sa.setRazza(rs.getString("razza"));
            s = sa;
        }

        s.setId(rs.getLong("id"));
        s.setIdUtente(rs.getLong("id_utente"));
        s.setTitolo(rs.getString("titolo"));
        s.setDescrizione(rs.getString("descrizione"));
        s.setDataRitrovamento(rs.getTimestamp("data_ritrovamento"));
        s.setLuogoRitrovamento(rs.getString("luogo_ritrovamento"));
        s.setCitta(rs.getString("citta"));
        s.setProvincia(rs.getString("provincia"));
        s.setLatitudine(rs.getObject("latitudine", Double.class));
        s.setLongitudine(rs.getObject("longitudine", Double.class));

        if (rs.getBytes("immagine") != null) {
            s.setImmagine(rs.getBytes("immagine"));
            s.setImmagineContentType(rs.getString("immagine_content_type"));
        }

        s.setDomandaVerifica1(rs.getString("domanda_verifica1"));
        s.setDomandaVerifica2(rs.getString("domanda_verifica2"));
        s.setDataPubblicazione(rs.getTimestamp("data_pubblicazione"));

        try {
            s.setStato(StatoSegnalazione.valueOf(rs.getString("stato")));
            s.setTipoSegnalazione(TipoSegnalazione.valueOf(tipo));
        } catch (Exception ignored) {}

        return s;
    }
}
</file>

<file path="src/main/java/model/service/SegnalazioneService.java">
package model.service;

import model.bean.Reclamo;
import model.bean.Segnalazione;
import model.bean.SegnalazioneOggetto;
import model.bean.Utente;
import model.bean.enums.ModalitaConsegna;
import model.bean.enums.StatoSegnalazione;
import model.dao.ReclamoDAO;
import model.dao.SegnalazioneDAO;
import model.utils.GeocodingUtils;

import java.util.List;

public class SegnalazioneService {

    private final SegnalazioneDAO segnalazioneDAO = new SegnalazioneDAO();
    private final ReclamoDAO reclamoDAO = new ReclamoDAO();
    private final UtenteService utenteService = new UtenteService(); // Per gestire i punti

    public boolean creaSegnalazione(Segnalazione segnalazione) {
        if (segnalazione.getLuogoRitrovamento() != null && !segnalazione.getLuogoRitrovamento().isEmpty() &&
                segnalazione.getCitta() != null && !segnalazione.getCitta().isEmpty()) {
            double[] coords = GeocodingUtils.getCoordinates(
                    segnalazione.getLuogoRitrovamento(),
                    segnalazione.getCitta(),
                    segnalazione.getProvincia()
            );
            segnalazione.setLatitudine(coords[0]);
            segnalazione.setLongitudine(coords[1]);
        }
        return segnalazioneDAO.doSave(segnalazione);
    }

    public List<Segnalazione> getUltimeSegnalazioni() {
        return segnalazioneDAO.doRetrieveLatest(8);
    }

    public Segnalazione trovaPerId(long id) {
        return segnalazioneDAO.doRetrieveById(id);
    }

    public List<Segnalazione> trovaPerUtente(long idUtente) {
        return segnalazioneDAO.doRetrieveByUtente(idUtente);
    }

    public boolean eliminaSegnalazione(long id) {
        return segnalazioneDAO.doDelete(id);
    }

    // --- LOGICA DROP-POINT (Con Codice) ---
    public boolean accettaReclamoEChiudiSegnalazione(long idReclamo, long idSegnalazione, String codice) {
        boolean successoReclamo = reclamoDAO.accettaReclamo(idReclamo, codice);

        if (successoReclamo) {
            boolean successoSegnalazione = segnalazioneDAO.updateStato(idSegnalazione, StatoSegnalazione.CHIUSA);

            if (successoSegnalazione) {
                // Se √® DropPoint, assegna il punto
                Segnalazione s = segnalazioneDAO.doRetrieveById(idSegnalazione);
                if (s != null) {
                    boolean isDropPoint = false;
                    if (s instanceof SegnalazioneOggetto) {
                        SegnalazioneOggetto so = (SegnalazioneOggetto) s;
                        if (so.getModalitaConsegna() == ModalitaConsegna.DROP_POINT) {
                            isDropPoint = true;
                        }
                    }
                    if (isDropPoint) {
                        Utente finder = utenteService.trovaPerId(s.getIdUtente());
                        if (finder != null) {
                            utenteService.aggiornaPunteggioEBadge(finder, 1);
                        }
                    }
                }
                return true;
            }
        }
        return false;
    }

    // --- LOGICA SCAMBIO DIRETTO (Doppia Conferma) ---
    public boolean gestisciConfermaScambio(long idReclamo, boolean isFinder) {
        // 1. Registra la conferma singola
        if (isFinder) {
            reclamoDAO.confermaFinder(idReclamo);
        } else {
            reclamoDAO.confermaOwner(idReclamo);
        }

        // 2. Controlla se ORA sono entrambi confermati
        Reclamo r = reclamoDAO.doRetrieveById(idReclamo);
        if (r != null && r.isConfermaFinder() && r.isConfermaOwner()) {

            // Entrambi hanno confermato: Chiudi e dai punti
            segnalazioneDAO.updateStato(r.getIdSegnalazione(), StatoSegnalazione.CHIUSA);

            Segnalazione s = segnalazioneDAO.doRetrieveById(r.getIdSegnalazione());
            if (s != null) {
                Utente finder = utenteService.trovaPerId(s.getIdUtente());
                if (finder != null) {
                    utenteService.aggiornaPunteggioEBadge(finder, 1);
                }
            }
            return true; // Scambio completato
        }
        return false; // Manca l'altro utente
    }

    public boolean rifiutaReclamo(long idReclamo) {
        return reclamoDAO.rifiutaReclamo(idReclamo);
    }

    public List<Segnalazione> cercaSegnalazioni(String q, String tipo, String categoria) {
        return segnalazioneDAO.doRetrieveByFiltri(q, tipo, categoria);
    }

    public List<Reclamo> trovaReclamiFattiDaUtente(long idUtente) {
        return reclamoDAO.doRetrieveByRichiedente(idUtente);
    }
}
</file>

<file path="src/main/webapp/WEB-INF/jsp/navbar.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="model.bean.Utente" %>
<%@ page import="model.bean.DropPoint" %>
<%@ page import="model.bean.enums.Ruolo" %>

<%
    String ctx = request.getContextPath();

    // Chi √® loggato?
    Utente    utenteLoggatoNav   = (Utente)    session.getAttribute("utente");
    DropPoint dropPointLoggato   = (DropPoint) session.getAttribute("dropPoint");

    boolean isDropPoint = (dropPointLoggato != null);
    boolean isUtente    = (!isDropPoint && utenteLoggatoNav != null);

    // Avatar (unico flag per entrambi i casi)
    boolean navHasAvatar = false;
    String  navAvatarUrl = null;

    if (isUtente) {
        if (utenteLoggatoNav.getImmagineProfilo() != null &&
                utenteLoggatoNav.getImmagineProfilo().length > 0) {

            navHasAvatar = true;
            navAvatarUrl = ctx + "/avatar?userId=" + utenteLoggatoNav.getId();
        }
    } else if (isDropPoint) {
        if (dropPointLoggato.getImmagine() != null &&
                dropPointLoggato.getImmagine().length > 0) {

            navHasAvatar = true;
            navAvatarUrl = ctx + "/drop-point-avatar?dpId=" + dropPointLoggato.getId();
        }
    }
%>

<nav class="navbar">
    <!-- Logo -->
    <a href="<%= ctx %>/index" class="brand">
        <div class="brand-icon">
            <img src="<%= ctx %>/assets/images/logo.png" alt="logo_foundly">
        </div>
    </a>

    <!-- Link centrali -->
    <div class="nav-links">
        <% if (isDropPoint) { %>
        <!-- Drop-Point: solo Area Drop-Point -->
        <a href="<%= ctx %>/area-drop-point" class="nav-item">
            <span class="material-icons">storefront</span> Area Drop-Point
        </a>
        <% } else { %>
        <!-- Utente normale -->
        <a href="<%= ctx %>/index" class="nav-item">
            <span class="material-icons">home</span> Home
        </a>
        <a href="<%= ctx %>/crea-segnalazione" class="nav-item">
            <span class="material-icons">add_circle_outline</span> Crea Segnalazione
        </a>
        <a href="<%= ctx %>/le-mie-segnalazioni" class="nav-item">
            <span class="material-icons">inventory</span> Segnalazioni e Reclami
        </a>
        <a href="<%= ctx %>/drop-point" class="nav-item">
            <span class="material-icons">place</span> Drop-Point
        </a>
        <a href="<%= ctx %>/classifica" class="nav-item">
            <span class="material-icons">emoji_events</span> Classifica
        </a>
        <% } %>
    </div>

    <!-- Lato destro: menu utente / drop-point -->
    <% if (isUtente || isDropPoint) { %>
    <div class="user-menu">
        <button type="button" class="user-avatar-btn" onclick="toggleUserMenu(event)">
            <% if (navHasAvatar) { %>
            <img src="<%= navAvatarUrl %>" alt="" class="user-avatar-img">
            <% } else { %>
            <div class="user-avatar-placeholder"></div>
            <% } %>
        </button>

        <div class="user-dropdown">
            <% if (isUtente) { %>
            <!-- Header per cittadino -->
            <div class="user-dropdown-header">
                <div class="user-email"><%= utenteLoggatoNav.getEmail() %></div>
                <div class="user-points-row">
                    <span class="points-label">punti</span>
                    <span class="points-value"><%= utenteLoggatoNav.getPunteggio() %></span>
                </div>
            </div>

            <a href="<%= ctx %>/profilo" class="user-dropdown-item">
                <span class="material-icons">person</span>
                <span>Profilo</span>
            </a>

            <% if (utenteLoggatoNav.getRuolo() == Ruolo.ADMIN) { %>
            <a href="<%= ctx %>/admin" class="user-dropdown-item">
                <span class="material-icons">admin_panel_settings</span>
                <span>Area Admin</span>
            </a>
            <% } %>

            <% } else { %>
            <!-- Header per Drop-Point -->
            <div class="user-dropdown-header">
                <div class="user-email"><%= dropPointLoggato.getEmail() %></div>
                <div class="user-dp-row">
                    <span class="user-dp-label">Drop-Point</span>
                    <span class="user-dp-name"><%= dropPointLoggato.getNomeAttivita() %></span>
                </div>
            </div>

            <a href="<%= ctx %>/profilo-drop-point" class="user-dropdown-item">
                <span class="material-icons">storefront</span>
                <span>Profilo Drop-Point</span>
            </a>
            <% } %>

            <a href="<%= ctx %>/logout" class="user-dropdown-item user-dropdown-item-logout">
                <span class="material-icons">logout</span>
                <span>Logout</span>
            </a>
        </div>
    </div>
    <% } else { %>
    <!-- Nessuno loggato -->
    <a href="<%= ctx %>/login" class="btn-login-nav">
        <span class="material-icons">login</span>
        <span>Accedi</span>
    </a>
    <% } %>
</nav>

<script>
    function toggleUserMenu(event) {
        if (event) {
            event.stopPropagation();
        }
        var menu = document.querySelector(".user-menu");
        if (menu) {
            menu.classList.toggle("open");
        }
    }

    document.addEventListener("click", function () {
        var menu = document.querySelector(".user-menu");
        if (menu) {
            menu.classList.remove("open");
        }
    });
</script>
</file>

<file path="src/main/webapp/WEB-INF/jsp/profilo.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="model.bean.Utente" %>
<%@ page import="model.bean.enums.Ruolo" %>

<%
    Utente utente = (Utente) session.getAttribute("utente");
    if (utente == null) {
        response.sendRedirect(request.getContextPath() + "/login");
        return;
    }

    // ===== BADGE =====
    String rawBadge = utente.getBadge(); // OCCHIO_DI_FALCO / DETECTIVE / SHERLOCK_HOLMES

    String badgeDisplay = "";
    if (rawBadge != null) {
        String[] parts = rawBadge.toLowerCase().split("_");
        StringBuilder sb = new StringBuilder();
        for (String p : parts) {
            if (p == null || p.isEmpty()) continue;
            if (sb.length() > 0) sb.append(" ");
            sb.append(Character.toUpperCase(p.charAt(0)));
            if (p.length() > 1) sb.append(p.substring(1));
        }
        badgeDisplay = sb.toString();
    }

    String badgeImg = "badge_default.png";
    if ("OCCHIO_DI_FALCO".equals(rawBadge)) {
        badgeImg = "badge_occhio_di_falco.png";
    } else if ("DETECTIVE".equals(rawBadge)) {
        badgeImg = "badge_detective.png";
    } else if ("SHERLOCK_HOLMES".equals(rawBadge)) {
        badgeImg = "badge_sherlock_holmes.png";
    }

    // ===== AVATAR (BLOB nel DB) =====
    boolean hasAvatar = (utente.getImmagineProfilo() != null
            && utente.getImmagineProfilo().length > 0);

    // URL della servlet che streamma l'immagine dal DB
    String avatarUrl = request.getContextPath() + "/avatar?userId=" + utente.getId();
%>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilo - Foundly</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/index.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/profilo.css">
</head>
<body class="page-enter">

<jsp:include page="navbar.jsp" />

<main class="profile-main">
    <section class="profile-card">
        <!-- HEADER: avatar + nome + email -->
        <div class="profile-header">
            <div class="profile-avatar-wrapper <%= hasAvatar ? "has-avatar" : "" %>" id="avatarWrapper">
                <div class="profile-avatar-large">
                    <% if (hasAvatar) { %>
                    <!-- Avatar servito dalla servlet che legge il BLOB dal DB -->
                    <img
                            src="<%= avatarUrl %>"
                            alt=""
                            id="profileAvatarImg">
                    <% } else { %>
                    <!-- Nessun avatar: img nascosta, cerchio arancione gestito via CSS -->
                    <img
                            src="<%= avatarUrl %>"
                            alt=""
                            id="profileAvatarImg"
                            style="display:none;">
                    <% } %>
                </div>

                <!-- overlay rosso con cestino -->
                <div class="avatar-remove-overlay" id="avatarRemoveOverlay">
                    <span class="material-icons">delete</span>
                </div>

                <button type="button" class="avatar-edit-btn" id="avatarEditBtn" title="Cambia foto profilo">
                    <span class="material-icons">edit</span>
                </button>
            </div>

            <div>
                <h1 class="profile-title">
                    <%= utente.getNome() %> <%= utente.getCognome() %>
                </h1>
                <p class="profile-subtitle">
                    <%= utente.getEmail() %>
                </p>
            </div>
        </div>

        <!-- BOX PUNTI -->
        <div class="profile-points-box">
            <div class="points-left">
                <span class="material-icons points-icon">star_rate</span>
                <span class="points-label-big">PUNTI TOTALI</span>
            </div>
            <div class="points-right">
                <span class="points-value-big">
                    <%= utente.getPunteggio() %>
                </span>
            </div>
        </div>

        <!-- BADGE -->
        <div class="profile-badge-card">
            <div class="badge-medal">
                <img src="<%= request.getContextPath() %>/assets/images/badges/<%= badgeImg %>"
                     alt="<%= badgeDisplay %>"
                     class="badge-medal-img">
            </div>
            <div class="badge-texts">
                <span class="badge-label">Badge</span>
                <span class="badge-name"><%= badgeDisplay %></span>
            </div>
        </div>

        <!-- FORM PROFILO (testo + avatar) -->
        <form method="post"
              action="${pageContext.request.contextPath}/profilo"
              id="profileEditForm"
              class="profile-edit-form"
              enctype="multipart/form-data">

            <!-- input file nascosto per l'avatar -->
            <input type="file"
                   name="avatar"
                   id="avatarInput"
                   accept="image/*"
                   class="avatar-file-input">

            <!-- flag rimozione avatar -->
            <input type="hidden"
                   name="removeAvatar"
                   id="removeAvatarField"
                   value="false">

            <section class="profile-edit-card" id="profileEditCard">
                <div class="profile-edit-header">
                    <div class="profile-edit-header-left">
                        <span class="material-icons">manage_accounts</span>
                        <span>Dettagli account</span>
                    </div>
                    <button type="button" class="edit-main-button" id="editToggleBtn">
                        <span class="material-icons">edit</span>
                        <span>Modifica</span>
                    </button>
                </div>

                <!-- USERNAME -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Username</span>
                        <span class="field-value view-mode" id="usernameView">
                            <%= utente.getUsername() %>
                        </span>
                        <input type="text"
                               class="field-input edit-mode"
                               name="username"
                               id="usernameInput"
                               value="<%= utente.getUsername() %>">
                    </div>
                </div>

                <!-- NOME -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Nome</span>
                        <span class="field-value view-mode" id="nomeView">
                            <%= utente.getNome() %>
                        </span>
                        <input type="text"
                               class="field-input edit-mode"
                               name="nome"
                               id="nomeInput"
                               value="<%= utente.getNome() %>">
                    </div>
                </div>

                <!-- COGNOME -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Cognome</span>
                        <span class="field-value view-mode" id="cognomeView">
                            <%= utente.getCognome() %>
                        </span>
                        <input type="text"
                               class="field-input edit-mode"
                               name="cognome"
                               id="cognomeInput"
                               value="<%= utente.getCognome() %>">
                    </div>
                </div>
            </section>

            <!-- PULSANTI SOTTO IL BOX, CENTRATI -->
            <div class="edit-actions">
                <button type="submit" class="btn-confirm">
                    Conferma Modifiche
                </button>
                <button type="button" class="btn-cancel" id="cancelEditBtn">
                    Annulla Modifiche
                </button>
            </div>
        </form>

        <div class="profile-grid">
            <!-- altri campi in futuro -->
        </div>
    </section>
</main>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const editForm          = document.getElementById("profileEditForm");
        const editToggleBtn     = document.getElementById("editToggleBtn");
        const cancelEditBtn     = document.getElementById("cancelEditBtn");

        const avatarWrapper     = document.getElementById("avatarWrapper");
        const avatarEditBtn     = document.getElementById("avatarEditBtn");
        const avatarRemoveOv    = document.getElementById("avatarRemoveOverlay");
        const avatarInput       = document.getElementById("avatarInput");
        const avatarImg         = document.getElementById("profileAvatarImg");
        const removeAvatarField = document.getElementById("removeAvatarField");

        // attiva/disattiva modalit√† editing per i campi testo
        if (editForm && editToggleBtn && cancelEditBtn) {
            editToggleBtn.addEventListener("click", function () {
                editForm.classList.add("editing");
            });

            cancelEditBtn.addEventListener("click", function () {
                window.location.reload();
            });
        }

        // click sulla matita -> selezione file avatar
        if (avatarEditBtn && avatarInput && avatarImg) {
            avatarEditBtn.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (!editForm.classList.contains("editing")) {
                    editForm.classList.add("editing");
                }
                avatarInput.click();
            });

            avatarInput.addEventListener("change", function () {
                const file = avatarInput.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (ev) {
                    avatarImg.src = ev.target.result;
                    avatarImg.style.display = "block";
                    if (avatarWrapper) {
                        avatarWrapper.classList.add("has-avatar");
                    }
                    if (removeAvatarField) {
                        removeAvatarField.value = "false"; // stiamo caricando una nuova immagine
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // click sul cestino -> rimozione avatar (UI + flag per il server)
        if (avatarRemoveOv && avatarWrapper && avatarImg && avatarInput && removeAvatarField) {
            avatarRemoveOv.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (!editForm.classList.contains("editing")) {
                    editForm.classList.add("editing");
                }

                removeAvatarField.value = "true";
                avatarInput.value = "";
                avatarImg.src = "";
                avatarImg.style.display = "none";
                avatarWrapper.classList.remove("has-avatar");
            });
        }
    });
</script>


</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/jsp/registrazione_droppoint.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundly - Registrazione Drop-Point</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
</head>
<body>

<div class="main-container">

    <div class="info-section">
        <div class="brand-header">
            <div class="brand-icon">
                <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
            </div>
        </div>

        <div class="hero-text">
            <h1>Diventa un Partner</h1>
            <p>
                Trasforma la tua attivit√† in un punto di riferimento per la community.
                Diventando un <strong>Drop-Point</strong>, offrirai un luogo sicuro per la restituzione di oggetti
                smarriti.
            </p>
            <div class="feature-pills">
                <span class="pill"><span class="material-icons">security</span> Secure Claim</span>
                <span class="pill active"><span class="material-icons">store</span> Drop-Points</span>
                <span class="pill"><span class="material-icons">emoji_events</span> Scoreboard</span>
            </div>
        </div>
    </div>

    <div class="auth-section">
        <div class="auth-card">
            <h2>Registra Attivit√†</h2>
            <p class="subtitle">Unisciti alla rete Foundly</p>

            <% String errore = (String) request.getAttribute("errore"); %>
            <% if (errore != null) { %>
            <div style="background-color: #ffebee; color: #c62828; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; text-align: center;">
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">error</span> <%= errore %>
            </div>
            <% } %>

            <form action="${pageContext.request.contextPath}/registrazione-droppoint" method="post">

                <div class="input-group">
                    <label for="nomeAttivita">Nome Attivit√† Commerciale</label>
                    <input type="text" id="nomeAttivita" name="nomeAttivita" placeholder="Es. Bar Centrale" required>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label for="email">Email Aziendale</label>
                        <input type="email" id="email" name="email" placeholder="info@barcentrale.it" required>
                    </div>
                    <div class="input-group">
                        <label for="telefono">Telefono</label>
                        <input type="tel" id="telefono" name="telefono" placeholder="081 1234567" required>
                    </div>
                </div>

                <div class="input-group">
                    <label for="indirizzo">Indirizzo</label>
                    <input type="text" id="indirizzo" name="indirizzo" placeholder="Via Roma, 10" required>
                </div>

                <div class="input-row">
                    <div class="input-group" style="flex: 3;">
                        <label for="citta">Citt√†</label>
                        <input type="text" id="citta" name="citta" placeholder="Milano" required>
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <label for="provincia">Prov.</label>
                        <input type="text" id="provincia" name="provincia" maxlength="2" placeholder="MI"
                               style="text-transform: uppercase;" required>
                    </div>
                </div>

                <span class="map-label">Posizione sulla mappa (clicca per selezionare)</span>
                <div id="map"></div>

                <input type="hidden" id="latitudine" name="latitudine" required>
                <input type="hidden" id="longitudine" name="longitudine" required>

                <div class="input-group">
                    <label for="orari">Orari di Apertura</label>
                    <input type="text" id="orari" name="orari" placeholder="Es. Lun-Sab 07:00 - 20:00" required>
                </div>

                <div class="input-group">
                    <label for="password">Password</label>
                    <input
                            type="password"
                            id="password"
                            name="password"
                            placeholder="Crea una password sicura"
                            required
                            minlength="8"
                            pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&._#-])[A-Za-z\d@$!%*?&._#-]{8,}$"
                            title="Almeno 8 caratteri, con una maiuscola, una minuscola, un numero e un carattere speciale (@$!%*?&._#-)"
                    >
                    <small id="passwordHelp" style="color:#777; font-size:0.8rem;">
                        Minimo 8 caratteri, almeno 1 maiuscola, 1 minuscola, 1 numero e 1 carattere speciale
                        (@$!%*?&._#-).
                    </small>
                    <div id="passwordError" style="display:none; color:#c62828; font-size:0.8rem; margin-top:4px;">
                        La password non rispetta i requisiti indicati.
                    </div>
                </div>

                <button type="submit" class="btn-primary mt-2">Invia Richiesta</button>

                <div class="form-footer">
                    <span>La tua attivit√† √® gi√† registrata?</span>
                    <a href="${pageContext.request.contextPath}/login" class="link-login">Accedi qui</a>
                </div>
            </form>

        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    // Inizializza la mappa su Italia / Roma
    var map = L.map('map').setView([41.9028, 12.4964], 6);

    // Layer OpenStreetMap
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    var marker = null;

    function setMarker(lat, lng) {
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng], {draggable: true}).addTo(map);

            // Quando l'utente trascina il marker, aggiorna le coordinate
            marker.on('dragend', function (e) {
                var pos = e.target.getLatLng();
                document.getElementById('latitudine').value = pos.lat;
                document.getElementById('longitudine').value = pos.lng;
                console.log("Posizione selezionata (drag):", pos.lat, pos.lng);
            });
        }

        document.getElementById('latitudine').value = lat;
        document.getElementById('longitudine').value = lng;
    }

    // CLICK MANUALE SULLA MAPPA
    map.on('click', function (e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;
        setMarker(lat, lng);
        console.log("Posizione selezionata (click): " + lat + ", " + lng);
    });

    // ------- G E O C O D I N G  D A  I N D I R I Z Z O -------

    let geocodeTimeout = null;

    function geocodeAddress() {
        var indirizzoRaw = document.getElementById('indirizzo').value.trim();
        var citta = document.getElementById('citta').value.trim();
        var provincia = document.getElementById('provincia').value.trim();

        if (!indirizzoRaw || !citta || !provincia) {
            return;
        }

        // Prova a separare via e civico: "Via Cervinia, 38" -> "38 Via Cervinia"
        var street = indirizzoRaw;
        var match = indirizzoRaw.match(/(.+?)(?:,?\s+(\d+\w*\/?\w*))$/);
        if (match) {
            var via = match[1].trim();
            var civico = match[2].trim();
            street = civico + " " + via;
        }

        var params = new URLSearchParams({
            format: "json",
            limit: "1",
            addressdetails: "1",
            street: street,
            city: citta,
            county: provincia,
            country: "Italia"
        });

        var url = "https://nominatim.openstreetmap.org/search?" + params.toString();

        fetch(url, {
            method: "GET",
            headers: {
                "Accept-Language": "it"
            }
        })
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                if (!data || data.length === 0) {
                    console.warn("Indirizzo non trovato");
                    return;
                }

                var result = data[0];
                var lat = parseFloat(result.lat);
                var lng = parseFloat(result.lon);

                if (isNaN(lat) || isNaN(lng)) {
                    console.warn("Coordinate non valide dal geocoder");
                    return;
                }

                var addr = result.address || {};
                if (!addr.house_number) {
                    console.warn("Nessun house_number nei dati: posizione solo approssimativa sulla via.");
                }

                setMarker(lat, lng);
                map.setView([lat, lng], 16);

                console.log("Posizione selezionata (geocode): " + lat + ", " + lng,
                    "| street:", street, "| address:", addr);
            })
            .catch(function (error) {
                console.error("Errore nel geocoding:", error);
            });
    }

    function scheduleGeocode() {
        clearTimeout(geocodeTimeout);
        geocodeTimeout = setTimeout(geocodeAddress, 600);
    }

    // Lancia il geocoding quando l‚Äôutente compila indirizzo/citt√†/provincia
    window.addEventListener('DOMContentLoaded', function () {
        ['indirizzo', 'citta', 'provincia'].forEach(function (id) {
            var el = document.getElementById(id);
            if (el) {
                el.addEventListener('blur', scheduleGeocode);
                el.addEventListener('keyup', function (e) {
                    if (!['Tab', 'Shift', 'Alt', 'Control', 'Meta'].includes(e.key)) {
                        scheduleGeocode();
                    }
                });
            }
        });
    });
</script>

<script>
    // Validazione password (stessi controlli della registrazione utente)
    (function () {
        const form = document.querySelector('.auth-card form');
        const passwordInput = document.getElementById('password');
        const passwordError = document.getElementById('passwordError');

        if (!form || !passwordInput || !passwordError) return;

        const passwordRegex =
            /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&._#-])[A-Za-z\d@$!%*?&._#-]{8,}$/;

        function validatePassword() {
            const value = passwordInput.value || "";

            if (passwordRegex.test(value)) {
                passwordInput.style.borderColor = '#ccc';
                passwordError.style.display = 'none';
                return true;
            } else {
                if (value.length > 0) {
                    passwordInput.style.borderColor = '#c62828';
                    passwordError.style.display = 'block';
                } else {
                    passwordInput.style.borderColor = '#ccc';
                    passwordError.style.display = 'none';
                }
                return false;
            }
        }

        passwordInput.addEventListener('input', validatePassword);

        form.addEventListener('submit', function (e) {
            if (!validatePassword()) {
                e.preventDefault();
                passwordInput.focus();
            }
        });
    })();
</script>

</body>
</html>
</file>

<file path="src/main/java/model/dao/UtenteDAO.java">
package model.dao;

import model.ConPool;
import model.bean.Utente;
import model.bean.enums.Ruolo;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class UtenteDAO {

    public boolean doSave(Utente utente) {
        String query = "INSERT INTO utente (" +
                "username, email, password_hash, nome, cognome, " +
                "telefono, immagine_profilo, immagine_profilo_content_type, " +
                "punteggio, ruolo, badge" +
                ") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query, Statement.RETURN_GENERATED_KEYS)) {

            ps.setString(1, utente.getUsername());
            ps.setString(2, utente.getEmail());
            ps.setString(3, utente.getPasswordHash());
            ps.setString(4, utente.getNome());
            ps.setString(5, utente.getCognome());
            ps.setString(6, utente.getTelefono());

            // immagine BLOB + content-type
            if (utente.getImmagineProfilo() != null && utente.getImmagineProfilo().length > 0) {
                ps.setBytes(7, utente.getImmagineProfilo());
                ps.setString(8, utente.getImmagineProfiloContentType());
            } else {
                ps.setNull(7, Types.BLOB);
                ps.setNull(8, Types.VARCHAR);
            }

            ps.setInt(9, utente.getPunteggio());
            ps.setString(10, utente.getRuolo().toString());
            ps.setString(11, utente.getBadge());

            int result = ps.executeUpdate();

            if (result > 0) {
                try (ResultSet generatedKeys = ps.getGeneratedKeys()) {
                    if (generatedKeys.next()) {
                        utente.setId(generatedKeys.getLong(1));
                    }
                }
                return true;
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    public Utente doRetrieveByEmail(String email) {
        String query = "SELECT * FROM utente WHERE email = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, email);

            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return mapRowToUtente(rs);
                }
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    public Utente doRetrieveByUsername(String username) {
        String query = "SELECT * FROM utente WHERE username = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, username);

            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return mapRowToUtente(rs);
                }
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    public List<Utente> doRetrieveAllByPunteggio() {
        List<Utente> utenti = new ArrayList<>();
        String query = "SELECT * FROM utente ORDER BY punteggio DESC LIMIT 50";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query);
             ResultSet rs = ps.executeQuery()) {

            while (rs.next()) {
                utenti.add(mapRowToUtente(rs));
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return utenti;
    }

    public List<Utente> doRetrieveAll() {
        List<Utente> utenti = new ArrayList<>();
        String query = "SELECT * FROM utente";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query);
             ResultSet rs = ps.executeQuery()) {

            while (rs.next()) {
                utenti.add(mapRowToUtente(rs));
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return utenti;
    }

    public Utente doRetrieveById(Long id) {
        String query = "SELECT * FROM utente WHERE id = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setLong(1, id);

            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return mapRowToUtente(rs);
                }
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    public boolean updateProfilo(Utente utente) {
        String query = "UPDATE utente SET " +
                "username = ?, nome = ?, cognome = ?, " +
                "immagine_profilo = ?, immagine_profilo_content_type = ? " +
                "WHERE id = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, utente.getUsername());
            ps.setString(2, utente.getNome());
            ps.setString(3, utente.getCognome());

            if (utente.getImmagineProfilo() != null && utente.getImmagineProfilo().length > 0) {
                ps.setBytes(4, utente.getImmagineProfilo());
                ps.setString(5, utente.getImmagineProfiloContentType());
            } else {
                ps.setNull(4, Types.BLOB);
                ps.setNull(5, Types.VARCHAR);
            }

            ps.setLong(6, utente.getId());

            int updated = ps.executeUpdate();
            return updated > 0;

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    private Utente mapRowToUtente(ResultSet rs) throws SQLException {
        Utente u = new Utente();
        u.setId(rs.getLong("id"));
        u.setUsername(rs.getString("username"));
        u.setEmail(rs.getString("email"));
        u.setPasswordHash(rs.getString("password_hash"));
        u.setNome(rs.getString("nome"));
        u.setCognome(rs.getString("cognome"));
        u.setTelefono(rs.getString("telefono"));

        // BLOB + content-type
        u.setImmagineProfilo(rs.getBytes("immagine_profilo"));
        u.setImmagineProfiloContentType(rs.getString("immagine_profilo_content_type"));

        u.setPunteggio(rs.getInt("punteggio"));

        String ruoloStr = rs.getString("ruolo");
        if (ruoloStr != null) {
            u.setRuolo(Ruolo.valueOf(ruoloStr));
        }

        u.setBadge(rs.getString("badge"));
        return u;
    }

    public boolean updatePasswordByEmail(String email, String nuovoHash) {
        String query = "UPDATE utente SET password_hash = ? WHERE email = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, nuovoHash);
            ps.setString(2, email);

            int updated = ps.executeUpdate();
            return updated > 0;

        } catch (SQLException e) {
            e.printStackTrace();
        }

        return false;
    }

    public boolean updatePunteggioEBadge(Utente utente) {
        String sql = "UPDATE utente SET punteggio = ?, badge = ? WHERE id = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(sql)) {

            ps.setInt(1, utente.getPunteggio());
            ps.setString(2, utente.getBadge());
            ps.setLong(3, utente.getId());

            return ps.executeUpdate() > 0;

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    /** Cancella un utente (ban = delete). */
    public boolean deleteById(long id) {
        String sql = "DELETE FROM utente WHERE id = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(sql)) {

            ps.setLong(1, id);
            return ps.executeUpdate() > 0;

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }
}
</file>

<file path="src/main/webapp/WEB-INF/jsp/dettaglio_segnalazione.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>
<%@ page import="model.bean.Utente" %>
<%@ page import="model.bean.Reclamo" %>
<%@ page import="model.bean.enums.ModalitaConsegna" %>
<%@ page import="model.bean.SegnalazioneOggetto" %>
<%@ page import="model.bean.enums.StatoReclamo" %>
<%@ page import="model.bean.enums.StatoSegnalazione" %>
<%@ page import="java.util.List" %>

<%
    model.bean.DropPoint dp = (model.bean.DropPoint) session.getAttribute("dropPoint");
    model.bean.Utente u = (model.bean.Utente) session.getAttribute("utente");

    if (dp != null) { response.sendRedirect(request.getContextPath() + "/area-drop-point"); return; }
    if (u == null) { response.sendRedirect(request.getContextPath() + "/login"); return; }

    Utente utente = (Utente) session.getAttribute("utente");
    model.bean.Segnalazione s = (model.bean.Segnalazione) request.getAttribute("segnalazione");
    boolean isLogged = (utente != null);
    boolean isOwner = (isLogged && s != null && s.getIdUtente() == utente.getId());

    // Controllo Modalit√† Consegna
    boolean isDropPoint = false;
    if (s instanceof SegnalazioneOggetto) {
        SegnalazioneOggetto so = (SegnalazioneOggetto) s;
        if (so.getModalitaConsegna() == ModalitaConsegna.DROP_POINT) {
            isDropPoint = true;
        }
    }

    // Recupero Reclamo Accettato
    List<Reclamo> reclami = (List<Reclamo>) request.getAttribute("reclamiRicevuti");
    Reclamo reclamoAccettato = null;

    if(reclami != null) {
        for(Reclamo r : reclami) {
            if(r.getStato() == StatoReclamo.ACCETTATO) { reclamoAccettato = r; break; }
        }
    }
    if(reclamoAccettato == null) {
        Reclamo mio = (Reclamo) request.getAttribute("mioReclamo");
        if(mio != null && mio.getStato() == StatoReclamo.ACCETTATO) {
            reclamoAccettato = mio;
        }
    }
%>

<!DOCTYPE html>
<html lang="it">
<head>
    <title>${segnalazione.titolo != null ? segnalazione.titolo : "Dettaglio"} - Foundly</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/index.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/dettaglio_segnalazione.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>

<jsp:include page="/WEB-INF/jsp/navbar.jsp"/>

<div class="local-wrapper">

    <a href="${pageContext.request.contextPath}/index" class="local-back-link">
        <span class="material-icons">arrow_back</span> Torna alla Home
    </a>

    <c:if test="${segnalazione == null}">
        <div class="local-card empty-card" style="text-align:center; padding:40px;">
            <h2>Segnalazione non trovata</h2>
            <a href="${pageContext.request.contextPath}/index" class="btn-primary" style="display:inline-block; width:auto; margin-top:10px;">Vai alla Home</a>
        </div>
    </c:if>

    <c:if test="${segnalazione != null}">
        <div class="local-grid">

            <div class="main-content">
                <div class="local-card hero-card">
                    <div class="image-container">
                        <c:choose>
                            <c:when test="${not empty segnalazione.immagine}">
                                <img src="${pageContext.request.contextPath}/segnalazione-img?id=${segnalazione.id}" class="local-hero-img">
                            </c:when>
                            <c:otherwise>
                                <div class="local-hero-placeholder"><span class="material-icons">image_not_supported</span></div>
                            </c:otherwise>
                        </c:choose>
                        <div class="status-overlay">
                            <span class="status-badge ${segnalazione.stato == 'CHIUSA' ? 'status-closed' : 'status-open'}">
                                    ${segnalazione.stato}
                            </span>
                        </div>
                    </div>

                    <div class="local-content">
                        <div class="header-row">
                            <div class="category-tags">
                                <span class="tag-pill">${segnalazione.tipoSegnalazione}</span>
                                <c:if test="${segnalazione.tipoSegnalazione == 'OGGETTO'}">
                                    <span class="tag-pill outline">${segnalazione.categoria}</span>
                                </c:if>
                                <c:if test="${segnalazione.tipoSegnalazione == 'ANIMALE'}">
                                    <span class="tag-pill outline">${segnalazione.specie}</span>
                                </c:if>
                            </div>
                            <span class="date-text">
                                Pubblicato il <fmt:formatDate value="${segnalazione.dataPubblicazione}" pattern="dd MMM yyyy"/>
                            </span>
                        </div>

                        <h1 class="local-title">${segnalazione.titolo}</h1>
                        <p class="local-text">${segnalazione.descrizione}</p>

                        <div class="info-grid">
                            <div class="info-item">
                                <span class="material-icons">event</span>
                                <div><span class="label">Data Ritrovamento</span><span class="value"><fmt:formatDate value="${segnalazione.dataRitrovamento}" pattern="dd MMMM yyyy"/></span></div>
                            </div>
                            <div class="info-item">
                                <span class="material-icons">location_on</span>
                                <div><span class="label">Luogo</span><span class="value">${segnalazione.luogoRitrovamento}</span><span class="sub-value">${segnalazione.citta} (${segnalazione.provincia})</span></div>
                            </div>
                        </div>

                        <div id="itemMap" class="mini-map"></div>

                        <% if (isDropPoint) { %>
                        <div class="delivery-box purple">
                            <div class="icon-box"><span class="material-icons">store</span></div>
                            <div><h4>Drop-Point</h4><p>Ritiro presso negozio partner autorizzato.</p></div>
                        </div>
                        <% } else { %>
                        <div class="delivery-box green">
                            <div class="icon-box"><span class="material-icons">handshake</span></div>
                            <div><h4>Consegna Diretta</h4><p>Accordo diretto tra Finder e Proprietario.</p></div>
                        </div>
                        <% } %>

                        <% if (reclamoAccettato != null && !isDropPoint && s.getStato() == StatoSegnalazione.APERTA) { %>
                        <div class="scambio-action-box">
                            <h3 class="scambio-title"><span class="material-icons">published_with_changes</span> Scambio in Corso</h3>
                            <p style="color:#5D4037; margin-bottom:20px;">
                                Ottimo! Il reclamo √® stato accettato. Incontratevi per lo scambio.<br>
                                Per chiudere la pratica e assegnare i punti, <strong>entrambi dovete confermare</strong>.
                            </p>
                            <form action="${pageContext.request.contextPath}/gestione-reclamo" method="post">
                                <input type="hidden" name="action" value="conferma_scambio">
                                <input type="hidden" name="idReclamo" value="<%= reclamoAccettato.getId() %>">
                                <input type="hidden" name="idSegnalazione" value="<%= s.getId() %>">

                                <% if (isOwner) { %>
                                <% if (reclamoAccettato.isConfermaFinder()) { %>
                                <button type="button" class="btn-disabled"><span class="material-icons" style="vertical-align: middle;">check_circle</span> Hai confermato</button>
                                <% } else { %>
                                <button type="submit" class="btn-primary" style="background: #2E7D32;"><span class="material-icons" style="vertical-align: middle;">send</span> Conferma Consegna</button>
                                <% } %>
                                <% } %>

                                <% if (utente.getId() == reclamoAccettato.getIdUtenteRichiedente()) { %>
                                <% if (reclamoAccettato.isConfermaOwner()) { %>
                                <button type="button" class="btn-disabled"><span class="material-icons" style="vertical-align: middle;">check_circle</span> Hai confermato</button>
                                <% } else { %>
                                <button type="submit" class="btn-primary" style="background: #1565C0;"><span class="material-icons" style="vertical-align: middle;">inventory</span> Conferma Ricezione</button>
                                <% } %>
                                <% } %>
                            </form>
                            <div class="scambio-status">
                                    <span class="status-pill <%= reclamoAccettato.isConfermaFinder() ? "done" : "" %>">
                                        <span class="material-icons" style="font-size:16px"><%= reclamoAccettato.isConfermaFinder() ? "check" : "hourglass_empty" %></span> Finder
                                    </span>
                                <span class="status-pill <%= reclamoAccettato.isConfermaOwner() ? "done" : "" %>">
                                        <span class="material-icons" style="font-size:16px"><%= reclamoAccettato.isConfermaOwner() ? "check" : "hourglass_empty" %></span> Owner
                                    </span>
                            </div>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <aside class="sidebar">
                    <%-- UTENTE RICHIEDENTE (NON FINDER) --%>
                <c:if test="<%= !isOwner %>">
                    <c:choose>
                        <%-- RECLAMO ACCETTATO (WINNER BOX) --%>
                        <c:when test="${not empty mioReclamo && mioReclamo.stato == 'ACCETTATO'}">
                            <div class="winner-card">
                                <div class="confetti-icon">üéâ</div>
                                <h4>Congratulazioni!</h4>
                                <p>Il tuo reclamo √® stato accettato.</p>

                                    <%-- SE C'√à CODICE (DROP POINT) --%>
                                <c:if test="${not empty mioReclamo.codiceConsegna}">
                                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:8px; margin-bottom:15px;">
                                        <small>CODICE RITIRO:</small>
                                        <div style="font-size:1.8rem; font-weight:800; letter-spacing:2px; margin-top:5px;">${mioReclamo.codiceConsegna}</div>
                                    </div>
                                    <p style="font-size:0.9rem;">Mostra questo codice al Drop-Point per ritirare l'oggetto.</p>
                                </c:if>

                                <div class="contact-box-white">
                                    <div style="margin-bottom:10px; font-weight:bold; color:#E65100;">Contatti del Finder</div>
                                    <div class="contact-row"><span class="material-icons">person</span><span>${proprietarioSegnalazione.nome} ${proprietarioSegnalazione.cognome}</span></div>
                                    <div class="contact-row"><span class="material-icons">email</span><a href="mailto:${proprietarioSegnalazione.email}">${proprietarioSegnalazione.email}</a></div>
                                    <div class="contact-row"><span class="material-icons">phone</span><a href="tel:${proprietarioSegnalazione.telefono}">${proprietarioSegnalazione.telefono}</a></div>
                                </div>
                            </div>
                        </c:when>

                        <c:otherwise>
                            <div class="sidebar-card action-card">
                                <h3 class="sidebar-title">√à tuo questo oggetto?</h3>
                                <c:if test="${not empty mioReclamo}">
                                    <div style="padding:15px; background:#f5f5f5; border-radius:8px; text-align:center;">Stato Richiesta: <strong>${mioReclamo.stato}</strong></div>
                                </c:if>
                                <c:if test="${empty mioReclamo && segnalazione.stato == 'APERTA'}">

                                    <form action="${pageContext.request.contextPath}/gestione-reclamo" method="post">
                                        <input type="hidden" name="action" value="invia">
                                        <input type="hidden" name="idSegnalazione" value="${segnalazione.id}">

                                        <label style="font-size:0.9rem; margin-bottom:5px;">1. ${segnalazione.domandaVerifica1}</label>
                                        <input type="text" name="risposta1" required class="form-input">

                                        <label style="font-size:0.9rem; margin-bottom:5px;">2. ${segnalazione.domandaVerifica2}</label>
                                        <input type="text" name="risposta2" required class="form-input">

                                        <button class="btn-primary full-width">Invia Reclamo</button>
                                    </form>

                                </c:if>
                            </div>
                        </c:otherwise>
                    </c:choose>
                </c:if>

                    <%-- UTENTE FINDER (Gestione) --%>
                <c:if test="<%= isOwner %>">
                    <div class="sidebar-card owner-card">
                        <h3 class="sidebar-title">Gestione Reclami</h3>
                        <c:if test="${empty reclamiRicevuti}"><p style="color:#999; font-style:italic;">Nessuna richiesta ricevuta.</p></c:if>
                        <c:forEach var="r" items="${reclamiRicevuti}">
                            <div class="claim-card">
                                <div class="claim-header">
                                    <strong>Richiesta #${r.id}</strong>
                                    <span style="font-size:0.8rem; color:#666;"><fmt:formatDate value="${r.dataRichiesta}" pattern="dd/MM HH:mm"/></span>
                                </div>
                                <div style="font-size:0.9rem; margin-bottom:10px;">
                                    R1: <i>${r.rispostaVerifica1}</i><br>R2: <i>${r.rispostaVerifica2}</i>
                                </div>
                                <c:if test="${r.stato == 'IN_ATTESA'}">
                                    <div style="display:flex; gap:5px;">
                                        <form action="${pageContext.request.contextPath}/gestione-reclamo" method="post" style="flex:1;">
                                            <input type="hidden" name="action" value="accetta"><input type="hidden" name="idReclamo" value="${r.id}"><input type="hidden" name="idSegnalazione" value="${segnalazione.id}"><button class="btn-accept" style="width:100%;">Accetta</button>
                                        </form>
                                        <form action="${pageContext.request.contextPath}/gestione-reclamo" method="post" style="flex:1;">
                                            <input type="hidden" name="action" value="rifiuta"><input type="hidden" name="idReclamo" value="${r.id}"><input type="hidden" name="idSegnalazione" value="${segnalazione.id}"><button class="btn-reject" style="width:100%;">Rifiuta</button>
                                        </form>
                                    </div>
                                </c:if>
                                <c:if test="${r.stato == 'ACCETTATO'}">
                                    <div style="text-align:center; margin-top:10px;">
                                        <span style="color:green; font-weight:bold;">ACCETTATO</span>
                                        <c:if test="${not empty r.codiceConsegna}">
                                            <div style="background:#E8F5E9; padding:5px; border-radius:4px; margin-top:5px; font-family:monospace; font-weight:bold;">COD: ${r.codiceConsegna}</div>
                                        </c:if>
                                    </div>
                                </c:if>
                                <c:if test="${r.stato == 'RIFIUTATO'}">
                                    <div style="text-align:center; color:red; font-weight:bold;">RIFIUTATO</div>
                                </c:if>
                            </div>
                        </c:forEach>
                        <form action="${pageContext.request.contextPath}/dettaglio-segnalazione" method="post" onsubmit="return confirm('Eliminare definitivamente questa segnalazione?');">
                            <input type="hidden" name="action" value="delete"><input type="hidden" name="idSegnalazione" value="${segnalazione.id}"><button class="btn-danger"><span class="material-icons">delete</span> Elimina Segnalazione</button>
                        </form>
                    </div>
                </c:if>
            </aside>

        </div>
    </c:if>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var lat = ${segnalazione.latitudine != null ? segnalazione.latitudine : 'null'};
        var lon = ${segnalazione.longitudine != null ? segnalazione.longitudine : 'null'};
        if (lat && lon) {
            var map = L.map('itemMap').setView([lat, lon], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
            L.marker([lat, lon]).addTo(map).bindPopup("<b>${segnalazione.titolo}</b><br>${segnalazione.luogoRitrovamento}").openPopup();
        } else { document.getElementById('itemMap').style.display = 'none'; }
    });
</script>

</body>
</html>
</file>

<file path="src/main/java/controller/LoginServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import model.bean.DropPoint;
import model.bean.Utente;
import model.service.DropPointService;
import model.service.UtenteService;

import java.io.IOException;

@WebServlet(name = "LoginServlet", value = "/login")
public class LoginServlet extends HttpServlet {

    private final UtenteService utenteService = new UtenteService();
    private final DropPointService dropPointService = new DropPointService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {
        request.getRequestDispatcher("/WEB-INF/jsp/login.jsp")
                .forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        String email = request.getParameter("email");
        String password = request.getParameter("password");

        HttpSession session = request.getSession(true);

        // 1) Provo login come UTENTE "cittadino"
        Utente utente = utenteService.login(email, password);
        if (utente != null) {
            // se prima era loggato un Drop-Point lo sgancio
            session.removeAttribute("dropPoint");

            session.setAttribute("utente", utente);
            session.setAttribute("ruoloLoggato", "CITTADINO");
            session.setMaxInactiveInterval(30 * 60);

            response.sendRedirect(request.getContextPath() + "/index");
            return;
        }

        // 2) Provo login come DROP-POINT
        DropPoint dropPoint = dropPointService.login(email, password);
        if (dropPoint != null) {
            // se prima era loggato un utente "cittadino" lo sgancio
            session.removeAttribute("utente");

            session.setAttribute("dropPoint", dropPoint);
            session.setAttribute("ruoloLoggato", "DROPPOINT");
            session.setMaxInactiveInterval(30 * 60);

            // QUI √® la differenza: il Drop-Point va SOLO nella sua area dedicata
            response.sendRedirect(request.getContextPath() + "/area-drop-point");
            return;
        }

        // 3) Credenziali non valide n√© per utente n√© per Drop-Point
        request.setAttribute("errore", "Email o Password non validi.");
        request.getRequestDispatcher("/WEB-INF/jsp/login.jsp")
                .forward(request, response);
    }
}
</file>

<file path="src/main/java/model/service/UtenteService.java">
package model.service;

import model.bean.Utente;
import model.bean.enums.Ruolo;
import model.dao.UtenteDAO;
import model.utils.PasswordUtils;

import java.util.List;

public class UtenteService {

    private final UtenteDAO utenteDAO = new UtenteDAO();

    /**
     * Registrazione di un nuovo utente "cittadino".
     */
    public boolean registraUtente(String nome,
                                  String cognome,
                                  String username,
                                  String email,
                                  String password,
                                  String telefono) {

        System.out.println("DEBUG: Inizio registrazione per " + email);

        // 1. Controllo Email
        if (utenteDAO.doRetrieveByEmail(email) != null) {
            System.out.println("DEBUG: Email gi√† presente.");
            return false;
        }

        // 2. Controllo Username
        if (utenteDAO.doRetrieveByUsername(username) != null) {
            System.out.println("DEBUG: Username gi√† presente.");
            return false;
        }

        System.out.println("DEBUG: Email e Username liberi. Procedo...");

        Utente nuovoUtente = new Utente();
        nuovoUtente.setNome(nome);
        nuovoUtente.setCognome(cognome);
        nuovoUtente.setUsername(username);
        nuovoUtente.setEmail(email);
        nuovoUtente.setTelefono(telefono);

        // Hash della password
        String passwordHash = PasswordUtils.hashPassword(password);
        nuovoUtente.setPasswordHash(passwordHash);

        // Impostazioni di default
        nuovoUtente.setRuolo(Ruolo.UTENTE_BASE);
        nuovoUtente.setPunteggio(0);
        nuovoUtente.setBadge("OCCHIO_DI_FALCO");
        nuovoUtente.setImmagineProfilo(null);

        boolean salvato = utenteDAO.doSave(nuovoUtente);
        System.out.println("DEBUG: Risultato salvataggio DAO: " + salvato);

        return salvato;
    }
    public List<Utente> getClassificaUtenti() {
        return utenteDAO.doRetrieveAllByPunteggio();
    }
    //commento fico

    /**
     * Login utente "cittadino" con email + password.
     */
    public Utente login(String email, String password) {
        // 1. Recupera l'utente dal DB
        Utente utente = utenteDAO.doRetrieveByEmail(email);
        if (utente == null) {
            return null; // Utente non trovato
        }

        // 2. Verifica la password (hash vs password in chiaro)
        if (PasswordUtils.checkPassword(password, utente.getPasswordHash())) {
            return utente; // Login successo
        }

        return null; // Password errata
    }

    /**
     * Comodo per il recupero password:
     * restituisce l'utente associato a una certa email,
     * oppure null se non esiste.
     */
    public Utente trovaPerEmail(String email) {
        return utenteDAO.doRetrieveByEmail(email);
    }

    /**
     * Usato nel flusso di recupero password:
     * - trova l'utente tramite email
     * - calcola il nuovo hash
     * - aggiorna la password nel DB
     *
     * @return true se l'aggiornamento va a buon fine, false altrimenti
     */
    public boolean resetPasswordByEmail(String email, String nuovaPassword) {
        Utente utente = utenteDAO.doRetrieveByEmail(email);
        if (utente == null) {
            return false; // nessun utente con questa email
        }

        // Applica gli stessi criteri di sicurezza che usi in registrazione (gi√† validati a monte)
        String nuovoHash = PasswordUtils.hashPassword(nuovaPassword);
        utente.setPasswordHash(nuovoHash);

        return utenteDAO.updatePasswordByEmail(email, nuovoHash);
    }

    /* =========================================================
       METODI PER GESTIONE PROFILO
       ========================================================= */

    /**
     * Aggiorna i dati base del profilo (username, nome, cognome).
     * Si aspetta un Utente gi√† caricato (es. da sessione) con id valorizzato.
     *
     * @param utente utente da aggiornare
     * @return true se l'update su DB va a buon fine, false altrimenti
     */
    public boolean aggiornaProfilo(Utente utente) {
        // id √® un long primitivo: uso un controllo > 0 invece di null
        if (utente == null || utente.getId() <= 0) {
            return false;
        }

        // Controllo eventuale duplicato di username
        Utente esistente = utenteDAO.doRetrieveByUsername(utente.getUsername());
        if (esistente != null && esistente.getId() != utente.getId()) {
            // c'√® gi√† un altro utente con questo username
            return false;
        }

        return utenteDAO.updateProfilo(utente);
    }


    /**
     * (Opzionale) Recupera utente per id, utile se in futuro
     * ti serve ricaricare i dati dal DB.
     */
    public Utente trovaPerId(long id) {
        return utenteDAO.doRetrieveById(id);
    }
    /* ==========================
   LOGICA BADGE/PUNTEGGIO
   ========================== */

    /**
     * Ritorna il nome del badge (stringa ENUM) in base al punteggio.
     * 0-2 punti  -> OCCHIO_DI_FALCO
     * 3-4 punti  -> DETECTIVE
     * >=5 punti  -> SHERLOCK_HOLMES
     */
    // in UtenteService

    /**
     * 0-2 punti  -> OCCHIO_DI_FALCO
     * 3-4 punti  -> DETECTIVE
     * >=5 punti  -> SHERLOCK_HOLMES
     */
    private String calcolaBadgePerPunteggio(int punti) {
        if (punti >= 150) {
            return "SHERLOCK_HOLMES";
        } else if (punti >= 100) {
            return "DETECTIVE";
        } else {
            return "OCCHIO_DI_FALCO";
        }
    }

    public boolean aggiornaPunteggioEBadge(Utente utente, int deltaPunti) {
        if (utente == null || utente.getId() <= 0) {
            return false;
        }

        int nuovoPunteggio = utente.getPunteggio() + deltaPunti;
        if (nuovoPunteggio < 0) {
            nuovoPunteggio = 0;
        }

        String nuovoBadge = calcolaBadgePerPunteggio(nuovoPunteggio);

        utente.setPunteggio(nuovoPunteggio);
        utente.setBadge(nuovoBadge);

        return utenteDAO.updatePunteggioEBadge(utente);
    }
    // =========================================================
    // METODI AREA ADMIN
    // =========================================================

    /** Tutti gli utenti, usato in Area Admin. */
    public java.util.List<Utente> trovaTutti() {
        return utenteDAO.doRetrieveAll();
    }

    /** Ban = cancellazione account. */
    public boolean cancellaUtente(long id) {
        return utenteDAO.deleteById(id);
    }
}
</file>

<file path="src/main/java/model/service/DropPointService.java">
package model.service;

import model.bean.DropPoint;
import model.bean.Reclamo;
import model.bean.Segnalazione;
import model.bean.SegnalazioneOggetto;
import model.bean.Utente;
import model.bean.enums.ModalitaConsegna;
import model.bean.enums.StatoDropPoint;
import model.bean.enums.StatoSegnalazione;
import model.dao.DropPointDAO;
import model.dao.ReclamoDAO;
import model.dao.SegnalazioneDAO;
import model.utils.PasswordUtils;

import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

public class DropPointService {

    private final DropPointDAO dropPointDAO = new DropPointDAO();
    private final ReclamoDAO reclamoDAO = new ReclamoDAO();
    private final SegnalazioneDAO segnalazioneDAO = new SegnalazioneDAO();
    private final UtenteService utenteService = new UtenteService();

    // ==========================
    //  REGISTRAZIONE / LOGIN
    // ==========================

    public boolean registraDropPoint(String nomeAttivita, String email, String password,
                                     String indirizzo, String citta, String provincia,
                                     String telefono, String orari,
                                     Double latitudine, Double longitudine) {

        if (dropPointDAO.doRetrieveByEmail(email) != null) {
            return false;
        }

        DropPoint dp = new DropPoint();
        dp.setNomeAttivita(nomeAttivita);
        dp.setEmail(email);
        dp.setPasswordHash(PasswordUtils.hashPassword(password));
        dp.setIndirizzo(indirizzo);
        dp.setCitta(citta);
        dp.setProvincia(provincia);
        dp.setTelefono(telefono);
        dp.setOrariApertura(orari);
        dp.setLatitudine(latitudine);
        dp.setLongitudine(longitudine);

        dp.setStato(StatoDropPoint.IN_ATTESA);
        dp.setRitiriEffettuati(0);
        dp.setImmagine(null);
        dp.setImmagineContentType(null);

        return dropPointDAO.doSave(dp);
    }

    public DropPoint login(String email, String password) {
        DropPoint dp = dropPointDAO.doRetrieveByEmail(email);
        if (dp == null) return null;

        if (!PasswordUtils.checkPassword(password, dp.getPasswordHash())) {
            return null;
        }
        return dropPointDAO.doRetrieveById(dp.getId());
    }

    // ==========================
    //   QUERY DI SUPPORTO
    // ==========================

    public List<DropPoint> findAllApprovati() {
        return dropPointDAO.doRetrieveAllApprovati();
    }

    public List<DropPoint> findAllInAttesa() {
        return dropPointDAO.doRetrieveByStato(StatoDropPoint.IN_ATTESA);
    }

    public boolean approvaDropPoint(long id) {
        return dropPointDAO.updateStato(id, StatoDropPoint.APPROVATO);
    }

    public boolean rifiutaDropPoint(long id) {
        return dropPointDAO.updateStato(id, StatoDropPoint.RIFIUTATO);
    }

    public DropPoint trovaPerId(long id) {
        return dropPointDAO.doRetrieveById(id);
    }

    // =====================================================
    //   LOGICA REALE (DB) - SOSTITUISCE QUELLA IN-MEMORY
    // =====================================================

    /**
     * Registra un RITIRO (Consegna al proprietario).
     * Chiude la segnalazione e assegna i punti.
     */
    public boolean registraRitiro(long idDropPoint, String codiceConsegna) {
        if (codiceConsegna == null || codiceConsegna.isBlank()) {
            return false;
        }

        // 1. Cerca il reclamo associato a questo codice
        Reclamo r = reclamoDAO.doRetrieveByCodice(codiceConsegna);
        if (r == null) {
            return false; // Codice non esistente
        }

        // 2. Recupera la segnalazione
        Segnalazione s = segnalazioneDAO.doRetrieveById(r.getIdSegnalazione());
        if (s == null) return false;

        // 3. Verifica che la segnalazione sia assegnata a QUESTO DropPoint
        if (s instanceof SegnalazioneOggetto) {
            SegnalazioneOggetto so = (SegnalazioneOggetto) s;

            boolean isCorrectDP = (so.getModalitaConsegna() == ModalitaConsegna.DROP_POINT
                    && so.getIdDropPoint() != null
                    && so.getIdDropPoint() == idDropPoint);

            if (isCorrectDP) {
                // 4. CHIUDI SEGNALAZIONE
                boolean chiuso = segnalazioneDAO.updateStato(s.getId(), StatoSegnalazione.CHIUSA);

                if (chiuso) {
                    // 5. ASSEGNA PUNTI AL FINDER
                    Utente finder = utenteService.trovaPerId(s.getIdUtente());
                    if (finder != null) {
                        utenteService.aggiornaPunteggioEBadge(finder, 1);
                    }

                    // (Opzionale) Aggiorna contatore ritiri DropPoint nel DB
                    // dropPointDAO.incrementaRitiri(idDropPoint);

                    return true;
                }
            }
        }
        return false;
    }

    // Manteniamo questi metodi per compatibilit√†, ma ora registraRitiro usa il DB
    // (registraDeposito pu√≤ rimanere placeholder o essere implementato similarmente)
    public boolean registraDeposito(long idDropPoint, String codiceConsegna) {
        // Implementazione base: verifica solo che il codice esista
        Reclamo r = reclamoDAO.doRetrieveByCodice(codiceConsegna);
        return r != null;
    }

    // Contatori (puoi lasciarli a 0 o implementarli con count DB se vuoi)
    public int countDepositiAttivi(long idDropPoint) { return 0; }
    public int countConsegneCompletate(long idDropPoint) { return 0; }
    public int countTotaleOperazioni(long idDropPoint) { return 0; }

    public boolean aggiornaProfilo(DropPoint dropPoint) {
        return dropPointDAO.updateProfilo(dropPoint);
    }
}
</file>

<file path="src/main/java/model/dao/DropPointDAO.java">
package model.dao;

import model.ConPool;
import model.bean.DropPoint;
import model.bean.enums.StatoDropPoint;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class DropPointDAO {

    public boolean doSave(DropPoint dp) {
        String query = "INSERT INTO drop_point (" +
                "nome_attivita, email, password_hash, indirizzo, " +
                "citta, provincia, telefono, orari_apertura, descrizione, " +
                "immagine, immagine_content_type, " +
                "latitudine, longitudine, ritiri_effettuati, stato" +
                ") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query, Statement.RETURN_GENERATED_KEYS)) {

            ps.setString(1, dp.getNomeAttivita());
            ps.setString(2, dp.getEmail());
            ps.setString(3, dp.getPasswordHash());
            ps.setString(4, dp.getIndirizzo());
            ps.setString(5, dp.getCitta());
            ps.setString(6, dp.getProvincia());
            ps.setString(7, dp.getTelefono());
            ps.setString(8, dp.getOrariApertura());
            ps.setString(9, dp.getDescrizione());

            // immagine BLOB + content type
            if (dp.getImmagine() != null && dp.getImmagine().length > 0) {
                ps.setBytes(10, dp.getImmagine());
                ps.setString(11, dp.getImmagineContentType());
            } else {
                ps.setNull(10, Types.BLOB);
                ps.setNull(11, Types.VARCHAR);
            }

            ps.setObject(12, dp.getLatitudine());
            ps.setObject(13, dp.getLongitudine());
            ps.setInt(14, dp.getRitiriEffettuati());
            ps.setString(15, dp.getStato().toString());

            int result = ps.executeUpdate();
            if (result > 0) {
                try (ResultSet generatedKeys = ps.getGeneratedKeys()) {
                    if (generatedKeys.next()) {
                        dp.setId(generatedKeys.getLong(1));
                    }
                }
                return true;
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    public DropPoint doRetrieveByEmail(String email) {
        String query = "SELECT * FROM drop_point WHERE email = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, email);

            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return mapRowToDropPoint(rs);
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    public List<DropPoint> doRetrieveAllApprovati() {
        List<DropPoint> list = new ArrayList<>();
        String query = "SELECT * FROM drop_point WHERE stato = 'APPROVATO'";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query);
             ResultSet rs = ps.executeQuery()) {

            while (rs.next()) {
                list.add(mapRowToDropPoint(rs));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return list;
    }

    /** Tutti i Drop-Point con un certo stato (per l‚Äôadmin). */
    public List<DropPoint> doRetrieveByStato(StatoDropPoint stato) {
        List<DropPoint> list = new ArrayList<>();
        String query = "SELECT * FROM drop_point WHERE stato = ? ORDER BY id DESC";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, stato.toString());

            try (ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    list.add(mapRowToDropPoint(rs));
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return list;
    }

    /** Cambia lo stato di un Drop-Point (IN_ATTESA ‚Üí APPROVATO/RIFIUTATO). */
    public boolean updateStato(long id, StatoDropPoint nuovoStato) {
        String query = "UPDATE drop_point SET stato = ? WHERE id = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, nuovoStato.toString());
            ps.setLong(2, id);

            int updated = ps.executeUpdate();
            return updated > 0;

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    private DropPoint mapRowToDropPoint(ResultSet rs) throws SQLException {
        DropPoint dp = new DropPoint();
        dp.setId(rs.getLong("id"));
        dp.setNomeAttivita(rs.getString("nome_attivita"));
        dp.setEmail(rs.getString("email"));
        dp.setPasswordHash(rs.getString("password_hash"));
        dp.setIndirizzo(rs.getString("indirizzo"));
        dp.setCitta(rs.getString("citta"));
        dp.setProvincia(rs.getString("provincia"));
        dp.setTelefono(rs.getString("telefono"));
        dp.setOrariApertura(rs.getString("orari_apertura"));
        dp.setDescrizione(rs.getString("descrizione"));

        // immagine BLOB + content-type
        dp.setImmagine(rs.getBytes("immagine"));
        dp.setImmagineContentType(rs.getString("immagine_content_type"));

        dp.setLatitudine(rs.getObject("latitudine", Double.class));
        dp.setLongitudine(rs.getObject("longitudine", Double.class));
        dp.setRitiriEffettuati(rs.getInt("ritiri_effettuati"));

        try {
            dp.setStato(StatoDropPoint.valueOf(rs.getString("stato")));
        } catch (IllegalArgumentException | NullPointerException e) {
            dp.setStato(StatoDropPoint.IN_ATTESA);
        }

        return dp;
    }

    public DropPoint doRetrieveById(long id) {
        String query = "SELECT * FROM drop_point WHERE id = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {
            ps.setLong(1, id);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return mapRowToDropPoint(rs);
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }
    public boolean updateProfilo(DropPoint dp) {
        String sql = "UPDATE drop_point SET " +
                "nome_attivita = ?, " +
                "email = ?, " +
                "indirizzo = ?, " +
                "citta = ?, " +
                "provincia = ?, " +
                "telefono = ?, " +
                "orari_apertura = ?, " +
                "immagine = ?, " +
                "immagine_content_type = ? " +
                "WHERE id = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(sql)) {

            ps.setString(1, dp.getNomeAttivita());
            ps.setString(2, dp.getEmail());
            ps.setString(3, dp.getIndirizzo());
            ps.setString(4, dp.getCitta());
            ps.setString(5, dp.getProvincia());
            ps.setString(6, dp.getTelefono());
            ps.setString(7, dp.getOrariApertura());

            if (dp.getImmagine() != null && dp.getImmagine().length > 0) {
                ps.setBytes(8, dp.getImmagine());
                ps.setString(9, dp.getImmagineContentType());
            } else {
                ps.setNull(8, Types.BLOB);
                ps.setNull(9, Types.VARCHAR);
            }

            ps.setLong(10, dp.getId());

            return ps.executeUpdate() > 0;
        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        }
    }
    public boolean doUpdateProfilo(DropPoint dp) {
        String sql = "UPDATE drop_point " +
                "SET nome_attivita = ?, " +
                "    indirizzo = ?, " +
                "    citta = ?, " +
                "    provincia = ?, " +
                "    telefono = ?, " +
                "    orari_apertura = ?, " +
                "    immagine = ?, " +
                "    immagine_content_type = ? " +
                "WHERE id = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(sql)) {

            ps.setString(1, dp.getNomeAttivita());
            ps.setString(2, dp.getIndirizzo());
            ps.setString(3, dp.getCitta());
            ps.setString(4, dp.getProvincia());
            ps.setString(5, dp.getTelefono());
            ps.setString(6, dp.getOrariApertura());

            if (dp.getImmagine() != null && dp.getImmagine().length > 0) {
                ps.setBytes(7, dp.getImmagine());
                ps.setString(8, dp.getImmagineContentType());
            } else {
                ps.setNull(7, java.sql.Types.BLOB);
                ps.setNull(8, java.sql.Types.VARCHAR);
            }

            ps.setLong(9, dp.getId());

            return ps.executeUpdate() > 0;
        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        }
    }
}
</file>

<file path="src/main/webapp/css/index.css">
/* --- LAYOUT GENERALE --- */
:root {
    --primary-color: #FB8C00;
    --primary-hover: #F57C00;
    --primary-light: #FFE0B2;
    --bg-page: #FFFFFF;
    --bg-grey: #F5F5F5;
    --text-dark: #202124;
    --text-grey: #5F6368;
    --white: #FFFFFF;
    --radius-md: 12px;
    --shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.08);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Roboto', sans-serif;
    background-color: var(--bg-page);
    color: var(--text-dark);
}

/* ================= NAVBAR ================= */

.navbar {
    position: sticky;
    top: 0;
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 48px;
    background-color: var(--white);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
}

.brand {
    display: inline-flex;
    align-items: center;
    text-decoration: none;
}

.brand-icon img {
    height: 100px;
    width: auto;
}

.nav-links {
    display: flex;
    align-items: center;
    gap: 16px;
}

.nav-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.95rem;
    color: #5F6368;
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 999px;
    transition: background-color 0.2s ease, color 0.2s ease;
}

.nav-item .material-icons {
    font-size: 20px;
}

.nav-item:hover {
    background-color: #F1F3F4;
    color: #202124;
}

.user-avatar-btn {
    border: none;
    background: transparent;
    padding: 0;
    cursor: pointer;
}

.user-avatar-img,
.user-avatar-placeholder {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: block;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.user-avatar-img { object-fit: cover; }
.user-avatar-placeholder { background: linear-gradient(135deg, #FFE0B2, #FB8C00); }

.btn-login-nav {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 999px;
    border: 1px solid #FFB74D;
    background-color: #FFF7EC;
    color: #E65100;
    font-size: 0.9rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    transition: all 0.2s ease;
}

.btn-login-nav:hover {
    background-color: #FFE7CF;
    border-color: #FFA726;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

/* ================= HERO ================= */

.hero {
    position: relative;
    padding: 80px 24px 120px;
    text-align: center;
    background: linear-gradient(135deg, #F57C00 0%, #FB8C00 40%, #F36C00 100%);
    color: var(--white);
}

.hero h1 { font-size: 3rem; margin-bottom: 16px; }
.hero p { max-width: 640px; margin: 0 auto 32px; font-size: 1.05rem; line-height: 1.6; }

.btn-cta-hero {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    background-color: #FFFFFF;
    color: #E65100;
    font-weight: 600;
    font-size: 0.98rem;
    border-radius: 999px;
    text-decoration: none;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.btn-cta-hero:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
}

/* ================= SEARCH BAR (Aggiornata) ================= */

.search-wrapper {
    max-width: 900px;
    margin: -30px auto 40px auto;
    padding: 0 20px;
    position: relative;
    z-index: 10;
}

.search-card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    padding: 10px;
    display: flex;
    flex-direction: column;
    border: 1px solid #f0f0f0;
}

/* Riga Superiore */
.search-main-row {
    display: flex;
    align-items: center;
    padding: 8px 15px;
    gap: 15px;
}

.input-group {
    flex-grow: 1;
    display: flex;
    align-items: center;
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 10px 15px;
    border: 1px solid #e0e0e0;
    transition: border-color 0.2s;
}

.input-group:focus-within {
    border-color: var(--primary-color);
    background-color: #fff;
}

.search-icon {
    color: #757575;
    font-size: 22px;
    margin-right: 10px;
}

.input-group input {
    border: none;
    background: transparent;
    width: 100%;
    font-size: 1rem;
    color: #333;
    outline: none;
}

.btn-search-submit {
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
    white-space: nowrap;
    box-shadow: 0 4px 10px rgba(251, 140, 0, 0.25);
}

.btn-search-submit:hover {
    background-color: var(--primary-hover);
    transform: translateY(-1px);
}

.search-divider {
    height: 1px;
    background-color: #eee;
    margin: 10px 20px;
}

/* Riga Inferiore (Filtri) */
.filters-row {
    display: flex;
    gap: 15px;
    padding: 5px 15px 10px 15px;
}

.filter-item {
    display: flex;
    align-items: center;
    background-color: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 30px;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.2s;
    flex: 1;
    justify-content: center;
}

.filter-item:hover {
    border-color: var(--primary-color);
    background-color: #fff8e1;
}

.filter-item .material-icons {
    font-size: 18px;
    color: #616161;
    margin-right: 8px;
}

.filter-item select {
    border: none;
    background: transparent;
    font-size: 0.9rem;
    color: #424242;
    outline: none;
    cursor: pointer;
    font-weight: 500;
    appearance: none;
    -webkit-appearance: none;
    width: 100%;
}

/* ================= CARDS & LISTA ================= */

.recent-section {
    max-width: 1100px;
    margin: 24px auto 40px;
    padding: 0 24px;
}

.section-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 16px;
}

.section-header h2 {
    font-size: 1.4rem;
    font-weight: 600;
    color: #202124;
}

.result-count { font-size: 0.85rem; color: #757575; }

.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 16px;
}

.card-link {
    text-decoration: none;
    color: inherit;
    display: block;
    transition: transform 0.2s ease;
}

.card-link:hover { transform: translateY(-5px); }

.card {
    background-color: #FFFFFF;
    border-radius: 16px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
    padding: 12px 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    height: 100%;
}

.card-badges { display: flex; gap: 6px; }

.badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.badge-active { background-color: #E8F5E9; color: #2E7D32; }
.badge-closed { background-color: #FFEBEE; color: #C62828; border: 1px solid #FFCDD2; }
.badge-type { background-color: #FFF3E0; color: #E65100; }

.card-image-placeholder {
    height: 120px;
    border-radius: 12px;
    background: linear-gradient(135deg, #F5F5F5, #E0E0E0);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9E9E9E;
}

.card-image-placeholder .material-icons { font-size: 42px; }

.card-footer { margin-top: auto; }

.card-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 2px;
    color: #202124;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.card-info { font-size: 0.85rem; color: #757575; }

/* ================= USER MENU ================= */

.user-menu { position: relative; display: flex; align-items: center; }

.user-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    width: 230px;
    background-color: #FFFFFF;
    border-radius: 14px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    padding: 10px 0;
    opacity: 0;
    transform: translateY(6px);
    pointer-events: none;
    transition: opacity 0.15s ease, transform 0.15s ease;
    z-index: 30;
}
/* --- Navbar e dropdown utente (forzato) --- */

.navbar {
    position: relative;
    z-index: 2000;          /* la navbar sta sopra tutto il resto */
}

.user-menu {
    position: relative;     /* riferimento per il dropdown */
    z-index: 2100;
}

.user-dropdown {
    position: absolute;
    top: 52px;              /* adattalo se serve */
    right: 0;
    z-index: 2200;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    padding: 12px 0;

    opacity: 0;
    pointer-events: none;
    transform: translateY(6px);
    transition: opacity 0.15s ease, transform 0.15s ease;
}

.user-menu.open .user-dropdown {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
}


.user-menu.open .user-dropdown { opacity: 1; transform: translateY(0); pointer-events: auto; }

.user-dropdown-header { padding: 8px 14px 10px; border-bottom: 1px solid #F1F3F4; }
.user-email { font-size: 0.85rem; color: #5F6368; margin-bottom: 4px; word-break: break-all; }
.user-points-row { display: flex; align-items: center; gap: 6px; }
.points-label { font-size: 0.75rem; color: #FFAB91; }
.points-value { font-size: 0.9rem; font-weight: 600; color: #E65100; }

.user-dropdown-item {
    display: flex; align-items: center; gap: 10px; padding: 8px 14px;
    font-size: 0.9rem; text-decoration: none; color: #202124;
    transition: background-color 0.15s ease;
}
.user-dropdown-item:hover { background-color: #FFF3E0; }
.user-dropdown-item-logout { color: #D32F2F; }

/* ================= RESPONSIVE ================= */

@media (max-width: 1200px) and (min-width: 851px) {
    .navbar { padding: 8px 32px; }
    .brand-icon img { height: 90px; }
    .nav-links { flex: 1; justify-content: center; gap: 12px; }
}

@media (max-width: 850px) {
    .navbar { padding: 8px 16px 8px 8px; }
    .brand-icon img { height: 90px; }
    .nav-item, .btn-login-nav { font-size: 0; padding: 6px; }
    .nav-item .material-icons, .btn-login-nav .material-icons { font-size: 22px; }
}

@media (max-width: 768px) {
    .hero { padding: 60px 16px 100px; }
    .hero h1 { font-size: 2.4rem; }
    .search-card { padding: 15px; }
    .search-main-row { flex-direction: column; padding: 0; }
    .input-group, .btn-search-submit { width: 100%; }
    .filters-row { flex-wrap: wrap; padding: 10px 0 0 0; }
    .filter-item { flex-grow: 1; justify-content: center; }
}

/* Animazioni */
.page-enter { opacity: 0; transform: translateY(10px); animation: pageFadeIn 0.6s ease-out forwards; }
@keyframes pageFadeIn { to { opacity: 1; transform: translateY(0); } }

.cards-grid .card { opacity: 0; transform: translateY(15px); animation: cardFadeIn 0.5s ease-out forwards; }
.cards-grid .card:nth-child(1) { animation-delay: 0.2s; }
.cards-grid .card:nth-child(2) { animation-delay: 0.35s; }
.cards-grid .card:nth-child(3) { animation-delay: 0.5s; }
@keyframes cardFadeIn { to { opacity: 1; transform: translateY(0); } }
</file>

<file path="README.md">
<div align="center">
  <img src="https://github.com/user-attachments/assets/6e9a0026-0671-45b5-bb89-6ae375693952" alt="logo_foundly" width="200" height="200" />
  <h1>Foundly</h1>
  <p>
    <b>The go-to platform for reporting, searching, and returning lost items.</b>
  </p>

  <p>
    <img src="https://img.shields.io/badge/Java-23-orange" alt="Java 23" />
    <img src="https://img.shields.io/badge/Jakarta%20EE-10-blue" alt="Jakarta EE 10" />
    <img src="https://img.shields.io/badge/Tomcat-11-yellow" alt="Apache Tomcat" />
    <img src="https://img.shields.io/badge/Database-MySQL-blue" alt="MySQL" />
    <img src="https://img.shields.io/badge/Build-Maven-C71A36" alt="Maven" />
  </p>
</div>

---

## üìñ About The Project

**Foundly** is a web application designed to digitize and simplify the process of returning lost items. 
We aim to build a network of honest citizens and local businesses (**Drop-Points**) collaborating to return what was lost in a **secure, traceable, and rewarding** way.

The system solves the issue of mistrust between strangers by introducing safe exchange points and a verification system (Secure Claim) based on specific questions.

---

## ‚ú® Key Features

### üë§ For Users (Finder & Owner)
- **Dual Role**: A single account to report found items or claim lost ones.
- **Secure Claim üõ°**: Anti-fraud system. The claimant must correctly answer verification questions set by the finder.
- **Lost Pets üêæ**: A dedicated section with specific fields for reporting lost pets.
- **Gamification üèÜ**: Earn points and badges (e.g., *Sherlock Holmes*) for every successful return.

### üè™ For Drop-Points (Businesses)
- **Business Registration**: Dedicated registration flow with business verification.
- **Custody Point**: Shops can offer themselves as safe locations for exchanges, increasing their local visibility.
- **Inventory Management**: Dashboard to track items in custody and manage check-in/check-out operations.

---

## üèó Architecture & Tech Stack

The project strictly follows the **MVC (Model-View-Controller)** architectural pattern to ensure maintainability and scalability.

### Backend
- **Language**: Java 23
- **Framework**: Jakarta EE 10 (Servlet 6.0)
- **Server**: Apache Tomcat 11.0.4
- **Security**: Password hashing via **BCrypt** (jBCrypt).
- **Data Access**: DAO (Data Access Object) pattern with custom Connection Pooling.
- **Service Layer**: Business logic completely separated from controllers.

### Database
- **DBMS**: MySQL (Hosted on Aiven Cloud)
- **Schema**: *Joined Inheritance* strategy for polymorphic report management (Objects vs. Animals).

### Frontend
- **Technology**: JSP (JavaServer Pages)
- **Styling**: Custom CSS3
- **Scripting**: JavaScript

---

## üöÄ Getting Started

To run Foundly locally in your development environment:

### Prerequisites
* JDK 23 or higher
* Apache Maven
* Apache Tomcat 11
* MySQL Server (or a connection to a Cloud DB)

### Installation

1.  **Clone the repository**
    ```bash
    git clone [https://github.com/YourUsername/Foundly.git](https://github.com/YourUsername/Foundly.git)
    cd Foundly
    ```

2.  **Database Setup**
    * Execute the `db/schema_v1.sql` script on your MySQL server to create the table structure.

3.  **Environment Configuration**
    * The project uses environment variables to secure credentials.
    * Configure the following in your IDE or OS:
        * `DB_PASSKEY`: Your MySQL user password.

4.  **Build & Run**
    ```bash
    mvn clean package
    ```
    * Deploy the generated `.war` file to your Tomcat server.
    * Access: `http://localhost:8080/Foundly`

## üë• Authors

This project was developed by the **NC05 Team** for the Bachelor's Degree in Computer Science at the **University of Salerno**.

| Name | Role | Contact |
| :--- | :--- | :--- |
| **Salvador Davide Passarelli** | Backend & Architecture | [Email](mailto:s.passarelli2@studenti.unisa.it) |
| **Natale Nappi** | Frontend & UI/UX | [Email](mailto:n.nappi8@studenti.unisa.it) |
| **Salvatore Lepore** | DataBase & UI/UX| [Email](mailto:s.lepore11@studenti.unisa.it) |

<p align="right">
  <i>Supervisor: Prof. Carmine Gravino</i>
</p>
</file>

</files>
