This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.mvn/
  wrapper/
    maven-wrapper.jar
    maven-wrapper.properties
db/
  insert.sql
  schemaDB.sql
doc/
  SOW_Foundly_2025-2026.pdf
src/
  main/
    java/
      controller/
        CreaSegnalazioneServlet.java
        IndexServlet.java
        LoginServlet.java
        LogoutServlet.java
        ProfiloServlet.java
        RecuperoPasswordServlet.java
        RegistrazioneDropPointServlet.java
        RegistrazioneUtenteServlet.java
      model/
        bean/
          enums/
            Badge.java
            CategoriaOggetto.java
            ModalitaConsegna.java
            Ruolo.java
            StatoDropPoint.java
            StatoReclamo.java
            StatoSegnalazione.java
            TipoSegnalazione.java
          DropPoint.java
          Reclamo.java
          Segnalazione.java
          SegnalazioneAnimale.java
          SegnalazioneOggetto.java
          Utente.java
        dao/
          DropPointDAO.java
          SegnalazioneDAO.java
          UtenteDAO.java
        service/
          DropPointService.java
          EmailService.java
          RecuperoPasswordService.java
          SegnalazioneService.java
          UtenteService.java
        utente/
          ConnectionTest.java
        utils/
          GeocodingUtils.java
          PasswordUtils.java
        ConPool.java
    webapp/
      assets/
        images/
          badges/
            badge_detective.png
            badge_occhio_di_falco.png
            badge_sherlock_holmes.png
          logo.png
      css/
        index.css
        login.css
        profilo.css
      javascript/
        index.js
      WEB-INF/
        jsp/
          crea_segnalazione.jsp
          index.jsp
          login.jsp
          profilo.jsp
          recupero_password_codice.jsp
          recupero_password_email.jsp
          registrazione_droppoint.jsp
          registrazione_utente.jsp
        web.xml
.gitignore
mvnw
mvnw.cmd
pom.xml
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".mvn/wrapper/maven-wrapper.properties">
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.6/apache-maven-3.9.6-bin.zip
wrapperUrl=https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.3.0/maven-wrapper-3.3.0.jar
</file>

<file path="db/schemaDB.sql">
DROP DATABASE IF EXISTS defaultdb;
CREATE DATABASE defaultdb;
USE defaultdb;

-- 1. UTENTE
CREATE TABLE utente
(
    id                 BIGINT AUTO_INCREMENT PRIMARY KEY,
    username           VARCHAR(50)  NOT NULL UNIQUE,
    email              VARCHAR(100) NOT NULL UNIQUE,
    password_hash      VARCHAR(255) NOT NULL,
    nome               VARCHAR(50)  NOT NULL,
    cognome            VARCHAR(50)  NOT NULL,
    telefono           VARCHAR(20),
    immagine_profilo   VARCHAR(255),
    punteggio          INT                                                      DEFAULT 0,
    ruolo              ENUM ('UTENTE_BASE', 'ADMIN')                            DEFAULT 'UTENTE_BASE',
    badge              ENUM ('OCCHIO_DI_FALCO', 'DETECTIVE', 'SHERLOCK_HOLMES') DEFAULT 'OCCHIO_DI_FALCO'
);

-- 2. DROP-POINT
CREATE TABLE drop_point
(
    id                BIGINT AUTO_INCREMENT PRIMARY KEY,
    nome_attivita     VARCHAR(100) NOT NULL,
    email             VARCHAR(100) NOT NULL UNIQUE,
    password_hash     VARCHAR(255) NOT NULL,
    indirizzo         VARCHAR(100) NOT NULL,
    citta             VARCHAR(50)  NOT NULL,
    provincia         VARCHAR(50)  NOT NULL,
    telefono          VARCHAR(20),
    orari_apertura    VARCHAR(255),
    descrizione       TEXT,
    immagine          VARCHAR(255),
    latitudine        DOUBLE,
    longitudine       DOUBLE,
    ritiri_effettuati INT                                          DEFAULT 0,
    stato             ENUM ('IN_ATTESA', 'APPROVATO', 'RIFIUTATO') DEFAULT 'IN_ATTESA'
);

-- 3. SEGNALAZIONE (Tabella Padre - Abstract)
CREATE TABLE segnalazione
(
    id                 BIGINT AUTO_INCREMENT PRIMARY KEY,
    id_utente          BIGINT                      NOT NULL,
    titolo             VARCHAR(100)                NOT NULL,
    descrizione        TEXT                        NOT NULL,
    data_ritrovamento  DATETIME                    NOT NULL,
    luogo_ritrovamento VARCHAR(100)                NOT NULL,
    citta              VARCHAR(50)                 NOT NULL,
    provincia          VARCHAR(50)                 NOT NULL,
    latitudine         DOUBLE,
    longitudine        DOUBLE,
    immagine           VARCHAR(255),
    domanda_verifica1  VARCHAR(255)                NOT NULL,
    domanda_verifica2  VARCHAR(255)                NOT NULL,
    data_pubblicazione DATETIME                                 DEFAULT CURRENT_TIMESTAMP,
    stato              ENUM ('APERTA', 'IN_CONSEGNA', 'CHIUSA') DEFAULT 'APERTA',
    tipo_segnalazione  ENUM ('OGGETTO', 'ANIMALE') NOT NULL,
    FOREIGN KEY (id_utente) REFERENCES utente (id) ON DELETE CASCADE
);

-- 4. SEGNALAZIONE OGGETTO (Estensione)
CREATE TABLE segnalazione_oggetto
(
    id_segnalazione   BIGINT PRIMARY KEY,
    categoria         ENUM ('DOCUMENTI', 'ELETTRONICA', 'PORTAFOGLI', 'CHIAVI', 'GIOIELLI', 'ABBIGLIAMENTO', 'ALTRO') NOT NULL,
    modalita_consegna ENUM ('DIRETTA', 'DROP_POINT')                                                                  NOT NULL,
    id_drop_point     BIGINT,
    FOREIGN KEY (id_segnalazione) REFERENCES segnalazione (id) ON DELETE CASCADE,
    FOREIGN KEY (id_drop_point) REFERENCES drop_point (id) ON DELETE SET NULL
);

-- 5. SEGNALAZIONE ANIMALE (Estensione)
CREATE TABLE segnalazione_animale
(
    id_segnalazione BIGINT PRIMARY KEY,
    specie          VARCHAR(50) NOT NULL,
    razza           VARCHAR(50),
    FOREIGN KEY (id_segnalazione) REFERENCES segnalazione (id) ON DELETE CASCADE
);

-- 6. RECLAMO (Secure Claim)
CREATE TABLE reclamo
(
    id                    BIGINT AUTO_INCREMENT PRIMARY KEY,
    id_segnalazione       BIGINT       NOT NULL,
    id_utente_richiedente BIGINT       NOT NULL,
    risposta_verifica1    VARCHAR(255) NOT NULL,
    risposta_verifica2    VARCHAR(255) NOT NULL,
    data_richiesta        DATETIME                                     DEFAULT CURRENT_TIMESTAMP,
    stato                 ENUM ('IN_ATTESA', 'ACCETTATO', 'RIFIUTATO') DEFAULT 'IN_ATTESA',

    codice_consegna       VARCHAR(6) UNIQUE,
    data_deposito         DATETIME,
    data_ritiro           DATETIME,
    conferma_finder       BOOLEAN                                      DEFAULT FALSE,
    conferma_owner        BOOLEAN                                      DEFAULT FALSE,

    FOREIGN KEY (id_segnalazione) REFERENCES segnalazione (id) ON DELETE CASCADE,
    FOREIGN KEY (id_utente_richiedente) REFERENCES utente (id) ON DELETE CASCADE
);
</file>

<file path="src/main/java/controller/CreaSegnalazioneServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.MultipartConfig;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import jakarta.servlet.http.Part;
import model.bean.Segnalazione;
import model.bean.SegnalazioneAnimale;
import model.bean.SegnalazioneOggetto;
import model.bean.Utente;
import model.bean.enums.CategoriaOggetto;
import model.bean.enums.ModalitaConsegna;
import model.bean.enums.StatoSegnalazione;
import model.service.DropPointService;
import model.service.SegnalazioneService;

import java.io.File;
import java.io.IOException;
import java.sql.Timestamp;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.util.UUID;

@WebServlet(name = "CreaSegnalazioneServlet", value = "/crea-segnalazione")
@MultipartConfig(
        fileSizeThreshold = 1024 * 1024 * 2, // 2MB
        maxFileSize = 1024 * 1024 * 10,      // 10MB
        maxRequestSize = 1024 * 1024 * 50    // 50MB
)
public class CreaSegnalazioneServlet extends HttpServlet {

    private final DropPointService dropPointService = new DropPointService();
    private final SegnalazioneService segnalazioneService = new SegnalazioneService();

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        HttpSession session = request.getSession(false);
        Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (utente == null) {
            response.sendRedirect(request.getContextPath() + "/login");
            return;
        }

        // CARICA LA LISTA DEI DROP-POINT PER LA SELECT
        request.setAttribute("listaDropPoint", dropPointService.findAllApprovati());

        request.getRequestDispatcher("/WEB-INF/jsp/crea_segnalazione.jsp").forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        HttpSession session = request.getSession(false);
        Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (utente == null) {
            response.sendRedirect("login");
            return;
        }

        try {
            // 1. Recupero parametri comuni
            String tipo = request.getParameter("tipo"); // OGGETTO o ANIMALE
            String titolo = request.getParameter("titolo");
            String descrizione = request.getParameter("descrizione");
            String dataStr = request.getParameter("dataRitrovamento");
            String luogo = request.getParameter("luogo"); // Via/Piazza
            String citta = request.getParameter("citta");
            String provincia = request.getParameter("provincia");
            String domanda1 = request.getParameter("domanda1");
            String domanda2 = request.getParameter("domanda2");

            // 2. Creazione Oggetto Polimorfico
            Segnalazione segnalazione;

            // ... dentro doPost ...

            if ("OGGETTO".equalsIgnoreCase(tipo)) {
                SegnalazioneOggetto so = new SegnalazioneOggetto();
                String categoriaStr = request.getParameter("categoria");
                so.setCategoria(CategoriaOggetto.valueOf(categoriaStr));

                // NUOVA LOGICA CONSEGNA
                String modalitaStr = request.getParameter("modalita");
                if ("DROP_POINT".equals(modalitaStr)) {
                    so.setModalitaConsegna(ModalitaConsegna.DROP_POINT);
                    String idDpStr = request.getParameter("idDropPoint");
                    if (idDpStr != null && !idDpStr.isEmpty()) {
                        so.setIdDropPoint(Long.parseLong(idDpStr));
                    }
                } else {
                    so.setModalitaConsegna(ModalitaConsegna.DIRETTA);
                    so.setIdDropPoint(null);
                }

                segnalazione = so;
            } else {
                SegnalazioneAnimale sa = new SegnalazioneAnimale();
                sa.setSpecie(request.getParameter("specie"));
                sa.setRazza(request.getParameter("razza"));
                segnalazione = sa;
            }

            // 3. Popolamento Dati Comuni
            segnalazione.setIdUtente(utente.getId());
            segnalazione.setTitolo(titolo);
            segnalazione.setDescrizione(descrizione);
            segnalazione.setLuogoRitrovamento(luogo);
            segnalazione.setCitta(citta);
            segnalazione.setProvincia(provincia);
            segnalazione.setDomandaVerifica1(domanda1);
            segnalazione.setDomandaVerifica2(domanda2);
            segnalazione.setStato(StatoSegnalazione.APERTA);
            segnalazione.setDataPubblicazione(new Timestamp(System.currentTimeMillis()));

            // Conversione Data (da HTML yyyy-mm-dd a Timestamp)
            if (dataStr != null && !dataStr.isEmpty()) {
                LocalDate date = LocalDate.parse(dataStr);
                segnalazione.setDataRitrovamento(Timestamp.valueOf(LocalDateTime.of(date, LocalTime.NOON)));
            }

            // 4. Gestione Immagine (Salvataggio su disco)
            Part filePart = request.getPart("immagine");
            String fileName = "default.png";

            if (filePart != null && filePart.getSize() > 0) {
                // Genera nome unico per evitare sovrascritture
                String originalName = filePart.getSubmittedFileName();
                String ext = originalName.substring(originalName.lastIndexOf("."));
                fileName = UUID.randomUUID().toString() + ext;

                // Percorso di salvataggio (nella cartella upload del server)
                String uploadPath = getServletContext().getRealPath("") + File.separator + "uploads";
                File uploadDir = new File(uploadPath);
                if (!uploadDir.exists()) uploadDir.mkdir();

                filePart.write(uploadPath + File.separator + fileName);

                // Salviamo il path relativo nel DB (es. "uploads/foto.jpg")
                segnalazione.setImmagine("uploads/" + fileName);
            } else {
                segnalazione.setImmagine("assets/images/default-item.png");
            }

            // 5. Chiamata al Service (che far√† anche il Geocoding)
            boolean successo = segnalazioneService.creaSegnalazione(segnalazione);

            if (successo) {
                response.sendRedirect(request.getContextPath() + "/index?msg=success_segnalazione");
            } else {
                request.setAttribute("errore", "Errore nel salvataggio. Riprova.");
                request.getRequestDispatcher("/WEB-INF/jsp/crea_segnalazione.jsp").forward(request, response);
            }

        } catch (Exception e) {
            e.printStackTrace();
            request.setAttribute("errore", "Errore tecnico: " + e.getMessage());
            request.getRequestDispatcher("/WEB-INF/jsp/crea_segnalazione.jsp").forward(request, response);
        }
    }
}
</file>

<file path="src/main/java/controller/LogoutServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;

import java.io.IOException;

@WebServlet(name = "LogoutServlet", value = "/logout")
public class LogoutServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        // Recupera la sessione se esiste (false = non crearne una nuova)
        HttpSession session = request.getSession(false);
        if (session != null) {
            session.removeAttribute("utente");
        }

        // Dopo il logout rimanda alla home (o alla pagina di login se preferisci)
        response.sendRedirect(request.getContextPath() + "/index");
        // oppure:
        // response.sendRedirect(request.getContextPath() + "/login");
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {
        doGet(request, response);
    }
}
</file>

<file path="src/main/java/model/bean/enums/Badge.java">
package model.bean.enums;

public enum Badge {
    OCCHIO_DI_FALCO, DETECTIVE, SHERLOCK_HOLMES
}
</file>

<file path="src/main/java/model/bean/enums/CategoriaOggetto.java">
package model.bean.enums;

public enum CategoriaOggetto {
    DOCUMENTI, ELETTRONICA, PORTAFOGLI, CHIAVI, GIOIELLI, ABBIGLIAMENTO, ALTRO
}
</file>

<file path="src/main/java/model/bean/enums/ModalitaConsegna.java">
package model.bean.enums;

public enum ModalitaConsegna { DIRETTA, DROP_POINT }
</file>

<file path="src/main/java/model/bean/enums/Ruolo.java">
package model.bean.enums;

public enum Ruolo { UTENTE_BASE, ADMIN }
</file>

<file path="src/main/java/model/bean/enums/StatoDropPoint.java">
package model.bean.enums;


public enum StatoDropPoint {
    IN_ATTESA,
    APPROVATO,
    RIFIUTATO
}
</file>

<file path="src/main/java/model/bean/enums/StatoReclamo.java">
package model.bean.enums;

public enum StatoReclamo { IN_ATTESA, ACCETTATO, RIFIUTATO }
</file>

<file path="src/main/java/model/bean/enums/StatoSegnalazione.java">
package model.bean.enums;

public enum StatoSegnalazione { APERTA, IN_CONSEGNA, CHIUSA }
</file>

<file path="src/main/java/model/bean/enums/TipoSegnalazione.java">
package model.bean.enums;

public enum TipoSegnalazione { OGGETTO, ANIMALE }
</file>

<file path="src/main/java/model/bean/Reclamo.java">
package model.bean;

import model.bean.enums.StatoReclamo;
import java.sql.Timestamp;

public class Reclamo {
    private long id;
    private long idSegnalazione;
    private long idUtenteRichiedente;
    private String rispostaVerifica1;
    private String rispostaVerifica2;
    private Timestamp dataRichiesta;
    private StatoReclamo stato;

    // Gestione Consegna
    private String codiceConsegna;
    private Timestamp dataDeposito;
    private Timestamp dataRitiro;
    private boolean confermaFinder;
    private boolean confermaOwner;

    public Reclamo() {}

    // Getters e Setters
    public long getId() { return id; }
    public void setId(long id) { this.id = id; }

    public long getIdSegnalazione() { return idSegnalazione; }
    public void setIdSegnalazione(long idSegnalazione) { this.idSegnalazione = idSegnalazione; }

    public long getIdUtenteRichiedente() { return idUtenteRichiedente; }
    public void setIdUtenteRichiedente(long idUtenteRichiedente) { this.idUtenteRichiedente = idUtenteRichiedente; }

    public String getRispostaVerifica1() { return rispostaVerifica1; }
    public void setRispostaVerifica1(String rispostaVerifica1) { this.rispostaVerifica1 = rispostaVerifica1; }

    public String getRispostaVerifica2() { return rispostaVerifica2; }
    public void setRispostaVerifica2(String rispostaVerifica2) { this.rispostaVerifica2 = rispostaVerifica2; }

    public Timestamp getDataRichiesta() { return dataRichiesta; }
    public void setDataRichiesta(Timestamp dataRichiesta) { this.dataRichiesta = dataRichiesta; }

    public StatoReclamo getStato() { return stato; }
    public void setStato(StatoReclamo stato) { this.stato = stato; }

    public String getCodiceConsegna() { return codiceConsegna; }
    public void setCodiceConsegna(String codiceConsegna) { this.codiceConsegna = codiceConsegna; }

    public Timestamp getDataDeposito() { return dataDeposito; }
    public void setDataDeposito(Timestamp dataDeposito) { this.dataDeposito = dataDeposito; }

    public Timestamp getDataRitiro() { return dataRitiro; }
    public void setDataRitiro(Timestamp dataRitiro) { this.dataRitiro = dataRitiro; }

    public boolean isConfermaFinder() { return confermaFinder; }
    public void setConfermaFinder(boolean confermaFinder) { this.confermaFinder = confermaFinder; }

    public boolean isConfermaOwner() { return confermaOwner; }
    public void setConfermaOwner(boolean confermaOwner) { this.confermaOwner = confermaOwner; }
}
</file>

<file path="src/main/java/model/bean/Segnalazione.java">
package model.bean;

import model.bean.enums.StatoSegnalazione;
import model.bean.enums.TipoSegnalazione;
import java.sql.Timestamp;

public abstract class Segnalazione {
    private long id;
    private long idUtente;
    private String titolo;
    private String descrizione;
    private Timestamp dataRitrovamento;
    private String luogoRitrovamento;
    private String citta;
    private String provincia;
    private Double latitudine;
    private Double longitudine;
    private String immagine;
    private String domandaVerifica1;
    private String domandaVerifica2;
    private Timestamp dataPubblicazione;
    private StatoSegnalazione stato;
    private TipoSegnalazione tipoSegnalazione;

    public Segnalazione() {}

    // Getters e Setters
    public long getId() { return id; }
    public void setId(long id) { this.id = id; }

    public long getIdUtente() { return idUtente; }
    public void setIdUtente(long idUtente) { this.idUtente = idUtente; }

    public String getTitolo() { return titolo; }
    public void setTitolo(String titolo) { this.titolo = titolo; }

    public String getDescrizione() { return descrizione; }
    public void setDescrizione(String descrizione) { this.descrizione = descrizione; }

    public Timestamp getDataRitrovamento() { return dataRitrovamento; }
    public void setDataRitrovamento(Timestamp dataRitrovamento) { this.dataRitrovamento = dataRitrovamento; }

    public String getLuogoRitrovamento() { return luogoRitrovamento; }
    public void setLuogoRitrovamento(String luogoRitrovamento) { this.luogoRitrovamento = luogoRitrovamento; }

    public String getCitta() { return citta; }
    public void setCitta(String citta) { this.citta = citta; }

    public String getProvincia() { return provincia; }
    public void setProvincia(String provincia) { this.provincia = provincia; }

    public Double getLatitudine() { return latitudine; }
    public void setLatitudine(Double latitudine) { this.latitudine = latitudine; }

    public Double getLongitudine() { return longitudine; }
    public void setLongitudine(Double longitudine) { this.longitudine = longitudine; }

    public String getImmagine() { return immagine; }
    public void setImmagine(String immagine) { this.immagine = immagine; }

    public String getDomandaVerifica1() { return domandaVerifica1; }
    public void setDomandaVerifica1(String domandaVerifica1) { this.domandaVerifica1 = domandaVerifica1; }

    public String getDomandaVerifica2() { return domandaVerifica2; }
    public void setDomandaVerifica2(String domandaVerifica2) { this.domandaVerifica2 = domandaVerifica2; }

    public Timestamp getDataPubblicazione() { return dataPubblicazione; }
    public void setDataPubblicazione(Timestamp dataPubblicazione) { this.dataPubblicazione = dataPubblicazione; }

    public StatoSegnalazione getStato() { return stato; }
    public void setStato(StatoSegnalazione stato) { this.stato = stato; }

    public TipoSegnalazione getTipoSegnalazione() { return tipoSegnalazione; }
    public void setTipoSegnalazione(TipoSegnalazione tipoSegnalazione) { this.tipoSegnalazione = tipoSegnalazione; }
}
</file>

<file path="src/main/java/model/bean/SegnalazioneAnimale.java">
package model.bean;

import model.bean.enums.TipoSegnalazione;

public class SegnalazioneAnimale extends Segnalazione {
    private String specie;
    private String razza;

    public SegnalazioneAnimale() {
        super();
        this.setTipoSegnalazione(TipoSegnalazione.ANIMALE);
    }

    public String getSpecie() { return specie; }
    public void setSpecie(String specie) { this.specie = specie; }

    public String getRazza() { return razza; }
    public void setRazza(String razza) { this.razza = razza; }
}
</file>

<file path="src/main/java/model/bean/SegnalazioneOggetto.java">
package model.bean;

import model.bean.enums.CategoriaOggetto;
import model.bean.enums.ModalitaConsegna;
import model.bean.enums.TipoSegnalazione;

public class SegnalazioneOggetto extends Segnalazione {
    private CategoriaOggetto categoria;
    private ModalitaConsegna modalitaConsegna;
    private Long idDropPoint;

    public SegnalazioneOggetto() {
        super();
        this.setTipoSegnalazione(TipoSegnalazione.OGGETTO);
    }

    public CategoriaOggetto getCategoria() { return categoria; }
    public void setCategoria(CategoriaOggetto categoria) { this.categoria = categoria; }

    public ModalitaConsegna getModalitaConsegna() { return modalitaConsegna; }
    public void setModalitaConsegna(ModalitaConsegna modalitaConsegna) { this.modalitaConsegna = modalitaConsegna; }

    public Long getIdDropPoint() { return idDropPoint; }
    public void setIdDropPoint(Long idDropPoint) { this.idDropPoint = idDropPoint; }
}
</file>

<file path="src/main/java/model/bean/Utente.java">
package model.bean;

import model.bean.enums.Ruolo;

public class Utente {
    private long id;
    private String username;
    private String email;
    private String passwordHash;
    private String nome;
    private String cognome;
    private String telefono;
    private String immagineProfilo;
    private int punteggio;
    private Ruolo ruolo;
    private String badge;

    public Utente() {}

    // Getters e Setters
    public long getId() { return id; }
    public void setId(long id) { this.id = id; }

    public String getUsername() { return username; }
    public void setUsername(String username) { this.username = username; }

    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }

    public String getPasswordHash() { return passwordHash; }
    public void setPasswordHash(String passwordHash) { this.passwordHash = passwordHash; }

    public String getNome() { return nome; }
    public void setNome(String nome) { this.nome = nome; }

    public String getCognome() { return cognome; }
    public void setCognome(String cognome) { this.cognome = cognome; }

    public String getTelefono() { return telefono; }
    public void setTelefono(String telefono) { this.telefono = telefono; }

    public String getImmagineProfilo() { return immagineProfilo; }
    public void setImmagineProfilo(String immagineProfilo) { this.immagineProfilo = immagineProfilo; }

    public int getPunteggio() { return punteggio; }
    public void setPunteggio(int punteggio) { this.punteggio = punteggio; }

    public Ruolo getRuolo() { return ruolo; }
    public void setRuolo(Ruolo ruolo) { this.ruolo = ruolo; }

    public String getBadge() { return badge; }
    public void setBadge(String badge) { this.badge = badge; }
}
</file>

<file path="src/main/java/model/dao/SegnalazioneDAO.java">
package model.dao;

import model.ConPool;
import model.bean.Segnalazione;
import model.bean.SegnalazioneAnimale;
import model.bean.SegnalazioneOggetto;
import model.bean.enums.TipoSegnalazione;

import java.sql.*;

public class SegnalazioneDAO {

    /**
     * Salva una segnalazione (Oggetto o Animale) gestendo la strategia Joined.
     */
    public boolean doSave(Segnalazione s) {
        Connection con = null;
        PreparedStatement psPadre = null;
        PreparedStatement psFiglio = null;

        // Query per la tabella padre
        String sqlPadre = "INSERT INTO segnalazione (id_utente, titolo, descrizione, data_ritrovamento, " +
                "luogo_ritrovamento, citta, provincia, latitudine, longitudine, immagine, " +
                "domanda_verifica1, domanda_verifica2, stato, tipo_segnalazione) " +
                "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

        try {
            con = ConPool.getConnection();
            con.setAutoCommit(false); // Iniziamo una transazione manuale

            // 1. Inserimento tabella PADRE
            psPadre = con.prepareStatement(sqlPadre, Statement.RETURN_GENERATED_KEYS);
            psPadre.setLong(1, s.getIdUtente());
            psPadre.setString(2, s.getTitolo());
            psPadre.setString(3, s.getDescrizione());
            psPadre.setTimestamp(4, s.getDataRitrovamento());
            psPadre.setString(5, s.getLuogoRitrovamento());
            psPadre.setString(6, s.getCitta());
            psPadre.setString(7, s.getProvincia());
            psPadre.setDouble(8, s.getLatitudine());
            psPadre.setDouble(9, s.getLongitudine());
            psPadre.setString(10, s.getImmagine());
            psPadre.setString(11, s.getDomandaVerifica1());
            psPadre.setString(12, s.getDomandaVerifica2());
            psPadre.setString(13, s.getStato().toString());
            psPadre.setString(14, s.getTipoSegnalazione().toString());

            int resultPadre = psPadre.executeUpdate();

            if (resultPadre > 0) {
                // Recuperiamo ID generato
                ResultSet generatedKeys = psPadre.getGeneratedKeys();
                if (generatedKeys.next()) {
                    long idSegnalazione = generatedKeys.getLong(1);
                    s.setId(idSegnalazione);

                    // 2. Inserimento tabella FIGLIA in base al tipo
                    if (s instanceof SegnalazioneOggetto) {
                        SegnalazioneOggetto so = (SegnalazioneOggetto) s;
                        String sqlOggetto = "INSERT INTO segnalazione_oggetto (id_segnalazione, categoria, modalita_consegna, id_drop_point) VALUES (?, ?, ?, ?)";
                        psFiglio = con.prepareStatement(sqlOggetto);
                        psFiglio.setLong(1, idSegnalazione);
                        psFiglio.setString(2, so.getCategoria().toString());
                        psFiglio.setString(3, so.getModalitaConsegna().toString());

                        if (so.getIdDropPoint() != null && so.getIdDropPoint() > 0) {
                            psFiglio.setLong(4, so.getIdDropPoint());
                        } else {
                            psFiglio.setNull(4, Types.BIGINT);
                        }

                    } else if (s instanceof SegnalazioneAnimale) {
                        SegnalazioneAnimale sa = (SegnalazioneAnimale) s;
                        String sqlAnimale = "INSERT INTO segnalazione_animale (id_segnalazione, specie, razza) VALUES (?, ?, ?)";
                        psFiglio = con.prepareStatement(sqlAnimale);
                        psFiglio.setLong(1, idSegnalazione);
                        psFiglio.setString(2, sa.getSpecie());
                        psFiglio.setString(3, sa.getRazza());
                    }

                    // Eseguiamo insert figlio
                    if (psFiglio != null) {
                        psFiglio.executeUpdate();
                    }

                    con.commit(); // Conferma tutto
                    return true;
                }
            }
            con.rollback(); // Se qualcosa va storto, annulla l'inserimento padre
            return false;

        } catch (SQLException e) {
            try {
                if (con != null) con.rollback();
            } catch (SQLException ex) {
                ex.printStackTrace();
            }
            e.printStackTrace();
            return false;
        } finally {
            // Chiudiamo tutto manualmente perch√© non usiamo try-with-resources per gestire il rollback
            try {
                if (psPadre != null) psPadre.close();
                if (psFiglio != null) psFiglio.close();
                if (con != null) {
                    con.setAutoCommit(true); // Ripristina default
                    con.close();
                }
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }

    /**
     * Recupera le ultime N segnalazioni ordinate per data decrescente.
     */
    public java.util.List<Segnalazione> doRetrieveLatest(int limit) {
        java.util.List<Segnalazione> list = new java.util.ArrayList<>();

        // Query che unisce Padre + Figlio Oggetto + Figlio Animale
        String query = "SELECT s.*, " +
                "so.categoria, so.modalita_consegna, so.id_drop_point, " +
                "sa.specie, sa.razza " +
                "FROM segnalazione s " +
                "LEFT JOIN segnalazione_oggetto so ON s.id = so.id_segnalazione " +
                "LEFT JOIN segnalazione_animale sa ON s.id = sa.id_segnalazione " +
                "WHERE s.stato = 'APERTA' " + // Mostriamo solo quelle aperte
                "ORDER BY s.data_pubblicazione DESC " +
                "LIMIT ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setInt(1, limit);

            try (ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    Segnalazione s = null;
                    String tipoStr = rs.getString("tipo_segnalazione");

                    // Istanziamo il bean corretto in base al tipo
                    if ("OGGETTO".equals(tipoStr)) {
                        SegnalazioneOggetto so = new SegnalazioneOggetto();
                        try {
                            so.setCategoria(model.bean.enums.CategoriaOggetto.valueOf(rs.getString("categoria")));
                            so.setModalitaConsegna(model.bean.enums.ModalitaConsegna.valueOf(rs.getString("modalita_consegna")));
                        } catch (Exception e) { /* Enum error handling */ }
                        so.setIdDropPoint(rs.getLong("id_drop_point"));
                        if (rs.wasNull()) so.setIdDropPoint(null);
                        s = so;
                    } else {
                        SegnalazioneAnimale sa = new SegnalazioneAnimale();
                        sa.setSpecie(rs.getString("specie"));
                        sa.setRazza(rs.getString("razza"));
                        s = sa;
                    }

                    // Popoliamo i dati comuni (Tabella Padre)
                    s.setId(rs.getLong("id"));
                    s.setIdUtente(rs.getLong("id_utente"));
                    s.setTitolo(rs.getString("titolo"));
                    s.setDescrizione(rs.getString("descrizione"));
                    s.setDataRitrovamento(rs.getTimestamp("data_ritrovamento"));
                    s.setLuogoRitrovamento(rs.getString("luogo_ritrovamento"));
                    s.setCitta(rs.getString("citta"));
                    s.setProvincia(rs.getString("provincia"));
                    s.setLatitudine(rs.getDouble("latitudine"));
                    s.setLongitudine(rs.getDouble("longitudine"));
                    s.setImmagine(rs.getString("immagine"));
                    s.setDataPubblicazione(rs.getTimestamp("data_pubblicazione"));

                    try {
                        s.setStato(model.bean.enums.StatoSegnalazione.valueOf(rs.getString("stato")));
                        s.setTipoSegnalazione(model.bean.enums.TipoSegnalazione.valueOf(tipoStr));
                    } catch (Exception e) { /* Enum handling */ }

                    list.add(s);
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return list;
    }
}
</file>

<file path="src/main/java/model/service/RecuperoPasswordService.java">
package model.service;

public class RecuperoPasswordService {
}
</file>

<file path="src/main/java/model/service/SegnalazioneService.java">
package model.service;

import model.bean.Segnalazione;
import model.dao.SegnalazioneDAO;
import model.utils.GeocodingUtils; // Importa la utility

public class SegnalazioneService {

    private final SegnalazioneDAO segnalazioneDAO = new SegnalazioneDAO();

    public boolean creaSegnalazione(Segnalazione segnalazione) {

        // 1. Calcolo automatico Latitudine e Longitudine
        // CORREZIONE: getIndirizzo() -> getLuogoRitrovamento()
        if (segnalazione.getLuogoRitrovamento() != null && !segnalazione.getLuogoRitrovamento().isEmpty() &&
                segnalazione.getCitta() != null && !segnalazione.getCitta().isEmpty()) {

            double[] coords = GeocodingUtils.getCoordinates(
                    segnalazione.getLuogoRitrovamento(), // QUI ERA L'ERRORE
                    segnalazione.getCitta(),
                    segnalazione.getProvincia()
            );

            segnalazione.setLatitudine(coords[0]);
            segnalazione.setLongitudine(coords[1]);
        }

        // 2. Salvataggio nel DB
        return segnalazioneDAO.doSave(segnalazione);
    }

    public java.util.List<Segnalazione> getUltimeSegnalazioni() {
        // Recuperiamo ad esempio le ultime 8 per la Home Page
        return segnalazioneDAO.doRetrieveLatest(8);
    }
}
</file>

<file path="src/main/java/model/utils/GeocodingUtils.java">
package model.utils;

import org.json.JSONArray;
import org.json.JSONObject;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

public class GeocodingUtils {

    // Coordinate di default (es. Roma) se l'indirizzo non viene trovato
    private static final double DEFAULT_LAT = 41.9028;
    private static final double DEFAULT_LON = 12.4964;

    /**
     * Restituisce un array di double {latitudine, longitudine} dato un indirizzo.
     */
    public static double[] getCoordinates(String indirizzo, String citta, String provincia) {
        try {
            // 1. Costruiamo la query per OpenStreetMap
            String fullAddress = indirizzo + ", " + citta + ", " + provincia;
            String encodedAddress = URLEncoder.encode(fullAddress, StandardCharsets.UTF_8);

            // URL API Nominatim (OpenStreetMap)
            String urlString = "https://nominatim.openstreetmap.org/search?q=" + encodedAddress + "&format=json&limit=1";

            URL url = new URL(urlString);
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("GET");

            // IMPORTANTE: Nominatim richiede uno User-Agent identificativo
            conn.setRequestProperty("User-Agent", "FoundlyApp/1.0 (student.project@unisa.it)");

            int responseCode = conn.getResponseCode();
            if (responseCode == 200) {
                BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                String inputLine;
                StringBuilder content = new StringBuilder();
                while ((inputLine = in.readLine()) != null) {
                    content.append(inputLine);
                }
                in.close();

                // 2. Parsiamo il JSON ricevuto
                JSONArray jsonArray = new JSONArray(content.toString());

                if (jsonArray.length() > 0) {
                    JSONObject location = jsonArray.getJSONObject(0);
                    double lat = location.getDouble("lat");
                    double lon = location.getDouble("lon");

                    System.out.println("Geocoding Successo: " + fullAddress + " -> " + lat + ", " + lon);
                    return new double[]{lat, lon};
                }
            } else {
                System.err.println("Errore API Geocoding: HTTP " + responseCode);
            }

        } catch (Exception e) {
            e.printStackTrace();
            System.err.println("Eccezione durante il geocoding per: " + indirizzo);
        }

        System.out.println("Indirizzo non trovato, uso coordinate default.");
        return new double[]{DEFAULT_LAT, DEFAULT_LON};
    }
}
</file>

<file path="src/main/java/model/utils/PasswordUtils.java">
package model.utils;

import org.mindrot.jbcrypt.BCrypt;

public class PasswordUtils {
    public static String hashPassword(String password) {
        return BCrypt.hashpw(password, BCrypt.gensalt(12));
    }
    public static boolean checkPassword(String plainPassword, String hashedPassword) {
        if (hashedPassword == null || !hashedPassword.startsWith("$2a$")) {
            throw new IllegalArgumentException("Hash non valido");
        }
        return BCrypt.checkpw(plainPassword, hashedPassword);
    }
}
</file>

<file path="src/main/webapp/WEB-INF/jsp/crea_segnalazione.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="model.bean.enums.CategoriaOggetto" %>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crea Segnalazione - Foundly</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">

    <style>
        /* Stili extra per il form dinamico */
        .hidden { display: none; }
        .form-section-title {
            font-size: 0.9rem;
            color: #E65100;
            text-transform: uppercase;
            font-weight: bold;
            margin: 20px 0 10px;
            border-bottom: 1px solid #FFE0B2;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="info-section">
        <div class="brand-header">
            <div class="brand-icon">
                <img src="${pageContext.request.contextPath}/assets/images/logo.png" alt="logo_foundly">
            </div>
        </div>
        <div class="hero-text">
            <h1>Nuova Segnalazione</h1>
            <p>Hai trovato qualcosa? Compila il modulo con i dettagli per aiutare il proprietario a ritrovarlo.</p>
            <div class="feature-pills">
                <span class="pill"><span class="material-icons">photo_camera</span> Foto</span>
                <span class="pill"><span class="material-icons">location_on</span> Geolocalizzazione</span>
                <span class="pill"><span class="material-icons">verified_user</span> Domande di Verifica</span>
            </div>
        </div>
    </div>

    <div class="auth-section">
        <div class="auth-card" style="max-width: 600px;">
            <h2>Dettagli Ritrovamento</h2>

            <% if (request.getAttribute("errore") != null) { %>
            <div style="background:#ffebee; color:#c62828; padding:10px; border-radius:8px; margin-bottom:15px;">
                <%= request.getAttribute("errore") %>
            </div>
            <% } %>

            <form action="${pageContext.request.contextPath}/crea-segnalazione" method="post" enctype="multipart/form-data">

                <div class="input-group">
                    <label>Cosa hai trovato?</label>
                    <select name="tipo" id="tipoSelect" onchange="toggleFormFields()" required style="width:100%; padding:12px; border-radius:8px; border:1px solid #ccc;">
                        <option value="OGGETTO">Un Oggetto</option>
                        <option value="ANIMALE">Un Animale</option>
                    </select>
                </div>

                <div id="fieldsOggetto">
                    <div class="input-group">
                        <label>Categoria</label>
                        <select name="categoria" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ccc;">
                            <% for(CategoriaOggetto c : CategoriaOggetto.values()) { %>
                            <option value="<%= c %>"><%= c %></option>
                            <% } %>
                        </select>
                    </div>
                </div>

                <div id="fieldsAnimale" class="hidden">
                    <div class="input-row">
                        <div class="input-group">
                            <label>Specie</label>
                            <input type="text" name="specie" placeholder="es. Cane, Gatto">
                        </div>
                        <div class="input-group">
                            <label>Razza (Opzionale)</label>
                            <input type="text" name="razza" placeholder="es. Labrador">
                        </div>
                    </div>
                </div>

                <div id="deliverySection" class="hidden">
                    <div class="form-section-title">Modalit√† di Restituzione</div>

                    <div class="input-group">
                        <label>Come vuoi restituirlo?</label>

                        <div class="radio-container">
                            <label class="radio-label">
                                <input type="radio" name="modalita" value="DIRETTA" checked onclick="toggleDropPointList(false)">
                                <span>Consegna Diretta (A mano)</span>
                            </label>

                            <label class="radio-label">
                                <input type="radio" name="modalita" value="DROP_POINT" onclick="toggleDropPointList(true)">
                                <span>Tramite Drop-Point (Negozio)</span>
                            </label>
                        </div>
                    </div>

                    <div id="dropPointSelection" class="hidden" style="margin-top: 15px;">
                        <div class="input-group">
                            <label>Scegli il Drop-Point pi√π vicino</label>
                            <select name="idDropPoint" id="selectDropPoint" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ccc;" onchange="showDropPointDetails()">
                                <option value="">-- Seleziona un negozio --</option>
                                <c:forEach var="dp" items="${listaDropPoint}">
                                    <option value="${dp.id}"
                                            data-indirizzo="${dp.indirizzo}, ${dp.citta} (${dp.provincia})"
                                            data-orari="${dp.orariApertura}"
                                            data-tel="${dp.telefono}">
                                            ${dp.nomeAttivita} - ${dp.citta}
                                    </option>
                                </c:forEach>
                            </select>

                            <div id="dropPointDetails" style="display:none; margin-top:15px; padding:15px; background:#f9f9f9; border-radius:8px; border-left: 4px solid #FB8C00;">
                                <h4 style="margin:0 0 5px 0; color:#E65100;">Dettagli Punto di Ritiro</h4>
                                <p style="margin:5px 0; font-size:0.9rem;"><strong>üìç Indirizzo:</strong> <span id="dpAddr"></span></p>
                                <p style="margin:5px 0; font-size:0.9rem;"><strong>üïí Orari:</strong> <span id="dpTime"></span></p>
                                <p style="margin:5px 0; font-size:0.9rem;"><strong>üìû Contatto:</strong> <span id="dpTel"></span></p>
                            </div>

                            <small style="color: #666;">Lasciando l'oggetto qui, il proprietario potr√† ritirarlo con un codice sicuro.</small>
                        </div>
                    </div>
                </div>

                <div class="form-section-title">Informazioni Generali</div>

                <div class="input-group">
                    <label>Titolo Annuncio</label>
                    <input type="text" name="titolo" placeholder="es. Mazzo di chiavi con portachiavi rosso" required>
                </div>

                <div class="input-group">
                    <label>Descrizione Dettagliata</label>
                    <textarea name="descrizione" rows="4" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;" required></textarea>
                </div>

                <div class="input-group">
                    <label>Data Ritrovamento</label>
                    <input type="date" name="dataRitrovamento" required>
                </div>

                <div class="form-section-title">Posizione</div>

                <div class="input-group">
                    <label>Via / Piazza (Luogo esatto)</label>
                    <input type="text" name="luogo" placeholder="es. Via Roma 10" required>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label>Citt√†</label>
                        <input type="text" name="citta" required>
                    </div>
                    <div class="input-group">
                        <label>Provincia (Sigla)</label>
                        <input type="text" name="provincia" maxlength="2" placeholder="NA" required>
                    </div>
                </div>

                <div class="form-section-title">Sicurezza (Secure Claim)</div>
                <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">
                    Imposta due domande a cui solo il vero proprietario pu√≤ rispondere.
                </p>

                <div class="input-group">
                    <label>Domanda 1</label>
                    <input type="text" name="domanda1" placeholder="es. Di che colore √® il portachiavi?" required>
                </div>

                <div class="input-group">
                    <label>Domanda 2</label>
                    <input type="text" name="domanda2" placeholder="es. Quante chiavi ci sono?" required>
                </div>

                <div class="input-group">
                    <label>Foto (Opzionale)</label>
                    <input type="file" name="immagine" accept="image/*">
                </div>

                <button type="submit" class="btn-primary mt-2">Pubblica Segnalazione</button>
            </form>

            <div style="text-align:center; margin-top:20px;">
                <a href="${pageContext.request.contextPath}/index" style="color:#666; text-decoration:none;">Annulla</a>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleFormFields() {
        const tipo = document.getElementById("tipoSelect").value;
        const fieldsOggetto = document.getElementById("fieldsOggetto");
        const fieldsAnimale = document.getElementById("fieldsAnimale");
        const deliverySection = document.getElementById("deliverySection"); // Recupera la sezione consegna

        if (tipo === "OGGETTO") {
            fieldsOggetto.classList.remove("hidden");
            fieldsAnimale.classList.add("hidden");
            // MOSTRA la scelta consegna solo se √® un oggetto
            if (deliverySection) deliverySection.classList.remove("hidden");
        } else {
            fieldsOggetto.classList.add("hidden");
            fieldsAnimale.classList.remove("hidden");
            // NASCONDI la scelta consegna se √® un animale (sempre diretta)
            if (deliverySection) deliverySection.classList.add("hidden");
        }
    }

    // Nuova funzione per mostrare la tendina solo se si sceglie Drop-Point
    function toggleDropPointList(show) {
        const dpDiv = document.getElementById("dropPointSelection");
        if (show) {
            dpDiv.classList.remove("hidden");
            // Rendiamo la select obbligatoria se visibile
            const select = dpDiv.querySelector("select");
            if(select) select.setAttribute("required", "required");
        } else {
            dpDiv.classList.add("hidden");
            // Togliamo l'obbligo se nascosta
            const select = dpDiv.querySelector("select");
            if(select) select.removeAttribute("required");
        }
    }

    // Eseguiamo al caricamento per impostare lo stato corretto se la pagina viene ricaricata
    document.addEventListener("DOMContentLoaded", function() {
        toggleFormFields();
        // Controlla anche lo stato iniziale dei radio button
        const radioDrop = document.querySelector('input[name="modalita"][value="DROP_POINT"]');
        if (radioDrop && radioDrop.checked) {
            toggleDropPointList(true);
        } else {
            toggleDropPointList(false);
        }
    });

    function showDropPointDetails() {
        const select = document.getElementById("selectDropPoint");
        const detailsDiv = document.getElementById("dropPointDetails");

        // Prendi l'opzione selezionata
        const selectedOption = select.options[select.selectedIndex];

        // Se non ha valore (es. "-- Seleziona --"), nascondi tutto
        if (!select.value) {
            detailsDiv.style.display = "none";
            return;
        }

        // Recupera i dati dagli attributi data-...
        const indirizzo = selectedOption.getAttribute("data-indirizzo");
        const orari = selectedOption.getAttribute("data-orari");
        const tel = selectedOption.getAttribute("data-tel");

        // Riempi il box e mostralo
        document.getElementById("dpAddr").textContent = indirizzo;
        document.getElementById("dpTime").textContent = orari;
        document.getElementById("dpTel").textContent = tel;

        detailsDiv.style.display = "block";
    }
</script>

</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/web.xml">
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="https://jakarta.ee/xml/ns/jakartaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="https://jakarta.ee/xml/ns/jakartaee https://jakarta.ee/xml/ns/jakartaee/web-app_6_0.xsd"
         version="6.0">
</web-app>
</file>

<file path="mvnw">
#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Maven Start Up Batch script
#
# Required ENV vars:
# ------------------
#   JAVA_HOME - location of a JDK home dir
#
# Optional ENV vars
# -----------------
#   M2_HOME - location of maven2's installed home dir
#   MAVEN_OPTS - parameters passed to the Java VM when running Maven
#     e.g. to debug Maven itself, use
#       set MAVEN_OPTS=-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8000
#   MAVEN_SKIP_RC - flag to disable loading of mavenrc files
# ----------------------------------------------------------------------------

if [ -z "$MAVEN_SKIP_RC" ] ; then

  if [ -f /usr/local/etc/mavenrc ] ; then
    . /usr/local/etc/mavenrc
  fi

  if [ -f /etc/mavenrc ] ; then
    . /etc/mavenrc
  fi

  if [ -f "$HOME/.mavenrc" ] ; then
    . "$HOME/.mavenrc"
  fi

fi

# OS specific support.  $var _must_ be set to either true or false.
cygwin=false;
darwin=false;
mingw=false
case "`uname`" in
  CYGWIN*) cygwin=true ;;
  MINGW*) mingw=true;;
  Darwin*) darwin=true
    # Use /usr/libexec/java_home if available, otherwise fall back to /Library/Java/Home
    # See https://developer.apple.com/library/mac/qa/qa1170/_index.html
    if [ -z "$JAVA_HOME" ]; then
      if [ -x "/usr/libexec/java_home" ]; then
        export JAVA_HOME="`/usr/libexec/java_home`"
      else
        export JAVA_HOME="/Library/Java/Home"
      fi
    fi
    ;;
esac

if [ -z "$JAVA_HOME" ] ; then
  if [ -r /etc/gentoo-release ] ; then
    JAVA_HOME=`java-config --jre-home`
  fi
fi

if [ -z "$M2_HOME" ] ; then
  ## resolve links - $0 may be a link to maven's home
  PRG="$0"

  # need this for relative symlinks
  while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
      PRG="$link"
    else
      PRG="`dirname "$PRG"`/$link"
    fi
  done

  saveddir=`pwd`

  M2_HOME=`dirname "$PRG"`/..

  # make it fully qualified
  M2_HOME=`cd "$M2_HOME" && pwd`

  cd "$saveddir"
  # echo Using m2 at $M2_HOME
fi

# For Cygwin, ensure paths are in UNIX format before anything is touched
if $cygwin ; then
  [ -n "$M2_HOME" ] &&
    M2_HOME=`cygpath --unix "$M2_HOME"`
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME=`cygpath --unix "$JAVA_HOME"`
  [ -n "$CLASSPATH" ] &&
    CLASSPATH=`cygpath --path --unix "$CLASSPATH"`
fi

# For Mingw, ensure paths are in UNIX format before anything is touched
if $mingw ; then
  [ -n "$M2_HOME" ] &&
    M2_HOME="`(cd "$M2_HOME"; pwd)`"
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME="`(cd "$JAVA_HOME"; pwd)`"
fi

if [ -z "$JAVA_HOME" ]; then
  javaExecutable="`which javac`"
  if [ -n "$javaExecutable" ] && ! [ "`expr \"$javaExecutable\" : '\([^ ]*\)'`" = "no" ]; then
    # readlink(1) is not available as standard on Solaris 10.
    readLink=`which readlink`
    if [ ! `expr "$readLink" : '\([^ ]*\)'` = "no" ]; then
      if $darwin ; then
        javaHome="`dirname \"$javaExecutable\"`"
        javaExecutable="`cd \"$javaHome\" && pwd -P`/javac"
      else
        javaExecutable="`readlink -f \"$javaExecutable\"`"
      fi
      javaHome="`dirname \"$javaExecutable\"`"
      javaHome=`expr "$javaHome" : '\(.*\)/bin'`
      JAVA_HOME="$javaHome"
      export JAVA_HOME
    fi
  fi
fi

if [ -z "$JAVACMD" ] ; then
  if [ -n "$JAVA_HOME"  ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
    else
      JAVACMD="$JAVA_HOME/bin/java"
    fi
  else
    JAVACMD="`\\unset -f command; \\command -v java`"
  fi
fi

if [ ! -x "$JAVACMD" ] ; then
  echo "Error: JAVA_HOME is not defined correctly." >&2
  echo "  We cannot execute $JAVACMD" >&2
  exit 1
fi

if [ -z "$JAVA_HOME" ] ; then
  echo "Warning: JAVA_HOME environment variable is not set."
fi

CLASSWORLDS_LAUNCHER=org.codehaus.plexus.classworlds.launcher.Launcher

# traverses directory structure from process work directory to filesystem root
# first directory with .mvn subdirectory is considered project base directory
find_maven_basedir() {

  if [ -z "$1" ]
  then
    echo "Path not specified to find_maven_basedir"
    return 1
  fi

  basedir="$1"
  wdir="$1"
  while [ "$wdir" != '/' ] ; do
    if [ -d "$wdir"/.mvn ] ; then
      basedir=$wdir
      break
    fi
    # workaround for JBEAP-8937 (on Solaris 10/Sparc)
    if [ -d "${wdir}" ]; then
      wdir=`cd "$wdir/.."; pwd`
    fi
    # end of workaround
  done
  echo "${basedir}"
}

# concatenates all lines of a file
concat_lines() {
  if [ -f "$1" ]; then
    echo "$(tr -s '\n' ' ' < "$1")"
  fi
}

BASE_DIR=`find_maven_basedir "$(pwd)"`
if [ -z "$BASE_DIR" ]; then
  exit 1;
fi

##########################################################################################
# Extension to allow automatically downloading the maven-wrapper.jar from Maven-central
# This allows using the maven wrapper in projects that prohibit checking in binary data.
##########################################################################################
if [ -r "$BASE_DIR/.mvn/wrapper/maven-wrapper.jar" ]; then
    if [ "$MVNW_VERBOSE" = true ]; then
      echo "Found .mvn/wrapper/maven-wrapper.jar"
    fi
else
    if [ "$MVNW_VERBOSE" = true ]; then
      echo "Couldn't find .mvn/wrapper/maven-wrapper.jar, downloading it ..."
    fi
    if [ -n "$MVNW_REPOURL" ]; then
      jarUrl="$MVNW_REPOURL/org/apache/maven/wrapper/maven-wrapper/3.1.0/maven-wrapper-3.1.0.jar"
    else
      jarUrl="https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.1.0/maven-wrapper-3.1.0.jar"
    fi
    while IFS="=" read key value; do
      case "$key" in (wrapperUrl) jarUrl="$value"; break ;;
      esac
    done < "$BASE_DIR/.mvn/wrapper/maven-wrapper.properties"
    if [ "$MVNW_VERBOSE" = true ]; then
      echo "Downloading from: $jarUrl"
    fi
    wrapperJarPath="$BASE_DIR/.mvn/wrapper/maven-wrapper.jar"
    if $cygwin; then
      wrapperJarPath=`cygpath --path --windows "$wrapperJarPath"`
    fi

    if command -v wget > /dev/null; then
        if [ "$MVNW_VERBOSE" = true ]; then
          echo "Found wget ... using wget"
        fi
        if [ -z "$MVNW_USERNAME" ] || [ -z "$MVNW_PASSWORD" ]; then
            wget "$jarUrl" -O "$wrapperJarPath" || rm -f "$wrapperJarPath"
        else
            wget --http-user=$MVNW_USERNAME --http-password=$MVNW_PASSWORD "$jarUrl" -O "$wrapperJarPath" || rm -f "$wrapperJarPath"
        fi
    elif command -v curl > /dev/null; then
        if [ "$MVNW_VERBOSE" = true ]; then
          echo "Found curl ... using curl"
        fi
        if [ -z "$MVNW_USERNAME" ] || [ -z "$MVNW_PASSWORD" ]; then
            curl -o "$wrapperJarPath" "$jarUrl" -f
        else
            curl --user $MVNW_USERNAME:$MVNW_PASSWORD -o "$wrapperJarPath" "$jarUrl" -f
        fi

    else
        if [ "$MVNW_VERBOSE" = true ]; then
          echo "Falling back to using Java to download"
        fi
        javaClass="$BASE_DIR/.mvn/wrapper/MavenWrapperDownloader.java"
        # For Cygwin, switch paths to Windows format before running javac
        if $cygwin; then
          javaClass=`cygpath --path --windows "$javaClass"`
        fi
        if [ -e "$javaClass" ]; then
            if [ ! -e "$BASE_DIR/.mvn/wrapper/MavenWrapperDownloader.class" ]; then
                if [ "$MVNW_VERBOSE" = true ]; then
                  echo " - Compiling MavenWrapperDownloader.java ..."
                fi
                # Compiling the Java class
                ("$JAVA_HOME/bin/javac" "$javaClass")
            fi
            if [ -e "$BASE_DIR/.mvn/wrapper/MavenWrapperDownloader.class" ]; then
                # Running the downloader
                if [ "$MVNW_VERBOSE" = true ]; then
                  echo " - Running MavenWrapperDownloader.java ..."
                fi
                ("$JAVA_HOME/bin/java" -cp .mvn/wrapper MavenWrapperDownloader "$MAVEN_PROJECTBASEDIR")
            fi
        fi
    fi
fi
##########################################################################################
# End of extension
##########################################################################################

export MAVEN_PROJECTBASEDIR=${MAVEN_BASEDIR:-"$BASE_DIR"}
if [ "$MVNW_VERBOSE" = true ]; then
  echo $MAVEN_PROJECTBASEDIR
fi
MAVEN_OPTS="$(concat_lines "$MAVEN_PROJECTBASEDIR/.mvn/jvm.config") $MAVEN_OPTS"

# For Cygwin, switch paths to Windows format before running java
if $cygwin; then
  [ -n "$M2_HOME" ] &&
    M2_HOME=`cygpath --path --windows "$M2_HOME"`
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME=`cygpath --path --windows "$JAVA_HOME"`
  [ -n "$CLASSPATH" ] &&
    CLASSPATH=`cygpath --path --windows "$CLASSPATH"`
  [ -n "$MAVEN_PROJECTBASEDIR" ] &&
    MAVEN_PROJECTBASEDIR=`cygpath --path --windows "$MAVEN_PROJECTBASEDIR"`
fi

# Provide a "standardized" way to retrieve the CLI args that will
# work with both Windows and non-Windows executions.
MAVEN_CMD_LINE_ARGS="$MAVEN_CONFIG $@"
export MAVEN_CMD_LINE_ARGS

WRAPPER_LAUNCHER=org.apache.maven.wrapper.MavenWrapperMain

exec "$JAVACMD" \
  $MAVEN_OPTS \
  $MAVEN_DEBUG_OPTS \
  -classpath "$MAVEN_PROJECTBASEDIR/.mvn/wrapper/maven-wrapper.jar" \
  "-Dmaven.home=${M2_HOME}" \
  "-Dmaven.multiModuleProjectDirectory=${MAVEN_PROJECTBASEDIR}" \
  ${WRAPPER_LAUNCHER} $MAVEN_CONFIG "$@"
</file>

<file path="mvnw.cmd">
@REM ----------------------------------------------------------------------------
@REM Licensed to the Apache Software Foundation (ASF) under one
@REM or more contributor license agreements.  See the NOTICE file
@REM distributed with this work for additional information
@REM regarding copyright ownership.  The ASF licenses this file
@REM to you under the Apache License, Version 2.0 (the
@REM "License"); you may not use this file except in compliance
@REM with the License.  You may obtain a copy of the License at
@REM
@REM    https://www.apache.org/licenses/LICENSE-2.0
@REM
@REM Unless required by applicable law or agreed to in writing,
@REM software distributed under the License is distributed on an
@REM "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
@REM KIND, either express or implied.  See the License for the
@REM specific language governing permissions and limitations
@REM under the License.
@REM ----------------------------------------------------------------------------

@REM ----------------------------------------------------------------------------
@REM Maven Start Up Batch script
@REM
@REM Required ENV vars:
@REM JAVA_HOME - location of a JDK home dir
@REM
@REM Optional ENV vars
@REM M2_HOME - location of maven2's installed home dir
@REM MAVEN_BATCH_ECHO - set to 'on' to enable the echoing of the batch commands
@REM MAVEN_BATCH_PAUSE - set to 'on' to wait for a keystroke before ending
@REM MAVEN_OPTS - parameters passed to the Java VM when running Maven
@REM     e.g. to debug Maven itself, use
@REM set MAVEN_OPTS=-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8000
@REM MAVEN_SKIP_RC - flag to disable loading of mavenrc files
@REM ----------------------------------------------------------------------------

@REM Begin all REM lines with '@' in case MAVEN_BATCH_ECHO is 'on'
@echo off
@REM set title of command window
title %0
@REM enable echoing by setting MAVEN_BATCH_ECHO to 'on'
@if "%MAVEN_BATCH_ECHO%" == "on"  echo %MAVEN_BATCH_ECHO%

@REM set %HOME% to equivalent of $HOME
if "%HOME%" == "" (set "HOME=%HOMEDRIVE%%HOMEPATH%")

@REM Execute a user defined script before this one
if not "%MAVEN_SKIP_RC%" == "" goto skipRcPre
@REM check for pre script, once with legacy .bat ending and once with .cmd ending
if exist "%USERPROFILE%\mavenrc_pre.bat" call "%USERPROFILE%\mavenrc_pre.bat" %*
if exist "%USERPROFILE%\mavenrc_pre.cmd" call "%USERPROFILE%\mavenrc_pre.cmd" %*
:skipRcPre

@setlocal

set ERROR_CODE=0

@REM To isolate internal variables from possible post scripts, we use another setlocal
@setlocal

@REM ==== START VALIDATION ====
if not "%JAVA_HOME%" == "" goto OkJHome

echo.
echo Error: JAVA_HOME not found in your environment. >&2
echo Please set the JAVA_HOME variable in your environment to match the >&2
echo location of your Java installation. >&2
echo.
goto error

:OkJHome
if exist "%JAVA_HOME%\bin\java.exe" goto init

echo.
echo Error: JAVA_HOME is set to an invalid directory. >&2
echo JAVA_HOME = "%JAVA_HOME%" >&2
echo Please set the JAVA_HOME variable in your environment to match the >&2
echo location of your Java installation. >&2
echo.
goto error

@REM ==== END VALIDATION ====

:init

@REM Find the project base dir, i.e. the directory that contains the folder ".mvn".
@REM Fallback to current working directory if not found.

set MAVEN_PROJECTBASEDIR=%MAVEN_BASEDIR%
IF NOT "%MAVEN_PROJECTBASEDIR%"=="" goto endDetectBaseDir

set EXEC_DIR=%CD%
set WDIR=%EXEC_DIR%
:findBaseDir
IF EXIST "%WDIR%"\.mvn goto baseDirFound
cd ..
IF "%WDIR%"=="%CD%" goto baseDirNotFound
set WDIR=%CD%
goto findBaseDir

:baseDirFound
set MAVEN_PROJECTBASEDIR=%WDIR%
cd "%EXEC_DIR%"
goto endDetectBaseDir

:baseDirNotFound
set MAVEN_PROJECTBASEDIR=%EXEC_DIR%
cd "%EXEC_DIR%"

:endDetectBaseDir

IF NOT EXIST "%MAVEN_PROJECTBASEDIR%\.mvn\jvm.config" goto endReadAdditionalConfig

@setlocal EnableExtensions EnableDelayedExpansion
for /F "usebackq delims=" %%a in ("%MAVEN_PROJECTBASEDIR%\.mvn\jvm.config") do set JVM_CONFIG_MAVEN_PROPS=!JVM_CONFIG_MAVEN_PROPS! %%a
@endlocal & set JVM_CONFIG_MAVEN_PROPS=%JVM_CONFIG_MAVEN_PROPS%

:endReadAdditionalConfig

SET MAVEN_JAVA_EXE="%JAVA_HOME%\bin\java.exe"
set WRAPPER_JAR="%MAVEN_PROJECTBASEDIR%\.mvn\wrapper\maven-wrapper.jar"
set WRAPPER_LAUNCHER=org.apache.maven.wrapper.MavenWrapperMain

set DOWNLOAD_URL="https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.1.0/maven-wrapper-3.1.0.jar"

FOR /F "usebackq tokens=1,2 delims==" %%A IN ("%MAVEN_PROJECTBASEDIR%\.mvn\wrapper\maven-wrapper.properties") DO (
    IF "%%A"=="wrapperUrl" SET DOWNLOAD_URL=%%B
)

@REM Extension to allow automatically downloading the maven-wrapper.jar from Maven-central
@REM This allows using the maven wrapper in projects that prohibit checking in binary data.
if exist %WRAPPER_JAR% (
    if "%MVNW_VERBOSE%" == "true" (
        echo Found %WRAPPER_JAR%
    )
) else (
    if not "%MVNW_REPOURL%" == "" (
        SET DOWNLOAD_URL="%MVNW_REPOURL%/org/apache/maven/wrapper/maven-wrapper/3.1.0/maven-wrapper-3.1.0.jar"
    )
    if "%MVNW_VERBOSE%" == "true" (
        echo Couldn't find %WRAPPER_JAR%, downloading it ...
        echo Downloading from: %DOWNLOAD_URL%
    )

    powershell -Command "&{"^
		"$webclient = new-object System.Net.WebClient;"^
		"if (-not ([string]::IsNullOrEmpty('%MVNW_USERNAME%') -and [string]::IsNullOrEmpty('%MVNW_PASSWORD%'))) {"^
		"$webclient.Credentials = new-object System.Net.NetworkCredential('%MVNW_USERNAME%', '%MVNW_PASSWORD%');"^
		"}"^
		"[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; $webclient.DownloadFile('%DOWNLOAD_URL%', '%WRAPPER_JAR%')"^
		"}"
    if "%MVNW_VERBOSE%" == "true" (
        echo Finished downloading %WRAPPER_JAR%
    )
)
@REM End of extension

@REM Provide a "standardized" way to retrieve the CLI args that will
@REM work with both Windows and non-Windows executions.
set MAVEN_CMD_LINE_ARGS=%*

%MAVEN_JAVA_EXE% ^
  %JVM_CONFIG_MAVEN_PROPS% ^
  %MAVEN_OPTS% ^
  %MAVEN_DEBUG_OPTS% ^
  -classpath %WRAPPER_JAR% ^
  "-Dmaven.multiModuleProjectDirectory=%MAVEN_PROJECTBASEDIR%" ^
  %WRAPPER_LAUNCHER% %MAVEN_CONFIG% %*
if ERRORLEVEL 1 goto error
goto end

:error
set ERROR_CODE=1

:end
@endlocal & set ERROR_CODE=%ERROR_CODE%

if not "%MAVEN_SKIP_RC%"=="" goto skipRcPost
@REM check for post script, once with legacy .bat ending and once with .cmd ending
if exist "%USERPROFILE%\mavenrc_post.bat" call "%USERPROFILE%\mavenrc_post.bat"
if exist "%USERPROFILE%\mavenrc_post.cmd" call "%USERPROFILE%\mavenrc_post.cmd"
:skipRcPost

@REM pause the script if MAVEN_BATCH_PAUSE is set to 'on'
if "%MAVEN_BATCH_PAUSE%"=="on" pause

if "%MAVEN_TERMINATE_CMD%"=="on" exit %ERROR_CODE%

cmd /C exit /B %ERROR_CODE%
</file>

<file path="src/main/java/controller/IndexServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.bean.Segnalazione;
import model.service.SegnalazioneService;

import java.io.IOException;
import java.util.List;

@WebServlet(name = "IndexServlet", urlPatterns = {"/index"})
public class IndexServlet extends HttpServlet {

    private final SegnalazioneService segnalazioneService = new SegnalazioneService();

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        // 1. Recupera la lista dal DB
        List<Segnalazione> lista = segnalazioneService.getUltimeSegnalazioni();

        // 2. Passa la lista alla JSP
        request.setAttribute("segnalazioni", lista);

        request.getRequestDispatcher("/WEB-INF/jsp/index.jsp").forward(request, response);
    }
}
</file>

<file path="src/main/java/controller/ProfiloServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.MultipartConfig;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import jakarta.servlet.http.Part;
import model.bean.Utente;
import model.service.UtenteService;

import java.io.File;
import java.io.IOException;
import java.nio.file.Paths;

@WebServlet(name = "ProfiloServlet", value = "/profilo")
@MultipartConfig(
        maxFileSize = 5 * 1024 * 1024,        // 5 MB
        maxRequestSize = 10 * 1024 * 1024     // 10 MB
)
public class ProfiloServlet extends HttpServlet {

    private final UtenteService utenteService = new UtenteService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (utente == null) {
            response.sendRedirect(request.getContextPath() + "/login");
            return;
        }

        // mantiene il badge coerente con il punteggio
        utenteService.aggiornaPunteggioEBadge(utente, 0);
        session.setAttribute("utente", utente);

        request.getRequestDispatcher("/WEB-INF/jsp/profilo.jsp")
                .forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        Utente utente = (session != null) ? (Utente) session.getAttribute("utente") : null;

        if (utente == null) {
            response.sendRedirect(request.getContextPath() + "/login");
            return;
        }

        // campi testo
        String username = request.getParameter("username");
        String nome = request.getParameter("nome");
        String cognome = request.getParameter("cognome");

        utente.setUsername(username);
        utente.setNome(nome);
        utente.setCognome(cognome);

        // flag rimozione immagine
        String removeAvatarParam = request.getParameter("removeAvatar");
        boolean removeAvatar = "true".equalsIgnoreCase(removeAvatarParam);

        // upload immagine profilo (campo "avatar")
        Part avatarPart = null;
        try {
            avatarPart = request.getPart("avatar");
        } catch (IllegalStateException | ServletException e) {
            // se qualcosa va storto sull'upload, ignoro e tengo immagine precedente
        }

        boolean hasNewUpload = (avatarPart != null && avatarPart.getSize() > 0);

        if (hasNewUpload) {
            // elimina il vecchio file se esiste
            String oldPath = utente.getImmagineProfilo();
            if (oldPath != null && !oldPath.trim().isEmpty()) {
                String oldRealPath = getServletContext().getRealPath("/" + oldPath);
                File oldFile = new File(oldRealPath);
                if (oldFile.exists()) {
                    oldFile.delete();
                }
            }

            // nome file originale
            String submittedFileName = Paths.get(avatarPart.getSubmittedFileName())
                    .getFileName().toString();

            // estensione (es. .jpg, .png)
            String extension = "";
            int dotIndex = submittedFileName.lastIndexOf('.');
            if (dotIndex >= 0) {
                extension = submittedFileName.substring(dotIndex);
            }

            // nuovo nome file unico
            String newFileName = "avatar_" + utente.getId() + "_" + System.currentTimeMillis() + extension;

            // cartella di upload (es. .../webapp/uploads/avatars)
            String uploadPath = getServletContext().getRealPath("/uploads/avatars");
            File uploadDir = new File(uploadPath);
            if (!uploadDir.exists()) {
                uploadDir.mkdirs();
            }

            File targetFile = new File(uploadDir, newFileName);
            avatarPart.write(targetFile.getAbsolutePath());

            // path relativo da salvare nel DB
            String relativePath = "uploads/avatars/" + newFileName;
            utente.setImmagineProfilo(relativePath);

        } else if (removeAvatar) {
            // rimozione esplicita senza nuovo upload
            String oldPath = utente.getImmagineProfilo();
            if (oldPath != null && !oldPath.trim().isEmpty()) {
                String oldRealPath = getServletContext().getRealPath("/" + oldPath);
                File oldFile = new File(oldRealPath);
                if (oldFile.exists()) {
                    oldFile.delete();
                }
            }
            utente.setImmagineProfilo(null);
        }

        // aggiorna profilo (username, nome, cognome, immagine_profilo)
        utenteService.aggiornaProfilo(utente);

        // aggiorna sessione
        session.setAttribute("utente", utente);

        // redirect al profilo (per evitare il resubmit del POST)
        response.sendRedirect(request.getContextPath() + "/profilo?success=1");
    }
}
</file>

<file path="src/main/java/controller/RegistrazioneDropPointServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.service.DropPointService;
import java.io.IOException;

@WebServlet(name = "RegistrazioneDropPointServlet", value = "/registrazione-droppoint")
public class RegistrazioneDropPointServlet extends HttpServlet {

    private final DropPointService dpService = new DropPointService();

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        request.getRequestDispatcher("/WEB-INF/jsp/registrazione_droppoint.jsp").forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String nomeAttivita = request.getParameter("nomeAttivita");
        String email = request.getParameter("email");
        String password = request.getParameter("password");
        String indirizzo = request.getParameter("indirizzo");
        String citta = request.getParameter("citta");
        String provincia = request.getParameter("provincia");
        String telefono = request.getParameter("telefono");
        String orari = request.getParameter("orari");

        String latStr = request.getParameter("latitudine");
        String lonStr = request.getParameter("longitudine");

        Double latitudine = null;
        Double longitudine = null;

        try {
            if (latStr != null && !latStr.isEmpty()) latitudine = Double.parseDouble(latStr);
            if (lonStr != null && !lonStr.isEmpty()) longitudine = Double.parseDouble(lonStr);
        } catch (NumberFormatException e) {
            // Ignora
        }

        if (email == null || password == null || nomeAttivita == null || latitudine == null || longitudine == null) {
            request.setAttribute("errore", "Campi obbligatori mancanti o posizione mappa non selezionata.");
            request.getRequestDispatcher("/WEB-INF/jsp/registrazione_droppoint.jsp").forward(request, response);
            return;
        }

        // CORRETTO: Ordine parametri allineato col Service aggiornato (Lat, Lon)
        boolean successo = dpService.registraDropPoint(nomeAttivita, email, password, indirizzo, citta, provincia, telefono, orari, latitudine, longitudine);

        if (successo) {
            response.sendRedirect("login?registrazione=attesa_approvazione");
        } else {
            request.setAttribute("errore", "Email gi√† registrata per un altro Drop-Point.");
            request.getRequestDispatcher("/WEB-INF/jsp/registrazione_droppoint.jsp").forward(request, response);
        }
    }
}
</file>

<file path="src/main/java/controller/RegistrazioneUtenteServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.service.UtenteService;
import java.io.IOException;

@WebServlet(name = "RegistrazioneUtenteServlet", value = "/registrazione-utente")
public class RegistrazioneUtenteServlet extends HttpServlet {

    private final UtenteService utenteService = new UtenteService();

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // Mostra il form per gli utenti
        request.getRequestDispatcher("/WEB-INF/jsp/registrazione_utente.jsp").forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String nome = request.getParameter("nome");
        String cognome = request.getParameter("cognome");
        String username = request.getParameter("username");
        String email = request.getParameter("email");
        String password = request.getParameter("password");
        String telefono = request.getParameter("telefono");

        String passwordPattern = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&._-])[A-Za-z\\d@$!%*?&._-]{8,}$";

        if (!password.matches(passwordPattern)) {
            request.setAttribute("errore", "La password non rispetta i requisiti di sicurezza.");
            request.getRequestDispatcher("/WEB-INF/views/registrazione-utente.jsp").forward(request, response);
            return;
        }
        // Validazione minima
        if (email == null || password == null || username == null) {
            request.setAttribute("errore", "Campi obbligatori mancanti.");
            request.getRequestDispatcher("/WEB-INF/jsp/registrazione_utente.jsp").forward(request, response);
            return;
        }

        boolean successo = utenteService.registraUtente(nome, cognome, username, email, password, telefono);

        if (successo) {
            response.sendRedirect("login?registrazione=ok");
        } else {
            request.setAttribute("errore", "Email o Username gi√† esistenti.");
            request.getRequestDispatcher("/WEB-INF/jsp/registrazione_utente.jsp").forward(request, response);
        }



    }
}
</file>

<file path="src/main/java/model/bean/DropPoint.java">
package model.bean;

import model.bean.enums.StatoDropPoint; // Importa l'Enum esterno condiviso

public class DropPoint {
    private Long id;
    private String nomeAttivita;
    private String email;
    private String passwordHash;
    private String indirizzo;
    private String citta;
    private String provincia;
    private String telefono;
    private String orariApertura;

    // Rimosso 'descrizione' perch√© non esiste nella tabella SQL che abbiamo creato
    // private String descrizione;

    private String immagine;
    private Double latitudine;
    private Double longitudine;
    private int ritiriEffettuati;

    // Campo stato corretto
    private StatoDropPoint stato;

    public DropPoint() {}

    // Getters e Setters

    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public String getNomeAttivita() { return nomeAttivita; }
    public void setNomeAttivita(String nomeAttivita) { this.nomeAttivita = nomeAttivita; }

    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }

    public String getPasswordHash() { return passwordHash; }
    public void setPasswordHash(String passwordHash) { this.passwordHash = passwordHash; }

    public String getIndirizzo() { return indirizzo; }
    public void setIndirizzo(String indirizzo) { this.indirizzo = indirizzo; }

    public String getCitta() { return citta; }
    public void setCitta(String citta) { this.citta = citta; }

    public String getProvincia() { return provincia; }
    public void setProvincia(String provincia) { this.provincia = provincia; }

    public String getTelefono() { return telefono; }
    public void setTelefono(String telefono) { this.telefono = telefono; }

    public String getOrariApertura() { return orariApertura; }
    public void setOrariApertura(String orariApertura) { this.orariApertura = orariApertura; }

    public String getImmagine() { return immagine; }
    public void setImmagine(String immagine) { this.immagine = immagine; }

    public Double getLatitudine() { return latitudine; }
    public void setLatitudine(Double latitudine) { this.latitudine = latitudine; }

    // CORRETTO: Rimosso parametro dal getter
    public Double getLongitudine() { return longitudine; }
    public void setLongitudine(Double longitudine) { this.longitudine = longitudine; }

    public int getRitiriEffettuati() { return ritiriEffettuati; }
    public void setRitiriEffettuati(int ritiriEffettuati) { this.ritiriEffettuati = ritiriEffettuati; }

    // CORRETTO: Ora restituisce il campo stato
    public StatoDropPoint getStato() { return stato; }
    public void setStato(StatoDropPoint stato) { this.stato = stato; }
}
</file>

<file path="src/main/webapp/css/profilo.css">
/* Layout generale della pagina profilo */

.profile-main {
    max-width: 900px;
    margin: 32px auto 40px;
    padding: 0 24px;
}

/* CARD PROFILO */

.profile-card {
    background: linear-gradient(135deg, #FFF8E1 0%, #FFFFFF 45%, #FFF3E0 100%);
    border-radius: 24px;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.14);
    padding: 24px 24px 28px;
    border: 1px solid rgba(255, 183, 77, 0.45);
}

/* Header con avatar grande + nome & email */

.profile-header {
    display: flex;
    align-items: center;
    gap: 18px;
    margin-bottom: 20px;
}

/* wrapper avatar + bottone matita */

.profile-avatar-wrapper {
    position: relative;
    display: inline-block;
}

.profile-avatar-large {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: linear-gradient(135deg, #FFE0B2, #FB8C00);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    overflow: hidden;
}

.profile-avatar-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* matita in alto a destra */

.avatar-edit-btn {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: none;
    background: #FFFFFF;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
}

.avatar-edit-btn .material-icons {
    font-size: 16px;
    color: #FB8C00;
}

.avatar-edit-btn:hover {
    background-color: #FFF3E0;
}

.avatar-file-input {
    display: none;
}

.profile-title {
    font-size: 1.4rem;
    font-weight: 600;
    color: #202124;
    margin-bottom: 4px;
}

.profile-subtitle {
    font-size: 0.9rem;
    color: #5F6368;
}

/* BOX PUNTI: pi√π evidente */

.profile-points-box {
    margin: 12px 0 18px;
    padding: 14px 20px;
    border-radius: 18px;
    background: linear-gradient(135deg, #FF9800 0%, #FB8C00 40%, #EF6C00 90%);
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 10px 26px rgba(244, 143, 0, 0.5);
}

.points-left {
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.points-icon {
    font-size: 24px;
    color: #FFFDE7;
    text-shadow: 0 2px 5px rgba(0,0,0,0.35);
}

.points-label-big {
    font-size: 1.05rem;
    font-weight: 700;
    color: #FFFFFF;
    text-transform: uppercase;
    letter-spacing: 0.12em;
}

.points-right {
    display: flex;
    align-items: center;
}

.points-value-big {
    font-size: 3rem;
    font-weight: 800;
    color: #FFFFFF;
    text-shadow: 0 3px 8px rgba(0,0,0,0.4);
}

/* BADGE: medaglia grafica */

.profile-badge-card {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding: 10px 14px;
    border-radius: 16px;
    background-color: rgba(255, 243, 224, 0.9);
    border: 1px dashed rgba(251, 140, 0, 0.6);
}

.badge-medal {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 20%, #FFF3E0 0%, #FFB74D 40%, #F57C00 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    overflow: hidden;
}

.badge-medal-img {
    max-width: 48px;
    max-height: 48px;
    display: block;
}

.badge-texts {
    display: flex;
    flex-direction: column;
}

.badge-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #E65100;
    margin-bottom: 2px;
}

.badge-name {
    font-size: 1rem;
    font-weight: 600;
    color: #BF360C;
}

/* BOX MODIFICA DATI: un solo bottone Modifica */

.profile-edit-card {
    margin-bottom: 12px;
    padding: 14px 16px 10px;
    border-radius: 18px;
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid #FFE0B2;
}

.profile-edit-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
}

.profile-edit-header-left {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    color: #E65100;
}

.profile-edit-header-left .material-icons {
    font-size: 20px;
}

/* bottone principale Modifica */

.edit-main-button {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 14px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(135deg, #FFB74D 0%, #FB8C00 60%);
    color: #FFFFFF;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(251, 140, 0, 0.5);
    transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
}

.edit-main-button .material-icons {
    font-size: 18px;
}

.edit-main-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 5px 14px rgba(251, 140, 0, 0.7);
    filter: brightness(1.05);
}

.profile-edit-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 8px 0;
    border-top: 1px solid #FFE0B2;
}

.profile-edit-row:first-of-type {
    border-top: none;
}

.edit-field-text {
    display: flex;
    flex-direction: column;
}

.field-label {
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: #9E9E9E;
    margin-bottom: 2px;
}

.field-value {
    font-size: 0.95rem;
    color: #212121;
}

/* input in modalit√† edit */

.field-input {
    display: none;
    border: none;
    border-bottom: 1px solid #FFE0B2;
    padding: 4px 0;
    font-size: 0.95rem;
    background-color: transparent;
    color: #212121;
    outline: none;
}

.field-input:focus {
    border-color: #FB8C00;
}

/* default: solo view, niente bottoni azione */

.profile-edit-card .edit-mode {
    display: none;
}

.profile-edit-form .edit-actions {
    display: none;
    margin-top: 16px;
    justify-content: center;
    gap: 10px;
}

/* quando il form √® in editing */

.profile-edit-form.editing .view-mode {
    display: none;
}

.profile-edit-form.editing .edit-mode {
    display: block;
}

.profile-edit-form.editing .edit-actions {
    display: flex;
}

/* bottoni Conferma/Annulla */

.btn-confirm,
.btn-cancel {
    padding: 8px 16px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
}

.btn-confirm {
    background: linear-gradient(135deg, #FFB74D 0%, #FB8C00 60%);
    color: #FFFFFF;
    box-shadow: 0 3px 10px rgba(251, 140, 0, 0.5);
}

.btn-confirm:hover {
    filter: brightness(1.05);
}

.btn-cancel {
    background-color: #FFFFFF;
    color: #E65100;
    border: 1px solid #FFB74D;
}

.btn-cancel:hover {
    background-color: #FFF3E0;
}

/* Griglia campi profilo (altri dati) */

.profile-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 14px 18px;
    margin-top: 8px;
}

.profile-field {
    padding: 8px 10px;
    border-radius: 12px;
    background-color: #FAFAFA;
    border: 1px solid #EEEEEE;
}

/* Responsive */

@media (max-width: 768px) {
    .profile-card {
        padding: 20px 16px 22px;
    }

    .profile-main {
        padding: 0 16px;
    }

    .profile-header {
        flex-direction: row;
        align-items: center;
    }

    .profile-title {
        font-size: 1.2rem;
    }

    .points-value-big {
        font-size: 2.4rem;
    }

    .profile-edit-row {
        align-items: flex-start;
    }
}
/* overlay rosso per rimozione avatar */

.avatar-remove-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 72px;          /* stessa size di .profile-avatar-large */
    height: 72px;
    border-radius: 50%;
    background: rgba(244, 67, 54, 0.8); /* rosso semi-trasparente */
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 2;
}

.avatar-remove-overlay .material-icons {
    font-size: 26px;
    color: #FFFFFF;
}

/* mostra overlay solo quando c‚Äô√® un avatar e sei in hover */

.profile-avatar-wrapper.has-avatar:hover .avatar-remove-overlay {
    opacity: 1;
    pointer-events: auto;
}

/* scurisce un po' l'immagine sotto in hover */

.profile-avatar-wrapper.has-avatar:hover .profile-avatar-large img {
    filter: brightness(0.7);
}

/* matita sopra l'overlay */
.avatar-edit-btn {
    z-index: 3;
}
</file>

<file path="src/main/webapp/WEB-INF/jsp/profilo.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="model.bean.Utente" %>

<%
    Utente utente = (Utente) session.getAttribute("utente");
    if (utente == null) {
        response.sendRedirect(request.getContextPath() + "/login");
        return;
    }

    // ===== BADGE =====
    String rawBadge = utente.getBadge(); // OCCHIO_DI_FALCO / DETECTIVE / SHERLOCK_HOLMES

    String badgeDisplay = "";
    if (rawBadge != null) {
        String[] parts = rawBadge.toLowerCase().split("_");
        StringBuilder sb = new StringBuilder();
        for (String p : parts) {
            if (p == null || p.isEmpty()) continue;
            if (sb.length() > 0) sb.append(" ");
            sb.append(Character.toUpperCase(p.charAt(0)));
            if (p.length() > 1) sb.append(p.substring(1));
        }
        badgeDisplay = sb.toString();
    }

    String badgeImg = "badge_default.png";
    if ("OCCHIO_DI_FALCO".equals(rawBadge)) {
        badgeImg = "badge_occhio_di_falco.png";
    } else if ("DETECTIVE".equals(rawBadge)) {
        badgeImg = "badge_detective.png";
    } else if ("SHERLOCK_HOLMES".equals(rawBadge)) {
        badgeImg = "badge_sherlock_holmes.png";
    }

    // ===== AVATAR ===== (di default nessuna immagine)
    String avatarPath = utente.getImmagineProfilo();
    boolean hasAvatar = false;

    if (avatarPath != null && !avatarPath.trim().isEmpty()) {
        try {
            java.io.File avatarFile = new java.io.File(
                    application.getRealPath("/" + avatarPath)
            );
            hasAvatar = avatarFile.exists();
            if (!hasAvatar) {
                avatarPath = null;
            }
        } catch (Exception e) {
            hasAvatar = false;
            avatarPath = null;
        }
    }
%>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilo - Foundly</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/index.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/profilo.css">
</head>
<body class="page-enter">

<nav class="navbar">
    <a href="${pageContext.request.contextPath}/index" class="brand">
        <div class="brand-icon">
            <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
        </div>
    </a>

    <div class="nav-links">
        <a href="${pageContext.request.contextPath}/index" class="nav-item">
            <span class="material-icons">home</span> Home
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">add_circle_outline</span> Crea Segnalazione
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">inventory</span> Segnalazioni
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">place</span> Drop-Point
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">emoji_events</span> Classifica
        </a>
    </div>

    <%
        Utente utenteLoggato = (Utente) session.getAttribute("utente");

        String navAvatarPath = null;
        boolean navHasAvatar = false;

        if (utenteLoggato != null) {
            navAvatarPath = utenteLoggato.getImmagineProfilo();
            if (navAvatarPath != null && !navAvatarPath.trim().isEmpty()) {
                try {
                    java.io.File navFile = new java.io.File(
                            application.getRealPath("/" + navAvatarPath)
                    );
                    navHasAvatar = navFile.exists();
                    if (!navHasAvatar) {
                        navAvatarPath = null;
                    }
                } catch (Exception e) {
                    navHasAvatar = false;
                    navAvatarPath = null;
                }
            }
        }

        if (utenteLoggato != null) {
    %>
    <div class="user-menu">
        <button type="button" class="user-avatar-btn">
            <% if (navHasAvatar) { %>
            <img src="<%= request.getContextPath() + "/" + navAvatarPath %>"
                 alt=""
                 class="user-avatar-img">
            <% } else { %>
            <div class="user-avatar-placeholder"></div>
            <% } %>
        </button>

        <div class="user-dropdown">
            <div class="user-dropdown-header">
                <div class="user-email"><%= utenteLoggato.getEmail() %></div>
                <div class="user-points-row">
                    <span class="points-label">punti</span>
                    <span class="points-value"><%= utenteLoggato.getPunteggio() %></span>
                </div>
            </div>

            <a href="${pageContext.request.contextPath}/profilo" class="user-dropdown-item">
                <span class="material-icons">person</span>
                <span>Profilo</span>
            </a>
            <a href="${pageContext.request.contextPath}/logout" class="user-dropdown-item user-dropdown-item-logout">
                <span class="material-icons">logout</span>
                <span>Logout</span>
            </a>
        </div>
    </div>
    <%
    } else {
    %>
    <a href="${pageContext.request.contextPath}/login" class="btn-login-nav">
        <span class="material-icons">login</span>
        <span>Accedi</span>
    </a>
    <%
        }
    %>

</nav>

<main class="profile-main">
    <section class="profile-card">
        <!-- HEADER: avatar + nome + email -->
        <div class="profile-header">
            <div class="profile-avatar-wrapper <%= hasAvatar ? "has-avatar" : "" %>" id="avatarWrapper">
                <div class="profile-avatar-large">
                    <% if (hasAvatar) { %>
                    <img
                            src="<%= request.getContextPath() + "/" + avatarPath %>"
                            alt=""
                            id="profileAvatarImg">
                    <% } else { %>
                    <img
                            alt=""
                            id="profileAvatarImg"
                            style="display:none;">
                    <% } %>
                </div>

                <!-- overlay rosso con cestino -->
                <div class="avatar-remove-overlay" id="avatarRemoveOverlay">
                    <span class="material-icons">delete</span>
                </div>

                <button type="button" class="avatar-edit-btn" id="avatarEditBtn" title="Cambia foto profilo">
                    <span class="material-icons">edit</span>
                </button>
            </div>

            <div>
                <h1 class="profile-title">
                    <%= utente.getNome() %> <%= utente.getCognome() %>
                </h1>
                <p class="profile-subtitle">
                    <%= utente.getEmail() %>
                </p>
            </div>
        </div>

        <!-- BOX PUNTI -->
        <div class="profile-points-box">
            <div class="points-left">
                <span class="material-icons points-icon">star_rate</span>
                <span class="points-label-big">PUNTI TOTALI</span>
            </div>
            <div class="points-right">
                <span class="points-value-big">
                    <%= utente.getPunteggio() %>
                </span>
            </div>
        </div>

        <!-- BADGE -->
        <div class="profile-badge-card">
            <div class="badge-medal">
                <img src="<%= request.getContextPath() %>/assets/images/badges/<%= badgeImg %>"
                     alt="<%= badgeDisplay %>"
                     class="badge-medal-img">
            </div>
            <div class="badge-texts">
                <span class="badge-label">Badge</span>
                <span class="badge-name"><%= badgeDisplay %></span>
            </div>
        </div>

        <!-- FORM PROFILO (testo + avatar) -->
        <form method="post"
              action="${pageContext.request.contextPath}/profilo"
              id="profileEditForm"
              class="profile-edit-form"
              enctype="multipart/form-data">

            <!-- input file nascosto per l'avatar -->
            <input type="file"
                   name="avatar"
                   id="avatarInput"
                   accept="image/*"
                   class="avatar-file-input">

            <!-- flag rimozione avatar -->
            <input type="hidden"
                   name="removeAvatar"
                   id="removeAvatarField"
                   value="false">

            <section class="profile-edit-card" id="profileEditCard">
                <div class="profile-edit-header">
                    <div class="profile-edit-header-left">
                        <span class="material-icons">manage_accounts</span>
                        <span>Dettagli account</span>
                    </div>
                    <button type="button" class="edit-main-button" id="editToggleBtn">
                        <span class="material-icons">edit</span>
                        <span>Modifica</span>
                    </button>
                </div>

                <!-- USERNAME -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Username</span>
                        <span class="field-value view-mode" id="usernameView">
                            <%= utente.getUsername() %>
                        </span>
                        <input type="text"
                               class="field-input edit-mode"
                               name="username"
                               id="usernameInput"
                               value="<%= utente.getUsername() %>">
                    </div>
                </div>

                <!-- NOME -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Nome</span>
                        <span class="field-value view-mode" id="nomeView">
                            <%= utente.getNome() %>
                        </span>
                        <input type="text"
                               class="field-input edit-mode"
                               name="nome"
                               id="nomeInput"
                               value="<%= utente.getNome() %>">
                    </div>
                </div>

                <!-- COGNOME -->
                <div class="profile-edit-row">
                    <div class="edit-field-text">
                        <span class="field-label">Cognome</span>
                        <span class="field-value view-mode" id="cognomeView">
                            <%= utente.getCognome() %>
                        </span>
                        <input type="text"
                               class="field-input edit-mode"
                               name="cognome"
                               id="cognomeInput"
                               value="<%= utente.getCognome() %>">
                    </div>
                </div>
            </section>

            <!-- PULSANTI SOTTO IL BOX, CENTRATI -->
            <div class="edit-actions">
                <button type="submit" class="btn-confirm">
                    Conferma Modifiche
                </button>
                <button type="button" class="btn-cancel" id="cancelEditBtn">
                    Annulla Modifiche
                </button>
            </div>
        </form>

        <div class="profile-grid">
            <!-- altri campi in futuro -->
        </div>
    </section>
</main>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // ===== dropdown utente in navbar =====
        const userMenu = document.querySelector(".user-menu");
        if (userMenu) {
            const btnAvatarMenu = userMenu.querySelector(".user-avatar-btn");
            btnAvatarMenu.addEventListener("click", function (e) {
                e.stopPropagation();
                userMenu.classList.toggle("open");
            });
            document.addEventListener("click", function () {
                userMenu.classList.remove("open");
            });
        }

        const editForm          = document.getElementById("profileEditForm");
        const editToggleBtn     = document.getElementById("editToggleBtn");
        const cancelEditBtn     = document.getElementById("cancelEditBtn");

        const avatarWrapper     = document.getElementById("avatarWrapper");
        const avatarEditBtn     = document.getElementById("avatarEditBtn");
        const avatarRemoveOv    = document.getElementById("avatarRemoveOverlay");
        const avatarInput       = document.getElementById("avatarInput");
        const avatarImg         = document.getElementById("profileAvatarImg");
        const removeAvatarField = document.getElementById("removeAvatarField");

        // attiva/disattiva modalit√† editing per i campi testo
        if (editForm && editToggleBtn && cancelEditBtn) {
            editToggleBtn.addEventListener("click", function () {
                editForm.classList.add("editing");
            });

            cancelEditBtn.addEventListener("click", function () {
                window.location.reload();
            });
        }

        // click sulla matita -> selezione file
        if (avatarEditBtn && avatarInput && avatarImg) {
            avatarEditBtn.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (!editForm.classList.contains("editing")) {
                    editForm.classList.add("editing");
                }
                avatarInput.click();
            });

            avatarInput.addEventListener("change", function () {
                const file = avatarInput.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (ev) {
                    avatarImg.src = ev.target.result;
                    avatarImg.style.display = "block";
                    if (avatarWrapper) {
                        avatarWrapper.classList.add("has-avatar");
                    }
                    if (removeAvatarField) {
                        removeAvatarField.value = "false"; // stiamo caricando una nuova immagine
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // click sul cestino -> rimozione avatar (UI + flag per il server)
        if (avatarRemoveOv && avatarWrapper && avatarImg && avatarInput && removeAvatarField) {
            avatarRemoveOv.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (!editForm.classList.contains("editing")) {
                    editForm.classList.add("editing");
                }

                // segna la rimozione per il backend
                removeAvatarField.value = "true";

                // svuota eventuale file scelto
                avatarInput.value = "";

                // nasconde subito l'immagine
                avatarImg.src = "";
                avatarImg.style.display = "none";
                avatarWrapper.classList.remove("has-avatar");
            });
        }
    });
</script>

</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/jsp/recupero_password_codice.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Foundly - Conferma Recupero</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">

  <style>
    .info-section {
      background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
    }

    /* Stile footer form come nello screenshot */
    .form-footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;   /* linea orizzontale */
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      color: #666;
      font-size: 0.95rem;
    }

    .link-login {
      color: #FB8C00;
      font-weight: 600;
      text-decoration: none;
      padding: 0 4px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .link-login:hover {
      background-color: #FFF3E0;
      color: #E65100;
    }
  </style>
</head>
<body>

<div class="main-container">

  <div class="info-section">
    <div class="brand-header">
      <div class="brand-icon">
        <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
      </div>
    </div>

    <div class="hero-text">
      <h1>Inserisci il codice</h1>
      <p>
        Abbiamo inviato un codice di verifica all'indirizzo email specificato.
        Inserisci il codice ricevuto e scegli una nuova password.
      </p>
      <% String msg = (String) request.getAttribute("messaggio"); %>
      <% if (msg != null) { %>
      <p style="margin-top:10px;color:#2e7d32;font-size:0.9rem;"><%= msg %></p>
      <% } %>
    </div>
  </div>

  <div class="auth-section">
    <div class="auth-card">
      <h2>Verifica Codice</h2>
      <p class="subtitle">Inserisci il codice e la nuova password</p>

      <% String errore = (String) request.getAttribute("errore"); %>
      <% if (errore != null) { %>
      <div style="background-color:#ffebee;color:#c62828;padding:10px;border-radius:8px;margin-bottom:20px;font-size:0.9rem;text-align:center;">
        <span class="material-icons" style="font-size:16px;vertical-align:middle;">error</span>
        <%= errore %>
      </div>
      <% } %>

      <form action="${pageContext.request.contextPath}/recupero-password" method="post">
        <input type="hidden" name="step" value="codice">

        <div class="input-group">
          <label for="codice">Codice di verifica</label>
          <input type="text"
                 id="codice"
                 name="codice"
                 placeholder="es. 123456"
                 required
                 minlength="6"
                 maxlength="6">
        </div>

        <div class="input-group">
          <label for="nuovaPassword">Nuova password</label>
          <input type="password"
                 id="nuovaPassword"
                 name="nuovaPassword"
                 placeholder="Minimo 8 caratteri, con maiuscole, minuscole, numeri e simboli"
                 required>
        </div>

        <div class="input-group">
          <label for="confermaPassword">Conferma password</label>
          <input type="password"
                 id="confermaPassword"
                 name="confermaPassword"
                 placeholder="Ripeti la nuova password"
                 required>
        </div>

        <button type="submit" class="btn-primary mt-2">Conferma</button>
      </form>

      <div class="form-footer">
        <span>Hai ricordato la password?</span>
        <a href="${pageContext.request.contextPath}/login" class="link-login">Accedi qui</a>
      </div>
    </div>
  </div>

</div>

</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/jsp/recupero_password_email.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundly - Recupero Password</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">

    <style>
        .info-section {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
        }

        .pill.active {
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #FF9800;
        }

        /* Stile footer form come nello screenshot */
        .form-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;   /* linea orizzontale */
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 0.95rem;
        }

        .link-login {
            color: #FB8C00;
            font-weight: 600;
            text-decoration: none;
            padding: 0 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .link-login:hover {
            background-color: #FFF3E0;
            color: #E65100;
        }
    </style>
</head>
<body>

<div class="main-container">

    <div class="info-section">
        <div class="brand-header">
            <div class="brand-icon">
                <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
            </div>
        </div>

        <div class="hero-text">
            <h1>Problemi di accesso?</h1>
            <p>
                Non preoccuparti, succede a tutti.
                Inserisci l'email associata al tuo account e ti invieremo le istruzioni
                per reimpostare la password in sicurezza.
            </p>
            <div class="feature-pills">
                <span class="pill"><span class="material-icons">lock</span> Sicurezza garantita</span>
                <span class="pill"><span class="material-icons">mail</span> Codice via Email</span>
            </div>
        </div>
    </div>

    <div class="auth-section">
        <div class="auth-card">
            <h2>Recupero Password</h2>
            <p class="subtitle">Inserisci la tua email per continuare</p>

            <%-- Messaggi --%>
            <% String errore = (String) request.getAttribute("errore"); %>
            <% String messaggio = (String) request.getAttribute("messaggio"); %>

            <% if (errore != null) { %>
            <div style="background-color:#ffebee;color:#c62828;padding:10px;border-radius:8px;margin-bottom:20px;font-size:0.9rem;text-align:center;">
                <span class="material-icons" style="font-size:16px;vertical-align:middle;">error</span>
                <%= errore %>
            </div>
            <% } %>

            <% if (messaggio != null) { %>
            <div style="background-color:#e8f5e9;color:#2e7d32;padding:10px;border-radius:8px;margin-bottom:20px;font-size:0.9rem;text-align:center;">
                <span class="material-icons" style="font-size:16px;vertical-align:middle;">check_circle</span>
                <%= messaggio %>
            </div>
            <% } %>

            <form action="${pageContext.request.contextPath}/recupero-password" method="post">
                <!-- IMPORTANTE per il servlet a due step -->
                <input type="hidden" name="step" value="email">

                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email"
                           id="email"
                           name="email"
                           placeholder="nome@esempio.com"
                           required>
                </div>

                <button type="submit" class="btn-primary mt-2">Invia codice</button>

                <div class="form-footer">
                    <span>Hai ricordato la password?</span>
                    <a href="${pageContext.request.contextPath}/login" class="link-login">Accedi qui</a>
                </div>
            </form>

        </div>
    </div>
</div>

</body>
</html>
</file>

<file path=".gitignore">
target/
!.mvn/wrapper/maven-wrapper.jar
!**/src/main/**/target/
!**/src/test/**/target/

### IntelliJ IDEA ###
.idea/modules.xml
.idea/jarRepositories.xml
.idea/compiler.xml
.idea/libraries/
*.iws
*.iml
*.ipr
repomix-output.xml

### Eclipse ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/
build/
!**/src/main/**/build/
!**/src/test/**/build/

### VS Code ###
.vscode/

### Mac OS ###
.DS_Store
</file>

<file path="db/insert.sql">
-- Cancellare dati da tabella utente
SET FOREIGN_KEY_CHECKS = 0;
TRUNCATE TABLE utente;
SET FOREIGN_KEY_CHECKS = 1;

-- Cancellare dati da tabella drop-point
SET FOREIGN_KEY_CHECKS = 0;
TRUNCATE TABLE drop_point;
SET FOREIGN_KEY_CHECKS = 1;
</file>

<file path="src/main/java/model/service/EmailService.java">
package model.service;

import jakarta.mail.Authenticator;
import jakarta.mail.Message;
import jakarta.mail.MessagingException;
import jakarta.mail.PasswordAuthentication;
import jakarta.mail.Session;
import jakarta.mail.Transport;
import jakarta.mail.internet.InternetAddress;
import jakarta.mail.internet.MimeBodyPart;
import jakarta.mail.internet.MimeMessage;
import jakarta.mail.internet.MimeMultipart;

import java.nio.charset.StandardCharsets;
import java.util.Properties;

public class EmailService {
    private final Session session;
    private final String mittente;
    private final String nomeMittente = "Foundly";

    public EmailService() {
        Properties props = new Properties();
        props.put("mail.smtp.auth", "true");
        props.put("mail.smtp.starttls.enable", "true");
        props.put("mail.smtp.host", "smtp.gmail.com");
        props.put("mail.smtp.port", "587");

        this.mittente = "foundly.app@gmail.com";
        final String username = "foundly.app@gmail.com";
        final String password = System.getenv("SMTP_PASSKEY"); // app password

        this.session = Session.getInstance(props, new Authenticator() {
            @Override
            protected PasswordAuthentication getPasswordAuthentication() {
                return new PasswordAuthentication(username, password);
            }
        });
    }

    public void inviaCodiceRecuperoPassword(String destinatario, String codice)
            throws MessagingException {

        MimeMessage message = new MimeMessage(session);

        try {
            message.setFrom(new InternetAddress(mittente, nomeMittente, StandardCharsets.UTF_8.name()));
        } catch (Exception e) {
            message.setFrom(new InternetAddress(mittente));
        }

        message.setRecipients(Message.RecipientType.TO, InternetAddress.parse(destinatario));
        message.setSubject("Codice per il recupero password Foundly", StandardCharsets.UTF_8.name());

        // versione testo semplice
        String testoPlain =
                "Ciao,\n\n" +
                        "hai richiesto il recupero della password per il tuo account Foundly.\n\n" +
                        "Questo √® il tuo codice di verifica:\n\n" +
                        codice + "\n\n" +
                        "Inseriscilo nella pagina di recupero password e scegli una nuova password.\n\n" +
                        "Se non hai richiesto tu questo recupero, puoi ignorare questa email.\n\n" +
                        "Il team Foundly";

        // versione HTML pi√π curata
        String testoHtml =
                "<!DOCTYPE html>" +
                        "<html lang=\"it\">" +
                        "<head>" +
                        "  <meta charset=\"UTF-8\">" +
                        "  <title>Codice recupero password Foundly</title>" +
                        "</head>" +
                        "<body style=\"margin:0;padding:0;background-color:#f5f5f5;font-family:Roboto,Arial,sans-serif;\">" +
                        "  <table align=\"center\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"padding:24px 0;\">" +
                        "    <tr>" +
                        "      <td>" +
                        "        <table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" " +
                        "               style=\"max-width:520px;width:100%;background-color:#ffffff;border-radius:12px;" +
                        "                      box-shadow:0 4px 16px rgba(0,0,0,0.06);overflow:hidden;\">" +
                        "          <tr>" +
                        "            <td style=\"padding:18px 24px;background:linear-gradient(135deg,#FB8C00,#F57C00);color:#ffffff;\">" +
                        "              <div style=\"font-size:20px;font-weight:700;\">Foundly</div>" +
                        "              <div style=\"font-size:12px;opacity:0.9;\">Recupero password</div>" +
                        "            </td>" +
                        "          </tr>" +
                        "          <tr>" +
                        "            <td style=\"padding:24px 24px 16px 24px;color:#202124;font-size:14px;line-height:1.6;\">" +
                        "              <p style=\"margin:0 0 12px 0;\">Ciao,</p>" +
                        "              <p style=\"margin:0 0 12px 0;\">" +
                        "                hai richiesto il recupero della password per il tuo account <strong>Foundly</strong>." +
                        "              </p>" +
                        "              <p style=\"margin:0 0 8px 0;\">Questo √® il tuo codice di verifica:</p>" +
                        "            </td>" +
                        "          </tr>" +
                        "          <tr>" +
                        "            <td style=\"padding:0 24px 16px 24px;\">" +
                        "              <div style=\"text-align:center;margin:8px 0 16px 0;\">" +
                        "                <span style=\"" +
                        "                       display:inline-block;" +
                        "                       padding:12px 24px;" +
                        "                       border-radius:999px;" +
                        "                       background-color:#FFF3E0;" +
                        "                       color:#E65100;" +
                        "                       font-size:22px;" +
                        "                       font-weight:700;" +
                        "                       letter-spacing:4px;" +
                        "                       font-family:monospace;\">" +
                        codice +
                        "                </span>" +
                        "              </div>" +
                        "              <p style=\"margin:0 0 8px 0;font-size:13px;color:#5f6368;text-align:center;\">" +
                        "                Inserisci questo codice nella pagina di <strong>Recupero password</strong> e scegli una nuova password." +
                        "              </p>" +
                        "            </td>" +
                        "          </tr>" +
                        "          <tr>" +
                        "            <td style=\"padding:0 24px 20px 24px;color:#5f6368;font-size:12px;line-height:1.6;\">" +
                        "              <p style=\"margin:0 0 10px 0;\">" +
                        "                Se non hai richiesto tu questo recupero, puoi ignorare questa email in totale sicurezza." +
                        "              </p>" +
                        "              <p style=\"margin:0;\">" +
                        "                A presto,<br>" +
                        "                <span style=\"color:#E65100;font-weight:600;\">Il team Foundly</span>" +
                        "              </p>" +
                        "            </td>" +
                        "          </tr>" +
                        "          <tr>" +
                        "            <td style=\"padding:12px 24px 18px 24px;border-top:1px solid #eee;color:#9e9e9e;font-size:10px;text-align:center;\">" +
                        "              Non rispondere a questa email: il messaggio √® stato generato automaticamente." +
                        "            </td>" +
                        "          </tr>" +
                        "        </table>" +
                        "      </td>" +
                        "    </tr>" +
                        "  </table>" +
                        "</body>" +
                        "</html>";

        MimeBodyPart textPart = new MimeBodyPart();
        textPart.setText(testoPlain, StandardCharsets.UTF_8.name());

        MimeBodyPart htmlPart = new MimeBodyPart();
        htmlPart.setContent(testoHtml, "text/html; charset=UTF-8");

        MimeMultipart multipart = new MimeMultipart("alternative");
        multipart.addBodyPart(textPart);
        multipart.addBodyPart(htmlPart);

        message.setContent(multipart);

        message.setHeader("X-Mailer", "Foundly Mailer");
        message.setHeader("Content-Transfer-Encoding", "8bit");

        Transport.send(message);
    }
}
</file>

<file path="src/main/java/model/utente/ConnectionTest.java">
package model.utente;

import model.bean.Utente;
import model.bean.enums.Ruolo;
import model.dao.UtenteDAO;
import model.utils.PasswordUtils; // Importa la nuova classe utility

public class ConnectionTest {
    public static void main(String[] args) {
        System.out.println("üöÄ Inizio Test Sicurezza Password...");

        UtenteDAO utenteDAO = new UtenteDAO();
        long timeSeed = System.currentTimeMillis();

        // 1. Definiamo una password in chiaro
        String passwordInChiaro = "Segreto123!";

        System.out.println("üîë Password utente: " + passwordInChiaro);

        // 2. Creiamo l'hash
        String passwordHashata = PasswordUtils.hashPassword(passwordInChiaro);
        System.out.println("üîí Hash generato (da salvare nel DB): " + passwordHashata);

        // 3. Creiamo l'utente con l'hash
        Utente nuovoUtente = new Utente();
        nuovoUtente.setNome("Luigi");
        nuovoUtente.setCognome("Verdi");
        nuovoUtente.setUsername("luigi_" + timeSeed);
        nuovoUtente.setEmail("luigi." + timeSeed + "@secure.com");

        // IMPORTANTE: Settiamo l'hash, NON la password in chiaro!
        nuovoUtente.setPasswordHash(passwordHashata);

        nuovoUtente.setTelefono("3339998888");
        nuovoUtente.setImmagineProfilo("img/avatar.png");
        nuovoUtente.setRuolo(Ruolo.UTENTE_BASE);
        nuovoUtente.setBadge("OCCHIO_DI_FALCO");

        try {
            // 4. Salviamo nel DB
            if (utenteDAO.doSave(nuovoUtente)) {
                System.out.println("‚úÖ Utente salvato con password criptata.");
            }

            // 5. Simuliamo il LOGIN
            System.out.println("\n--- Simulazione Login ---");
            String emailLogin = nuovoUtente.getEmail();
            String passwordInseritaLogin = "Segreto123!"; // Quella giusta
            String passwordErrata = "Sbagliata!";

            // Recuperiamo l'utente dal DB
            Utente utenteDb = utenteDAO.doRetrieveByEmail(emailLogin);

            if (utenteDb != null) {
                // Test Password Corretta
                boolean accessoConsentito = PasswordUtils.checkPassword(passwordInseritaLogin, utenteDb.getPasswordHash());
                System.out.println("Tentativo con password corretta: " + (accessoConsentito ? "‚úÖ ACCESSO RIUSCITO" : "‚ùå ERRORE"));

                // Test Password Errata
                boolean accessoNegato = PasswordUtils.checkPassword(passwordErrata, utenteDb.getPasswordHash());
                System.out.println("Tentativo con password errata:   " + (!accessoNegato ? "‚úÖ ACCESSO NEGATO (Corretto)" : "‚ùå ERRORE DI SICUREZZA"));
            }

        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
</file>

<file path="src/main/java/model/ConPool.java">
package model;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

public class ConPool {
    private static final String URL = "jdbc:mysql://foundly-db-salvolepore7.j.aivencloud.com:21893/defaultdb"
            + "?useSSL=true"
            + "&requireSSL=true"
            + "&verifyServerCertificate=false"
            + "&allowPublicKeyRetrieval=true"
            + "&serverTimezone=Europe/Rome"
            + "&enabledTLSProtocols=TLSv1.2,TLSv1.3";

    private static final String USER = "avnadmin";
    private static final String PASSWORD = System.getenv("DB_PASSKEY"); //Ciao

    static {
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
        } catch (ClassNotFoundException e) {
            throw new RuntimeException("Driver MySQL non trovato!", e);
        }
    }

    /**
     * Restituisce una connessione attiva al database.
     */
    public static Connection getConnection() throws SQLException {
        return DriverManager.getConnection(URL, USER, PASSWORD);
    }
}
</file>

<file path="src/main/webapp/css/login.css">
:root {
    /* Palette Colori Arancione (Stile Google/Material) */
    --primary-color: #FB8C00;
    --primary-hover: #F57C00;
    --primary-light: #FFE0B2;
    --text-dark: #202124;
    --text-grey: #5f6368;
    --bg-color: #f0f2f5;
    --white: #ffffff;
    --border-radius: 8px;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Roboto', sans-serif;
    background-color: var(--bg-color);
    color: var(--text-dark);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

/* --- CONTENITORE PRINCIPALE --- */
.main-container {
    display: flex;
    width: 100%;
    max-width: 1200px;
    min-height: 80vh;
    height: auto;
    background-color: var(--white);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

/* --- PARTE SINISTRA (Info) --- */
.info-section {
    position: relative;
    flex: 1;
    background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
    padding: 190px 60px 60px 60px; /* spazio tra logo e testo */
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}

/* Logo in alto a sinistra su schermi grandi */
.brand-header {
    position: absolute;
    top: 32px;
    left: 40px;
}

.brand-icon img {
    height: 150px;
    width: 150px;
    display: block;
}

.hero-text h1 {
    font-size: 3rem;
    line-height: 1.2;
    margin-bottom: 20px;
    color: var(--text-dark);
}

.hero-text p {
    font-size: 1.1rem;
    color: var(--text-grey);
    line-height: 1.6;
    margin-bottom: 30px;
}

.feature-pills {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.pill {
    background-color: rgba(255, 255, 255, 0.6);
    padding: 8px 16px;
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 500;
    color: #E65100;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* pill attiva evidenziata */
.pill.active {
    background-color: #ffffff;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    border: 1px solid #FF9800;
}

/* --- PARTE DESTRA (Form) --- */
.auth-section {
    flex: 1.2;
    padding: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--white);
}

.auth-card {
    width: 100%;
    max-width: 480px;
}

.auth-card h2 {
    font-size: 2rem;
    margin-bottom: 10px;
}

.subtitle {
    color: var(--text-grey);
    margin-bottom: 30px;
}

/* --- STILE INPUT --- */
.input-group {
    margin-bottom: 20px;
}

/* per righe affiancate */
.input-row {
    display: flex;
    gap: 15px;
}

.input-group label {
    display: block;
    font-size: 0.9rem;
    color: var(--text-grey);
    margin-bottom: 5px;
    font-weight: 500;
}

.input-group input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #dadce0;
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: all 0.3s ease;
    background-color: #fafafa;
}

.input-group input:focus {
    border-color: var(--primary-color);
    background-color: var(--white);
    outline: none;
    box-shadow: 0 0 0 3px rgba(251, 140, 0, 0.2);
}

/* --- BOTTONI --- */
.btn-primary {
    width: 100%;
    padding: 14px;
    background-color: var(--primary-color);
    color: var(--white);
    border: none;
    border-radius: var(--border-radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
}

.btn-primary:hover {
    background-color: var(--primary-hover);
    box-shadow: 0 4px 12px rgba(251, 140, 0, 0.3);
}

.mt-2 {
    margin-top: 20px;
}

/* Utility Links */
.form-actions {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 20px;
}

.forgot-password {
    color: var(--primary-color);
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
}

.back-link {
    margin-top: 20px;
    text-align: center;
    font-size: 0.9rem;
    color: var(--text-grey);
}

.back-link a {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
}

/* --- FOOTER FORM (login/registrazione) --- */
.form-footer {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    color: #666;
    font-size: 0.95rem;
}

.link-login {
    color: #FB8C00;
    font-weight: 600;
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.link-login:hover {
    background-color: #FFF3E0;
    color: #E65100;
}

/* --- BOTTONI REGISTRAZIONE / OSPITE (pagina login) --- */
.registration-area {
    margin-top: 24px;
    text-align: center;
}

.registration-area p {
    margin-bottom: 12px;
    color: #5f6368;
}

.reg-buttons {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

/* base comune per registrazione e ospite */
.btn-register,
.btn-guest {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 999px;
    font-size: 0.9rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    line-height: 1.2;
    white-space: nowrap;
}

/* stile registrazione */
.btn-register {
    border: 1px solid #FFB74D;
    background: #FFF7EC;
    color: #E65100;
}

.btn-register:hover {
    background: #FFE7CF;
    border-color: #FFA726;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
}

/* versione Drop Point */
.btn-register.drop {
    border-color: #FFCC80;
}

.btn-register.drop:hover {
    background: #FFE0C0;
}

/* stile per "Continua come ospite" */
.btn-guest {
    border: 1px solid #e0e0e0;
    background: #ffffff;
    color: var(--text-grey);
}

.btn-guest:hover {
    background: #f7f7f7;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.btn-register .material-icons,
.btn-guest .material-icons {
    font-size: 18px;
}

/* Desktop: "Continua come ospite" sotto ma non a tutta larghezza */
@media (min-width: 768px) {
    .reg-buttons {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
    }

    .reg-buttons .btn-guest {
        flex-basis: 100%; /* resta su una riga tutta sua */
        max-width: 220px; /* ma visivamente √® pi√π corto */
        margin-top: 4px;
        margin-inline: auto; /* centrato */
        padding: 8px 12px; /* un filo meno largo */
    }
}

/* --- STILE MAPPA (registrazione droppoint) --- */
#map {
    height: 250px;
    width: 100%;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #dadce0;
    z-index: 1;
}

.map-label {
    display: block;
    font-size: 0.9rem;
    color: var(--text-grey);
    margin-bottom: 8px;
    font-weight: 500;
}

/* --- RESPONSIVE MOBILE / TABLET --- */
@media (max-width: 960px) {
    .main-container {
        flex-direction: column;
        height: auto;
        min-height: auto;
    }

    .info-section {
        padding: 40px 30px;
        min-height: 300px;
    }

    .auth-section {
        padding: 40px 20px;
    }

    .hero-text h1 {
        font-size: 2.2rem;
    }

    /* Logo centrato sopra al testo su schermi medi/piccoli */
    .brand-header {
        position: static;
        margin-bottom: 24px;
        text-align: center;
    }

    .brand-icon img {
        height: 120px;
        width: auto;
        margin: 0 auto;
    }
}

/* --- FIX PER I RADIO BUTTON (Scelta Consegna) --- */

/* Impedisce che il pallino diventi largo quanto tutto lo schermo */
.input-group input[type="radio"] {
    width: auto !important;       /* Torna alla dimensione naturale */
    height: auto !important;
    margin-right: 8px;            /* Spazio tra pallino e testo */
    margin-bottom: 0;
    padding: 0;
    box-shadow: none;             /* Rimuove l'ombra degli input di testo */
    border: none;
    background-color: transparent;
}

/* Contenitore per mettere le due opzioni in riga */
.radio-container {
    display: flex;
    gap: 25px;       /* Spazio tra le due opzioni */
    margin-top: 8px;
}

/* Stile per l'etichetta cliccabile (pallino + testo) */
.radio-label {
    display: flex !important;     /* Forza allineamento orizzontale */
    align-items: center;
    font-weight: 500 !important;
    color: #333 !important;
    cursor: pointer;
    margin-bottom: 0 !important;  /* Rimuove il margine sotto */
    width: auto !important;       /* Non prendere tutta la riga */
}

.radio-label span {
    font-size: 0.95rem;
}
</file>

<file path="src/main/java/controller/RecuperoPasswordServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import model.bean.Utente;
import model.service.EmailService;
import model.service.UtenteService;

import java.io.IOException;
import java.security.SecureRandom;

@WebServlet(name = "RecuperoPasswordServlet", value = "/recupero-password")
public class RecuperoPasswordServlet extends HttpServlet {

    private final UtenteService utenteService = new UtenteService();
    private final EmailService emailService = new EmailService();

    // durata codice in millisecondi (es. 15 minuti)
    private static final long DURATA_CODICE_MS = 15 * 60 * 1000L;

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {
        request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_email.jsp")
                .forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        String step = request.getParameter("step");
        if (step == null || step.isEmpty()) {
            step = "email";
        }

        if ("email".equals(step)) {
            gestisciStepEmail(request, response);
        } else if ("codice".equals(step)) {
            gestisciStepCodice(request, response);
        } else {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST, "Step non valido");
        }
    }

    private void gestisciStepEmail(HttpServletRequest request,
                                   HttpServletResponse response) throws ServletException, IOException {

        String email = request.getParameter("email");
        HttpSession session = request.getSession();

        // Non riveliamo se l'email esiste o meno:
        // ma se esiste, generiamo codice e inviamo mail.

        Utente utente = utenteService.trovaPerEmail(email);
        if (utente != null) {
            // genera codice 6 cifre
            String codice = generaCodiceSeiCifre();

            long scadenza = System.currentTimeMillis() + DURATA_CODICE_MS;

            session.setAttribute("recuperoEmail", email);
            session.setAttribute("recuperoCodice", codice);
            session.setAttribute("recuperoScadenza", scadenza);

            try {
                emailService.inviaCodiceRecuperoPassword(email, codice);
            } catch (Exception e) {
                e.printStackTrace();
                // NON diciamo all'utente che √® fallito, per sicurezza
            }
        }

        // Messaggio generico, anche se utente == null
        request.setAttribute("messaggio",
                "Se l'email esiste nel sistema, riceverai un codice di verifica a breve.");
        // Mostra pagina per inserire codice + nuova password
        request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_codice.jsp")
                .forward(request, response);
    }

    private void gestisciStepCodice(HttpServletRequest request,
                                    HttpServletResponse response) throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        if (session == null) {
            request.setAttribute("errore",
                    "Sessione di recupero scaduta. Ripeti la procedura.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_email.jsp")
                    .forward(request, response);
            return;
        }

        String emailSession = (String) session.getAttribute("recuperoEmail");
        String codiceSession = (String) session.getAttribute("recuperoCodice");
        Long scadenza = (Long) session.getAttribute("recuperoScadenza");

        if (emailSession == null || codiceSession == null || scadenza == null) {
            request.setAttribute("errore",
                    "Sessione di recupero non valida. Ripeti la procedura.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_email.jsp")
                    .forward(request, response);
            return;
        }

        if (System.currentTimeMillis() > scadenza) {
            // codice scaduto
            session.removeAttribute("recuperoEmail");
            session.removeAttribute("recuperoCodice");
            session.removeAttribute("recuperoScadenza");

            request.setAttribute("errore",
                    "Il codice √® scaduto. Richiedi un nuovo codice.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_email.jsp")
                    .forward(request, response);
            return;
        }

        String codiceInserito = request.getParameter("codice");
        String nuovaPassword = request.getParameter("nuovaPassword");
        String confermaPassword = request.getParameter("confermaPassword");

        // verifica codice
        if (codiceInserito == null || !codiceInserito.equals(codiceSession)) {
            request.setAttribute("errore", "Codice non valido.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_codice.jsp")
                    .forward(request, response);
            return;
        }

        // verifica password + conferma
        if (nuovaPassword == null || confermaPassword == null ||
                !nuovaPassword.equals(confermaPassword)) {

            request.setAttribute("errore", "Le password non coincidono.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_codice.jsp")
                    .forward(request, response);
            return;
        }

        // opzionale: applica gli stessi controlli di sicurezza delle altre password
        String patternPassword =
                "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&._-])[A-Za-z\\d@$!%*?&._-]{8,}$";

        if (!nuovaPassword.matches(patternPassword)) {
            request.setAttribute("errore",
                    "La password non rispetta i requisiti di sicurezza.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_codice.jsp")
                    .forward(request, response);
            return;
        }

        // aggiorna password nel DB
        boolean aggiornato = utenteService.resetPasswordByEmail(emailSession, nuovaPassword);
        // implementa resetPasswordByEmail(email, nuovaPassword) nel tuo service

        // pulizia attributi di sessione
        session.removeAttribute("recuperoEmail");
        session.removeAttribute("recuperoCodice");
        session.removeAttribute("recuperoScadenza");

        if (!aggiornato) {
            request.setAttribute("errore",
                    "Si √® verificato un errore durante l'aggiornamento della password.");
            request.getRequestDispatcher("/WEB-INF/jsp/recupero_password_codice.jsp")
                    .forward(request, response);
            return;
        }

        // scenario: mostra messaggio e reindirizza al login
        request.setAttribute("messaggioSuccesso", "Password aggiornata con successo. Ora puoi accedere.");
        request.getRequestDispatcher("/WEB-INF/jsp/login.jsp")
                .forward(request, response);
    }

    private String generaCodiceSeiCifre() {
        SecureRandom random = new SecureRandom();
        int codice = random.nextInt(1_000_000); // 0..999999
        return String.format("%06d", codice);
    }
}
</file>

<file path="src/main/java/model/dao/UtenteDAO.java">
package model.dao;

import model.ConPool;
import model.bean.Utente;
import model.bean.enums.Ruolo;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class UtenteDAO {

    public boolean doSave(Utente utente) {
        String query = "INSERT INTO utente (username, email, password_hash, nome, cognome, " +
                "telefono, immagine_profilo, punteggio, ruolo, badge) " +
                "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query, Statement.RETURN_GENERATED_KEYS)) {

            ps.setString(1, utente.getUsername());
            ps.setString(2, utente.getEmail());
            ps.setString(3, utente.getPasswordHash());
            ps.setString(4, utente.getNome());
            ps.setString(5, utente.getCognome());
            ps.setString(6, utente.getTelefono());
            ps.setString(7, utente.getImmagineProfilo());
            ps.setInt(8, utente.getPunteggio());
            ps.setString(9, utente.getRuolo().toString());
            ps.setString(10, utente.getBadge());

            int result = ps.executeUpdate();

            if (result > 0) {
                try (ResultSet generatedKeys = ps.getGeneratedKeys()) {
                    if (generatedKeys.next()) {
                        utente.setId(generatedKeys.getLong(1));
                    }
                }
                return true;
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    public Utente doRetrieveByEmail(String email) {
        String query = "SELECT * FROM utente WHERE email = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, email);

            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return mapRowToUtente(rs);
                }
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    public Utente doRetrieveByUsername(String username) {
        String query = "SELECT * FROM utente WHERE username = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, username);

            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return mapRowToUtente(rs);
                }
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    public List<Utente> doRetrieveAll() {
        List<Utente> utenti = new ArrayList<>();
        String query = "SELECT * FROM utente";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query);
             ResultSet rs = ps.executeQuery()) {

            while (rs.next()) {
                utenti.add(mapRowToUtente(rs));
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return utenti;
    }

    /**
     * Recupera un utente per id.
     */
    public Utente doRetrieveById(Long id) {
        String query = "SELECT * FROM utente WHERE id = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setLong(1, id);

            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return mapRowToUtente(rs);
                }
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    /**
     * Aggiorna i dati base del profilo (username, nome, cognome).
     */
    public boolean updateProfilo(Utente utente) {
        String query = "UPDATE utente SET username = ?, nome = ?, cognome = ?, immagine_profilo = ? WHERE id = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, utente.getUsername());
            ps.setString(2, utente.getNome());
            ps.setString(3, utente.getCognome());
            ps.setString(4, utente.getImmagineProfilo());
            ps.setLong(5, utente.getId());

            int updated = ps.executeUpdate();
            return updated > 0;

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    private Utente mapRowToUtente(ResultSet rs) throws SQLException {
        Utente u = new Utente();
        u.setId(rs.getLong("id"));
        u.setUsername(rs.getString("username"));
        u.setEmail(rs.getString("email"));
        u.setPasswordHash(rs.getString("password_hash"));
        u.setNome(rs.getString("nome"));
        u.setCognome(rs.getString("cognome"));
        u.setTelefono(rs.getString("telefono"));
        u.setImmagineProfilo(rs.getString("immagine_profilo"));
        u.setPunteggio(rs.getInt("punteggio"));

        String ruoloStr = rs.getString("ruolo");
        if (ruoloStr != null) {
            u.setRuolo(Ruolo.valueOf(ruoloStr));
        }

        u.setBadge(rs.getString("badge"));
        return u;
    }

    /**
     * Aggiorna l'hash della password per l'utente con la email specificata.
     *
     * @param email     email dell'utente
     * @param nuovoHash nuovo valore di password_hash (gi√† hashato)
     * @return true se √® stata aggiornata almeno una riga, false altrimenti
     */
    public boolean updatePasswordByEmail(String email, String nuovoHash) {
        String query = "UPDATE utente SET password_hash = ? WHERE email = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {

            ps.setString(1, nuovoHash);
            ps.setString(2, email);

            int updated = ps.executeUpdate();
            return updated > 0;

        } catch (SQLException e) {
            e.printStackTrace();
        }

        return false;
    }
    /**
     * Aggiorna punteggio e badge per un utente.
     */
    public boolean updatePunteggioEBadge(Utente utente) {
        String sql = "UPDATE utente SET punteggio = ?, badge = ? WHERE id = ?";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(sql)) {

            ps.setInt(1, utente.getPunteggio());
            ps.setString(2, utente.getBadge());
            ps.setLong(3, utente.getId());

            return ps.executeUpdate() > 0;

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }


}
</file>

<file path="src/main/java/model/service/DropPointService.java">
package model.service;

import model.bean.DropPoint;
import model.bean.enums.StatoDropPoint;
import model.dao.DropPointDAO;
import model.utils.PasswordUtils;

public class DropPointService {

    private final DropPointDAO dropPointDAO = new DropPointDAO();

    // NOTA: Ho corretto l'ordine: prima latitudine, poi longitudine (come nella Servlet)
    public boolean registraDropPoint(String nomeAttivita, String email, String password,
                                     String indirizzo, String citta, String provincia,
                                     String telefono, String orari,
                                     Double latitudine, Double longitudine) {

        if(dropPointDAO.doRetrieveByEmail(email) != null) return false;

        DropPoint dp = new DropPoint();
        dp.setNomeAttivita(nomeAttivita);
        dp.setEmail(email);
        dp.setPasswordHash(PasswordUtils.hashPassword(password));
        dp.setIndirizzo(indirizzo);
        dp.setCitta(citta);
        dp.setProvincia(provincia);
        dp.setTelefono(telefono);
        dp.setOrariApertura(orari);

        // CORRETTO: Uso dei setter
        dp.setLatitudine(latitudine);
        dp.setLongitudine(longitudine);

        // CORRETTO: Uso Enum e valori default obbligatori nel DB
        dp.setStato(StatoDropPoint.IN_ATTESA);
        dp.setRitiriEffettuati(0);
        dp.setImmagine("default.png");

        return dropPointDAO.doSave(dp);
    }

    public DropPoint login(String email, String password) {
        DropPoint dp = dropPointDAO.doRetrieveByEmail(email);
        if(dp == null) return null;
        if(PasswordUtils.checkPassword(password, dp.getPasswordHash())) return dp;
        return null;
    }

     /**
      * Recupera la lista di tutti i Drop-Point approvati.
     */
    public java.util.List<DropPoint> findAllApprovati() {
        return dropPointDAO.doRetrieveAllApprovati();
    }
}
</file>

<file path="src/main/webapp/WEB-INF/jsp/login.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundly - Login</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">
</head>
<body>

<div class="main-container">

    <div class="info-section">
        <div class="brand-header">
            <div class="brand-icon">
                <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
            </div>
        </div>

        <div class="hero-text">
            <h1>Hai perso qualcosa?</h1>
            <p>
                Foundly ti aiuta a ritrovare oggetti e animali smarriti grazie alla nostra community.
                Segnala uno smarrimento, cerca tra i ritrovamenti e restituisci in sicurezza tramite i nostri
                Drop-Point.
            </p>
            <div class="feature-pills">
                <span class="pill"><span class="material-icons">security</span> Secure Claim</span>
                <span class="pill"><span class="material-icons">store</span> Drop-Points</span>
                <span class="pill"><span class="material-icons">emoji_events</span> Scoreboard</span>
            </div>
        </div>
    </div>

    <div class="auth-section">
        <div class="auth-card">
            <h2>Accedi</h2>
            <p class="subtitle">Benvenuto su Foundly</p>

            <form action="${pageContext.request.contextPath}/login" method="post">

                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="nome@esempio.com" required>
                </div>

                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Inserisci la tua password"
                           required>
                </div>

                <div class="form-actions">
                    <a href="${pageContext.request.contextPath}/recupero-password" class="forgot-password">
                        Password dimenticata?
                    </a>
                </div>

                <button type="submit" class="btn-primary">Accedi</button>
            </form>

            <div class="registration-area">
                <p>Non hai un account?</p>
                <div class="reg-buttons">
                    <a href="${pageContext.request.contextPath}/registrazione-utente" class="btn-register">
                        <span class="material-icons">person</span>
                        <span>Registrati come Utente</span>
                    </a>
                    <a href="${pageContext.request.contextPath}/registrazione-droppoint" class="btn-register drop">
                        <span class="material-icons">storefront</span>
                        <span>Registrati come Drop Point</span>
                    </a>
                    <a href="${pageContext.request.contextPath}/index" class="btn-guest">
                        <span class="material-icons">arrow_back</span>
                        <span>Continua come ospite</span>
                    </a>
                </div>
            </div>

        </div>
    </div>
</div>

</body>
</html>
</file>

<file path="src/main/webapp/WEB-INF/jsp/registrazione_utente.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundly - Registrazione Utente</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">
</head>
<body>

<div class="main-container">

    <div class="info-section">
        <div class="brand-header">
            <div class="brand-icon">
                <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
            </div>
        </div>

        <div class="hero-text">
            <h1>Entra nella Community</h1>
            <p>
                Registrati come utente per segnalare oggetti ritrovati o reclamare ci√≤ che hai perso.
                Aiutaci a costruire una rete di cittadini onesti e collaborativi.
            </p>
            <div class="feature-pills">
                <span class="pill active"><span class="material-icons">security</span> Secure Claim</span>
                <span class="pill"><span class="material-icons">store</span> Drop-Points</span>
                <span class="pill"><span class="material-icons">emoji_events</span> Scoreboard</span>
            </div>
        </div>
    </div>

    <div class="auth-section">
        <div class="auth-card">
            <h2>Crea Account</h2>
            <p class="subtitle">Inserisci i tuoi dati personali</p>

            <%-- Gestione Errori --%>
            <% String errore = (String) request.getAttribute("errore"); %>
            <% if (errore != null) { %>
            <div style="background-color: #ffebee; color: #c62828; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; text-align: center;">
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">error</span> <%= errore %>
            </div>
            <% } %>

            <form action="${pageContext.request.contextPath}/registrazione-utente" method="post">

                <div class="input-row">
                    <div class="input-group">
                        <label for="nome">Nome</label>
                        <input type="text" id="nome" name="nome" placeholder="Es. Mario" required>
                    </div>
                    <div class="input-group">
                        <label for="cognome">Cognome</label>
                        <input type="text" id="cognome" name="cognome" placeholder="Es. Rossi" required>
                    </div>
                </div>

                <div class="input-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" placeholder="Scegli un username" required>
                </div>

                <div class="input-row">
                    <div class="input-group" style="flex: 2;">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="mario.rossi@email.com" required>
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <label for="telefono">Telefono</label>
                        <input type="tel" id="telefono" name="telefono" placeholder="342..." required>
                    </div>
                </div>

                <div class="input-group">
                    <label for="password">Password</label>
                    <input
                            type="password"
                            id="password"
                            name="password"
                            placeholder="Minimo 8 caratteri"
                            required
                            minlength="8"
                            pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&._-])[A-Za-z\\d@$!%*?&._-]{8,}$"
                            title="Almeno 8 caratteri, con una maiuscola, una minuscola, un numero e un carattere speciale (@$!%*?&._-)"
                    >
                    <small id="passwordHelp" style="color:#777; font-size:0.8rem;">
                        Minimo 8 caratteri, almeno 1 maiuscola, 1 minuscola, 1 numero e 1 carattere speciale
                        (@$!%*?&._-).
                    </small>
                    <div id="passwordError" style="display:none; color:#c62828; font-size:0.8rem; margin-top:4px;">
                        La password non rispetta i requisiti indicati.
                    </div>
                </div>

                <button type="submit" class="btn-primary mt-2">Registrati</button>

                <div class="form-footer">
                    <span>Hai gi√† un account?</span>
                    <a href="${pageContext.request.contextPath}/login" class="link-login">Accedi qui</a>
                </div>

            </form>

        </div>
    </div>
</div>

<script>
    (function () {
        const form = document.querySelector('.auth-card form');
        const passwordInput = document.getElementById('password');
        const passwordError = document.getElementById('passwordError');

        if (!form || !passwordInput || !passwordError) return;

        const passwordRegex =
            /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&._-])[A-Za-z\d@$!%*?&._-]{8,}$/;

        function validatePassword() {
            const value = passwordInput.value || "";

            if (passwordRegex.test(value)) {
                passwordInput.style.borderColor = '#ccc';
                passwordError.style.display = 'none';
                return true;
            } else {
                if (value.length > 0) {
                    passwordInput.style.borderColor = '#c62828';
                    passwordError.style.display = 'block';
                } else {
                    passwordInput.style.borderColor = '#ccc';
                    passwordError.style.display = 'none';
                }
                return false;
            }
        }

        passwordInput.addEventListener('input', validatePassword);

        form.addEventListener('submit', function (e) {
            if (!validatePassword()) {
                e.preventDefault();
                passwordInput.focus();
            }
        });
    })();
</script>

</body>
</html>
</file>

<file path="src/main/java/model/service/UtenteService.java">
package model.service;

import model.bean.Utente;
import model.bean.enums.Ruolo;
import model.dao.UtenteDAO;
import model.utils.PasswordUtils;

public class UtenteService {

    private final UtenteDAO utenteDAO = new UtenteDAO();

    /**
     * Registrazione di un nuovo utente "cittadino".
     */
    public boolean registraUtente(String nome,
                                  String cognome,
                                  String username,
                                  String email,
                                  String password,
                                  String telefono) {

        System.out.println("DEBUG: Inizio registrazione per " + email);

        // 1. Controllo Email
        if (utenteDAO.doRetrieveByEmail(email) != null) {
            System.out.println("DEBUG: Email gi√† presente.");
            return false;
        }

        // 2. Controllo Username
        if (utenteDAO.doRetrieveByUsername(username) != null) {
            System.out.println("DEBUG: Username gi√† presente.");
            return false;
        }

        System.out.println("DEBUG: Email e Username liberi. Procedo...");

        Utente nuovoUtente = new Utente();
        nuovoUtente.setNome(nome);
        nuovoUtente.setCognome(cognome);
        nuovoUtente.setUsername(username);
        nuovoUtente.setEmail(email);
        nuovoUtente.setTelefono(telefono);

        // Hash della password
        String passwordHash = PasswordUtils.hashPassword(password);
        nuovoUtente.setPasswordHash(passwordHash);

        // Impostazioni di default
        nuovoUtente.setRuolo(Ruolo.UTENTE_BASE);
        nuovoUtente.setPunteggio(0);
        nuovoUtente.setBadge("OCCHIO_DI_FALCO");
        nuovoUtente.setImmagineProfilo(null);

        boolean salvato = utenteDAO.doSave(nuovoUtente);
        System.out.println("DEBUG: Risultato salvataggio DAO: " + salvato);

        return salvato;
    }

    /**
     * Login utente "cittadino" con email + password.
     */
    public Utente login(String email, String password) {
        // 1. Recupera l'utente dal DB
        Utente utente = utenteDAO.doRetrieveByEmail(email);
        if (utente == null) {
            return null; // Utente non trovato
        }

        // 2. Verifica la password (hash vs password in chiaro)
        if (PasswordUtils.checkPassword(password, utente.getPasswordHash())) {
            return utente; // Login successo
        }

        return null; // Password errata
    }

    /**
     * Comodo per il recupero password:
     * restituisce l'utente associato a una certa email,
     * oppure null se non esiste.
     */
    public Utente trovaPerEmail(String email) {
        return utenteDAO.doRetrieveByEmail(email);
    }

    /**
     * Usato nel flusso di recupero password:
     * - trova l'utente tramite email
     * - calcola il nuovo hash
     * - aggiorna la password nel DB
     *
     * @return true se l'aggiornamento va a buon fine, false altrimenti
     */
    public boolean resetPasswordByEmail(String email, String nuovaPassword) {
        Utente utente = utenteDAO.doRetrieveByEmail(email);
        if (utente == null) {
            return false; // nessun utente con questa email
        }

        // Applica gli stessi criteri di sicurezza che usi in registrazione (gi√† validati a monte)
        String nuovoHash = PasswordUtils.hashPassword(nuovaPassword);
        utente.setPasswordHash(nuovoHash);

        return utenteDAO.updatePasswordByEmail(email, nuovoHash);
    }

    /* =========================================================
       METODI PER GESTIONE PROFILO
       ========================================================= */

    /**
     * Aggiorna i dati base del profilo (username, nome, cognome).
     * Si aspetta un Utente gi√† caricato (es. da sessione) con id valorizzato.
     *
     * @param utente utente da aggiornare
     * @return true se l'update su DB va a buon fine, false altrimenti
     */
    public boolean aggiornaProfilo(Utente utente) {
        // id √® un long primitivo: uso un controllo > 0 invece di null
        if (utente == null || utente.getId() <= 0) {
            return false;
        }

        // Controllo eventuale duplicato di username
        Utente esistente = utenteDAO.doRetrieveByUsername(utente.getUsername());
        if (esistente != null && esistente.getId() != utente.getId()) {
            // c'√® gi√† un altro utente con questo username
            return false;
        }

        return utenteDAO.updateProfilo(utente);
    }


    /**
     * (Opzionale) Recupera utente per id, utile se in futuro
     * ti serve ricaricare i dati dal DB.
     */
    public Utente trovaPerId(long id) {
        return utenteDAO.doRetrieveById(id);
    }
    /* ==========================
   LOGICA BADGE/PUNTEGGIO
   ========================== */

    /**
     * Ritorna il nome del badge (stringa ENUM) in base al punteggio.
     * 0-2 punti  -> OCCHIO_DI_FALCO
     * 3-4 punti  -> DETECTIVE
     * >=5 punti  -> SHERLOCK_HOLMES
     */
    // in UtenteService

    /**
     * 0-2 punti  -> OCCHIO_DI_FALCO
     * 3-4 punti  -> DETECTIVE
     * >=5 punti  -> SHERLOCK_HOLMES
     */
    private String calcolaBadgePerPunteggio(int punti) {
        if (punti >= 5) {
            return "SHERLOCK_HOLMES";
        } else if (punti >= 3) {
            return "DETECTIVE";
        } else {
            return "OCCHIO_DI_FALCO";
        }
    }

    public boolean aggiornaPunteggioEBadge(Utente utente, int deltaPunti) {
        if (utente == null || utente.getId() <= 0) {
            return false;
        }

        int nuovoPunteggio = utente.getPunteggio() + deltaPunti;
        if (nuovoPunteggio < 0) {
            nuovoPunteggio = 0;
        }

        String nuovoBadge = calcolaBadgePerPunteggio(nuovoPunteggio);

        utente.setPunteggio(nuovoPunteggio);
        utente.setBadge(nuovoBadge);

        return utenteDAO.updatePunteggioEBadge(utente);
    }
}
</file>

<file path="pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.example</groupId>
    <artifactId>Foundly</artifactId>
    <version>1.0-SNAPSHOT</version>
    <name>Foundly</name>
    <packaging>war</packaging>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.target>23</maven.compiler.target>
        <maven.compiler.source>23</maven.compiler.source>
        <junit.version>5.11.0</junit.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>jakarta.servlet</groupId>
            <artifactId>jakarta.servlet-api</artifactId>
            <version>6.1.0</version>
            <scope>provided</scope>
        </dependency>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-api</artifactId>
            <version>${junit.version}</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-engine</artifactId>
            <version>${junit.version}</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
            <version>9.2.0</version>
        </dependency>
        <dependency>
            <groupId>org.apache.tomcat</groupId>
            <artifactId>tomcat-jdbc</artifactId>
            <version>11.0.4</version>
        </dependency>

        <dependency>
            <groupId>org.mindrot</groupId>
            <artifactId>jbcrypt</artifactId>
            <version>0.4</version>
        </dependency>

        <dependency>
            <groupId>com.sun.mail</groupId>
            <artifactId>jakarta.mail</artifactId>
            <version>2.0.1</version>
        </dependency>

        <dependency>
            <groupId>org.json</groupId>
            <artifactId>json</artifactId>
            <version>20231013</version>
        </dependency>

        <dependency>
            <groupId>jakarta.servlet.jsp.jstl</groupId>
            <artifactId>jakarta.servlet.jsp.jstl-api</artifactId>
            <version>3.0.0</version>
        </dependency>
        <dependency>
            <groupId>org.glassfish.web</groupId>
            <artifactId>jakarta.servlet.jsp.jstl</artifactId>
            <version>3.0.1</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-war-plugin</artifactId>
                <version>3.4.0</version>
            </plugin>
        </plugins>
    </build>
</project>
</file>

<file path="src/main/java/model/dao/DropPointDAO.java">
package model.dao;

import model.ConPool;
import model.bean.DropPoint;
import model.bean.enums.StatoDropPoint;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class DropPointDAO {

    public boolean doSave(DropPoint dp) {
        // CORRETTO: Nome tabella DropPoint e colonne corrispondenti allo script SQL
        String query = "INSERT INTO drop_point (nome_attivita, email, password_hash, indirizzo, " +
                "citta, provincia, telefono, orari_apertura, latitudine, longitudine, " +
                "stato, ritiri_effettuati, immagine) " +
                "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query, Statement.RETURN_GENERATED_KEYS)) {

            ps.setString(1, dp.getNomeAttivita());
            ps.setString(2, dp.getEmail());
            ps.setString(3, dp.getPasswordHash());
            ps.setString(4, dp.getIndirizzo());
            ps.setString(5, dp.getCitta());
            ps.setString(6, dp.getProvincia());
            ps.setString(7, dp.getTelefono());
            ps.setString(8, dp.getOrariApertura());

            // CORRETTO: setObject gestisce meglio i Double (anche se null)
            ps.setObject(9, dp.getLatitudine());
            ps.setObject(10, dp.getLongitudine());

            // CORRETTO: Conversione Enum a Stringa
            ps.setString(11, dp.getStato().toString());
            ps.setInt(12, dp.getRitiriEffettuati());
            ps.setString(13, dp.getImmagine());

            int result = ps.executeUpdate();
            if (result > 0) {
                try (ResultSet generatedKeys = ps.getGeneratedKeys()) {
                    if (generatedKeys.next()) dp.setId(generatedKeys.getLong(1));
                }
                return true;
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    public DropPoint doRetrieveByEmail(String email) {
        // CORRETTO: Nome tabella DropPoint
        String query = "SELECT * FROM drop_point WHERE email = ?";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query)) {
            ps.setString(1, email);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    DropPoint dp = new DropPoint();
                    dp.setId(rs.getLong("id"));
                    dp.setNomeAttivita(rs.getString("nome_attivita"));
                    dp.setEmail(rs.getString("email"));
                    dp.setPasswordHash(rs.getString("password_hash"));
                    dp.setIndirizzo(rs.getString("indirizzo"));
                    dp.setCitta(rs.getString("citta"));
                    dp.setProvincia(rs.getString("provincia")); // Aggiunto
                    dp.setTelefono(rs.getString("telefono"));   // Aggiunto
                    dp.setOrariApertura(rs.getString("orari_apertura")); // Aggiunto

                    dp.setLatitudine(rs.getObject("latitudine", Double.class));
                    dp.setLongitudine(rs.getObject("longitudine", Double.class));

                    // Gestione conversione stringa DB -> Enum Java
                    try {
                        dp.setStato(StatoDropPoint.valueOf(rs.getString("stato")));
                    } catch (IllegalArgumentException | NullPointerException e) {
                        dp.setStato(StatoDropPoint.IN_ATTESA);
                    }

                    return dp;
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    public List<DropPoint> doRetrieveAllApprovati() {
        List<DropPoint> list = new ArrayList<>();
        String query = "SELECT * FROM drop_point WHERE stato = 'APPROVATO'";
        try (Connection con = ConPool.getConnection();
             PreparedStatement ps = con.prepareStatement(query);
             ResultSet rs = ps.executeQuery()) {
            while (rs.next()) {
                DropPoint dp = new DropPoint();
                dp.setId(rs.getLong("id"));
                dp.setNomeAttivita(rs.getString("nome_attivita"));
                dp.setIndirizzo(rs.getString("indirizzo"));
                dp.setCitta(rs.getString("citta"));
                dp.setProvincia(rs.getString("provincia"));
                dp.setTelefono(rs.getString("telefono"));
                dp.setOrariApertura(rs.getString("orari_apertura"));

                list.add(dp);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return list;
    }
}
</file>

<file path="src/main/webapp/WEB-INF/jsp/registrazione_droppoint.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundly - Registrazione Drop-Point</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/login.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
</head>
<body>

<div class="main-container">

    <div class="info-section">
        <div class="brand-header">
            <div class="brand-icon">
                <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
            </div>
        </div>

        <div class="hero-text">
            <h1>Diventa un Partner</h1>
            <p>
                Trasforma la tua attivit√† in un punto di riferimento per la community.
                Diventando un <strong>Drop-Point</strong>, offrirai un luogo sicuro per la restituzione di oggetti
                smarriti.
            </p>
            <div class="feature-pills">
                <span class="pill"><span class="material-icons">security</span> Secure Claim</span>
                <span class="pill active"><span class="material-icons">store</span> Drop-Points</span>
                <span class="pill"><span class="material-icons">emoji_events</span> Scoreboard</span>
            </div>
        </div>
    </div>

    <div class="auth-section">
        <div class="auth-card">
            <h2>Registra Attivit√†</h2>
            <p class="subtitle">Unisciti alla rete Foundly</p>

            <% String errore = (String) request.getAttribute("errore"); %>
            <% if (errore != null) { %>
            <div style="background-color: #ffebee; color: #c62828; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; text-align: center;">
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">error</span> <%= errore %>
            </div>
            <% } %>

            <form action="${pageContext.request.contextPath}/registrazione-droppoint" method="post">

                <div class="input-group">
                    <label for="nomeAttivita">Nome Attivit√† Commerciale</label>
                    <input type="text" id="nomeAttivita" name="nomeAttivita" placeholder="Es. Bar Centrale" required>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label for="email">Email Aziendale</label>
                        <input type="email" id="email" name="email" placeholder="info@barcentrale.it" required>
                    </div>
                    <div class="input-group">
                        <label for="telefono">Telefono</label>
                        <input type="tel" id="telefono" name="telefono" placeholder="081 1234567" required>
                    </div>
                </div>

                <div class="input-group">
                    <label for="indirizzo">Indirizzo</label>
                    <input type="text" id="indirizzo" name="indirizzo" placeholder="Via Roma, 10" required>
                </div>

                <div class="input-row">
                    <div class="input-group" style="flex: 3;">
                        <label for="citta">Citt√†</label>
                        <input type="text" id="citta" name="citta" placeholder="Milano" required>
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <label for="provincia">Prov.</label>
                        <input type="text" id="provincia" name="provincia" maxlength="2" placeholder="MI"
                               style="text-transform: uppercase;" required>
                    </div>
                </div>

                <span class="map-label">Posizione sulla mappa (clicca per selezionare)</span>
                <div id="map"></div>

                <input type="hidden" id="latitudine" name="latitudine" required>
                <input type="hidden" id="longitudine" name="longitudine" required>

                <div class="input-group">
                    <label for="orari">Orari di Apertura</label>
                    <input type="text" id="orari" name="orari" placeholder="Es. Lun-Sab 07:00 - 20:00" required>
                </div>

                <div class="input-group">
                    <label for="password">Password</label>
                    <input
                            type="password"
                            id="password"
                            name="password"
                            placeholder="Crea una password sicura"
                            required
                            minlength="8"
                            pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&._-])[A-Za-z\\d@$!%*?&._-]{8,}$"
                            title="Almeno 8 caratteri, con una maiuscola, una minuscola, un numero e un carattere speciale (@$!%*?&._-)"
                    >
                    <small id="passwordHelp" style="color:#777; font-size:0.8rem;">
                        Minimo 8 caratteri, almeno 1 maiuscola, 1 minuscola, 1 numero e 1 carattere speciale
                        (@$!%*?&._-).
                    </small>
                    <div id="passwordError" style="display:none; color:#c62828; font-size:0.8rem; margin-top:4px;">
                        La password non rispetta i requisiti indicati.
                    </div>
                </div>

                <button type="submit" class="btn-primary mt-2">Invia Richiesta</button>

                <div class="form-footer">
                    <span>La tua attivit√† √® gi√† registrata?</span>
                    <a href="${pageContext.request.contextPath}/login" class="link-login">Accedi qui</a>
                </div>
            </form>

        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    // Inizializza la mappa su Italia / Roma
    var map = L.map('map').setView([41.9028, 12.4964], 6);

    // Layer OpenStreetMap
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    var marker = null;

    function setMarker(lat, lng) {
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng], {draggable: true}).addTo(map);

            // Quando l'utente trascina il marker, aggiorna le coordinate
            marker.on('dragend', function (e) {
                var pos = e.target.getLatLng();
                document.getElementById('latitudine').value = pos.lat;
                document.getElementById('longitudine').value = pos.lng;
                console.log("Posizione selezionata (drag):", pos.lat, pos.lng);
            });
        }

        document.getElementById('latitudine').value = lat;
        document.getElementById('longitudine').value = lng;
    }

    // CLICK MANUALE SULLA MAPPA
    map.on('click', function (e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;
        setMarker(lat, lng);
        console.log("Posizione selezionata (click): " + lat + ", " + lng);
    });

    // ------- G E O C O D I N G  D A  I N D I R I Z Z O -------

    let geocodeTimeout = null;

    function geocodeAddress() {
        var indirizzoRaw = document.getElementById('indirizzo').value.trim();
        var citta = document.getElementById('citta').value.trim();
        var provincia = document.getElementById('provincia').value.trim();

        if (!indirizzoRaw || !citta || !provincia) {
            return;
        }

        // Prova a separare via e civico: "Via Cervinia, 38" -> "38 Via Cervinia"
        var street = indirizzoRaw;
        var match = indirizzoRaw.match(/(.+?)(?:,?\s+(\d+\w*\/?\w*))$/);
        if (match) {
            var via = match[1].trim();
            var civico = match[2].trim();
            street = civico + " " + via;
        }

        var params = new URLSearchParams({
            format: "json",
            limit: "1",
            addressdetails: "1",
            street: street,
            city: citta,
            county: provincia,
            country: "Italia"
        });

        var url = "https://nominatim.openstreetmap.org/search?" + params.toString();

        fetch(url, {
            method: "GET",
            headers: {
                "Accept-Language": "it"
            }
        })
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                if (!data || data.length === 0) {
                    console.warn("Indirizzo non trovato");
                    return;
                }

                var result = data[0];
                var lat = parseFloat(result.lat);
                var lng = parseFloat(result.lon);

                if (isNaN(lat) || isNaN(lng)) {
                    console.warn("Coordinate non valide dal geocoder");
                    return;
                }

                var addr = result.address || {};
                if (!addr.house_number) {
                    console.warn("Nessun house_number nei dati: posizione solo approssimativa sulla via.");
                }

                setMarker(lat, lng);
                map.setView([lat, lng], 16);

                console.log("Posizione selezionata (geocode): " + lat + ", " + lng,
                    "| street:", street, "| address:", addr);
            })
            .catch(function (error) {
                console.error("Errore nel geocoding:", error);
            });
    }

    function scheduleGeocode() {
        clearTimeout(geocodeTimeout);
        geocodeTimeout = setTimeout(geocodeAddress, 600);
    }

    // Lancia il geocoding quando l‚Äôutente compila indirizzo/citt√†/provincia
    window.addEventListener('DOMContentLoaded', function () {
        ['indirizzo', 'citta', 'provincia'].forEach(function (id) {
            var el = document.getElementById(id);
            if (el) {
                el.addEventListener('blur', scheduleGeocode);
                el.addEventListener('keyup', function (e) {
                    if (!['Tab', 'Shift', 'Alt', 'Control', 'Meta'].includes(e.key)) {
                        scheduleGeocode();
                    }
                });
            }
        });
    });
</script>

<script>
    // Validazione password (stessi controlli della registrazione utente)
    (function () {
        const form = document.querySelector('.auth-card form');
        const passwordInput = document.getElementById('password');
        const passwordError = document.getElementById('passwordError');

        if (!form || !passwordInput || !passwordError) return;

        const passwordRegex =
            /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&._-])[A-Za-z\d@$!%*?&._-]{8,}$/;

        function validatePassword() {
            const value = passwordInput.value || "";

            if (passwordRegex.test(value)) {
                passwordInput.style.borderColor = '#ccc';
                passwordError.style.display = 'none';
                return true;
            } else {
                if (value.length > 0) {
                    passwordInput.style.borderColor = '#c62828';
                    passwordError.style.display = 'block';
                } else {
                    passwordInput.style.borderColor = '#ccc';
                    passwordError.style.display = 'none';
                }
                return false;
            }
        }

        passwordInput.addEventListener('input', validatePassword);

        form.addEventListener('submit', function (e) {
            if (!validatePassword()) {
                e.preventDefault();
                passwordInput.focus();
            }
        });
    })();
</script>

</body>
</html>
</file>

<file path="src/main/java/controller/LoginServlet.java">
package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import model.bean.DropPoint;
import model.bean.Utente;
import model.service.DropPointService;
import model.service.UtenteService;

import java.io.IOException;

@WebServlet(name = "LoginServlet", value = "/login")
public class LoginServlet extends HttpServlet {

    private final UtenteService utenteService = new UtenteService();
    private final DropPointService dropPointService = new DropPointService();

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {
        request.getRequestDispatcher("/WEB-INF/jsp/login.jsp").forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        String email = request.getParameter("email");
        String password = request.getParameter("password");

        HttpSession session = request.getSession();

        // 1. Login come UTENTE (cittadino)
        Utente utente = utenteService.login(email, password);
        if (utente != null) {
            session.setAttribute("utente", utente); // usato in index.jsp
            session.setAttribute("ruoloLoggato", "CITTADINO");
            session.setMaxInactiveInterval(30 * 60);

            response.sendRedirect(request.getContextPath() + "/index");
            return;
        }

        // 2. Login come DROP-POINT
        DropPoint dropPoint = dropPointService.login(email, password);
        if (dropPoint != null) {
            // opzionale: tieni un attributo specifico
            session.setAttribute("dropPoint", dropPoint);

            // IMPORTANTE: metto anche "utente" cos√¨ index.jsp lo vede come loggato
            session.setAttribute("utente", dropPoint);

            session.setAttribute("ruoloLoggato", "DROPPOINT");
            session.setMaxInactiveInterval(30 * 60);

            response.sendRedirect(request.getContextPath() + "/index");
            return;
        }

        // 3. Nessun login valido
        request.setAttribute("errore", "Email o Password non validi.");
        request.getRequestDispatcher("/WEB-INF/jsp/login.jsp").forward(request, response);
    }
}
</file>

<file path="src/main/webapp/WEB-INF/jsp/index.jsp">
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="model.bean.Utente" %>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundly - Home</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/index.css">
</head>
<body class="page-enter">

<nav class="navbar">
    <a href="${pageContext.request.contextPath}/index" class="brand">
        <div class="brand-icon">
            <img src="<%= request.getContextPath() %>/assets/images/logo.png" alt="logo_foundly">
        </div>
    </a>

    <div class="nav-links">
        <a href="${pageContext.request.contextPath}/index" class="nav-item">
            <span class="material-icons">home</span> Home
        </a>
        <a href="crea-segnalazione" class="nav-item">
            <span class="material-icons">add_circle_outline</span> Crea Segnalazione
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">inventory</span> Segnalazioni
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">place</span> Drop-Point
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">emoji_events</span> Classifica
        </a>
    </div>

    <%
        Utente utenteLoggato = (Utente) session.getAttribute("utente");

        String navAvatarPath = null;
        boolean navHasAvatar = false;

        if (utenteLoggato != null) {
            navAvatarPath = utenteLoggato.getImmagineProfilo();
            if (navAvatarPath != null && !navAvatarPath.trim().isEmpty()) {
                try {
                    java.io.File navFile = new java.io.File(
                            application.getRealPath("/" + navAvatarPath)
                    );
                    navHasAvatar = navFile.exists();
                    if (!navHasAvatar) {
                        navAvatarPath = null;
                    }
                } catch (Exception e) {
                    navHasAvatar = false;
                    navAvatarPath = null;
                }
            }
        }

        if (utenteLoggato != null) {
    %>
    <div class="user-menu">
        <button type="button" class="user-avatar-btn">
            <% if (navHasAvatar) { %>
            <img src="<%= request.getContextPath() + "/" + navAvatarPath %>"
                 alt=""
                 class="user-avatar-img">
            <% } else { %>
            <div class="user-avatar-placeholder"></div>
            <% } %>
        </button>

        <div class="user-dropdown">
            <div class="user-dropdown-header">
                <div class="user-email"><%= utenteLoggato.getEmail() %></div>
                <div class="user-points-row">
                    <span class="points-label">punti</span>
                    <span class="points-value"><%= utenteLoggato.getPunteggio() %></span>
                </div>
            </div>

            <a href="${pageContext.request.contextPath}/profilo" class="user-dropdown-item">
                <span class="material-icons">person</span>
                <span>Profilo</span>
            </a>
            <a href="${pageContext.request.contextPath}/logout" class="user-dropdown-item user-dropdown-item-logout">
                <span class="material-icons">logout</span>
                <span>Logout</span>
            </a>
        </div>
    </div>
    <%
    } else {
    %>
    <a href="${pageContext.request.contextPath}/login" class="btn-login-nav">
        <span class="material-icons">login</span>
        <span>Accedi</span>
    </a>
    <%
        }
    %>
</nav>

<header class="hero">
    <h1>Hai perso qualcosa?</h1>
    <p>
        Foundly ti aiuta a ritrovare oggetti e animali smarriti grazie alla nostra
        community. Segnala, cerca e restituisci!
    </p>
    <a href="crea-segnalazione" class="btn-cta-hero">
        <span class="material-icons">inventory_2</span>
        Crea Segnalazione
    </a>
</header>

<div class="search-wrapper">
    <div class="search-card">
        <form action="search" method="GET">
            <div class="search-top">
                <div class="input-box">
                    <span class="material-icons" style="color: #9e9e9e;">search</span>
                    <input type="text" name="q" placeholder="Cerca per titolo, descrizione o luogo...">
                </div>
                <button type="button" class="btn-cerca">
                    <span class="material-icons">search</span>
                    Cerca
                </button>
            </div>

            <div class="filters-row">
                <div class="filter-icon-container">
                    <span class="material-icons">filter_alt</span>
                </div>

                <select class="filter-select" name="tipo">
                    <option value="">Tutti i tipi</option>
                    <option value="oggetto">Oggetto</option>
                    <option value="animale">Animale</option>
                </select>

                <select class="filter-select" name="categoria">
                    <option value="">Tutte</option>
                    <option value="elettronica">Elettronica</option>
                    <option value="documenti">Documenti</option>
                    <option value="abbigliamento">Abbigliamento</option>
                    <option value="gioielli">Gioielli</option>
                    <option value="chiavi">Chiavi</option>
                    <option value="portafogli">Portafogli</option>
                    <option value="borse">Borse</option>
                    <option value="altro">Altro</option>
                </select>

                <select class="filter-select" name="citta">
                    <option value="">Tutte le citt√†</option>
                    <option value="Roma">Roma</option>
                    <option value="Milano">Milano</option>
                    <option value="Napoli">Napoli</option>
                    <option value="Torino">Torino</option>
                    <option value="Firenze">Firenze</option>
                    <option value="Venezia">Venezia</option>
                    <option value="Bari">Bari</option>
                    <option value="Palermo">Palermo</option>
                </select>
            </div>
        </form>
    </div>
</div>

<section class="recent-section">
    <div class="section-header">
        <h2>Segnalazioni Recenti</h2>
        <%-- Conta quanti elementi ci sono nella lista --%>
        <span class="result-count">${segnalazioni != null ? segnalazioni.size() : 0} risultati</span>
    </div>

    <div class="cards-grid">

        <%-- Se la lista √® vuota --%>
        <c:if test="${empty segnalazioni}">
            <p style="color: #666; font-style: italic;">Nessuna segnalazione recente trovata.</p>
        </c:if>

        <%-- Ciclo sulle segnalazioni reali --%>
        <c:forEach var="s" items="${segnalazioni}">
            <article class="card">
                <div class="card-badges">
                    <span class="badge badge-active">${s.stato}</span>
                    <span class="badge badge-type">${s.tipoSegnalazione}</span>
                </div>

                <div class="card-image-placeholder"
                     style="${not empty s.immagine and s.immagine != 'default.png' ? 'background-image: url(' += pageContext.request.contextPath += '/' += s.immagine += '); background-size: cover; background-position: center;' : ''}">

                    <c:if test="${empty s.immagine or s.immagine == 'default.png'}">
                        <span class="material-icons">inventory_2</span>
                    </c:if>
                </div>

                <div class="card-footer">
                    <div class="card-title">${s.titolo}</div>
                    <div class="card-info">
                            ${s.citta} ‚Ä¢
                        <fmt:formatDate value="${s.dataRitrovamento}" pattern="dd MMM" />
                    </div>
                </div>
            </article>
        </c:forEach>

    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const userMenu = document.querySelector(".user-menu");
        if (!userMenu) return;

        const btn = userMenu.querySelector(".user-avatar-btn");

        btn.addEventListener("click", function (e) {
            e.stopPropagation();
            userMenu.classList.toggle("open");
        });

        // chiude cliccando fuori
        document.addEventListener("click", function () {
            userMenu.classList.remove("open");
        });
    });
</script>

</body>
</html>
</file>

<file path="src/main/webapp/css/index.css">
:root {
    --primary-color: #FB8C00;
    --primary-hover: #F57C00;
    --primary-light: #FFE0B2;
    --bg-page: #FFFFFF;
    --bg-grey: #F5F5F5;
    --text-dark: #202124;
    --text-grey: #5F6368;
    --white: #FFFFFF;
    --radius-md: 12px;
    --shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.08);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Roboto', sans-serif;
    background-color: var(--bg-page);
    color: var(--text-dark);
}

/* ================= NAVBAR ================= */

.navbar {
    position: sticky;
    top: 0;
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 48px;
    background-color: var(--white);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
}

/* Brand / Logo */

.brand {
    display: inline-flex;
    align-items: center;
    text-decoration: none;
}

.brand-icon img {
    height: 100px;
    width: auto;
}

/* Link di navigazione */

.nav-links {
    display: flex;
    align-items: center;
    gap: 16px;
}

.nav-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.95rem;
    color: #5F6368;
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 999px;
    transition: background-color 0.2s ease, color 0.2s ease;
}

.nav-item .material-icons {
    font-size: 20px;
}

.nav-item:hover {
    background-color: #F1F3F4;
    color: #202124;
}

/* Avatar utente (se loggato) */

/* Bottone avatar nella navbar */
.user-avatar-btn {
    border: none;
    background: transparent;
    padding: 0;
    cursor: pointer;
}

/* Immagine profilo / placeholder nella navbar */
.user-avatar-img,
.user-avatar-placeholder {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: block;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

/* Foto reale */
.user-avatar-img {
    object-fit: cover;
}

/* Cerchio arancione di default */
.user-avatar-placeholder {
    background: linear-gradient(135deg, #FFE0B2, #FB8C00);
}

/* Bottone Login / Registrati (se NON loggato) */

.btn-login-nav {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 999px;
    border: 1px solid #FFB74D;
    background-color: #FFF7EC;
    color: #E65100;
    font-size: 0.9rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    transition: all 0.2s ease;
}

.btn-login-nav .material-icons {
    font-size: 20px;
}

.btn-login-nav:hover {
    background-color: #FFE7CF;
    border-color: #FFA726;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

/* ================= HERO ================= */

.hero {
    position: relative;
    padding: 80px 24px 120px;
    text-align: center;
    background: linear-gradient(135deg, #F57C00 0%, #FB8C00 40%, #F36C00 100%);
    color: var(--white);
}

.hero h1 {
    font-size: 3rem;
    margin-bottom: 16px;
}

.hero p {
    max-width: 640px;
    margin: 0 auto 32px;
    font-size: 1.05rem;
    line-height: 1.6;
}

/* Pulsante call-to-action nel hero */

.btn-cta-hero {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    background-color: #FFFFFF;
    color: #E65100;
    font-weight: 600;
    font-size: 0.98rem;
    border-radius: 999px;
    text-decoration: none;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.btn-cta-hero .material-icons {
    font-size: 20px;
}

.btn-cta-hero:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
}

/* ================= SEARCH CARD ================= */

.search-wrapper {
    position: relative;
    margin-top: -52px;
    padding: 0 24px 32px;
}

.search-card {
    max-width: 900px;
    margin: 0 auto;
    background-color: #FFFFFF;
    border-radius: 24px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    padding: 18px 22px 16px;
}

/* Riga superiore (input + bottone Drop-Point) */

.search-top {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 12px;
}

.input-box {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: #F8F9FA;
    border-radius: 999px;
    padding: 8px 14px;
    border: 1px solid #E0E0E0;
}

.input-box input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    font-size: 0.95rem;
    color: #202124;
}

/* Bottone Trova Drop-Point */

.btn-cerca {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 9px 16px;
    border-radius: 999px;
    border: 1px solid #FFB74D;
    background-color: #FFF7EC;
    color: #E65100;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
}

.btn-cerca:hover {
    background-color: #FFE7CF;
    border-color: #FFA726;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.btn-droppoint .material-icons {
    font-size: 18px;
}

.btn-droppoint:hover {
    background-color: #FFE7CF;
    border-color: #FFA726;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

/* Filtri sotto */

.filters-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 4px;
}

.filter-icon-container {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #FFF3E0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.filter-icon-container .material-icons {
    font-size: 18px;
    color: #E65100;
}

.filter-select {
    flex: 1;
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid #E0E0E0;
    background-color: #FAFAFA;
    font-size: 0.9rem;
    color: #424242;
    outline: none;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
}

.filter-select:focus {
    border-color: var(--primary-color);
    background-color: #FFFFFF;
    box-shadow: 0 0 0 3px rgba(251, 140, 0, 0.16);
}

/* ================= SEZIONE SEGNALAZIONI ================= */

.recent-section {
    max-width: 1100px;
    margin: 24px auto 40px;
    padding: 0 24px;
}

.section-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 16px;
}

.section-header h2 {
    font-size: 1.4rem;
    font-weight: 600;
    color: #202124;
}

.result-count {
    font-size: 0.85rem;
    color: #757575;
}

/* Griglia cards */

.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 16px;
}

/* Card singola */

.card {
    background-color: #FFFFFF;
    border-radius: 16px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
    padding: 12px 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.card-badges {
    display: flex;
    gap: 6px;
}

.badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.badge-active {
    background-color: #E8F5E9;
    color: #2E7D32;
}

.badge-type {
    background-color: #FFF3E0;
    color: #E65100;
}

/* Placeholder immagine */

.card-image-placeholder {
    height: 120px;
    border-radius: 12px;
    background: linear-gradient(135deg, #F5F5F5, #E0E0E0);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9E9E9E;
}

.card-image-placeholder .material-icons {
    font-size: 42px;
}

/* Footer card */

.card-footer {
    margin-top: 4px;
}

.card-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 2px;
    color: #202124;
}

.card-info {
    font-size: 0.85rem;
    color: #757575;
}

/* ================= RESPONSIVE ================= */

/* 851px‚Äì1200px: navbar pi√π compatta ma con testo, pi√π bilanciata */
@media (max-width: 1200px) and (min-width: 851px) {
    .navbar {
        padding: 8px 32px;
    }

    .brand-icon img {
        height: 90px;
    }

    .nav-links {
        flex: 1;
        justify-content: center;  /* voci al centro */
        gap: 12px;
    }

    .nav-item {
        padding: 4px 10px;
        font-size: 0.9rem;
    }

    .btn-login-nav {
        margin-left: auto;
        padding: 6px 14px;
        font-size: 0.9rem;
    }
}

/* <=850px: logo pi√π a sinistra, solo icone in navbar */
@media (max-width: 850px) {
    .navbar {
        /* top | right | bottom | left */
        padding: 8px 16px 8px 8px;  /* logo pi√π vicino al bordo sinistro */
    }

    .brand-icon img {
        height: 90px;
    }

    .nav-links {
        gap: 8px;
    }

    /* nasconde il testo, lasciando visibili solo le icone */
    .nav-item,
    .btn-login-nav {
        font-size: 0;
        padding: 6px;
    }

    .nav-item .material-icons,
    .btn-login-nav .material-icons {
        font-size: 22px; /* icone ben visibili */
    }
}

/* Layout mobile (hero / search / cards), navbar gi√† gestita sopra */
@media (max-width: 768px) {
    .hero {
        padding: 60px 16px 100px;
    }

    .hero h1 {
        font-size: 2.4rem;
    }

    .search-wrapper {
        padding: 0 12px 24px;
    }

    .search-card {
        padding: 14px 14px 12px;
    }

    .filters-row {
        flex-wrap: wrap;
    }

    .filter-select {
        flex: 1 1 calc(50% - 16px);
    }
}

/* Animazione ingresso pagina */
.page-enter {
    opacity: 0;
    transform: translateY(10px);
    animation: pageFadeIn 0.6s ease-out forwards;
}

@keyframes pageFadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Animazione card recenti (fade + slide up) */
.cards-grid .card {
    opacity: 0;
    transform: translateY(15px);
    animation: cardFadeIn 0.5s ease-out forwards;
}

/* Ritardi per effetto "staggered" */
.cards-grid .card:nth-child(1) {
    animation-delay: 0.2s;
}

.cards-grid .card:nth-child(2) {
    animation-delay: 0.35s;
}

.cards-grid .card:nth-child(3) {
    animation-delay: 0.5s;
}

@keyframes cardFadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
/* ================= USER MENU DROPDOWN ================= */

.user-menu {
    position: relative;
    display: flex;
    align-items: center;
}

.user-avatar-btn {
    border: none;
    background: none;
    padding: 0;
    cursor: pointer;
}

/* .user-avatar esiste gi√†: lo riuso, quindi non toccarlo */

.user-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    width: 230px;
    background-color: #FFFFFF;
    border-radius: 14px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    padding: 10px 0;
    opacity: 0;
    transform: translateY(6px);
    pointer-events: none;
    transition: opacity 0.15s ease, transform 0.15s ease;
    z-index: 30;
}

/* stato aperto */
.user-menu.open .user-dropdown {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

/* header con email e punti */

.user-dropdown-header {
    padding: 8px 14px 10px;
    border-bottom: 1px solid #F1F3F4;
}

.user-email {
    font-size: 0.85rem;
    color: #5F6368;
    margin-bottom: 4px;
    word-break: break-all;
}

.user-points-row {
    display: flex;
    align-items: center;
    gap: 6px;
}

.points-label {
    font-size: 0.75rem;
    color: #FFAB91;
}

.points-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: #E65100;
}

/* voci menu Profilo / Logout */

.user-dropdown-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 14px;
    font-size: 0.9rem;
    text-decoration: none;
    color: #202124;
    transition: background-color 0.15s ease;
}

.user-dropdown-item .material-icons {
    font-size: 20px;
    color: #757575;
}

.user-dropdown-item:hover {
    background-color: #FFF3E0;
}

.user-dropdown-item-logout {
    color: #D32F2F;
}

.user-dropdown-item-logout .material-icons {
    color: #D32F2F;
}
</file>

<file path="README.md">
<div align="center">
  <img src="https://github.com/user-attachments/assets/6e9a0026-0671-45b5-bb89-6ae375693952" alt="logo_foundly" width="200" height="200" />
  <h1>Foundly</h1>
  <p>
    <b>The go-to platform for reporting, searching, and returning lost items.</b>
  </p>

  <p>
    <img src="https://img.shields.io/badge/Java-23-orange" alt="Java 23" />
    <img src="https://img.shields.io/badge/Jakarta%20EE-10-blue" alt="Jakarta EE 10" />
    <img src="https://img.shields.io/badge/Tomcat-11-yellow" alt="Apache Tomcat" />
    <img src="https://img.shields.io/badge/Database-MySQL-blue" alt="MySQL" />
    <img src="https://img.shields.io/badge/Build-Maven-C71A36" alt="Maven" />
  </p>
</div>

---

## üìñ About The Project

**Foundly** is a web application designed to digitize and simplify the process of returning lost items. 
We aim to build a network of honest citizens and local businesses (**Drop-Points**) collaborating to return what was lost in a **secure, traceable, and rewarding** way.

The system solves the issue of mistrust between strangers by introducing safe exchange points and a verification system (Secure Claim) based on specific questions.

---

## ‚ú® Key Features

### üë§ For Users (Finder & Owner)
- **Dual Role**: A single account to report found items or claim lost ones.
- **Secure Claim üõ°**: Anti-fraud system. The claimant must correctly answer verification questions set by the finder.
- **Lost Pets üêæ**: A dedicated section with specific fields for reporting lost pets.
- **Gamification üèÜ**: Earn points and badges (e.g., *Sherlock Holmes*) for every successful return.

### üè™ For Drop-Points (Businesses)
- **Business Registration**: Dedicated registration flow with business verification.
- **Custody Point**: Shops can offer themselves as safe locations for exchanges, increasing their local visibility.
- **Inventory Management**: Dashboard to track items in custody and manage check-in/check-out operations.

---

## üèó Architecture & Tech Stack

The project strictly follows the **MVC (Model-View-Controller)** architectural pattern to ensure maintainability and scalability.

### Backend
- **Language**: Java 23
- **Framework**: Jakarta EE 10 (Servlet 6.0)
- **Server**: Apache Tomcat 11.0.4
- **Security**: Password hashing via **BCrypt** (jBCrypt).
- **Data Access**: DAO (Data Access Object) pattern with custom Connection Pooling.
- **Service Layer**: Business logic completely separated from controllers.

### Database
- **DBMS**: MySQL (Hosted on Aiven Cloud)
- **Schema**: *Joined Inheritance* strategy for polymorphic report management (Objects vs. Animals).

### Frontend
- **Technology**: JSP (JavaServer Pages)
- **Styling**: Custom CSS3
- **Scripting**: JavaScript

---

## üöÄ Getting Started

To run Foundly locally in your development environment:

### Prerequisites
* JDK 23 or higher
* Apache Maven
* Apache Tomcat 11
* MySQL Server (or a connection to a Cloud DB)

### Installation

1.  **Clone the repository**
    ```bash
    git clone [https://github.com/YourUsername/Foundly.git](https://github.com/YourUsername/Foundly.git)
    cd Foundly
    ```

2.  **Database Setup**
    * Execute the `db/schema_v1.sql` script on your MySQL server to create the table structure.

3.  **Environment Configuration**
    * The project uses environment variables to secure credentials.
    * Configure the following in your IDE or OS:
        * `DB_PASSKEY`: Your MySQL user password.

4.  **Build & Run**
    ```bash
    mvn clean package
    ```
    * Deploy the generated `.war` file to your Tomcat server.
    * Access: `http://localhost:8080/Foundly`

## üë• Authors

This project was developed by the **NC05 Team** for the Bachelor's Degree in Computer Science at the **University of Salerno**.

| Name | Role | Contact |
| :--- | :--- | :--- |
| **Salvador Davide Passarelli** | Backend & Architecture | [Email](mailto:s.passarelli2@studenti.unisa.it) |
| **Natale Nappi** | Frontend & UI/UX | [Email](mailto:n.nappi8@studenti.unisa.it) |
| **Salvatore Lepore** | DataBase & UI/UX| [Email](mailto:s.lepore11@studenti.unisa.it) |

<p align="right">
  <i>Supervisor: Prof. Carmine Gravino</i>
</p>
</file>

</files>
