<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RecuperoPasswordServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foundly</a> &gt; <a href="index.source.html" class="el_package">controller</a> &gt; <span class="el_source">RecuperoPasswordServlet.java</span></div><h1>RecuperoPasswordServlet.java</h1><pre class="source lang-java linenums">package controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import model.bean.Utente;
import model.service.EmailService;
import model.service.UtenteService;

import java.io.IOException;
import java.security.SecureRandom;

@WebServlet(name = &quot;RecuperoPasswordServlet&quot;, value = &quot;/recupero-password&quot;)
<span class="fc" id="L17">public class RecuperoPasswordServlet extends HttpServlet {</span>

<span class="fc" id="L19">    private final UtenteService utenteService = new UtenteService();</span>
<span class="fc" id="L20">    private final EmailService emailService = new EmailService();</span>

    // durata codice in millisecondi (es. 15 minuti)
    private static final long DURATA_CODICE_MS = 15 * 60 * 1000L;

    @Override
    protected void doGet(HttpServletRequest request,
                         HttpServletResponse response) throws ServletException, IOException {
<span class="fc" id="L28">        request.getRequestDispatcher(&quot;/WEB-INF/jsp/recupero_password_email.jsp&quot;)</span>
<span class="fc" id="L29">                .forward(request, response);</span>
<span class="fc" id="L30">    }</span>

    @Override
    protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

<span class="fc" id="L36">        String step = request.getParameter(&quot;step&quot;);</span>
<span class="pc bpc" id="L37" title="2 of 4 branches missed.">        if (step == null || step.isEmpty()) {</span>
<span class="nc" id="L38">            step = &quot;email&quot;;</span>
        }

<span class="fc bfc" id="L41" title="All 2 branches covered.">        if (&quot;email&quot;.equals(step)) {</span>
<span class="fc" id="L42">            gestisciStepEmail(request, response);</span>
<span class="fc bfc" id="L43" title="All 2 branches covered.">        } else if (&quot;codice&quot;.equals(step)) {</span>
<span class="fc" id="L44">            gestisciStepCodice(request, response);</span>
        } else {
<span class="fc" id="L46">            response.sendError(HttpServletResponse.SC_BAD_REQUEST, &quot;Step non valido&quot;);</span>
        }
<span class="fc" id="L48">    }</span>

    private void gestisciStepEmail(HttpServletRequest request,
                                   HttpServletResponse response) throws ServletException, IOException {

<span class="fc" id="L53">        String email = request.getParameter(&quot;email&quot;);</span>
<span class="fc" id="L54">        HttpSession session = request.getSession();</span>

        // Non riveliamo se l'email esiste o meno:
        // ma se esiste, generiamo codice e inviamo mail.

<span class="fc" id="L59">        Utente utente = utenteService.trovaPerEmail(email);</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">        if (utente != null) {</span>
            // genera codice 6 cifre
<span class="fc" id="L62">            String codice = generaCodiceSeiCifre();</span>

<span class="fc" id="L64">            long scadenza = System.currentTimeMillis() + DURATA_CODICE_MS;</span>

<span class="fc" id="L66">            session.setAttribute(&quot;recuperoEmail&quot;, email);</span>
<span class="fc" id="L67">            session.setAttribute(&quot;recuperoCodice&quot;, codice);</span>
<span class="fc" id="L68">            session.setAttribute(&quot;recuperoScadenza&quot;, scadenza);</span>

            try {
<span class="fc" id="L71">                emailService.inviaCodiceRecuperoPassword(email, codice);</span>
<span class="nc" id="L72">            } catch (Exception e) {</span>
<span class="nc" id="L73">                e.printStackTrace();</span>
                // NON diciamo all'utente che è fallito, per sicurezza
<span class="fc" id="L75">            }</span>
        }

        // Messaggio generico, anche se utente == null
<span class="fc" id="L79">        request.setAttribute(&quot;messaggio&quot;,</span>
                &quot;Se l'email esiste nel sistema, riceverai un codice di verifica a breve.&quot;);
        // Mostra pagina per inserire codice + nuova password
<span class="fc" id="L82">        request.getRequestDispatcher(&quot;/WEB-INF/jsp/recupero_password_codice.jsp&quot;)</span>
<span class="fc" id="L83">                .forward(request, response);</span>
<span class="fc" id="L84">    }</span>

    private void gestisciStepCodice(HttpServletRequest request,
                                    HttpServletResponse response) throws ServletException, IOException {

<span class="fc" id="L89">        HttpSession session = request.getSession(false);</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">        if (session == null) {</span>
<span class="fc" id="L91">            request.setAttribute(&quot;errore&quot;,</span>
                    &quot;Sessione di recupero scaduta. Ripeti la procedura.&quot;);
<span class="fc" id="L93">            request.getRequestDispatcher(&quot;/WEB-INF/jsp/recupero_password_email.jsp&quot;)</span>
<span class="fc" id="L94">                    .forward(request, response);</span>
<span class="fc" id="L95">            return;</span>
        }

<span class="fc" id="L98">        String emailSession = (String) session.getAttribute(&quot;recuperoEmail&quot;);</span>
<span class="fc" id="L99">        String codiceSession = (String) session.getAttribute(&quot;recuperoCodice&quot;);</span>
<span class="fc" id="L100">        Long scadenza = (Long) session.getAttribute(&quot;recuperoScadenza&quot;);</span>

<span class="pc bpc" id="L102" title="2 of 6 branches missed.">        if (emailSession == null || codiceSession == null || scadenza == null) {</span>
<span class="fc" id="L103">            request.setAttribute(&quot;errore&quot;,</span>
                    &quot;Sessione di recupero non valida. Ripeti la procedura.&quot;);
<span class="fc" id="L105">            request.getRequestDispatcher(&quot;/WEB-INF/jsp/recupero_password_email.jsp&quot;)</span>
<span class="fc" id="L106">                    .forward(request, response);</span>
<span class="fc" id="L107">            return;</span>
        }

<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (System.currentTimeMillis() &gt; scadenza) {</span>
            // codice scaduto
<span class="fc" id="L112">            session.removeAttribute(&quot;recuperoEmail&quot;);</span>
<span class="fc" id="L113">            session.removeAttribute(&quot;recuperoCodice&quot;);</span>
<span class="fc" id="L114">            session.removeAttribute(&quot;recuperoScadenza&quot;);</span>

<span class="fc" id="L116">            request.setAttribute(&quot;errore&quot;,</span>
                    &quot;Il codice è scaduto. Richiedi un nuovo codice.&quot;);
<span class="fc" id="L118">            request.getRequestDispatcher(&quot;/WEB-INF/jsp/recupero_password_email.jsp&quot;)</span>
<span class="fc" id="L119">                    .forward(request, response);</span>
<span class="fc" id="L120">            return;</span>
        }

<span class="fc" id="L123">        String codiceInserito = request.getParameter(&quot;codice&quot;);</span>
<span class="fc" id="L124">        String nuovaPassword = request.getParameter(&quot;nuovaPassword&quot;);</span>
<span class="fc" id="L125">        String confermaPassword = request.getParameter(&quot;confermaPassword&quot;);</span>

        // verifica codice
<span class="pc bpc" id="L128" title="1 of 4 branches missed.">        if (codiceInserito == null || !codiceInserito.equals(codiceSession)) {</span>
<span class="fc" id="L129">            request.setAttribute(&quot;errore&quot;, &quot;Codice non valido.&quot;);</span>
<span class="fc" id="L130">            request.getRequestDispatcher(&quot;/WEB-INF/jsp/recupero_password_codice.jsp&quot;)</span>
<span class="fc" id="L131">                    .forward(request, response);</span>
<span class="fc" id="L132">            return;</span>
        }

        // verifica password + conferma
<span class="pc bpc" id="L136" title="2 of 4 branches missed.">        if (nuovaPassword == null || confermaPassword == null ||</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">                !nuovaPassword.equals(confermaPassword)) {</span>

<span class="fc" id="L139">            request.setAttribute(&quot;errore&quot;, &quot;Le password non coincidono.&quot;);</span>
<span class="fc" id="L140">            request.getRequestDispatcher(&quot;/WEB-INF/jsp/recupero_password_codice.jsp&quot;)</span>
<span class="fc" id="L141">                    .forward(request, response);</span>
<span class="fc" id="L142">            return;</span>
        }

        // opzionale: applica gli stessi controlli di sicurezza delle altre password
<span class="fc" id="L146">        String patternPassword =</span>
                &quot;^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&amp;._-])[A-Za-z\\d@$!%*?&amp;._-]{8,}$&quot;;

<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (!nuovaPassword.matches(patternPassword)) {</span>
<span class="fc" id="L150">            request.setAttribute(&quot;errore&quot;,</span>
                    &quot;La password non rispetta i requisiti di sicurezza.&quot;);
<span class="fc" id="L152">            request.getRequestDispatcher(&quot;/WEB-INF/jsp/recupero_password_codice.jsp&quot;)</span>
<span class="fc" id="L153">                    .forward(request, response);</span>
<span class="fc" id="L154">            return;</span>
        }

        // aggiorna password nel DB
<span class="fc" id="L158">        boolean aggiornato = utenteService.resetPasswordByEmail(emailSession, nuovaPassword);</span>
        // implementa resetPasswordByEmail(email, nuovaPassword) nel tuo service

        // pulizia attributi di sessione
<span class="fc" id="L162">        session.removeAttribute(&quot;recuperoEmail&quot;);</span>
<span class="fc" id="L163">        session.removeAttribute(&quot;recuperoCodice&quot;);</span>
<span class="fc" id="L164">        session.removeAttribute(&quot;recuperoScadenza&quot;);</span>

<span class="pc bpc" id="L166" title="1 of 2 branches missed.">        if (!aggiornato) {</span>
<span class="nc" id="L167">            request.setAttribute(&quot;errore&quot;,</span>
                    &quot;Si è verificato un errore durante l'aggiornamento della password.&quot;);
<span class="nc" id="L169">            request.getRequestDispatcher(&quot;/WEB-INF/jsp/recupero_password_codice.jsp&quot;)</span>
<span class="nc" id="L170">                    .forward(request, response);</span>
<span class="nc" id="L171">            return;</span>
        }

        // scenario: mostra messaggio e reindirizza al login
<span class="fc" id="L175">        request.setAttribute(&quot;messaggioSuccesso&quot;, &quot;Password aggiornata con successo. Ora puoi accedere.&quot;);</span>
<span class="fc" id="L176">        request.getRequestDispatcher(&quot;/WEB-INF/jsp/login.jsp&quot;)</span>
<span class="fc" id="L177">                .forward(request, response);</span>
<span class="fc" id="L178">    }</span>

    private String generaCodiceSeiCifre() {
<span class="fc" id="L181">        SecureRandom random = new SecureRandom();</span>
<span class="fc" id="L182">        int codice = random.nextInt(1_000_000); // 0..999999</span>
<span class="fc" id="L183">        return String.format(&quot;%06d&quot;, codice);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>